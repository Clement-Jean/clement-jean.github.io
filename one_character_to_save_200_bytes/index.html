<!DOCTYPE html> <html> <head> <title>One Character to Save 200 Bytes – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="Recently, I've been working with Markus Tacker on improving his comparison of JSON vs Protobuf for a Wifi Site Survey. This has been a lot of fun and I thought I could do a simple post about what went well and what were my mistakes. " /> <meta property="og:description" content="Recently, I've been working with Markus Tacker on improving his comparison of JSON vs Protobuf for a Wifi Site Survey. This has been a lot of fun and I thought I could do a simple post about what went well and what were my mistakes. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="One Character to Save 200 Bytes" /> <meta property="twitter:title" content="One Character to Save 200 Bytes" /> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>One Character to Save 200 Bytes</h1> <div class="entry"> <p>Recently, I've been working with <a href="https://techhub.social/@coderbyheart@chaos.social">Markus Tacker</a> on improving his <a href="https://github.com/coderbyheart/json-protobuf-comparison-wifi-site-survey">comparison of JSON vs Protobuf for a Wifi Site Survey</a>. This has been a lot of fun and I thought I could do a simple post about what went well and what were my mistakes.</p> <h2 id="looking-at-the-proto-file">Looking at the proto file</h2> <p>Here is the proto file at the moment I was looking at it:</p> <div class="code_switcher_container_parent 73beb46a-995a-40ab-a94f-a22f67e05038"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">WiFiSiteSurvey</span> <span class="p">{</span>
  <span class="kt">uint32</span> <span class="na">timestamp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="n">AP</span> <span class="na">accesspoints</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">AP</span> <span class="p">{</span>
  <span class="kt">int64</span> <span class="na">mac</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">ssid</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">rssi</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">channel</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>The first thing that made me think about improving this schema is the use of repeated on a complex object. If you don't know why, I go into more details about why it is less efficient to use complex objects in a repeated field, in the article called <a href="https://clement-jean.github.io/packed_vs_unpacked_repeated_fields/">Packed vs Unpacked Repeated Fields</a>.</p> <p>Other than that, I didn't have any other idea at that point. I needed to analyze the data.</p> <h2 id="analyzing-the-data">Analyzing the data</h2> <p>The first thing to do when you are dealing with data is to understand it and get a sense of the possible values you can have. One thing that came out directly after running the comparison script and analyzing the <a href="https://github.com/coderbyheart/json-protobuf-comparison-wifi-site-survey/blob/saga/sitesurvey.json">sitesurvey.json</a> is that all <code>rssi</code> properties are negative.</p> <p>Now, I'm not an expert in Wifi protocol but after searching online what <code>rssi</code> meant, I found that it's an acronym for Received Signal Strength Indicator and that it will always be a negative value ranging from -30 to -90 (see <a href="https://corecabling.com/understanding-received-signal-strength-rssi-in-your-wifi-network/">here</a>).</p> <p>This is interesting because by knowing this range we know that we are dealing with a range that fits in the 32 bytes integers and we know that the number are all negative so we will prefer to use a sint instead of a int (TODO: article about sint vs int). And, if you look at the proto file shown above the <code>rssi</code> field has the type <code>int32</code>, which means that we are encoding all the values into 10 bytes (because negative values are encoded as big positive numbers).</p> <p>Ok, so, before applying the change, Markus got the following result:</p> <div class="code_switcher_container_parent 60625623-ced3-4081-a241-f9499ce5ec60"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node compare.js
Found APs 30
JSON payload length: 1949 bytes
Protobuf payload length: 966 bytes
</code></pre></div></div> </div> <p>This is already very nice because we save 50% of bytes in our payload. But, after changing <code>int32 rssi = 3;</code> to <code>sint32 rssi = 3;</code>, we got the following result:</p> <div class="code_switcher_container_parent 5553596b-c036-48c8-8487-7aa78185e604"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node compare.js
Found APs 30
JSON payload length: 1949 bytes
Protobuf payload length: 713 bytes
</code></pre></div></div> </div> <p>200+ bytes gone, with one character added. Pretty cool!</p> <h2 id="back-to-the-original-idea">Back to the original idea</h2> <p>Even though we saved 200 bytes, that wasn't my original idea on how to improve this proto file. As I mentionned I wanted to see if making the repeated field act on simple data could help.</p> <p>Now, this is important to note that everything that comes after this wasn't added to the repository since we didn't entirely understand the requirements for the data. So I will show the assumption that we were making at that time and we will see how it was dismissed later. Here are the assumption:</p> <ul> <li>None of the fields are optional, if an info is missing treat the data as erroneous.</li> </ul> <p>This is important because with that assumption we could make multiple repeated fields instead of having the <code>AP</code> message and we would save encoding a complex object. This would be lowering the payload size and then later on because all the lists have the same length we could do a zip between these lists to get the objects back (first object get first element of all the lists). So the proto file changed like so:</p> <div class="code_switcher_container_parent 35727117-3fee-4ef9-8467-678fa68328f5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">WiFiSiteSurvey</span> <span class="p">{</span>
  <span class="kt">uint32</span> <span class="na">timestamp</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="kt">int64</span> <span class="na">macs</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="kt">string</span> <span class="na">ssids</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="kt">int32</span> <span class="na">rssis</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="kt">int32</span> <span class="na">channels</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <blockquote> <p>Note: <code>string</code> is a complex object so we are still using unpacked repeated field on <code>ssids</code>.</p> </blockquote> <p>We first filtered all the erroneous data in the dataset and rerun the comparison. Here is the result:</p> <div class="code_switcher_container_parent 56f1ea95-e520-49c6-98f8-614b4d821c47"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>node compare.js
Found APs 24
JSON payload length: 1949 bytes
Protobuf payload length: 510 bytes
</code></pre></div></div> </div> <p>Another 200 bytes gone.</p> <h2 id="why-the-repeated-trick-didnt-work">Why the repeated 'trick' didn't work</h2> <p>This mostly didn't work because some of the fields in <code>AP</code> are actually optional. This means that either we would have to add empty wrappers into the lists to get the list have the same length (not worth, the payload size would be bigger than 713 bytes) or we go back to our <code>AP</code> message after the <code>sint32</code> improvement.</p> <p>The second thing that is making this approach not work is that, if you noticed, we are lowering the payload but we are doing more computation in our code. We need to do a zip afterwards. This might be fine if this is internal to your company and well documented. However, if this is a client facing proto file, this might just make their life harder.</p> <p><strong>Lesson: Know your data requirements!</strong></p> <h2 id="other-improvements">Other Improvements</h2> <p>Here is a list of further improvements, added or not yet added, that are not impacting payload size:</p> <ul> <li>Change <code>uint32 timestamp = 1;</code> to <code>uint64 timestamp = 1;</code> for accepting bigger range of numbers.</li> <li>Change <code>int32 channel = 4;</code> to <code>uint32 channel = 4;</code> for invalidating negative numbers on client side.</li> <li>Change <code>int64 mac = 1;</code> to <code>uint64 mac = 1;</code> for invalidating negative numbers on client side (I'm not sure yet, but this seems possible).</li> </ul> <h2 id="conclusion">Conclusion</h2> <p>We saw that by knowing your data and knowing the encoding algorithm behind Protobuf, we can get really big payload size improvements. However, we still need to care about the usage of our proto files and be more accurate on the different data requirements, otherwise we will implement obscure 'fixes' and in the end they will not be needed.</p> <p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p> </div> <div class="date"> Written on January 14, 2023 </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'clement-jean-github-io-1'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <!-- Google Analytics --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-111260962-1', 'auto'); ga('send', 'pageview', { 'page': '/one_character_to_save_200_bytes/', 'title': 'One Character to Save 200 Bytes' }); </script> <!-- End Google Analytics --> </body> </html>