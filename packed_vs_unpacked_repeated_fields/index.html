<!DOCTYPE html> <html> <head> <title>Packed vs Unpacked Repeated Fields – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="As this is a common and not well documented mistake that developers are doing, I decided to do a post explaining the problem that you might face when using repeated fields in your Protobuf messages. " /> <meta property="og:description" content="As this is a common and not well documented mistake that developers are doing, I decided to do a post explaining the problem that you might face when using repeated fields in your Protobuf messages. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="Packed vs Unpacked Repeated Fields" /> <meta property="twitter:title" content="Packed vs Unpacked Repeated Fields" /> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>Packed vs Unpacked Repeated Fields</h1> <div class="entry"> <p>As this is a common and not well documented mistake that developers are doing, I decided to do a post explaining the problem that you might face when using repeated fields in your Protobuf messages.</p> <p>Be sure to open any refresher section if you feel like you are not sure about a topic. We are going to use them during this post.</p> <p> <details><summary><b>Refresher #1: Repeated Fields</b></summary> <p>A repeated field is a field that can contain 0 or more values. In other words, this is a list. We can create such a field by simply adding a `repeated` modifier in front of the field. This looks like this:</p> <p> <figure class="highlight"><pre><code class="language-proto" data-lang="proto"><span class="k">repeated</span> <span class="kt">int32</span> <span class="na">ids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span></code></pre></figure> </p> </details> </p> <p> <details><summary><b>Refresher #2: Field Options</b></summary> <p>A field option is some additional information that will be affecting the compilation and thus the code generation. These options can be defined as key value pairs between square brackets between the field tag and the semicolon. In this post we are going to use the <code>packed</code> option, which takes a boolean as value and can only be used on repeated field. This looks like this:</p> <p> <figure class="highlight"><pre><code class="language-proto" data-lang="proto"><span class="k">repeated</span> <span class="kt">int32</span> <span class="na">ids</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span><span class="k">packed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">];</span></code></pre></figure> </p> </details> </p> <p> <details><summary><b>Refresher #3: Protobuf Text Format</b></summary> <p>Protobuf does not exclusively encode to binary. It is possible to encode to JSON or to a format that is close to JSON. This text format is generally used for improving readability/writeability (nobody wants to read/write binary) and enhance your debugging or analysis of your messages. I will not go into too much detail about this here, but to write a repeated field, you can simply repeated the field name as many times as you want to add value to the field, followed by a colon and the value. This looks like this:</p> <p> <figure class="highlight"><pre><code class="language-yaml" data-lang="yaml"><span class="na">ids</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">ids</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">ids</span><span class="pi">:</span> <span class="s">3</span></code></pre></figure> </p> </details> </p> </p> <h2 id="packed">Packed</h2> <p>Let's start with packed repeated fields. In order to see how they are encoded we are going to use <code>protoc --encode</code> and pass it the content of some file defining the values in Protobuf Text Format. In this text file, let's define 3 values:</p> <ul class="code-tab-container b952e99f-a6af-4978-bcd4-58b560453306"><li class="active-tab code_switcher_yaml"><a onclick="selectTab('code_switcher_yaml', 'b952e99f-a6af-4978-bcd4-58b560453306', 0)">repeated.txt</a></li></ul><ul class="code-tab-switcher b952e99f-a6af-4978-bcd4-58b560453306"><li class="code_switcher_container_parent active-tab code_switcher_yaml cfce4b0c-a04a-4e7c-a440-92783e48e54a"><div class="code_switcher_code_action_container"><div id="code_copied_snackbar">Copied!</div><button class="code_switcher_copy_button" title="Copy" onclick="copyText('cfce4b0c-a04a-4e7c-a440-92783e48e54a')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ids</span><span class="pi">:</span> <span class="m">1</span>
<span class="na">ids</span><span class="pi">:</span> <span class="m">2</span>
<span class="na">ids</span><span class="pi">:</span> <span class="m">3</span>
</code></pre></div></div> </li></ul> <p>Then, for our proto file, we are going to store these values in a message called <code>PackedRepeated</code> that has a field of type <code>repeated int32</code>.</p> <ul class="code-tab-container 0fa95da5-cc56-4626-a1c6-7288760725b5"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '0fa95da5-cc56-4626-a1c6-7288760725b5', 0)">repeated.proto</a></li></ul><ul class="code-tab-switcher 0fa95da5-cc56-4626-a1c6-7288760725b5"><li class="code_switcher_container_parent active-tab code_switcher_proto 84667769-93bc-4a9b-8e6a-c4b544fc5afe"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('84667769-93bc-4a9b-8e6a-c4b544fc5afe')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">PackedRepeated</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="kt">int32</span> <span class="na">ids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>And finally, we need to use the <code>--encode</code> flag from protoc, which let us take some binary content on the standard input and write some protobuf encoded message on the standard output. To take advantage of this we are going to display the content of a file on the standard output, pipe that to the standard input of protoc and finally, pipe the standard output of protoc to a command that displays a hexadecimal dump.</p> <ul class="code-tab-container 13c6b030-df37-4c16-a8a0-8b1e76b537e0"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '13c6b030-df37-4c16-a8a0-8b1e76b537e0', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '13c6b030-df37-4c16-a8a0-8b1e76b537e0', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher 13c6b030-df37-4c16-a8a0-8b1e76b537e0"><li class="code_switcher_container_parent active-tab code_switcher_shell c25657d9-6252-4907-8ec0-998771618c9b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>PackedRepeated proto/repeated.proto | hexdump <span class="nt">-C</span>
00000000  0a 03 01 02 03                                    |.....|
00000005
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell e738fdf3-b68c-48c1-bc17-6c2fc23e1a38"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="o">(</span>Get-Content ./repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>PackedRepeated proto/repeated.proto<span class="o">)</span> <span class="nt">-join</span> <span class="s2">"</span><span class="sb">`</span>n<span class="s2">" | Format-Hex
   Label: /Users/clement/Git/experiment/out.bin

          Offset Bytes                                           Ascii
                 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
          ------ ----------------------------------------------- -----
0000000000000000 0A 03 01 02 03                                  �����
</span></code></pre></div></div> </li></ul> <p>So here we can see that the end result of encoding <code>repeated.txt</code> content as <code>PackedRepeated</code> is <code>0A 03 01 02 03</code>. What does that mean? Let's decrypt that.</p> <p>To do that, we can simply take each hexadecimal number and transform it into binary. While this is pretty simple numbers, let's use the command line to make sure we don't slip up and have wrong binary.</p> <ul class="code-tab-container dc5e5833-9615-450a-85bf-01f602f4039f"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'dc5e5833-9615-450a-85bf-01f602f4039f', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'dc5e5833-9615-450a-85bf-01f602f4039f', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher dc5e5833-9615-450a-85bf-01f602f4039f"><li class="code_switcher_container_parent active-tab code_switcher_shell 4b605f49-a5d8-40bb-9b82-acca3d78454f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"ibase=16; obase=2; 0A"</span> | bc
1010

<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"ibase=16; obase=2; 03"</span> | bc
11

<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"ibase=16; obase=2; 01"</span> | bc
1

<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"ibase=16; obase=2; 02"</span> | bc
10
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell 6b123e3e-7a99-44d3-9062-2ec1ea724873"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="o">[</span>Convert]::ToString<span class="o">(</span>0x0A, 2<span class="o">)</span>
1010

<span class="nv">$ </span><span class="o">[</span>Convert]::ToString<span class="o">(</span>0x03, 2<span class="o">)</span>
11

<span class="nv">$ </span><span class="o">[</span>Convert]::ToString<span class="o">(</span>0x01, 2<span class="o">)</span>
1

<span class="nv">$ </span><span class="o">[</span>Convert]::ToString<span class="o">(</span>0x02, 2<span class="o">)</span>
10
</code></pre></div></div> </li></ul> <blockquote> <p>Note: When you are using integers that are not fixed, you are dealing with varints. This means that the bigger the value, the bigger the number of bytes it will be encoded in. In our example, we purposely chose small numbers so that they are encoded into one byte. The following encoding explanation is not correct for all numbers you might use.</p> </blockquote> <ul> <li><code>0A</code> gives us <code>1010</code>. This is a byte that represent both the wire type (type of value) and the field tag. To get the wire type, we simply take the first 3 bits starting from the right. In our case this is <code>010</code> or 2. if you check the <a href="https://developers.google.com/protocol-buffers/docs/encoding#structure">Encoding</a> page of Protobuf Documentation, this means that we have a Length-Delimited type. In other words, we have some kind of data that has a dynamic size. This is exactly what we have, this is a list. Then, we are left with a tag equal to 1.</li> <li><code>03</code> gives us <code>11</code>. This is the actual length of the list. Here we have 3 values.</li> <li><code>01</code>, <code>02</code> and <code>03</code> (we omitted it, because we know the result), gives us respectively <code>1</code>, <code>10</code> and <code>11</code>. These are the actual values that we added into the list.</li> </ul> <p>In the end, we have 5 bytes, 1 byte for type + tag, 1 byte for the list length, and 3 bytes for the values. Pretty compact.</p> <h2 id="unpacked">Unpacked</h2> <p>Let's now see how the same values are encoded in an unpacked repeated field. To do that, we are going to use the <code>packed</code> field option. We are going to set that to false so that protoc skip the packing.</p> <ul class="code-tab-container 0e21405f-ba99-4c43-8117-28ce7794a8ff"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '0e21405f-ba99-4c43-8117-28ce7794a8ff', 0)">repeated.proto</a></li></ul><ul class="code-tab-switcher 0e21405f-ba99-4c43-8117-28ce7794a8ff"><li class="code_switcher_container_parent active-tab code_switcher_proto 1016858f-017c-4854-af25-84a28b9507e8"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('1016858f-017c-4854-af25-84a28b9507e8')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">UnpackedRepeated</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="kt">int32</span> <span class="na">ids</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span><span class="k">packed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>With that done, we can now run similar commands as what we did in the <code>Packed</code> section. The only difference is that, now, we need to specify that we want to encode the data as <code>UnpackedRepeated</code>.</p> <ul class="code-tab-container f4bab049-d294-455c-a363-014c4cd73cdf"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'f4bab049-d294-455c-a363-014c4cd73cdf', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'f4bab049-d294-455c-a363-014c4cd73cdf', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher f4bab049-d294-455c-a363-014c4cd73cdf"><li class="code_switcher_container_parent active-tab code_switcher_shell b49b4fba-ebcc-4778-aa46-307e7864364b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>UnpackedRepeated proto/repeated.proto | hexdump <span class="nt">-C</span>
00000000  08 01 08 02 08 03                                 |......|
00000006
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell 3b8c0fae-9b3d-474c-b381-d75c6a7cc670"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="o">(</span>Get-Content ./repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>UnpackedRepeated proto/repeated.proto<span class="o">)</span> <span class="nt">-join</span> <span class="s2">"</span><span class="sb">`</span>n<span class="s2">" | Format-Hex
   Label: String (System.String) &lt;01DCACCB&gt;

          Offset Bytes                                           Ascii
                 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
          ------ ----------------------------------------------- -----
0000000000000000 08 01 08 02 08 03                               ������
</span></code></pre></div></div> </li></ul> <p>And ... We have six bytes.</p> <p>There are two things we can notice here. The first is that now we don't have any <code>0A</code> byte. And the second one is that we are interleaving <code>08</code> with our values. Let's find out how this was encoded.</p> <p>As we already know the values for <code>01</code>, <code>02</code> and <code>03</code>, we can just convert <code>08</code>.</p> <ul class="code-tab-container 28ffb970-55c9-4778-ad24-be8400d2001e"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '28ffb970-55c9-4778-ad24-be8400d2001e', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '28ffb970-55c9-4778-ad24-be8400d2001e', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher 28ffb970-55c9-4778-ad24-be8400d2001e"><li class="code_switcher_container_parent active-tab code_switcher_shell ad87f86e-9453-4208-86ce-1d1371f7bbdc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"ibase=16; obase=2; 08"</span> | bc
1000
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell 6566888d-f516-4ab1-982e-cca97d76cf05"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="o">[</span>Convert]::ToString<span class="o">(</span>0x08, 2<span class="o">)</span>
1000
</code></pre></div></div> </li></ul> <ul> <li><code>08</code> gives us <code>1000</code>. Once again this is the combination of wire type and field tag. So we have 0 for the wire type, which corresponds to varint. And then the field tag is 1.</li> </ul> <p>So in this case, we are basically encoding each value of the list as a separate field. Protobuf will then see that the <code>ids</code> field is repeated and that we are adding multiple values with the same field tag and it will just add these values to the list.</p> <p>In the end, Protobuf is encoding <code>UnpackedRepeated</code> into six bytes instead of five. This sounds negligible here because we have a simple example but if you run the example on 100 ids:</p> <blockquote> <p>You can generate the repeated.txt by running this in your shell:</p> <ul class="code-tab-container 147bfdd1-a073-435e-9302-a640dbda6cbf"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '147bfdd1-a073-435e-9302-a640dbda6cbf', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '147bfdd1-a073-435e-9302-a640dbda6cbf', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher 147bfdd1-a073-435e-9302-a640dbda6cbf"><li class="code_switcher_container_parent active-tab code_switcher_shell 2c9719b9-ea2f-402e-9b5b-93ea371900ef"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('2c9719b9-ea2f-402e-9b5b-93ea371900ef')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for </span>i <span class="k">in</span> <span class="o">{</span>1..100<span class="o">}</span>
<span class="k">do
  </span><span class="nb">echo</span> <span class="s2">"ids: </span><span class="k">${</span><span class="nv">i</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> repeated.txt
<span class="k">done</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell b899a46f-ba13-4fc6-8eb1-5b159fe1a975"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('b899a46f-ba13-4fc6-8eb1-5b159fe1a975')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>foreach <span class="o">(</span><span class="nv">$i</span> <span class="k">in </span>1..100<span class="o">)</span> <span class="o">{</span>
  Add-Content <span class="nt">-Path</span> <span class="s2">"repeated1.txt"</span> <span class="nt">-Value</span> <span class="s2">"ids: </span><span class="nv">$i</span><span class="s2">"</span>
<span class="o">}</span>
</code></pre></div></div> </li></ul></blockquote> <ul class="code-tab-container f233599d-2ebb-404f-81d1-3958c9f51611"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'f233599d-2ebb-404f-81d1-3958c9f51611', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'f233599d-2ebb-404f-81d1-3958c9f51611', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher f233599d-2ebb-404f-81d1-3958c9f51611"><li class="code_switcher_container_parent active-tab code_switcher_shell b6be10ed-671a-4249-ac28-5252618f3f17"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>PackedRepeated proto/repeated.proto | hexdump <span class="nt">-C</span>
00000000  0a 64 01 02 03 04 05 06  07 08 09 0a 0b 0c 0d 0e  |.d..............|
00000010  0f 10 11 12 13 14 15 16  17 18 19 1a 1b 1c 1d 1e  |................|
00000020  1f 20 21 22 23 24 25 26  27 28 29 2a 2b 2c 2d 2e  |. <span class="o">!</span><span class="s2">"#</span><span class="nv">$%</span><span class="s2">&amp;'()*+,-.|
00000030  2f 30 31 32 33 34 35 36  37 38 39 3a 3b 3c 3d 3e  |/0123456789:;&lt;=&gt;|
00000040  3f 40 41 42 43 44 45 46  47 48 49 4a 4b 4c 4d 4e  |?@ABCDEFGHIJKLMN|
00000050  4f 50 51 52 53 54 55 56  57 58 59 5a 5b 5c 5d 5e  |OPQRSTUVWXYZ[</span><span class="se">\]</span><span class="s2">^|
00000060  5f 60 61 62 63 64                                 |_</span><span class="sb">`</span>abcd|
00000066

<span class="nv">$ </span><span class="nb">cat </span>repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>UnpackedRepeated proto/repeated.proto | hexdump <span class="nt">-C</span>
00000000  08 01 08 02 08 03 08 04  08 05 08 06 08 07 08 08  |................|
00000010  08 09 08 0a 08 0b 08 0c  08 0d 08 0e 08 0f 08 10  |................|
00000020  08 11 08 12 08 13 08 14  08 15 08 16 08 17 08 18  |................|
00000030  08 19 08 1a 08 1b 08 1c  08 1d 08 1e 08 1f 08 20  |............... |
00000040  08 21 08 22 08 23 08 24  08 25 08 26 08 27 08 28  |.!.<span class="s2">".#.</span><span class="nv">$.</span><span class="s2">%.&amp;.'.(|
00000050  08 29 08 2a 08 2b 08 2c  08 2d 08 2e 08 2f 08 30  |.).*.+.,.-.../.0|
00000060  08 31 08 32 08 33 08 34  08 35 08 36 08 37 08 38  |.1.2.3.4.5.6.7.8|
00000070  08 39 08 3a 08 3b 08 3c  08 3d 08 3e 08 3f 08 40  |.9.:.;.&lt;.=.&gt;.?.@|
00000080  08 41 08 42 08 43 08 44  08 45 08 46 08 47 08 48  |.A.B.C.D.E.F.G.H|
00000090  08 49 08 4a 08 4b 08 4c  08 4d 08 4e 08 4f 08 50  |.I.J.K.L.M.N.O.P|
000000a0  08 51 08 52 08 53 08 54  08 55 08 56 08 57 08 58  |.Q.R.S.T.U.V.W.X|
000000b0  08 59 08 5a 08 5b 08 5c  08 5d 08 5e 08 5f 08 60  |.Y.Z.[.</span><span class="se">\.</span><span class="s2">].^._.</span><span class="sb">`</span>|
000000c0  08 61 08 62 08 63 08 64                           |.a.b.c.d|
000000c8
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell 0128ac93-ac86-4124-bbe5-3257e77e4b74"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="o">(</span>Get-Content ./repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>PackedRepeated proto/repeated.proto<span class="o">)</span> <span class="nt">-join</span> <span class="s2">"</span><span class="sb">`</span>n<span class="s2">" | Format-Hex
   Label: String (System.String) &lt;470F6C47&gt;

          Offset Bytes                                           Ascii
                 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
          ------ ----------------------------------------------- -----
0000000000000000 0A 64 01 02 03 04 05 06 07 08 09 0A 0B 0C 0A 0E �d��������������
0000000000000010 0F 10 11 12 13 14 15 16 17 18 19 1A 1B 1C 1D 1E ����������������
0000000000000020 1F 20 21 22 23 24 25 26 27 28 29 2A 2B 2C 2D 2E � !"</span><span class="c">#$%&amp;'()*+,-.</span>
0000000000000030 2F 30 31 32 33 34 35 36 37 38 39 3A 3B 3C 3D 3E /0123456789:<span class="p">;</span>&lt;<span class="o">=&gt;</span>
0000000000000040 3F 40 41 42 43 44 45 46 47 48 49 4A 4B 4C 4D 4E ?@ABCDEFGHIJKLMN
0000000000000050 4F 50 51 52 53 54 55 56 57 58 59 5A 5B 5C 5D 5E OPQRSTUVWXYZ[<span class="se">\]</span>^
0000000000000060 5F 60 61 62 63 64                               _<span class="sb">`</span><span class="s2">abcd

</span><span class="nv">$ </span><span class="s2">(Get-Content ./repeated.txt | protoc --encode=UnpackedRepeated proto/repeated.proto) -join "</span><span class="sb">`</span>n<span class="s2">" | Format-Hex
   Label: String (System.String) &lt;6F5008AF&gt;

          Offset Bytes                                           Ascii
                 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
          ------ ----------------------------------------------- -----
0000000000000000 08 01 08 02 08 03 08 04 08 05 08 06 08 07 08 08 ����������������
0000000000000010 08 09 08 0A 08 0B 08 0C 08 0A 08 0E 08 0F 08 10 ����������������
0000000000000020 08 11 08 12 08 13 08 14 08 15 08 16 08 17 08 18 ����������������
0000000000000030 08 19 08 1A 08 1B 08 1C 08 1D 08 1E 08 1F 08 20 ���������������
0000000000000040 08 21 08 22 08 23 08 24 08 25 08 26 08 27 08 28 �!�"</span>�#�<span class="nv">$�</span>%�&amp;�<span class="s1">'�(
0000000000000050 08 29 08 2A 08 2B 08 2C 08 2D 08 2E 08 2F 08 30 �)�*�+�,�-�.�/�0
0000000000000060 08 31 08 32 08 33 08 34 08 35 08 36 08 37 08 38 �1�2�3�4�5�6�7�8
0000000000000070 08 39 08 3A 08 3B 08 3C 08 3D 08 3E 08 3F 08 40 �9�:�;�&lt;�=�&gt;�?�@
0000000000000080 08 41 08 42 08 43 08 44 08 45 08 46 08 47 08 48 �A�B�C�D�E�F�G�H
0000000000000090 08 49 08 4A 08 4B 08 4C 08 4D 08 4E 08 4F 08 50 �I�J�K�L�M�N�O�P
00000000000000A0 08 51 08 52 08 53 08 54 08 55 08 56 08 57 08 58 �Q�R�S�T�U�V�W�X
00000000000000B0 08 59 08 5A 08 5B 08 5C 08 5D 08 5E 08 5F 08 60 �Y�Z�[�\�]�^�_�`
00000000000000C0 08 61 08 62 08 63 08 64                         �a�b�c�d
</span></code></pre></div></div> </li></ul> <p>you will get 102 bytes with the packed version and 200 with the unpacked one. Ouch!</p> <h2 id="ill-never-use-codepacked--falsecode-so-whats-the-problem">I'll never use <code>packed = false</code>, so what's the problem?</h2> <p>As of now, we were using an example that would probably never appear in real life. So now, it's time to get back in touch with reality. Let's say that instead of storing as <code>int32</code> you want to store your ids as strings. To test that, we can create a Simple message called <code>Repeated</code> with a repeated string field.</p> <ul class="code-tab-container a51b11c9-ec33-400b-af8e-08af1e596fa1"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'a51b11c9-ec33-400b-af8e-08af1e596fa1', 0)">repeated.proto</a></li></ul><ul class="code-tab-switcher a51b11c9-ec33-400b-af8e-08af1e596fa1"><li class="code_switcher_container_parent active-tab code_switcher_proto ca6d5b6a-27c2-4803-b262-306c99756285"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('ca6d5b6a-27c2-4803-b262-306c99756285')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Repeated</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="kt">string</span> <span class="na">ids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>and change our text file to specify string values.</p> <ul class="code-tab-container 10bcb0a4-436b-4ed3-9f69-f744f7c2b043"><li class="active-tab code_switcher_yaml"><a onclick="selectTab('code_switcher_yaml', '10bcb0a4-436b-4ed3-9f69-f744f7c2b043', 0)">repeated.txt</a></li></ul><ul class="code-tab-switcher 10bcb0a4-436b-4ed3-9f69-f744f7c2b043"><li class="code_switcher_container_parent active-tab code_switcher_yaml 534400cb-fa50-4b33-a1a7-8617c9496f27"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('534400cb-fa50-4b33-a1a7-8617c9496f27')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">ids</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
<span class="na">ids</span><span class="pi">:</span> <span class="s2">"</span><span class="s">2"</span>
<span class="na">ids</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
</code></pre></div></div> </li></ul> <p>After that, we are familiar how to encode that, we can just change the <code>--encode</code> flag value to <code>Repeated</code>.</p> <ul class="code-tab-container 8b447345-0cec-4095-baf4-39a369b09572"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '8b447345-0cec-4095-baf4-39a369b09572', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '8b447345-0cec-4095-baf4-39a369b09572', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher 8b447345-0cec-4095-baf4-39a369b09572"><li class="code_switcher_container_parent active-tab code_switcher_shell acf18193-21ec-4371-bf3f-9aefc7157a06"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">cat </span>repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>Repeated proto/repeated.proto | hexdump <span class="nt">-C</span>
00000000  0a 01 31 0a 01 32 0a 01  33                       |..1..2..3|
00000009
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell de7a6763-dde1-4470-a5d2-595789b13f1a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="o">(</span>Get-Content ./repeated.txt | protoc <span class="nt">--encode</span><span class="o">=</span>Repeated proto/repeated.proto<span class="o">)</span> <span class="nt">-join</span> <span class="s2">"</span><span class="sb">`</span>n<span class="s2">" | Format-Hex

   Label: String (System.String) &lt;7AB0A992&gt;

          Offset Bytes                                           Ascii
                 00 01 02 03 04 05 06 07 08 09 0A 0B 0C 0D 0E 0F
          ------ ----------------------------------------------- -----
0000000000000000 0A 01 31 0A 01 32 0A 01 33                      ��1��2��3
</span></code></pre></div></div> </li></ul> <p>Does it look familiar to you? Yes, we are interleaving <code>0A</code> (length-delimited type with tag 1) with the values (two bytes, <code>01</code> is the length and <code>31</code>, <code>32</code>, <code>33</code> are the ASCII values for <code>1</code>, <code>2</code>, <code>3</code>).</p> <p>This is basically showing us that, even though repeated fields are packed by default, some types cannot be packed. This is the case for the following types:</p> <ul> <li><code>bytes</code></li> <li><code>string</code></li> <li>User defined Types (messages)</li> </ul> <h2 id="conclusion">Conclusion</h2> <p>The overall idea of this post was to explain that some types are not 'packable' when used in repeated fields. Simple types like varints and other numbers can be packed but more complex types cannot. This can cause performance problems and this can even result in poor performance compared to JSON. So the thing to keep in mind when using repeated field is that we should mostly use it with numbers. For other types, use <code>repeated</code> with caution.</p> <p><strong>If you find this kind of article interesting or you would like me to cover some topic on Protobuf or gRPC, be sure to let me know in the comments.</strong></p> </div> <div class="date"> Written on January 5, 2023 </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'clement-jean-github-io-1'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <!-- Google Analytics --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-111260962-1', 'auto'); ga('send', 'pageview', { 'page': '/packed_vs_unpacked_repeated_fields/', 'title': 'Packed vs Unpacked Repeated Fields' }); </script> <!-- End Google Analytics --> </body> </html>