<!DOCTYPE html> <html> <head> <title>gRPC 'mocking' – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="After being used to the traditional way of debug an android app by using mocking and interceptors, I came across an interesting problem with gRPC. I wanted to do the same. Basically, add an interceptor that mock a server response. " /> <meta property="og:description" content="After being used to the traditional way of debug an android app by using mocking and interceptors, I came across an interesting problem with gRPC. I wanted to do the same. Basically, add an interceptor that mock a server response. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="gRPC 'mocking'" /> <meta property="twitter:title" content="gRPC 'mocking'" /> <link rel="stylesheet" type="text/css" href="/css/org-style.css" /> <link rel="stylesheet" type="text/css" href="/css/org-code.css"/> <link rel="stylesheet" type="text/css" href="/css/org-normalize.css"/> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/css/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>gRPC 'mocking'</h1> <div class="entry"> <p>After being used to the traditional way of debug an android app by using mocking and interceptors, I came across an interesting problem with gRPC. I wanted to do the same. Basically, add an interceptor that mock a server response.</p> <p><strong>An important note: The app is in Kotlin, however this code I show is in Java. What I want to show here is that the concepts in gRPC are generally easily convertible to other languages. And even if you are actually coding in another supported language, you should be able to do pretty much the same</strong></p> <p>I discovered that, of course, gRPC has interceptors, but I also discovered in my case I didn't need them. Let me explain here. After playing a little bit with the <a href="https://grpc.github.io/grpc-java/javadoc/io/grpc/ForwardingClientCall.SimpleForwardingClientCall.html">ForwardingClientCall.SimpleForwardingClientCall</a> class by inheriting it like <a href="https://github.com/grpc/grpc-java/blob/master/examples/src/test/java/io/grpc/examples/header/HeaderServerInterceptorTest.java">this</a>:</p> <div class="code_switcher_container_parent 3b892888-fd2b-453b-bf40-c616a32222b1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">serverHeaderDeliveredToClient</span><span class="o">()</span> <span class="o">{</span>
  <span class="kd">class</span> <span class="nc">SpyingClientInterceptor</span> <span class="kd">implements</span> <span class="nc">ClientInterceptor</span> <span class="o">{</span>
    <span class="nc">ClientCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">&lt;?&gt;</span> <span class="n">spyListener</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="o">&lt;</span><span class="nc">ReqT</span><span class="o">,</span> <span class="nc">RespT</span><span class="o">&gt;</span> <span class="nc">ClientCall</span><span class="o">&lt;</span><span class="nc">ReqT</span><span class="o">,</span> <span class="nc">RespT</span><span class="o">&gt;</span> <span class="nf">interceptCall</span><span class="o">(</span>
        <span class="nc">MethodDescriptor</span><span class="o">&lt;</span><span class="nc">ReqT</span><span class="o">,</span> <span class="nc">RespT</span><span class="o">&gt;</span> <span class="n">method</span><span class="o">,</span> <span class="nc">CallOptions</span> <span class="n">callOptions</span><span class="o">,</span> <span class="nc">Channel</span> <span class="n">next</span><span class="o">)</span>
    <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">SimpleForwardingClientCall</span><span class="o">&lt;</span><span class="nc">ReqT</span><span class="o">,</span> <span class="nc">RespT</span><span class="o">&gt;(</span><span class="n">next</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">method</span><span class="o">,</span> <span class="n">callOptions</span><span class="o">))</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">start</span><span class="o">(</span><span class="nc">Listener</span><span class="o">&lt;</span><span class="nc">RespT</span><span class="o">&gt;</span> <span class="n">responseListener</span><span class="o">,</span> <span class="nc">Metadata</span> <span class="n">headers</span><span class="o">)</span> <span class="o">{</span>
          <span class="n">spyListener</span> <span class="o">=</span> <span class="n">responseListener</span> <span class="o">=</span>
              <span class="n">mock</span><span class="o">(</span><span class="nc">ClientCall</span><span class="o">.</span><span class="na">Listener</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">delegatesTo</span><span class="o">(</span><span class="n">responseListener</span><span class="o">));</span>
          <span class="kd">super</span><span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="n">responseListener</span><span class="o">,</span> <span class="n">headers</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">};</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div> </div> <p>I didn't find any way to send back a message to my client. After going through the gRPC code and especially the comments (ctrl+left click on android studio),something caught my eye:</p> <div class="code_switcher_container_parent 5aa72423-fde9-4663-abb0-998620c6ea64"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
    ...
 * &lt;p&gt;DO NOT MOCK: Use InProcessServerBuilder and make a test server instead.
 *
 * @param &lt;ReqT&gt; type of message sent one or more times to the server.
 * @param &lt;RespT&gt; type of message received one or more times from the server.
 */</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ClientCall</span><span class="o">&lt;</span><span class="nc">ReqT</span><span class="o">,</span> <span class="nc">RespT</span><span class="o">&gt;</span> <span class="o">{</span>
</code></pre></div></div> </div> <p>Here was my solution: <code>InProcessServerBuilder</code>. After a little bit more searching in github, I found <a href="https://github.com/grpc/grpc-java/blob/e6c8534f10d938566a62e38792a74032955e6c82/examples/src/test/java/io/grpc/examples/helloworld/HelloWorldServerTest.java">this</a>:</p> <div class="code_switcher_container_parent 33faa95b-ed01-4f59-a09c-057f7b939ce8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kt">void</span> <span class="nf">greeterImpl_replyMessage</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
  <span class="c1">// Generate a unique in-process server name.</span>
  <span class="nc">String</span> <span class="n">serverName</span> <span class="o">=</span> <span class="nc">InProcessServerBuilder</span><span class="o">.</span><span class="na">generateName</span><span class="o">();</span>

  <span class="c1">// Create a server, add service, start, and register for automatic graceful shutdown.</span>
  <span class="n">grpcCleanup</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">InProcessServerBuilder</span>
      <span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">serverName</span><span class="o">)</span>
      <span class="o">.</span><span class="na">directExecutor</span><span class="o">()</span>
      <span class="o">.</span><span class="na">addService</span><span class="o">(</span><span class="k">new</span> <span class="nc">GreeterImpl</span><span class="o">())</span>
      <span class="o">.</span><span class="na">build</span><span class="o">()</span>
      <span class="o">.</span><span class="na">start</span><span class="o">());</span>

  <span class="nc">GreeterGrpc</span><span class="o">.</span><span class="na">GreeterBlockingStub</span> <span class="n">blockingStub</span> <span class="o">=</span> <span class="nc">GreeterGrpc</span><span class="o">.</span><span class="na">newBlockingStub</span><span class="o">(</span>
      <span class="c1">// Create a client channel and register for automatic graceful shutdown.</span>
      <span class="n">grpcCleanup</span><span class="o">.</span><span class="na">register</span><span class="o">(</span><span class="nc">InProcessChannelBuilder</span>
        <span class="o">.</span><span class="na">forName</span><span class="o">(</span><span class="n">serverName</span><span class="o">)</span>
        <span class="o">.</span><span class="na">directExecutor</span><span class="o">()</span>
        <span class="o">.</span><span class="na">build</span><span class="o">()));</span>


  <span class="nc">HelloReply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">blockingStub</span><span class="o">.</span><span class="na">sayHello</span><span class="o">(</span><span class="nc">HelloRequest</span>
    <span class="o">.</span><span class="na">newBuilder</span><span class="o">()</span>
    <span class="o">.</span><span class="na">setName</span><span class="o">(</span> <span class="s">"test name"</span><span class="o">)</span>
    <span class="o">.</span><span class="na">build</span><span class="o">());</span>

  <span class="n">assertEquals</span><span class="o">(</span><span class="s">"Hello test name"</span><span class="o">,</span> <span class="n">reply</span><span class="o">.</span><span class="na">getMessage</span><span class="o">());</span>
<span class="o">}</span>
</code></pre></div></div> </div> <p>The most important thing to note here is the use of the two 2 builders:</p> <ul> <li>InProcessServerBuilder</li> <li>InProcessChannelBuilder</li> </ul> <p>and the use of InProcessServerBuilder's function :</p> <ul> <li>addService</li> </ul> <p>And if you are familiar with the greeter example of gRPC, everything will make sense here. If you are not, you can join my gRPC Java course on <a href="https://www.udemy.com/course/grpc-java/?referralCode=9648E53DF9F3D92EB2EA">Udemy</a>.</p> <p>You can now adapt this solution for the testing part of you application !</p> </div> <div class="date"> Written on March 9, 2020 </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <script type="text/javascript" src="/js/codetabs.js"></script> </body> </html>