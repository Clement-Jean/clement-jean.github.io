<!DOCTYPE html> <html> <head> <title>Storing Colors in Protocol Buffers – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content=" While working on a new course, I was looking for an example to store a Color in Protocol Buffers. At first this seemed like an easy task but it turned out to be an interesting example of optimization. Let's work through it. " /> <meta property="og:description" content=" While working on a new course, I was looking for an example to store a Color in Protocol Buffers. At first this seemed like an easy task but it turned out to be an interesting example of optimization. Let's work through it. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="Storing Colors in Protocol Buffers" /> <meta property="twitter:title" content="Storing Colors in Protocol Buffers" /> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/Clement-Jean/clement-jean.github.io/master/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> </head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" class="site-avatar"><img src="https://raw.githubusercontent.com/Clement-Jean/clement-jean.github.io/master/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" /></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>Storing Colors in Protocol Buffers</h1> <div class="entry"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script> <p>While working on a new course, I was looking for an example to store a Color in Protocol Buffers. At first this seemed like an easy task but it turned out to be an interesting example of optimization. Let's work through it.</p> <h2 id="quick-requirements">Quick Requirements</h2> <p>In order to define what's the most optimal message definition that we come with, we need a way to calculate the serialized size of that message. Fortunately, doing so is pretty easy with Protocol Buffers.</p> <ul class="code-tab-container ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', 'ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b', 0)">Python</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', 'ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b', 1)">Java</a></li><li class=" code_switcher_kotlin"><a onclick="selectTab('code_switcher_kotlin', 'ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b', 2)">Kotlin</a></li><li class=" code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b', 3)">Go</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', 'ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b', 4)">C#</a></li><li class=" code_switcher_js"><a onclick="selectTab('code_switcher_js', 'ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b', 5)">JS</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', 'ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b', 6)">C++</a></li></ul><ul class="code-tab-switcher ef5c49f8-3bea-4fee-9f8a-9c2c5725d44b"><li class="code_switcher_container_parent active-tab code_switcher_python 452234ff-fe43-4b79-b035-d1fedb983194"><div class="code_switcher_code_action_container"><div id="code_copied_snackbar">Copied!</div><button class="code_switcher_copy_button" title="Copy" onclick="copyText('452234ff-fe43-4b79-b035-d1fedb983194')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_size</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java 7b7b0698-413d-4009-bf79-2410b41ea2a2"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('7b7b0698-413d-4009-bf79-2410b41ea2a2')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.Message</span><span class="o">;</span>

<span class="kt">int</span> <span class="nf">calculateSize</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_kotlin 71108f6a-9c38-4071-a7f8-257870a5405e"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('71108f6a-9c38-4071-a7f8-257870a5405e')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.google.protobuf.Message</span>

<span class="k">fun</span> <span class="nf">calculateSize</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">Message</span><span class="p">)</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">serializedSize</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_go 2e68331a-dccc-490a-bc6e-83cd2c0c3c20"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('2e68331a-dccc-490a-bc6e-83cd2c0c3c20')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"google.golang.org/protobuf/proto"</span>

<span class="k">func</span> <span class="n">calculateSize</span><span class="p">(</span><span class="n">message</span> <span class="n">proto</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">proto</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalln</span><span class="p">(</span><span class="s">"Failed to encode:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp 43decea3-fee5-4829-a519-bd5e31652cfe"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('43decea3-fee5-4829-a519-bd5e31652cfe')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Google.Protobuf</span>

<span class="kt">int</span> <span class="nf">CalculateSize</span><span class="p">(</span><span class="n">IMessage</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">message</span><span class="p">.</span><span class="nf">CalculateSize</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_js bf838319-d330-419e-9227-11a881505027"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('bf838319-d330-419e-9227-11a881505027')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">calculateSize</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">serializeBinary</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 3ab3f725-1989-4a6b-9c6b-82fed7478817"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('3ab3f725-1989-4a6b-9c6b-82fed7478817')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;google/protobuf/message.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">calculate_size</span><span class="p">(</span><span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Message</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">out</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">serialized</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serialized</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="a-primitive-implementation">A primitive implementation</h2> <p>When I see something like <code>#FFFFFFFF</code> or <code>#00000000</code> (RGBA), I directly think about two things:</p> <ul> <li>The human readable solution: <code>string</code></li> <li>The non human readable solution: <code>int32</code> or <code>int64</code></li> </ul> <p>Let's try with the string and work our way through, here is the proto file we are gonna use:</p> <div class="code_switcher_container_parent bddc0035-9bce-4c98-b716-99f0a60fc89d"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('bddc0035-9bce-4c98-b716-99f0a60fc89d')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">option</span> <span class="na">java_package</span> <span class="o">=</span> <span class="s">"com.example"</span><span class="p">;</span>
<span class="k">option</span> <span class="na">java_multiple_files</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"example.com/m"</span><span class="p">;</span>
<span class="k">option</span> <span class="na">csharp_namespace</span> <span class="o">=</span> <span class="s">"Example"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">Color</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>and here is the code that calculates the size for <code>Color</code> with value <code>#FFFFFFFF</code> (max color value):</p> <ul class="code-tab-container a0353855-d593-4fb4-bf4b-d3b463d8af06"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', 'a0353855-d593-4fb4-bf4b-d3b463d8af06', 0)">Python</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', 'a0353855-d593-4fb4-bf4b-d3b463d8af06', 1)">Java</a></li><li class=" code_switcher_kotlin"><a onclick="selectTab('code_switcher_kotlin', 'a0353855-d593-4fb4-bf4b-d3b463d8af06', 2)">Kotlin</a></li><li class=" code_switcher_go"><a onclick="selectTab('code_switcher_go', 'a0353855-d593-4fb4-bf4b-d3b463d8af06', 3)">Go</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', 'a0353855-d593-4fb4-bf4b-d3b463d8af06', 4)">C#</a></li><li class=" code_switcher_js"><a onclick="selectTab('code_switcher_js', 'a0353855-d593-4fb4-bf4b-d3b463d8af06', 5)">JS</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', 'a0353855-d593-4fb4-bf4b-d3b463d8af06', 6)">C++</a></li></ul><ul class="code-tab-switcher a0353855-d593-4fb4-bf4b-d3b463d8af06"><li class="code_switcher_container_parent active-tab code_switcher_python e0b7b498-ba8b-43c5-bdc2-63c5bb265051"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('e0b7b498-ba8b-43c5-bdc2-63c5bb265051')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">proto.color_pb2</span> <span class="k">as</span> <span class="n">pb</span>

<span class="k">print</span><span class="p">(</span><span class="n">calculate_size</span><span class="p">(</span><span class="n">pb</span><span class="p">.</span><span class="n">Color</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"FFFFFFFF"</span><span class="p">)))</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java 44119195-5d51-4631-bd67-001e3ee3fe23"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('44119195-5d51-4631-bd67-001e3ee3fe23')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.example.Color</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">calculateSize</span><span class="o">(</span><span class="nc">Color</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setValue</span><span class="o">(</span><span class="s">"FFFFFFFF"</span><span class="o">).</span><span class="na">build</span><span class="o">()));</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_kotlin eea8eb0a-16dc-461d-ba9a-182128fae2c8"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('eea8eb0a-16dc-461d-ba9a-182128fae2c8')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.example.color</span>

<span class="nf">println</span><span class="p">(</span><span class="nf">calculateSize</span><span class="p">(</span><span class="nf">color</span> <span class="p">{</span> <span class="n">value</span> <span class="p">=</span> <span class="s">"FFFFFFFF"</span> <span class="p">}))</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_go fa874ce9-769d-47a0-b567-29f3de8e219f"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('fa874ce9-769d-47a0-b567-29f3de8e219f')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">pb</span> <span class="s">"example.com/m"</span>

<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">calculateSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">Color</span><span class="p">{</span><span class="n">Value</span><span class="o">:</span> <span class="s">"FFFFFFFF"</span><span class="p">}))</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp 67928621-c354-457f-9341-5584419750c7"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('67928621-c354-457f-9341-5584419750c7')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Example</span><span class="p">;</span>

<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="nf">CalculateSize</span><span class="p">(</span><span class="k">new</span> <span class="n">Color</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="s">"FFFFFFFF"</span> <span class="p">}));</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_js 814dc29b-cbfd-4bdf-8f48-f2d7412767a9"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('814dc29b-cbfd-4bdf-8f48-f2d7412767a9')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span><span class="nx">Color</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./proto/color_pb</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">calculateSize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Color</span><span class="p">().</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">"</span><span class="s2">FFFFFFFF</span><span class="dl">"</span><span class="p">)));</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 70cfd17d-dcc4-43d9-a8c3-bb1ac010f72a"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('70cfd17d-dcc4-43d9-a8c3-bb1ac010f72a')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"color.pb.h"</span><span class="cp">
</span>
<span class="n">Color</span> <span class="n">color</span><span class="p">;</span>

<span class="n">color</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">"FFFFFFFF"</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">calculate_size</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</code></pre></div></div> </li></ul> <p>And that should give us a 10 bytes serialization, because this will be encoded as the following:</p> <p class="text-center h4"> <span style="color: blue">0a</span> <span style="color: red">08</span> <span style="color: green">46 46 46 46 46 46 46 46</span> </p> <p>where:</p> <p>🔵 blue: is the combinaison between field tag and field type in one byte (read more <a href="https://developers.google.com/protocol-buffers/docs/encoding#structure">here</a>). In our case our tag is 1 and the type is what's called <code>Length-delimited</code>.</p> <p>🔴 red: is the size of the <code>Length-delimited</code> field, here 8.</p> <p>🟢 green: is the <code>Length-delimited</code> field value. Here 46 is F (you can type <code>man ascii</code> and have a look at the Hexadecimal set).</p> <h2 id="lets-optimize-that">Let's optimize that</h2> <p>As mentioned earlier, the other way to solve that is to store the value in an integer. So let's check the decimal value of the biggest color that we can get, which is <code>FFFFFFFF</code>.</p> <ul class="code-tab-container aa3f6059-a56f-4f6e-8991-b21e9cb38d91"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'aa3f6059-a56f-4f6e-8991-b21e9cb38d91', 0)">Linux/Mac</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'aa3f6059-a56f-4f6e-8991-b21e9cb38d91', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher aa3f6059-a56f-4f6e-8991-b21e9cb38d91"><li class="code_switcher_container_parent active-tab code_switcher_shell d6373b58-2495-4b47-ac7d-0c532a8fd7ee"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('d6373b58-2495-4b47-ac7d-0c532a8fd7ee')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"ibase=16; FFFFFFFF"</span> | bc
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell 93a2f0f4-7226-4228-81a9-0faaa928c803"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('93a2f0f4-7226-4228-81a9-0faaa928c803')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>convert]::toint64<span class="o">(</span><span class="s2">"FFFFFFFF"</span>, 16<span class="o">)</span>
</code></pre></div></div> </li></ul> <p>and this gives us: <strong>4,294,967,295</strong>. Sounds like this gonna fit inside an <code>int32</code> or even an <code>uint32</code> if we wanted to make class instantiation safer (not letting user enter negative value). So we now have:</p> <div class="code_switcher_container_parent 1f2a6b52-a1ba-4674-a770-411ccf0348b6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Color</span> <span class="p">{</span>
  <span class="kt">uint32</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>and by using the same code for calculating the size we obtain: <strong>6 bytes</strong>.</p> <h2 id="a-step-further">A step further</h2> <p>Let's take a look at a table that I made for another post.</p> <div class="table-responsive"> <table class="table table-striped table-borderless"> <thead> <tr> <th scope="col" class="text-center">Threshold value</th> <th scope="col" class="text-center">Bytes size (without tag)</th> </tr> </thead> <tbody> <tr> <th scope="row" class="text-center">0</th> <td class="text-center">0</td> </tr> <tr> <th scope="row" class="text-center">1</th> <td class="text-center">1</td> </tr> <tr> <th scope="row" class="text-center">128</th> <td class="text-center">2</td> </tr> <tr> <th scope="row" class="text-center">16,384</th> <td class="text-center">3</td> </tr> <tr> <th scope="row" class="text-center">2,097,152</th> <td class="text-center">4</td> </tr> <tr> <th scope="row" class="text-center">268,435,456</th> <td class="text-center">5</td> </tr> </tbody> </table> </div> <p>This table presents the field value thresholds and the bytes size for serialization of <code>uint32</code>. Can you see the problem here ? <strong>4,294,967,295</strong> is simply bigger than <strong>268,435,456</strong> and what it means is that, our value of <code>FFFFFFFF</code> will be serialized to 5 bytes.</p> <p>Do we know another type that could help us serialize in less bytes? Sure we do! We know that <code>fixed32</code> is an unsigned integer and it will always be serialized to 4 bytes. So we if change to:</p> <div class="code_switcher_container_parent 37abd783-01c8-4fd6-8a07-9672d8fdf722"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Color</span> <span class="p">{</span>
  <span class="kt">fixed32</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>the value <code>FFFFFFFF</code> will be serialized into:</p> <p class="text-center h4"> <span style="color: blue">0d</span> <span style="color: green">ff ff ff ff</span> </p> <p>and we are done!</p> <h2 id="wait-a-minute-">Wait a minute ...</h2> <p>This seems to vary with our data/color distribution, isn't it ?</p> <div class="text-center"> <img src="/images/threshold_color.png" alt="Threshold color between uint32 and fixed32"> </div> <p>It varies. However you can see the number of colors that can be efficiently serialized with a <code>uint32</code> is pretty small. The dots here represent the threshold that I showed in the table presented in &quot;A step further&quot; and here we can see that the threshold at <strong>2,097,152</strong> or <code>001FFFFF</code> is where it becomes efficient to store with a <code>fixed32</code>.</p> <p>Let's calculate the percentage of colors that can be efficiently stored with an <code>uint32</code>.</p> <p class="text-center h4"> (<span style="color: blue">2097152</span> / <span style="color: red">4294967295</span>) * 100 ~= 0.05 </p> <p>where:</p> <p>🔵 blue: is the threshold at which it becomes more optimal to save with <code>fixed32</code>.</p> <p>🔴 red: biggest number that we can have (<code>FFFFFFFF</code>).</p> <p>So in conclusion only 0.05% of the possible numbers will be not optimally serialized. I think we can agree on the fact that is acceptable.</p> <h2 id="conclusion">Conclusion</h2> <p>Protocol Buffers are providing us with a lot of types for numbers, and choosing the right one is important for optimizing you payload or serialized data size. If you want to know more about how to choose between them, you might consider joining <a href="https://www.udemy.com/course/protocol-buffers/?referralCode=CB382B4ED9936D6C6193">my Udemy course</a> on Protocol Buffers.</p> <p>Hope you enjoyed this article, I will be glad to get some feedback on this. Especially if you find a more efficient way to serialize this data. Check the about page to find all the ways you can us for reaching to me.</p> </div> <div class="date"> Written on June 2, 2022 </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'clement-jean-github-io-1'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <!-- Google Analytics --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-111260962-1', 'auto'); ga('send', 'pageview', { 'page': '/storing_color_in_pb/', 'title': 'Storing Colors in Protocol Buffers' }); </script> <!-- End Google Analytics --> </body> </html>
