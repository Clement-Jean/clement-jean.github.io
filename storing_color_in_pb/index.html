<!DOCTYPE html> <html> <head> <title>Storing Colors in Protocol Buffers – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="While working on a new course, I was looking for an example to store a Color in Protocol Buffers. At first this seemed like an easy task but it turned out to be an interesting example of optimization. Let's work through it. " /> <meta property="og:description" content="While working on a new course, I was looking for an example to store a Color in Protocol Buffers. At first this seemed like an easy task but it turned out to be an interesting example of optimization. Let's work through it. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="Storing Colors in Protocol Buffers" /> <meta property="twitter:title" content="Storing Colors in Protocol Buffers" /> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>Storing Colors in Protocol Buffers</h1> <div class="entry"> <p>While working on a new course, I was looking for an example to store a Color in Protocol Buffers. At first this seemed like an easy task but it turned out to be an interesting example of optimization. Let's work through it.</p> <h2 id="quick-requirements">Quick Requirements</h2> <p>In order to define what's the most optimal message definition that we come with, we need a way to calculate the serialized size of that message. Fortunately, doing so is pretty easy with Protocol Buffers.</p> <ul class="code-tab-container 35ed326e-5711-47be-a113-34e3fff2f2bf"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', '35ed326e-5711-47be-a113-34e3fff2f2bf', 0)">Python</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '35ed326e-5711-47be-a113-34e3fff2f2bf', 1)">Java</a></li><li class=" code_switcher_kotlin"><a onclick="selectTab('code_switcher_kotlin', '35ed326e-5711-47be-a113-34e3fff2f2bf', 2)">Kotlin</a></li><li class=" code_switcher_go"><a onclick="selectTab('code_switcher_go', '35ed326e-5711-47be-a113-34e3fff2f2bf', 3)">Go</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '35ed326e-5711-47be-a113-34e3fff2f2bf', 4)">C#</a></li><li class=" code_switcher_js"><a onclick="selectTab('code_switcher_js', '35ed326e-5711-47be-a113-34e3fff2f2bf', 5)">JS</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '35ed326e-5711-47be-a113-34e3fff2f2bf', 6)">C++</a></li></ul><ul class="code-tab-switcher 35ed326e-5711-47be-a113-34e3fff2f2bf"><li class="code_switcher_container_parent active-tab code_switcher_python 7ffa8ef6-23a9-41eb-854f-a781e177d1fc"><div class="code_switcher_code_action_container"><div id="code_copied_snackbar">Copied!</div><button class="code_switcher_copy_button" title="Copy" onclick="copyText('7ffa8ef6-23a9-41eb-854f-a781e177d1fc')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">calculate_size</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">message</span><span class="p">.</span><span class="n">SerializeToString</span><span class="p">())</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java ed085b99-c1db-4538-8ad9-bed49ca9e37d"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('ed085b99-c1db-4538-8ad9-bed49ca9e37d')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.Message</span><span class="o">;</span>

<span class="kt">int</span> <span class="nf">calculateSize</span><span class="o">(</span><span class="nc">Message</span> <span class="n">message</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">message</span><span class="o">.</span><span class="na">getSerializedSize</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_kotlin e3c71b71-03f0-4c85-9b92-6abc6ac53173"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('e3c71b71-03f0-4c85-9b92-6abc6ac53173')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.google.protobuf.Message</span>

<span class="k">fun</span> <span class="nf">calculateSize</span><span class="p">(</span><span class="n">message</span><span class="p">:</span> <span class="nc">Message</span><span class="p">)</span> <span class="p">=</span> <span class="n">message</span><span class="p">.</span><span class="n">serializedSize</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_go ed9d3b28-5b66-426d-8f0c-3a0fda161cac"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('ed9d3b28-5b66-426d-8f0c-3a0fda161cac')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"google.golang.org/protobuf/proto"</span>

<span class="k">func</span> <span class="n">calculateSize</span><span class="p">(</span><span class="n">message</span> <span class="n">proto</span><span class="o">.</span><span class="n">Message</span><span class="p">)</span> <span class="kt">int</span> <span class="p">{</span>
  <span class="n">out</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">proto</span><span class="o">.</span><span class="n">Marshal</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatalln</span><span class="p">(</span><span class="s">"Failed to encode:"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp ebdb23d3-e0ef-401e-9409-1a98a1b3f4b4"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('ebdb23d3-e0ef-401e-9409-1a98a1b3f4b4')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Google.Protobuf</span>

<span class="kt">int</span> <span class="nf">CalculateSize</span><span class="p">(</span><span class="n">IMessage</span> <span class="n">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">message</span><span class="p">.</span><span class="nf">CalculateSize</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_js d6384eed-0da1-4a8f-a868-2b4caffbb2a7"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('d6384eed-0da1-4a8f-a868-2b4caffbb2a7')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">calculateSize</span><span class="p">(</span><span class="nx">message</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">message</span><span class="p">.</span><span class="nx">serializeBinary</span><span class="p">().</span><span class="nx">length</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 9266518f-a14d-4e8d-a8d1-874b43f3e773"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('9266518f-a14d-4e8d-a8d1-874b43f3e773')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;google/protobuf/message.h&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">calculate_size</span><span class="p">(</span><span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">Message</span> <span class="o">*</span><span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">out</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">serialized</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">SerializeToString</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">serialized</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="k">return</span> <span class="n">out</span><span class="p">.</span><span class="n">length</span><span class="p">();</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="a-primitive-implementation">A primitive implementation</h2> <p>When I see something like <code>#FFFFFFFF</code> or <code>#00000000</code> (RGBA), I directly think about two things:</p> <ul> <li>The human readable solution: <code>string</code></li> <li>The non human readable solution: <code>int32</code> or <code>int64</code></li> </ul> <p>Let's try with the string and work our way through, here is the proto file we are gonna use:</p> <div class="code_switcher_container_parent 390fe96f-1620-4eb8-b2f7-4b8e07eff7be"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('390fe96f-1620-4eb8-b2f7-4b8e07eff7be')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">option</span> <span class="na">java_package</span> <span class="o">=</span> <span class="s">"com.example"</span><span class="p">;</span>
<span class="k">option</span> <span class="na">java_multiple_files</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"example.com/m"</span><span class="p">;</span>
<span class="k">option</span> <span class="na">csharp_namespace</span> <span class="o">=</span> <span class="s">"Example"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">Color</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>and here is the code that calculates the size for <code>Color</code> with value <code>#FFFFFFFF</code> (max color value):</p> <ul class="code-tab-container a93ba0b9-f59f-4cbb-9848-208d61a370ca"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', 'a93ba0b9-f59f-4cbb-9848-208d61a370ca', 0)">Python</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', 'a93ba0b9-f59f-4cbb-9848-208d61a370ca', 1)">Java</a></li><li class=" code_switcher_kotlin"><a onclick="selectTab('code_switcher_kotlin', 'a93ba0b9-f59f-4cbb-9848-208d61a370ca', 2)">Kotlin</a></li><li class=" code_switcher_go"><a onclick="selectTab('code_switcher_go', 'a93ba0b9-f59f-4cbb-9848-208d61a370ca', 3)">Go</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', 'a93ba0b9-f59f-4cbb-9848-208d61a370ca', 4)">C#</a></li><li class=" code_switcher_js"><a onclick="selectTab('code_switcher_js', 'a93ba0b9-f59f-4cbb-9848-208d61a370ca', 5)">JS</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', 'a93ba0b9-f59f-4cbb-9848-208d61a370ca', 6)">C++</a></li></ul><ul class="code-tab-switcher a93ba0b9-f59f-4cbb-9848-208d61a370ca"><li class="code_switcher_container_parent active-tab code_switcher_python f86cf36a-1557-4f3e-8bb6-47ec1ece292c"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('f86cf36a-1557-4f3e-8bb6-47ec1ece292c')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">proto.color_pb2</span> <span class="k">as</span> <span class="n">pb</span>

<span class="k">print</span><span class="p">(</span><span class="n">calculate_size</span><span class="p">(</span><span class="n">pb</span><span class="p">.</span><span class="n">Color</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">"FFFFFFFF"</span><span class="p">)))</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java d7af1531-7747-4a6f-8491-7bff54cac390"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('d7af1531-7747-4a6f-8491-7bff54cac390')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.example.Color</span>

<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">calculateSize</span><span class="o">(</span><span class="nc">Color</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">setValue</span><span class="o">(</span><span class="s">"FFFFFFFF"</span><span class="o">).</span><span class="na">build</span><span class="o">()));</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_kotlin 98ce9a4e-dca4-4c1f-8094-fe7fbe2f892f"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('98ce9a4e-dca4-4c1f-8094-fe7fbe2f892f')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">com.example.color</span>

<span class="nf">println</span><span class="p">(</span><span class="nf">calculateSize</span><span class="p">(</span><span class="nf">color</span> <span class="p">{</span> <span class="n">value</span> <span class="p">=</span> <span class="s">"FFFFFFFF"</span> <span class="p">}))</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_go 3dca3de3-4374-47ba-87bd-20f07f6b8e10"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('3dca3de3-4374-47ba-87bd-20f07f6b8e10')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">pb</span> <span class="s">"example.com/m"</span>

<span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">calculateSize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">Color</span><span class="p">{</span><span class="n">Value</span><span class="o">:</span> <span class="s">"FFFFFFFF"</span><span class="p">}))</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp 4a9ba9b1-7423-42c8-9702-7967873830af"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('4a9ba9b1-7423-42c8-9702-7967873830af')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">Example</span><span class="p">;</span>

<span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="nf">CalculateSize</span><span class="p">(</span><span class="k">new</span> <span class="n">Color</span> <span class="p">{</span> <span class="n">Value</span> <span class="p">=</span> <span class="s">"FFFFFFFF"</span> <span class="p">}));</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_js cf8348f7-436f-4b77-9422-b2d03d53b593"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('cf8348f7-436f-4b77-9422-b2d03d53b593')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="p">{</span><span class="nx">Color</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">./proto/color_pb</span><span class="dl">'</span><span class="p">);</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">calculateSize</span><span class="p">(</span><span class="k">new</span> <span class="nx">Color</span><span class="p">().</span><span class="nx">setValue</span><span class="p">(</span><span class="dl">"</span><span class="s2">FFFFFFFF</span><span class="dl">"</span><span class="p">)));</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 78fcb7d9-94ce-43dc-89a7-33ed0228dbd3"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('78fcb7d9-94ce-43dc-89a7-33ed0228dbd3')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">"color.pb.h"</span><span class="cp">
</span>
<span class="n">Color</span> <span class="n">color</span><span class="p">;</span>

<span class="n">color</span><span class="p">.</span><span class="n">set_value</span><span class="p">(</span><span class="s">"FFFFFFFF"</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">calculate_size</span><span class="p">(</span><span class="n">color</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</code></pre></div></div> </li></ul> <p>And that should give us a 10 bytes serialization, because this will be encoded as the following:</p> <p class="text-center h4"> <span style="color: blue">0a</span> <span style="color: red">08</span> <span style="color: green">46 46 46 46 46 46 46 46</span> </p> <p>where:</p> <p>🔵 blue: is the combinaison between field tag and field type in one byte (read more <a href="https://developers.google.com/protocol-buffers/docs/encoding#structure">here</a>). In our case our tag is 1 and the type is what's called <code>Length-delimited</code>.</p> <p>🔴 red: is the size of the <code>Length-delimited</code> field, here 8.</p> <p>🟢 green: is the <code>Length-delimited</code> field value. Here 46 is F (you can type <code>man ascii</code> and have a look at the Hexadecimal set).</p> <h2 id="lets-optimize-that">Let's optimize that</h2> <p>As mentioned earlier, the other way to solve that is to store the value in an integer. So let's check the decimal value of the biggest color that we can get, which is <code>FFFFFFFF</code>.</p> <ul class="code-tab-container 113f0fef-d284-433b-a961-a19fa1fd4b12"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '113f0fef-d284-433b-a961-a19fa1fd4b12', 0)">Linux/Mac</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '113f0fef-d284-433b-a961-a19fa1fd4b12', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher 113f0fef-d284-433b-a961-a19fa1fd4b12"><li class="code_switcher_container_parent active-tab code_switcher_shell dd48e987-ed39-4412-a874-3385ac69e047"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('dd48e987-ed39-4412-a874-3385ac69e047')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"ibase=16; FFFFFFFF"</span> | bc
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell ec03928d-40e5-4482-a95e-85da1fb1f252"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('ec03928d-40e5-4482-a95e-85da1fb1f252')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>convert]::toint64<span class="o">(</span><span class="s2">"FFFFFFFF"</span>, 16<span class="o">)</span>
</code></pre></div></div> </li></ul> <p>and this gives us: <strong>4,294,967,295</strong>. Sounds like this gonna fit inside an <code>int32</code> or even an <code>uint32</code> if we wanted to make class instantiation safer (not letting user enter negative value). So we now have:</p> <div class="code_switcher_container_parent bc23c3ad-67dd-4f18-b204-76d7930e9622"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Color</span> <span class="p">{</span>
  <span class="kt">uint32</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>and by using the same code for calculating the size we obtain: <strong>6 bytes</strong>.</p> <h2 id="a-step-further">A step further</h2> <p>Let's take a look at a table that I made for another post.</p> <div class="table-responsive"> <table class="table table-striped table-borderless"> <thead> <tr> <th scope="col" class="text-center">Threshold value</th> <th scope="col" class="text-center">Bytes size (without tag)</th> </tr> </thead> <tbody> <tr> <th scope="row" class="text-center">0</th> <td class="text-center">0</td> </tr> <tr> <th scope="row" class="text-center">1</th> <td class="text-center">1</td> </tr> <tr> <th scope="row" class="text-center">128</th> <td class="text-center">2</td> </tr> <tr> <th scope="row" class="text-center">16,384</th> <td class="text-center">3</td> </tr> <tr> <th scope="row" class="text-center">2,097,152</th> <td class="text-center">4</td> </tr> <tr> <th scope="row" class="text-center">268,435,456</th> <td class="text-center">5</td> </tr> </tbody> </table> </div> <p>This table presents the field value thresholds and the bytes size for serialization of <code>uint32</code>. Can you see the problem here ? <strong>4,294,967,295</strong> is simply bigger than <strong>268,435,456</strong> and what it means is that, our value of <code>FFFFFFFF</code> will be serialized to 5 bytes.</p> <p>Do we know another type that could help us serialize in less bytes? Sure we do! We know that <code>fixed32</code> is an unsigned integer and it will always be serialized to 4 bytes. So we if change to:</p> <div class="code_switcher_container_parent cc3e14d0-f7f3-4646-a0e3-6a8fc3f49e55"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Color</span> <span class="p">{</span>
  <span class="kt">fixed32</span> <span class="na">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>the value <code>FFFFFFFF</code> will be serialized into:</p> <p class="text-center h4"> <span style="color: blue">0d</span> <span style="color: green">ff ff ff ff</span> </p> <p>and we are done!</p> <h2 id="wait-a-minute-">Wait a minute ...</h2> <p>This seems to vary with our data/color distribution, isn't it ?</p> <div class="text-center"> <img src="/images/threshold_color.png" alt="Threshold color between uint32 and fixed32"> </div> <p>It varies. However you can see the number of colors that can be efficiently serialized with a <code>uint32</code> is pretty small. The dots here represent the threshold that I showed in the table presented in &quot;A step further&quot; and here we can see that the threshold at <strong>2,097,152</strong> or <code>001FFFFF</code> is where it becomes efficient to store with a <code>fixed32</code>.</p> <p>Let's calculate the percentage of colors that can be efficiently stored with an <code>uint32</code>.</p> <p class="text-center h4"> (<span style="color: blue">2097152</span> / <span style="color: red">4294967295</span>) * 100 ~= 0.05 </p> <p>where:</p> <p>🔵 blue: is the threshold at which it becomes more optimal to save with <code>fixed32</code>.</p> <p>🔴 red: biggest number that we can have (<code>FFFFFFFF</code>).</p> <p>So in conclusion only 0.05% of the possible numbers will be not optimally serialized. I think we can agree on the fact that is acceptable.</p> <h2 id="conclusion">Conclusion</h2> <p>Protocol Buffers are providing us with a lot of types for numbers, and choosing the right one is important for optimizing you payload or serialized data size. If you want to know more about how to choose between them, you might consider joining <a href="https://www.udemy.com/course/protocol-buffers/?referralCode=CB382B4ED9936D6C6193">my Udemy course</a> on Protocol Buffers.</p> <p>Hope you enjoyed this article, I will be glad to get some feedback on this. Especially if you find a more efficient way to serialize this data. Check the about page to find all the ways you can us for reaching to me.</p> </div> <div class="date"> Written on June 2, 2022 </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'clement-jean-github-io-1'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <!-- Google Analytics --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-111260962-1', 'auto'); ga('send', 'pageview', { 'page': '/storing_color_in_pb/', 'title': 'Storing Colors in Protocol Buffers' }); </script> <!-- End Google Analytics --> </body> </html>