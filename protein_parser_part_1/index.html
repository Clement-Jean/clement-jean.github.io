<!DOCTYPE html> <html> <head> <title>Protein: Parser (Part 1) – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="In this article we are going to finally get to building the Parser. We are going to start parsing syntax, package and import statements, and we are going to see how to represent our serializable AST. Hope you are ready for this, it's gonna be fun! " /> <meta property="og:description" content="In this article we are going to finally get to building the Parser. We are going to start parsing syntax, package and import statements, and we are going to see how to represent our serializable AST. Hope you are ready for this, it's gonna be fun! " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="Protein: Parser (Part 1)" /> <meta property="twitter:title" content="Protein: Parser (Part 1)" /> <link rel="stylesheet" type="text/css" href="/css/org-style.css" /> <link rel="stylesheet" type="text/css" href="/css/org-code.css"/> <link rel="stylesheet" type="text/css" href="/css/org-normalize.css"/> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/css/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>Protein: Parser (Part 1)</h1> <div class="entry"> <p>In this article we are going to finally get to building the Parser. We are going to start parsing syntax, package and import statements, and we are going to see how to represent our serializable AST. Hope you are ready for this, it's gonna be fun!</p> <h2 id="boilerplate">Boilerplate</h2> <p>As always, we need to think a little bit before to actually write the features themselves. The first thing that we can do to get us started is to write the Parser interface.</p> <ul class="code-tab-container 6f77a8de-405a-4734-80b4-fb1a20b9b50e"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '6f77a8de-405a-4734-80b4-fb1a20b9b50e', 0)">parser/parser.go</a></li></ul><ul class="code-tab-switcher 6f77a8de-405a-4734-80b4-fb1a20b9b50e"><li class="code_switcher_container_parent active-tab code_switcher_go 53a5b54c-5d0a-4698-a4f1-37f2cfa5f433"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="c">// Parser is protein's parser</span>
<span class="k">type</span> <span class="n">Parser</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// Parse returns ???</span>
  <span class="n">Parse</span><span class="p">()</span> <span class="err">???</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>This doesn't seem like a fancy interface but we do have a problem. What is our parser returning when finished? Well, it should return an AST, right? But how do we represent this AST. It turns out, we have two good possibilities:</p> <ul> <li>We roll our own serializable AST where each object is a Protobuf Message.</li> <li>We use the descriptor.proto file which defines Messages for describing elements in a Protobuf file.</li> </ul> <p>Both have pros and cons. If we go with the first one we have more control over our serialization. It means that we can optimize some elements' serialized data. However, it also means that we are not compatible with the official way and that's not good. For the &quot;using the official serialization&quot;, I think you get the idea. We have the pros being the cons of the other implementation, and the cons being the pros of the other implementation.</p> <p>In the end, for the sake of compatibility, I will be sacrificing some performance. However, these performances are only saving a few bytes and having compatibility with programs serialized by protoc far overweights them.</p> <h3 id="depending-on-protobuf">Depending on Protobuf</h3> <p>To use the descriptor, we are going to depend on Protobuf's library. To do that we are going to add in our dependency:</p> <div class="code_switcher_container_parent 7de82a06-979f-4d10-bf7d-deae0b8a853f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go get google.golang.org/protobuf
</code></pre></div></div> </div> <p>This will let us access <code>descriptorpb</code> package, which contains the <code>FileDescriptorProto</code> struct. If you look at the definition of that struct, you will see the following comment:</p> <div class="code_switcher_container_parent b0ee2882-e5d1-4af9-859b-c568013c41dd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Describes a complete .proto file.</span>
<span class="k">type</span> <span class="n">FileDescriptorProto</span> <span class="k">struct</span>
</code></pre></div></div> </div> <p>That's exactly what we are trying to do.</p> <h3 id="back-to-interface">Back to interface</h3> <p>With that dependency on Protobuf, we can now finish our interface:</p> <ul class="code-tab-container 007f0235-718a-44f0-94d5-4008310c7677"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '007f0235-718a-44f0-94d5-4008310c7677', 0)">parser/parser.go</a></li></ul><ul class="code-tab-switcher 007f0235-718a-44f0-94d5-4008310c7677"><li class="code_switcher_container_parent active-tab code_switcher_go 67fd6f24-04a8-449e-a83a-c26053bedde9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="n">pb</span> <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>

<span class="c">// Parser is protein's parser</span>
<span class="k">type</span> <span class="n">Parser</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// Parse returns the representation of a file in Protobuf Descriptor</span>
  <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="implementation">Implementation</h2> <p>Let's now implement the interface. But by now you know the drill. We are going to create a minimal implementation so that our first test fails. So what we need is an <code>Impl</code> struct and we need to implement <code>Parser</code> by writing the <code>Parse</code> function.</p> <p>For now, the <code>Parse</code> function will simply return an empty <code>FileDescriptorProto</code>.</p> <ul class="code-tab-container 7ec5784f-2cdd-4122-a3ce-635fe3c10723"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '7ec5784f-2cdd-4122-a3ce-635fe3c10723', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 7ec5784f-2cdd-4122-a3ce-635fe3c10723"><li class="code_switcher_container_parent active-tab code_switcher_go cd080357-bf7f-49fd-8332-4335f04166df"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="n">pb</span> <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>
<span class="p">)</span>

<span class="c">// Impl is the implementation for the Parser interface.</span>
<span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span>
<span class="p">}</span>

<span class="c">// New creates a new instance of the Parser</span>
<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span><span class="p">)</span> <span class="n">Parser</span> <span class="p">{</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span><span class="n">l</span><span class="o">:</span> <span class="n">l</span><span class="p">}</span>
  <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// Parse populates a FileDescriptorProto</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>
  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h3 id="first-test">First test</h3> <p>As our first test we are going to create the test for a syntax statement. This test will take advantage of the fact that <code>Lexer</code> is an interface by creating a <code>FakeLexer</code>. This fake lexer will simply iterate over an array of tokens and return them one by one.</p> <ul class="code-tab-container 3b350eb6-4d3f-4393-80d9-eac26ca8e50e"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '3b350eb6-4d3f-4393-80d9-eac26ca8e50e', 0)">parser/parser_test.go</a></li></ul><ul class="code-tab-switcher 3b350eb6-4d3f-4393-80d9-eac26ca8e50e"><li class="code_switcher_container_parent active-tab code_switcher_go 8524f922-b2e4-4851-ab0d-4cf97daaae76"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">FakeLexer</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">i</span>      <span class="kt">int</span>
  <span class="n">tokens</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">FakeLexer</span><span class="p">)</span> <span class="n">NextToken</span><span class="p">()</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}}</span>
  <span class="p">}</span>

  <span class="n">token</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
  <span class="n">l</span><span class="o">.</span><span class="n">i</span><span class="o">++</span>
  <span class="k">return</span> <span class="n">token</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>This basically means that each time we are running a test in the parser, we are not going to run the lexer code. We are going to simply focus on our current features. So, if we encounter a bug, it means that it is in the parser, not anywhere else.</p> <p>With that, we can write our first test for <code>syntax = &quot;proto3&quot;;</code>.</p> <ul class="code-tab-container 4871aab5-42b6-47eb-bbda-40d4ba9fe536"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4871aab5-42b6-47eb-bbda-40d4ba9fe536', 0)">parser/parser_syntax_test.go</a></li></ul><ul class="code-tab-switcher 4871aab5-42b6-47eb-bbda-40d4ba9fe536"><li class="code_switcher_container_parent active-tab code_switcher_go 2cc82b29-d3e0-479e-8ecf-03575d6a8234"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParseSyntaxProto3</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"syntax"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenEqual</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"="</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">proto3</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"proto3"</span>

  <span class="k">if</span> <span class="n">syntax</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetSyntax</span><span class="p">();</span> <span class="n">syntax</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"syntax wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">syntax</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Obviously:</p> <div class="code_switcher_container_parent 7b5c5b99-2b6f-4d5e-9f4a-b9710c6d074d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParseSyntaxProto3 <span class="o">(</span>0.00s<span class="o">)</span>
    parser_syntax_test.go:22: syntax wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'proto3'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
FAIL
</code></pre></div></div> </div> <h3 id="parsing">Parsing</h3> <p>We should now improve the <code>Parse</code> function to consume the <code>Lexer</code>'s tokens and do things with that. Here is the pseudo code:</p> <div class="code_switcher_container_parent 060359f8-e5aa-4f20-8634-fe450b40422a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">currToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">EOF</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">currToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">Identifier</span> <span class="p">{</span>
    <span class="n">fn</span> <span class="o">:=</span> <span class="n">parseFuncs</span><span class="p">[</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">]</span> <span class="c">// find the function depending on keyword</span>
    <span class="n">fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">)</span> <span class="c">// populate the descriptor</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>You notice that we need a <code>currToken</code> representing the current token being parsed. We will also need the peek token for parsing syntax and other statements. This is because we are going to make sure each time that the peek token is correct, otherwise we will return an error. So <code>Impl</code> now has a <code>currToken</code> and <code>peekToken</code>:</p> <ul class="code-tab-container c4eeda8b-563c-49f0-9390-cdce21d47e29"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c4eeda8b-563c-49f0-9390-cdce21d47e29', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher c4eeda8b-563c-49f0-9390-cdce21d47e29"><li class="code_switcher_container_parent active-tab code_switcher_go f5c553c6-a206-4591-a9da-24ccfd68447a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span>
  <span class="n">curToken</span>  <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
  <span class="n">peekToken</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Now, we need to populate these tokens before being able to use them. The first time we need to initialize them is in the <code>New</code> function.</p> <ul class="code-tab-container 70a86838-feb4-4482-a002-daa4fe4f0f0b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '70a86838-feb4-4482-a002-daa4fe4f0f0b', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 70a86838-feb4-4482-a002-daa4fe4f0f0b"><li class="code_switcher_container_parent active-tab code_switcher_go a57f76bd-2752-478b-b0c8-c5505349b3b2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span><span class="p">)</span> <span class="n">Parser</span> <span class="p">{</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span><span class="n">l</span><span class="o">:</span> <span class="n">l</span><span class="p">}</span>
  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>But <code>nextToken</code> is not the <code>Lexer.NextToken</code>, this is a private function in <code>Parser</code>. This is a function that looks for the next non-space token.</p> <ul class="code-tab-container f0903050-2924-4500-8168-a2e6fa5ca105"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f0903050-2924-4500-8168-a2e6fa5ca105', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher f0903050-2924-4500-8168-a2e6fa5ca105"><li class="code_switcher_container_parent active-tab code_switcher_go 14fb8bf5-872e-4c00-ac71-8689f799e1db"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">nextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSpace</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">();</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSpace</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>With that we can start updating our <code>Parse</code> function.</p> <ul class="code-tab-container 53c39bf5-07ef-4492-b444-85a2db6a909d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '53c39bf5-07ef-4492-b444-85a2db6a909d', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 53c39bf5-07ef-4492-b444-85a2db6a909d"><li class="code_switcher_container_parent active-tab code_switcher_go 9bb12f4d-4643-4455-a35b-a4fa91219ed2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
      <span class="c">//Do something with token</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Finally, we are going to register all the parsing functions that we are gonna write in this and next articles. We are going to have a map mapping &quot;syntax&quot; to parseSyntax, ...</p> <ul class="code-tab-container 791dda4e-46ab-4786-a311-de4b9f6cae3c"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '791dda4e-46ab-4786-a311-de4b9f6cae3c', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 791dda4e-46ab-4786-a311-de4b9f6cae3c"><li class="code_switcher_container_parent active-tab code_switcher_go d0170ac1-e5ce-4f82-8e0d-24b6d5645bce"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>With this we can finalize the <code>Parse</code> function by looking at the relevant function for the <code>currToken.Literal</code>.</p> <ul class="code-tab-container ac4a84be-03a4-48a2-8736-f7072992a559"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ac4a84be-03a4-48a2-8736-f7072992a559', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher ac4a84be-03a4-48a2-8736-f7072992a559"><li class="code_switcher_container_parent active-tab code_switcher_go b2cb26c2-f4d7-44aa-8d62-1fda3458255c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
      <span class="n">fn</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">parseFuncs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span> <span class="c">// keyword not found</span>
        <span class="k">break</span>
      <span class="p">}</span>
      <span class="n">fn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h3 id="parsesyntax">parseSyntax()</h3> <p>Before actually parsing a syntax statement, we need two helper functions: <code>accept</code> and <code>acceptPeek</code>. <code>acceptPeek</code> will just call <code>accept</code> with the <code>peekToken.Type</code>. <code>accept</code> take a <code>TokenType</code> and checks if it exists in the following variadic arguments.</p> <ul class="code-tab-container 30a4b74d-42a7-4ca2-a5af-4a73022bc340"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '30a4b74d-42a7-4ca2-a5af-4a73022bc340', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 30a4b74d-42a7-4ca2-a5af-4a73022bc340"><li class="code_switcher_container_parent active-tab code_switcher_go 2dd1b045-4722-4db6-b7c0-8303d9da68d4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">accept</span><span class="p">(</span><span class="n">original</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">,</span> <span class="n">expected</span> <span class="o">...</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">slices</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// TODO: add error</span>
    <span class="k">return</span> <span class="no">false</span>
  <span class="p">}</span>

  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="k">return</span> <span class="no">true</span>
<span class="p">}</span>

<span class="c">// acceptPeek returns true and advance token</span>
<span class="c">// if tt contains the peekToken.Type</span>
<span class="c">// else it returns false</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">acceptPeek</span><span class="p">(</span><span class="n">tt</span> <span class="o">...</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">tt</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>And now we ready for our <code>parseSyntax</code> function. We are first going to check that we have an <code>=</code> after syntax. Then we check that we have a String, if it’s the case we are going to take the value inside the quotes. And finally, we are going to check that there is a semicolon at the end of the statement.</p> <ul class="code-tab-container b7c3f3d8-743f-4221-9d68-586cd936ec00"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b7c3f3d8-743f-4221-9d68-586cd936ec00', 0)">parser/syntax.go</a></li></ul><ul class="code-tab-switcher b7c3f3d8-743f-4221-9d68-586cd936ec00"><li class="code_switcher_container_parent active-tab code_switcher_go 1ba7fe40-ce70-4554-b3b8-420a7dc05081"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parseSyntax</span><span class="p">()</span> <span class="o">*</span><span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenEqual</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="n">s</span> <span class="o">:=</span> <span class="n">destringify</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>The <code>destringify</code> function looks like the following:</p> <ul class="code-tab-container 982bcb64-1ef4-4c0c-aa6d-8e1b97462adb"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '982bcb64-1ef4-4c0c-aa6d-8e1b97462adb', 0)">parser/utils.go</a></li></ul><ul class="code-tab-switcher 982bcb64-1ef4-4c0c-aa6d-8e1b97462adb"><li class="code_switcher_container_parent active-tab code_switcher_go d3a6717a-8520-4cf0-8f39-f0c7c6ea0461"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="s">"strings"</span>

<span class="k">func</span> <span class="n">destringify</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">strings</span><span class="o">.</span><span class="n">TrimFunc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="kt">rune</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\'</span><span class="err">'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'"'</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>As mentioned, it takes the values between the quotes.</p> <p>With our <code>parseSyntax</code> finished, we can rerun the test and:</p> <div class="code_switcher_container_parent d88bc72d-ccfb-4879-b7bf-64e5a60383c7"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  1.361s
</code></pre></div></div> </div> <h3 id="parseimport">parseImport()</h3> <p><code>parseImport</code> is really similar to <code>parseSyntax</code>. However, with imports, we get introduced to optional keywords. An import can be written in 3 ways:</p> <ul> <li><code>import &quot;my.proto&quot;;</code></li> <li><code>import public &quot;my.proto&quot;;</code></li> <li><code>import weak &quot;my.proto&quot;;</code></li> </ul> <p>Let's write the tests:</p> <ul class="code-tab-container ee8f3acb-6b67-475a-a1d9-0a75ac8b2c74"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ee8f3acb-6b67-475a-a1d9-0a75ac8b2c74', 0)">parser/parser_import_test.go</a></li></ul><ul class="code-tab-switcher ee8f3acb-6b67-475a-a1d9-0a75ac8b2c74"><li class="code_switcher_container_parent active-tab code_switcher_go 0ef11cdf-555f-4b7a-afa6-72eb5b8d6930"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParseImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParsePublicImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"public"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{</span><span class="m">0</span><span class="p">}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParseWeakImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"weak"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{</span><span class="m">0</span><span class="p">}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Obviously:</p> <div class="code_switcher_container_parent dd4279a0-e431-4bdc-ae61-594ddf55d38e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParseImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:25: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
<span class="nt">---</span> FAIL: TestParsePublicImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:52: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
<span class="nt">---</span> FAIL: TestParseWeakImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:79: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
FAIL
</code></pre></div></div> </div> <p>Even though the 2nd and 3rd one are rarely used, we still need to support them. To do so, we are going to need to create an enum called <code>DependencyType</code> which will have the variants: None, Public, and Weak. After that, we are going to check if we have an identifier and depending on the <code>Literal</code>, we are going to return the type.</p> <ul class="code-tab-container d1d4d84e-68d3-4acf-be8b-f789cca56ae1"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd1d4d84e-68d3-4acf-be8b-f789cca56ae1', 0)">parser/import.go</a></li></ul><ul class="code-tab-switcher d1d4d84e-68d3-4acf-be8b-f789cca56ae1"><li class="code_switcher_container_parent active-tab code_switcher_go 4281daea-c666-40fd-948b-57f3bd59d9fd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"fmt"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">DependencyType</span> <span class="kt">int</span>

<span class="k">const</span> <span class="p">(</span>
  <span class="n">None</span> <span class="n">DependencyType</span> <span class="o">=</span> <span class="no">iota</span>
  <span class="n">Public</span>
  <span class="n">Weak</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parseImport</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">DependencyType</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
  <span class="p">}</span>

  <span class="n">depType</span> <span class="o">:=</span> <span class="n">None</span>

  <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">"public"</span><span class="o">:</span>
      <span class="n">depType</span> <span class="o">=</span> <span class="n">Public</span>
    <span class="k">case</span> <span class="s">"weak"</span><span class="o">:</span>
      <span class="n">depType</span> <span class="o">=</span> <span class="n">Weak</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">)</span> <span class="p">{</span>
      <span class="c">// TODO: add error</span>
      <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">s</span> <span class="o">:=</span> <span class="n">destringify</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">depType</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>And the last thing we need to do is register that to the <code>parseFuncs</code>.</p> <ul class="code-tab-container 22ff73b6-98cf-4019-b871-e304c9623f8c"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '22ff73b6-98cf-4019-b871-e304c9623f8c', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 22ff73b6-98cf-4019-b871-e304c9623f8c"><li class="code_switcher_container_parent active-tab code_switcher_go ef8be32c-c108-4a55-9420-ad0ef86852a2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"import"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dep</span><span class="p">,</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseImport</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">))</span>
      <span class="n">d</span><span class="o">.</span><span class="n">Dependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
      <span class="k">switch</span> <span class="n">t</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">Public</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">Weak</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>We basically append the dependency and if we have a public or weak dependency we add its index into <code>PublicDependency</code> and <code>WeakDependency</code> respectively.</p> <p>We rerun our test:</p> <div class="code_switcher_container_parent 2e584cb9-0b92-41fb-8694-62bfaeeabc03"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  0.450s
</code></pre></div></div> </div> <h3 id="parsepackage">parsePackage()</h3> <p>Once again this function is pretty similar. The main difference is that we are going to look for identifiers and fully qualified names (identifiers separated by dots).</p> <p>Let's write some tests.</p> <ul class="code-tab-container b30de41c-d54d-41b4-a278-6fe4654fe784"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b30de41c-d54d-41b4-a278-6fe4654fe784', 0)">parser/parser_package_test.go</a></li></ul><ul class="code-tab-switcher b30de41c-d54d-41b4-a278-6fe4654fe784"><li class="code_switcher_container_parent active-tab code_switcher_go 92855ec7-5e63-4459-8847-b73b171b64cd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParsePackage</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"package"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"google"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"google"</span>

  <span class="k">if</span> <span class="n">pkg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPackage</span><span class="p">();</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"package wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParsePackageFullIdentifier</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"package"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"google"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenDot</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"."</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"protobuf"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"google.protobuf"</span>

  <span class="k">if</span> <span class="n">pkg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPackage</span><span class="p">();</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"package wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Let's fail our tests:</p> <div class="code_switcher_container_parent 9fdc832c-323f-4765-a707-d5b49ab1fb7b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParsePackage <span class="o">(</span>0.00s<span class="o">)</span>
    parser_package_test.go:21: package wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'google'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
<span class="nt">---</span> FAIL: TestParsePackageFullIdentifier <span class="o">(</span>0.00s<span class="o">)</span>
    parser_package_test.go:39: package wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'google.protobuf'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
FAIL
</code></pre></div></div> </div> <p>And now we can implement the <code>parsePackage</code> function. We are going to check that we have at least one identifier, and then if we have a dot we are going to make sure that we have another identifier after. Finally, we will be looking for the semicolon.</p> <ul class="code-tab-container 90ca0d1f-614b-47f2-a420-e6e1f3030148"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '90ca0d1f-614b-47f2-a420-e6e1f3030148', 0)">parser/package.go</a></li></ul><ul class="code-tab-switcher 90ca0d1f-614b-47f2-a420-e6e1f3030148"><li class="code_switcher_container_parent active-tab code_switcher_go c426748e-7a22-4787-9ffe-bcafa03b4f7c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"strings"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parsePackage</span><span class="p">()</span> <span class="o">*</span><span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">var</span> <span class="n">parts</span> <span class="p">[]</span><span class="kt">string</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenDot</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">nil</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">s</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="s">"."</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>The last thing to do is to register this function in our <code>parseFuncs</code>.</p> <ul class="code-tab-container 08a433db-2d93-412a-a025-07e0b08779a8"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '08a433db-2d93-412a-a025-07e0b08779a8', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 08a433db-2d93-412a-a025-07e0b08779a8"><li class="code_switcher_container_parent active-tab code_switcher_go 75931e8e-b640-40bf-82db-ee4cc2db6278"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"package"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Package</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parsePackage</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"import"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dep</span><span class="p">,</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseImport</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">))</span>
      <span class="n">d</span><span class="o">.</span><span class="n">Dependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
      <span class="k">switch</span> <span class="n">t</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">Public</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">Weak</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>and we rerun our tests.</p> <div class="code_switcher_container_parent 956d46b1-3bae-444b-bd98-207a3de36359"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  0.847s
</code></pre></div></div> </div> <h1 id="conclusion">Conclusion</h1> <p>In this article, we created our first three parsing functions. We parsed syntax, package and imports. We are now ready to go more complicated statements.</p> <p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p> <div class="container"> <div class="row"> <div class="col text-center"> <a href="/protein_lexer_part_3" class="btn btn-danger text-center">Previous Article</a> </div> <!-- <div class="col text-center"> <a href="/protein_lexer_part_1" class="btn btn-danger text-center">Next Article</a> </div> --> </div> </div> </div> <div class="date"> Written on March 9, 2023 </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <script type="text/javascript" src="/js/codetabs.js"></script> </body> </html>