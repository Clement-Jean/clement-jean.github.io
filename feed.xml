<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.3">Jekyll</generator><link href="https://clement-jean.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://clement-jean.github.io/" rel="alternate" type="text/html" /><updated>2024-07-09T18:12:49+08:00</updated><id>https://clement-jean.github.io/feed.xml</id><title type="html">Clément Jean</title><subtitle>Eternal learner and challenges lover</subtitle><author><name>Clément Jean</name></author><entry><title type="html">Binary Search Tree with SIMD</title><link href="https://clement-jean.github.io/simd_binary_search_tree/" rel="alternate" type="text/html" title="Binary Search Tree with SIMD" /><published>2024-07-09T00:00:00+08:00</published><updated>2024-07-09T00:00:00+08:00</updated><id>https://clement-jean.github.io/simd_binary_search_tree</id><content type="html" xml:base="https://clement-jean.github.io/simd_binary_search_tree/"><![CDATA[<p>Recently, I've been looking at cache friendly algorithm for common data structures like trees, tries, ... One such algorithm kept coming up to mind and that's why I decided to implement it in Go. You can find the paper describing the algorithm <a href="https://dl.acm.org/doi/10.1145/1807167.1807206">here</a>.</p>
<h2 id="the-intuition">The Intuition</h2>
<p>Let's assume that we have a binary tree:</p>
<div class="code_switcher_container_parent c3f4b3cd-808d-444b-b582-88ba4ecef6df"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>	  ┌────── 41 ──────┐
      │                │
   ┌──23──┐       ┌───61───┐
   │      │       │        │
┌─11─┐  ┌─31─┐  ┌─47─┐  ┌─73─┐
│    │  │    │  │    │  │    │
2   19  29  37  43  53  67  79
</code></pre></div>
<p>A normal way of representing a binary tree into an array is by representing it like so:</p>
<div class="code_switcher_container_parent eda60361-9e4f-4609-9ae3-9e407920d2cd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>┌────┬────┬────┬────┬────┬────┬────┬───┬────┬────┬────┬────┬────┬────┬────┐
│ 41 │ 23 │ 61 │ 11 │ 31 │ 47 │ 73 │ 2 │ 19 │ 29 │ 37 │ 47 │ 53 │ 67 │ 79 │
└────┴────┴────┴────┴────┴────┴────┴───┴────┴────┴────┴────┴────┴────┴────┘
</code></pre></div>
<p>or, in other words, we have the level nodes layed out consecutively.</p>
<p>This approach however, is not that cache friendly. While the locality of the data for a level is good, in a binary search, we actually care more about the parent-children locality. This is because, by keeping the children next to the parent, we wouldn't need to jump far ahead in the array.</p>
<p>The paper mentionned at the beginning, propose to have a binary tree layed out like the following:</p>
<div class="code_switcher_container_parent f7517a96-44d7-4182-b783-10c917399c47"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>┌────┬────┬────┬────┬───┬────┬────┬────┬────┬────┬────┬────┬────┬────┬────┐
│ 41 │ 23 │ 61 │ 11 │ 2 │ 19 │ 31 │ 29 │ 37 │ 47 │ 43 │ 53 │ 73 │ 67 │ 79 │
└────┴────┴────┴────┴───┴────┴────┴────┴────┴────┴────┴────┴────┴────┴────┘
</code></pre></div>
<p>And if you take time to understand how this maps back to the binary tree, you will notice that we are storing parent-children triangles. With this, we can now apply SIMD operations on both the parent and the children in order to either dtermine if the data we are looking for is in the triangle, or if we should continue our search.</p>
<p>The next important thing to understand is how we do the search of elements.</p>
<p>Let's take an example to make things clearer. Let's say that we are looking for the number 62. We will start by loading 41, 23, 61 into a vector.</p>
<div class="code_switcher_container_parent 01a7be38-f617-40e7-bc98-c6762114d81f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>┌────┬────┬────┐
│ 41 │ 23 │ 61 │
└────┴────┴────┘
</code></pre></div>
<p>Then, we will compare (smaller than) each number with the element we are looking for:</p>
<div class="code_switcher_container_parent 1dc23680-4eae-48b1-ad31-b75a87638f6a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>┌────┬────┬────┐
│ 41 │ 23 │ 61 │
└────┴────┴────┘
        &lt;
┌────┬────┬────┐
│ 62 │ 62 │ 62 │
└────┴────┴────┘
        =
┌────┬────┬────┐
│  1 │  1 │  1 │
└────┴────┴────┘
</code></pre></div>
<p>and with the mask we get, we can map to an index in the following subtrees. Here is the full mapping:</p>
<div class="code_switcher_container_parent 29b86ddb-208d-43f5-869b-485397bec7a5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code> 0 0 0 -&gt; 0
 0 1 0 -&gt; 1
 1 1 0 -&gt; 2
 1 1 1 -&gt; 3
</code></pre></div>
<p>It's actually a popcount.</p>
<p>So, with our <code>[1, 1, 1]</code>, we should access the 4th child (mapping is 0 indexed).</p>
<p>If you look at the binary tree, this means that we need to go to the number 73 and we now have the vector:</p>
<div class="code_switcher_container_parent 9792714a-02fc-4ce6-8d40-fe4a2b0887e3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>┌────┬────┬────┐
│ 73 │ 67 │ 79 │
└────┴────┴────┘
</code></pre></div>
<p>Now, we can obviously repeat the process.</p>
<p>On top of the lookup for index, we also need to be able to check the equality of the search vector and the curr loaded vector. This is as simple as:</p>
<div class="code_switcher_container_parent 8e0b52a3-c78c-4e30-87cb-40d8f22f45d8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>┌────┬────┬────┐
│ 41 │ 23 │ 61 │
└────┴────┴────┘
       ==
┌────┬────┬────┐
│ 62 │ 62 │ 62 │
└────┴────┴────┘
        =
┌────┬────┬────┐
│  0 │  0 │  0 │
└────┴────┴────┘
</code></pre></div>
<p>If we found a 1, it would mean that the element is in the tree. Otherwise, we keep running as long as we are within the boundaries of the array.</p>
<p>Hopefully, this all makes sense. Let us move to the code.</p>
<h2 id="the-code">The Code</h2>
<p>As <a href="https://github.com/golang/go/issues/67520">my proposal for adding SIMD intrinsics</a> is still not evaluated/accepted, we will need to write Go assembly (ARM64) to make use of SIMD instructions. I'll try to be as clear as possible on what each instruction is doing but you should know at least basics of assembly.</p>
<p>Let's start by defining the function definition in our <code>main.go</code>:</p>
<div class="code_switcher_container_parent d66fbb15-cce8-4235-91bb-bad87d3011a7"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">func</span> <span class="n">binarySearch</span><span class="p">(</span><span class="n">arr</span> <span class="p">[]</span><span class="kt">uint32</span><span class="p">,</span> <span class="n">n</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">bool</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>You can see that we are working with uint32s. This is because on ARM64 Neon, we only have 128 bits, and as we need to load at least 3 elements per triangle, uint32 is our best choice.</p>
<p>Next, we will jump to our <code>main.s</code> file and start defining our function:</p>
<div class="code_switcher_container_parent 44bb8cfa-8bf6-4841-bec4-57fb3d067bf6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code class="language-asm">>#include &quot;textflag.h&quot;

//func binarySearch(arr []int, n int) bool
TEXT ·binarySearch(SB),NOSPLIT,$0-33
	//...
</code></pre></div>
<p>The most important thing here is the <code>$0-33</code> part. We are saying that we do not have local variables (0) and that our arguments/return value take 33 bytes (24 for the slice, 8 for the int, and 1 for the bool).</p>
<p>Next, as part of my function, I generally like to define some names for the register. It helps me remember what each register is supposed to contain. This looks like this:</p>
<div class="code_switcher_container_parent e7793726-93c2-4daa-b6f8-9700bd68dfdc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code class="language-asm">>TEXT ·binarySearch(SB),NOSPLIT,$0-33
#define data R0
#define dataLen R1
#define toFind R2
#define curr R3
#define tmp R4
#define child_idx R5
#define nb_subtree R6
#define level R7
#define searchKey V0
#define mask V1
#define idx V2
#define one V3
#define equalMask V4
</code></pre></div>
<p>With that, we can initialize the registers and check the base cases:</p>
<div class="code_switcher_container_parent c5babe9b-3d78-4e2d-8f8d-861bae6b492e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code class="language-asm">>TEXT ·binarySearch(SB),NOSPLIT,$0-33
//...

    // initialize registers
	MOVD arr+0(FP), data
	MOVD arr_len+8(FP), dataLen
	MOVD n+24(FP), toFind
	MOVD $0, curr
	MOVD $1, level
	MOVD $0, nb_subtree
	VDUP level, one.S4

    // if array len is 0 return false
	CMP $0, dataLen
	BEQ not_found

    // if array len &gt; 1 start the work
	// otherwise check if the first element is equal
	//  to the one we are looking for
	CMP $1, dataLen
	BGT load
	MOVD (data), tmp
	CMP tmp, toFind
	BEQ found
	B not_found

	//...

not_found:
	MOVD $0, R19 // false
	MOVD R19, ret+32(FP)
	RET

found:
	MOVD $1, R19 // true
	MOVD R19, ret+32(FP)
	RET
</code></pre></div>
<p>Now, we can start the real work. We will have a simple loop which we load 4 elements at the <code>curr</code> position in <code>data</code>:</p>
<div class="code_switcher_container_parent 49dc8da4-0ba7-4c60-a9c9-f26a8644b4ec"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code class="language-asm">>TEXT ·binarySearch(SB),NOSPLIT,$0-33
//...

load:
	VDUP toFind, searchKey.S4

check:
	CMP dataLen, curr
	BGE not_found

loop:
	MOVD $4, R19
	MUL R19, curr
	ADD curr, data, R19
	VLD1 (R19), [mask.S4]

	//TODO update curr

	B check
</code></pre></div>
<p>Notice that we are multiplying <code>curr</code> by 4. This is because we are working with uint32s (4 bytes) so our index (<code>curr</code>) need to be moved by <code>curr * 4</code> bytes.</p>
<p>Then, inside the loop, we will check for equality between the four loaded elements and the search vector:</p>
<div class="code_switcher_container_parent 22f84cc6-7d82-43a9-bb23-5f6578be9a04"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code class="language-asm">>TEXT ·binarySearch(SB),NOSPLIT,$0-33
//...

loop:
	//...

	VCMEQ mask.S4, searchKey.S4, equalMask.S4
	WORD $0x6eb0a893 //umaxv.4s s19, v4
	FMOVS F19, R19
	CMP $4294967295, R19
	BEQ found

	//...
</code></pre></div>
<p>You can notice that if the maximum value inside <code>equalMask</code> is <code>math.MaxUint32</code> (4294967295), it means that we found the element and thus we can return.</p>
<p>After that, we fall into the binary search algorithm. We will first start by looking for the index:</p>
<div class="code_switcher_container_parent 9786383a-ae24-460c-8be1-f58a2e40a002"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code class="language-asm">>TEXT ·binarySearch(SB),NOSPLIT,$0-33
//...

loop:
	//...

	WORD $0x6ea13401 //cmhi.4s v1, v0, v1
	MOVD $0, R19
	VMOV R19, mask.S[3]
	VAND mask.B16, one.B16, idx.B16
	WORD $0x6eb0384f //uaddlv.4s d15, v2
	FMOVD F15, child_idx

	//...
</code></pre></div>
<p>The <code>cmhi</code> checks whether the data we are looking for is bigger that the data we loaded. Then, we bitwise AND the loaded vector with ones and finally, we do a basic popcount to determine the <code>child_idx</code>.</p>
<p>Finally, we need to update the <code>curr</code>, <code>level</code>, and the <code>nb_subtree</code>. As mentionned, the former is telling us from where to read the data in the array. The two last ones actually help us calculate the <code>curr</code> by running the following formula: <code>curr = nb_subtree * 3 + (3 * (child_idx + 1))</code>.</p>
<div class="code_switcher_container_parent c0c58d8a-df6b-41a8-a257-251a8ad3c325"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code class="language-asm">>TEXT ·binarySearch(SB),NOSPLIT,$0-33
//...

loop:
	//...

	//curr = nb_subtree * 3 + (3 * (child_idx + 1))
	MOVD child_idx, tmp
	ADD $1, tmp
	MOVD $3, R19
	MUL R19, tmp
	MOVD tmp, curr
	MUL R19, nb_subtree, R19
	ADD R19, curr

	//nb_subtree = level &lt;&lt; 2
	LSL $2, level, nb_subtree

	//level++
	ADD $1, level

	//...
</code></pre></div>
<p>And that actually is all for the binary search algorithm.</p>
<h2 id="a-demo">A Demo</h2>
<p>We can now go back to our <code>main.go</code> and try it.</p>
<div class="code_switcher_container_parent 270e2ca7-71a4-4baf-8d2a-35f8c9ceff92"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">binarySearch</span><span class="p">(</span><span class="n">arr</span> <span class="p">[]</span><span class="kt">uint32</span><span class="p">,</span> <span class="n">n</span> <span class="kt">uint32</span><span class="p">)</span> <span class="kt">bool</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">arr</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">uint32</span><span class="p">{</span><span class="m">41</span><span class="p">,</span> <span class="m">23</span><span class="p">,</span> <span class="m">61</span><span class="p">,</span> <span class="m">11</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">19</span><span class="p">,</span> <span class="m">31</span><span class="p">,</span> <span class="m">29</span><span class="p">,</span> <span class="m">37</span><span class="p">,</span> <span class="m">47</span><span class="p">,</span> <span class="m">43</span><span class="p">,</span> <span class="m">53</span><span class="p">,</span> <span class="m">73</span><span class="p">,</span> <span class="m">67</span><span class="p">,</span> <span class="m">79</span><span class="p">}</span>

  <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">binarySearch</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="m">19</span><span class="p">))</span>
  <span class="n">fmt</span><span class="o">.</span><span class="n">Printf</span><span class="p">(</span><span class="s">"%v</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">binarySearch</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="m">100</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>and if we run, we should have:</p>
<div class="code_switcher_container_parent 01037a14-5c76-4f35-805f-118a4b8f08e8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go run <span class="nb">.</span>
<span class="nb">true
false</span>
</code></pre></div></div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>In this article we saw a cache friendly version of the binary search using SIMD. While, we focused on the algorithm itself, I worked on this as part of a data structure. It is an AVL Tree that can be frozen at any point, and once frozen, it will let you do the binary search described in this article.</p>
<p>If you would like to have more details on the data structure implemented, or if you have feedback on this article, let me know in the comments section!</p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="SIMD" /><summary type="html"><![CDATA[Recently, I've been looking at cache friendly algorithm for common data structures like trees, tries, ... One such algorithm kept coming up to mind and that's why I decided to implement it in Go. You can find the paper describing the algorithm here.]]></summary></entry><entry><title type="html">Pagination in gRPC</title><link href="https://clement-jean.github.io/pagination_in_grpc/" rel="alternate" type="text/html" title="Pagination in gRPC" /><published>2023-08-24T00:00:00+08:00</published><updated>2023-08-24T00:00:00+08:00</updated><id>https://clement-jean.github.io/pagination_in_grpc</id><content type="html" xml:base="https://clement-jean.github.io/pagination_in_grpc/"><![CDATA[<p>Looking into optimizing one of my APIs, I recently stumbled upon the following resource: <a href="https://cloud.google.com/apis/design/design_patterns">Common design patterns</a>. This contains a lot of insights on how to design proto files in order to make gRPC APIs more idiomatic or more efficient. Within this document, I found the pagination part interesting and decided to write an article on how to implement it.</p>
<h2 id="a-disclaimer">A disclaimer</h2>
<p>In this article I assume that you already know how to create a simple server in gRPC. <strong>I will not show all the boilerplate, you can check it in <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-08-24-pagination_in_grpc">here</a></strong>.</p>
<p>Finally, this article contains data from <a href="https://subscription.packtpub.com/search">Packt</a>. They do not sponsor this article in any way. I'm not getting any money promoting these books (except mine), I simply needed some interesting data for this article.</p>
<h2 id="an-explanation">An explanation</h2>
<p>Before starting the implementation, let's first understand what we are implementing.</p>
<h3 id="what">What</h3>
<p>Pagination is a mechanism which allows the consumer of the API to get a subset of the available resources. This is done in order to limit the payload size returned by the API and thus make the API response faster.</p>
<p>This is generally implemented with the combination of <code>page_size</code> and <code>page_token</code> fields. The former tells how big is the subset we want, and the latter act as an index from which we are going to get the next subset.</p>
<p>Let's see an example of such a pagination. We have the following data:</p>
<div class="code_switcher_container_parent e028789e-85f5-4aeb-82ad-7fb85e53ce81"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"books"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gRPC Go for Professionals"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"In recent years, the popularity of microservice architecture has surged, bringing forth a new set of requirements."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Clément Jean"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-07-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">260</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781837638840"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Full-Stack Web Development with Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Go is a modern programming language with capabilities to enable high-performance app development."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Nanik Tolaram"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Nick Glynn"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-02-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">302</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781803234199"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Domain-Driven Design with Golang"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Domain-driven design (DDD) is one of the most sought-after skills in the industry."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Matthew Boyle"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-12-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">204</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804613450"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Building Modern CLI Applications in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Although graphical user interfaces (GUIs) are intuitive and user-friendly, nothing beats a command-line interface"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Marian Montagnino"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-03-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">406</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804611654"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Functional Programming in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"While Go is a multi-paradigm language that gives you the option to choose whichever paradigm works best"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Dylan Meeus"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-03-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">248</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781801811163"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Event-Driven Architecture in Golang"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Event-driven architecture in Golang is an approach used to develop applications that shares state changes asynchronously, internally, and externally using messages."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Michael Stack"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-11-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">384</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781803238012"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Test-Driven Development in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Experienced developers understand the importance of designing a comprehensive testing strategy to ensure efficient shipping and maintaining services in production."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Adelina Simion"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-04-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">342</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781803247878"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mastering Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mastering Go is the essential guide to putting Go to work on real production systems."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Mihalis Tsoukalos"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-08-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">682</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781801079310"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Network Automation with Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Go’s built-in first-class concurrency mechanisms make it an ideal choice for long-lived low-bandwidth I/O operations, which are typical requirements of network automation and network operations applications."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Nicolas Leiva"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-01-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">442</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781800560925"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microservices with Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This book covers the key benefits and common issues of microservices, helping you understand the problems microservice architecture helps to solve, the issues it usually introduces, and the ways to tackle them."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Alexander Shuiskov"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-11-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">328</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804617007"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Effective Concurrency in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The Go language has been gaining momentum due to its treatment of concurrency as a core language feature, making concurrent programming more accessible than ever."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Burak Serdar"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-04-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">212</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804619070"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
</div>
<p>As expected, if we start by requesting subset of size 2, we will get the first two books (<code>gRPC Go for Professionals</code> and <code>Full-Stack Web Development with Go</code>). On top of that result, a page token will be returned to us. If we now use this token and request a subset of size 2 we will get the 2 following books (<code>Domain-Driven Design with Golang</code> and <code>Building Modern CLI Applications in Go</code>).</p>
<p>This is pretty much it. It is simple to grasp and also simple to implement.</p>
<h2 id="the-setup">The setup</h2>
<p>In this article:</p>
<ul>
<li>I will be using Postgres to store our books' data. You can find the initialization script <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-08-24-pagination_in_grpc/db">here</a></li>
<li>I will run Postgres and the gRPC with Docker Compose. You can find the YAML file <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-08-24-pagination_in_grpc/docker-compose.yml">here</a></li>
</ul>
<h2 id="protobuf">Protobuf</h2>
<p>If you check the <a href="https://cloud.google.com/apis/design/design_patterns#list_pagination">List Pagination</a> section, you will see that we have the following protobuf schema:</p>
<div class="code_switcher_container_parent 6e20e04a-dd36-4b03-83df-d3ee1f7f11f1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">rpc</span> <span class="n">ListBooks</span><span class="p">(</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">ListBooksResponse</span><span class="p">);</span>

<span class="kd">message</span> <span class="nc">ListBooksRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">parent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">page_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">page_token</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">ListBooksResponse</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="n">Book</span> <span class="na">books</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">next_page_token</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This code is mostly correct but we are going to remove the <code>parent</code> field. If you are interested in knowing what this is used for, check the <a href="https://cloud.google.com/apis/design/design_patterns#list_sub-collections">List Sub-Collections</a> section.</p>
<p>So we now have:</p>
<div class="code_switcher_container_parent 3cb0ff4d-27c3-4d96-a2fd-622be750e0ec"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">ListBooksRequest</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">page_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">page_token</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">ListBooksResponse</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="n">Book</span> <span class="na">books</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">next_page_token</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">service</span> <span class="n">BookStoreService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">ListBooks</span><span class="p">(</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">ListBooksResponse</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>The last thing that we need to do is defining the <code>Book</code> message:</p>
<div class="code_switcher_container_parent 0b62abd9-6603-424f-a702-eeb2b9808fed"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"google/protobuf/timestamp.proto"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">Book</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">description</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="kt">string</span> <span class="na">authors</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="n">google.protobuf.Timestamp</span> <span class="na">published</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">uint32</span> <span class="na">pages</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">isbn</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>There is nothing fancy here. We simply laid out all the information needed to represent our books.</p>
<h2 id="listbooks">ListBooks</h2>
<p>Let's get started with an empty implementation for <code>ListBooks</code>:</p>
<div class="code_switcher_container_parent 500bed46-f070-4301-916d-fe100f5cd1d9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span> <span class="n">ListBooks</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>The first step in every endpoint implementation is to validate arguments. In our case we will validate the <code>page_size</code>. We mostly need to check that the <code>page_size</code> is not too big because it defeats the purpose of pagination, and if no <code>page_size</code> is provided we are going to set it to a default value.</p>
<div class="code_switcher_container_parent 3d3e63b7-b6ec-4cb8-9f87-5f6a971a2a66"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="p">(</span>
  <span class="n">defaultPageSize</span> <span class="o">=</span> <span class="m">10</span>
  <span class="n">maxPageSize</span>     <span class="o">=</span> <span class="m">30</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">validatePageSize</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span> <span class="o">&gt;</span> <span class="n">maxPageSize</span> <span class="p">{</span>
    <span class="n">msg</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span>
      <span class="s">"expected page size between 0 and %d, got %d"</span><span class="p">,</span>
      <span class="n">maxPageSize</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span> <span class="c">// no page_size provided</span>
    <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span> <span class="o">=</span> <span class="n">defaultPageSize</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This means that we can now do the following in <code>ListBooks</code>:</p>
<div class="code_switcher_container_parent d69d057e-4015-4a10-84bf-a02b3c3afb49"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">validatePageSize</span><span class="p">(</span><span class="n">req</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">codes</span><span class="o">.</span><span class="n">InvalidArgument</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Next, we need to validate <code>page_token</code>. In this implementation, I decided to use <a href="https://github.com/ulid/spec">ULIDs</a>. This is because they are short ids and they are lexicographically sortable. The sortability part is interesting because we will sort the books by their IDs which are ULIDs.</p>
<p>Fortunately for us oklog provides an <a href="https://github.com/oklog/ulid">ULID implementation</a> for us to verify if a ULID is valid or not. In <code>ListBooks</code>, we can simply do:</p>
<div class="code_switcher_container_parent 5073662d-03f6-4a91-917c-bb437cae9a78"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ulid</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">);</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">msg</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"expected valid ULID, got error %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">codes</span><span class="o">.</span><span class="n">InvalidArgument</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Notice that the <code>page_token</code> is optional (<code>len(req.PageToken) != 0</code>). When we do not provide one we will start from the beginning of the dataset.</p>
<p>Then, we need to generate the SQL query in order to get the subsets. We need to create the following SQL:</p>
<div class="code_switcher_container_parent 866cecd6-577b-4d90-ad15-5638690db307"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">book</span>
<span class="k">WHERE</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="n">page_token</span>
<span class="k">LIMIT</span> <span class="n">page_size</span>
<span class="k">ORDER</span> <span class="n">id</span> <span class="k">ASC</span>
</code></pre></div></div>
</div>
<p>Obviously, because the page_token is optional, the where clause is optional too.</p>
<p>Using <a href="https://gorm.io/">GORM</a>, we can easily create the request by writing the following:</p>
<div class="code_switcher_container_parent 0bc97f5c-7ef1-44d8-b282-21823087fd04"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">"book"</span><span class="p">)</span><span class="o">.</span><span class="n">Limit</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageSize</span><span class="p">))</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="s">"id ASC"</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">Where</span><span class="p">(</span><span class="s">"id &gt; ?"</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Now that we have the query, we can simply execute it and map the result into our Protobuf <code>Book</code> model:</p>
<div class="code_switcher_container_parent a6d6f0eb-89cc-40e8-a801-6dac9b23fe90"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">queryRes</span> <span class="o">=</span> <span class="p">[]</span><span class="n">Book</span><span class="p">{}</span>
<span class="n">query</span><span class="o">.</span><span class="n">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queryRes</span><span class="p">)</span> <span class="c">// execute query</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryRes</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
  <span class="c">// short circuit if not results</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksResponse</span><span class="p">{},</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="n">books</span> <span class="o">:=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">queryRes</span><span class="p">,</span> <span class="n">mapBookToBookPb</span><span class="p">)</span>
</code></pre></div></div>
</div>
<p>Finally, we can get the ID (ULID) of the last item in subset (<code>queryRes</code>) and this will represent the <code>page_token</code> from where a subsequent request need to start getting new result.</p>
<div class="code_switcher_container_parent 17408660-be0b-484f-b516-b67ad621cd38"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lastItemIdx</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryRes</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span>
<span class="n">nextPageToken</span> <span class="o">:=</span> <span class="n">queryRes</span><span class="p">[</span><span class="n">lastItemIdx</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryRes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="kt">int</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageSize</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// no more pages</span>
  <span class="n">nextPageToken</span> <span class="o">=</span> <span class="s">""</span>
<span class="p">}</span>

<span class="k">return</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksResponse</span><span class="p">{</span>
  <span class="n">Books</span><span class="o">:</span>         <span class="n">books</span><span class="p">,</span>
  <span class="n">NextPageToken</span><span class="o">:</span> <span class="n">nextPageToken</span><span class="p">,</span>
<span class="p">},</span> <span class="no">nil</span>
</code></pre></div></div>
</div>
<p>And we now have pagination! Let's go ahead and test it.</p>
<h2 id="testing">Testing</h2>
<p>The first thing we can test is the case where the consumer doesn't provide a <code>page_token</code> and <code>page_size</code>. This should return 10 results (see <code>defaultPageSize</code>) from the beginning of the data.</p>
<div class="code_switcher_container_parent 488613e0-994e-47b9-a2c6-e0cb3eda17fd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Full-Stack Web Development with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Domain-Driven Design with Golang"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Building Modern CLI Applications in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Functional Programming in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Event-Driven Architecture in Golang"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Test-Driven Development in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Mastering Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Network Automation with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Microservices with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Effective Concurrency in Go"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"nextPageToken"</span>: <span class="s2">"01H8EH4VYYCS6M4BFVZ90RP7FS"</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>First, you can notice that we had 11 datum and that because we asked for 10 we didn't get &quot;gRPC Go for Professionals&quot;. And secondly, we can see that we got the <code>nextPageToken</code> field.</p>
<p>Let's now use the <code>nextPageToken</code> as <code>page_token</code>:</p>
<div class="code_switcher_container_parent 61b56040-e33e-41b2-9d06-df16597a8dfe"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{"page_token": "01H8EH4VYYCS6M4BFVZ90RP7FS"}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"gRPC Go for Professionals"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>And here we get our 11th datum!</p>
<p>Finally, we can try mixing the <code>page_token</code> and <code>page_size</code> fields. Let's say that we are going to have a <code>page_size</code> of 2. We will do the first request without <code>page_token</code> to get the 2 first elements:</p>
<div class="code_switcher_container_parent 0fa10db1-63a4-4ddd-bf44-eec1a4611596"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{"page_size": 2}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Full-Stack Web Development with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Domain-Driven Design with Golang"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"nextPageToken"</span>: <span class="s2">"01H8EH2RM7HVFJG4HYA4XTV0R5"</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>and then we can use the <code>nextPageToken</code> to get the 3rd and 4th elements:</p>
<div class="code_switcher_container_parent 12bda19c-fa6a-4248-abf5-c4f80a02f5e4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{"page_size": 2, "page_token": "01H8EH2RM7HVFJG4HYA4XTV0R5"}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Building Modern CLI Applications in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Functional Programming in Go"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"nextPageToken"</span>: <span class="s2">"01H8EH3CKPT5BX263G0NGGKQCQ"</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>Here we go! Everything workks as expected!</p>
<h2 id="conclusion">Conclusion</h2>
<p>We saw that we can implement pagination quite easily in gRPC with the combination of <code>page_token</code> and <code>page_size</code> fields in the request. We also saw that the API endpoint will return a <code>next_page_token</code> that we can later use as an index for the next page we want to get.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="gRPC" /><summary type="html"><![CDATA[Looking into optimizing one of my APIs, I recently stumbled upon the following resource: Common design patterns. This contains a lot of insights on how to design proto files in order to make gRPC APIs more idiomatic or more efficient. Within this document, I found the pagination part interesting and decided to write an article on how to implement it.]]></summary></entry><entry><title type="html">Authorization with gRPC and Envoy</title><link href="https://clement-jean.github.io/grpc_authz_envoy/" rel="alternate" type="text/html" title="Authorization with gRPC and Envoy" /><published>2023-06-07T00:00:00+08:00</published><updated>2023-06-07T00:00:00+08:00</updated><id>https://clement-jean.github.io/grpc_authz_envoy</id><content type="html" xml:base="https://clement-jean.github.io/grpc_authz_envoy/"><![CDATA[<p>Recently, I've been looking for a good alternative to <a href="https://traefik.io/traefik/">Traefik</a> as Reverse Proxy for gRPC services. Traefik has great support for gRPC and other common features, but Envoy comes with Protobuf-backed configuration and even greater support for gRPC services. In the article, I want to show how you can make Envoy use your custom authorization logic before redirecting (or not) the request to other services.</p>
<h2 id="the-code">The code</h2>
<p>The code is available <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-06-07-grpc_authz_envoy">here</a>.</p>
<h2 id="disclaimer">Disclaimer</h2>
<p>This post has been inspired from this <a href="https://ekhabarov.com/post/envoy-as-an-api-gateway-authentication-and-authorization/">article</a>. I thought it would be nice to have a little bit more details and explain how to run the whole thing.</p>
<h2 id="envoy">Envoy</h2>
<p>If you don't know Envoy, it is a <a href="https://en.wikipedia.org/wiki/Reverse_proxy">Reverse Proxy</a>. This is basically a server relaying client requests to other servers (your services). It is generally used to protect the services from direct access and potential abuse. As such, Reverse Proxies can load balance, rate limit, and much more.</p>
<p>Envoy is a project originally designed by Lyft and it is described as &quot;a high performance C++ distributed proxy designed for single services and applications, as well as a communication bus and “universal data plane” designed for large microservice “service mesh” architectures&quot;. That's a lot of buzz words! But for us, the most important is this feature:</p>
<blockquote>
<p>HTTP/2 AND GRPC SUPPORT</p>
<p>Envoy has first class support for HTTP/2 and gRPC for both incoming and outgoing connections. It is a transparent HTTP/1.1 to HTTP/2 proxy.</p>
</blockquote>
<p>One of the interesting features coming out of this support is the fact that Envoy can use custom gRPC services you develop. An example of this is the authorization service that I want to show you here.</p>
<h2 id="protobuf">Protobuf</h2>
<p>Before everything else, let us start by defining the service that we want to protect. Nothing fancy, we are going to use a simple GreetService:</p>
<div class="code_switcher_container_parent a7fd351c-2468-46c5-b65d-d8bd75cd2d24"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kn">package</span> <span class="nn">greet</span><span class="p">;</span>

<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"github.com/Clement-Jean/clement-jean.github.io/proto"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">GreetRequest</span> <span class="p">{}</span>
<span class="kd">message</span> <span class="nc">GreetResponse</span> <span class="p">{}</span>

<span class="kd">service</span> <span class="n">GreetService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">Greet</span> <span class="p">(</span><span class="n">GreetRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">GreetResponse</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>After that, Envoy provides us with its own protobuf definition for authorization. We can take a look at <a href="https://github.com/envoyproxy/envoy/blob/main/api/envoy/service/auth/v3/external_auth.proto">external_auth.proto</a> which contains the following:</p>
<div class="code_switcher_container_parent c7a95e29-af42-4f61-ab51-65daa074d639"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// A generic interface for performing authorization check on incoming</span>
<span class="c1">// requests to a networked service.</span>
<span class="kd">service</span> <span class="n">Authorization</span> <span class="p">{</span>
  <span class="c1">// Performs authorization check based on the attributes associated with the</span>
  <span class="c1">// incoming request, and returns status `OK` or not `OK`.</span>
  <span class="k">rpc</span> <span class="n">Check</span><span class="p">(</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CheckResponse</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This means that we need to implement the Check unary endpoint and register the Authorization service.</p>
<h2 id="go-control-plane">go-control-plane</h2>
<p>Envoy provides us with a project called go-control-plane. This contains a collection of services such as Authorization that we can implement in our project.</p>
<p>To get it, we simply execute:</p>
<div class="code_switcher_container_parent acbd9da2-b25c-49f2-86ae-76fba713b096"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go get github.com/envoyproxy/go-control-plane
</code></pre></div></div>
</div>
<p>This gives us access to <code>github.com/envoyproxy/go-control-plane/envoy/service/auth/v3</code> which contains the following structs:</p>
<ul>
<li>CheckRequest</li>
<li>CheckResponse</li>
<li>AutorizationServer (which is an interface containing <code>Check</code>)</li>
</ul>
<p>In our code we can now implement the <code>Check</code> function for our server type. This looks like this:</p>
<div class="code_switcher_container_parent b85afe90-ee1a-4243-9339-a4cbedebba44"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">auth</span> <span class="s">"github.com/envoyproxy/go-control-plane/envoy/service/auth/v3"</span>

<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Check</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>If you are familiar with gRPC, this should look familiar.</p>
<p>And to register the Authorization service we can simply register like we normally would:</p>
<div class="code_switcher_container_parent f89fff95-55ac-440b-a2b1-7a341553b799"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="n">auth</span> <span class="s">"github.com/envoyproxy/go-control-plane/envoy/service/auth/v3"</span>
  <span class="n">pb</span> <span class="s">"github.com/Clement-Jean/clement-jean.github.io/proto"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Server</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">pb</span><span class="o">.</span><span class="n">UnimplementedGreetServiceServer</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="n">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Server</span><span class="p">{}</span>
  <span class="n">auth</span><span class="o">.</span><span class="n">RegisterAuthorizationServer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">srv</span><span class="p">)</span>
  <span class="n">pb</span><span class="o">.</span><span class="n">RegisterGreetServiceServer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">srv</span><span class="p">)</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Notice that we are registering both services on the server here. This is not necessary. You could have a microservice specifically dedicated to authorization and the other one to greeting people.</p>
<h2 id="envoy-configuration">Envoy Configuration</h2>
<p>Now, in order to make Envoy do what we want, we need to create some YAML configuration. This configuration generally contains the ports on which Envoy listens, filters for filtering requests based on some properties, and clusters which are a collection of one or more endpoints.</p>
<p>In our case we are going to create two clusters. One for the authorization service and the other service. This is in fact not necessary since we registered both services on the same server, but I wanted to show you that you can split clusters for different microservices.</p>
<p>The clusters definition looks like the following:</p>
<div class="code_switcher_container_parent b6ddbf30-c3d1-4576-a738-f86abff1a1c0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">clusters</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">grpc_auth</span>
    <span class="na">http2_protocol_options</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">lb_policy</span><span class="pi">:</span> <span class="s">round_robin</span>
    <span class="na">load_assignment</span><span class="pi">:</span>
      <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">grpc_auth</span>
      <span class="na">endpoints</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">lb_endpoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">endpoint</span><span class="pi">:</span>
            <span class="na">address</span><span class="pi">:</span>
              <span class="na">socket_address</span><span class="pi">:</span>
                <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">port_value</span><span class="pi">:</span> <span class="m">50051</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">grpc_greet</span>
    <span class="na">http2_protocol_options</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">lb_policy</span><span class="pi">:</span> <span class="s">round_robin</span>
    <span class="na">load_assignment</span><span class="pi">:</span>
      <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">grpc_greet</span>
      <span class="na">endpoints</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">lb_endpoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">endpoint</span><span class="pi">:</span>
            <span class="na">address</span><span class="pi">:</span>
              <span class="na">socket_address</span><span class="pi">:</span>
                <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">port_value</span><span class="pi">:</span> <span class="m">50051</span>
</code></pre></div></div>
</div>
<p>I hope we can agree on the fact that they are very similar so let's only dissect the authorization one.</p>
<p><code>http2_protocol_options: {}</code> simply means that we are enabling HTTP/2 for this cluster. This is required for gRPC services since gRPC is basically Protobuf over HTTP/2.</p>
<p>Then we have <code>lb_policy: round_robin</code>. This is not required for us since we will have only one instance of each service but in the case you scale things up, you will have to balance the load across the multiple services.</p>
<p>And finally, all the rest is basically defining a cluster with the name <code>grpc_auth</code> which can be reached at the address <code>0.0.0.0:50051</code>.</p>
<p>Now that we have that, we can take a look at the listener. Let's see the first part of the listener which is simply defining on which address and port Envoy will listen.</p>
<div class="code_switcher_container_parent 9cd3d903-cb44-4f0f-8010-1859c8291f98"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
  <span class="na">address</span><span class="pi">:</span>
    <span class="na">socket_address</span><span class="pi">:</span>
      <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
      <span class="na">port_value</span><span class="pi">:</span> <span class="m">50050</span>
</code></pre></div></div>
</div>
<p>Once again Envoy will listen on <code>0.0.0.0:50050</code>. Now, note that even if you had <code>0.0.0.0:50051</code> there will be no conflict with the <code>0.0.0.0:50051</code> address set in the cluster. This is because generally the gRPC server will be containerized separately from Envoy and thus will listen on its own 50051 port.</p>
<p>Finally, things get a little bit more interesting when we talk about the filters. We need to start with a <code>http_connection_manager</code> that defines the route that we want to protect with authorization.</p>
<div class="code_switcher_container_parent 29a097d2-b733-4cdd-b69e-83de2f35102c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
    <span class="c1"># address</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
          <span class="s">stat_prefix</span><span class="err">:</span> <span class="s">grpc_json</span>
          <span class="s">codec_type</span><span class="err">:</span> <span class="s">AUTO</span>
          <span class="s">route_config</span><span class="err">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">route</span>
            <span class="na">virtual_hosts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">vh</span>
              <span class="na">domains</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
              <span class="na">routes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/greet.GreetService/"</span><span class="pi">,</span> <span class="nv">grpc</span><span class="pi">:</span> <span class="pi">{}</span> <span class="pi">}</span>
                <span class="na">route</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">cluster</span><span class="pi">:</span> <span class="nv">grpc_greet</span><span class="pi">,</span> <span class="nv">timeout</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">seconds</span><span class="pi">:</span> <span class="nv">60</span> <span class="pi">}</span> <span class="pi">}</span>
</code></pre></div></div>
</div>
<p>The most important part is the virtual_hosts one. We say that we will accept requests from any domain (not recommended in prod), and then we basically that every request made on route matching <code>/greet.GreetService/</code> will be redirected to the <code>grpc_greet</code> cluster</p>
<p>After that, we will configure the external authorization.</p>
<div class="code_switcher_container_parent 03fada2e-6023-4d3e-81c2-28ba4b1fefe6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
    <span class="c1"># address</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="c1"># route matching</span>
          <span class="na">http_filters</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.http.ext_authz</span>
            <span class="na">typed_config</span><span class="pi">:</span>
              <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
              <span class="s">grpc_service</span><span class="err">:</span>
                <span class="na">envoy_grpc</span><span class="pi">:</span>
                  <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">grpc_auth</span>
                <span class="na">timeout</span><span class="pi">:</span> <span class="s">0.5s</span>
              <span class="na">transport_api_version</span><span class="pi">:</span> <span class="s">V3</span>
              <span class="na">failure_mode_allow</span><span class="pi">:</span> <span class="no">false</span>
              <span class="na">with_request_body</span><span class="pi">:</span>
                <span class="na">max_request_bytes</span><span class="pi">:</span> <span class="m">8192</span>
                <span class="na">allow_partial_message</span><span class="pi">:</span> <span class="no">true</span>
                <span class="na">pack_as_bytes</span><span class="pi">:</span> <span class="no">true</span>
              <span class="na">status_on_error</span><span class="pi">:</span>
                <span class="na">code</span><span class="pi">:</span> <span class="m">503</span>
</code></pre></div></div>
</div>
<p>The most important things in this part of the config are:</p>
<ul>
<li><code>cluster_name: grpc_auth</code>. We are specifying that the Authorization service can be found in the <code>grpc_auth</code> cluster.</li>
<li><code>code: 503</code>. If any error happens such as not finding the <code>Check</code> endpoint, Envoy will return a 503 error code.</li>
<li><code>with_request_body</code> forwards HTTP body to the Authorization service.</li>
</ul>
<p>Finally, we need to tell Envoy to actually route the requests. We simply do that by adding a <code>envoy.filters.http.router</code> at the end of the <code>http_filters</code>.</p>
<div class="code_switcher_container_parent 1be48d9f-7f87-4d2b-9e97-fb90515dc60f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
    <span class="c1"># address</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="c1"># route matching</span>
          <span class="na">http_filters</span><span class="pi">:</span>
          <span class="c1"># ext_authz</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.http.router</span>
            <span class="na">typed_config</span><span class="pi">:</span>
              <span class="s1">'</span><span class="s">@type'</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span>
</code></pre></div></div>
</div>
<h2 id="lets-codecheckcode">Let's <code>Check</code></h2>
<p>Now that we have our Envoy config ready, it is time to implement the <code>Check</code> endpoint. We will first create a small demo environment where we will receive a token as header. We will check:</p>
<ul>
<li>If the token is empty/doesn't exist -&gt; Deny</li>
<li>If the token value is different from 'authz' -&gt; Deny</li>
<li>Otherwise -&gt; Allow</li>
</ul>
<p>Token checks would normally involve a database of some sort but here, as this is a small demo, let's create a simple function.</p>
<div class="code_switcher_container_parent 3c1163bb-5f53-4fdf-894e-566596158ae6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">containsToken</span><span class="p">(</span><span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">false</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"empty key"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">"authz"</span><span class="p">),</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Nothing fancy.</p>
<p>Now, in <code>Check</code> we will be receiving headers, not as metadata, but as part of the request. I will let you check <a href="https://github.com/envoyproxy/envoy/blob/main/api/envoy/service/auth/v3/external_auth.proto">external_auth.proto</a> and <a href="https://github.com/envoyproxy/envoy/blob/main/api/envoy/service/auth/v3/attribute_context.proto">attribute_context.proto</a> to understand a little bit more about the data that we will receive as part of <code>CheckRequest</code>.</p>
<p>So we now get the token from the headers and pass it through <code>containsToken</code>.</p>
<div class="code_switcher_container_parent c19857c4-dd75-417c-b757-31af3eb25a7f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Check</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">headers</span> <span class="o">:=</span> <span class="n">req</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Http</span><span class="o">.</span><span class="n">Headers</span>
  <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containsToken</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s">"token"</span><span class="p">])</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Finally, we still have to do error handling. <code>ok</code> will tell us whether the key is in the 'database' and the <code>err</code> will be errors like <code>empty key</code>. Now, returning an error with <code>go-control-plane</code> and Envoy is a little bit different that what you might expect. This is because instead of returning the error as status like we normally do in gRPC is not compatible with Envoy. Instead, we need to return the status as part of the <code>CheckResponse</code>.</p>
<p>Two helpers functions aiming at creating a <code>Allow</code> and <code>Deny</code> response, that I found <a href="https://ekhabarov.com/post/envoy-as-an-api-gateway-authentication-and-authorization/">here</a>, are pretty self describing:</p>
<div class="code_switcher_container_parent 8d92ed5b-c1ed-457e-87bc-3f32ab8c1594"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="c">//...</span>
  <span class="s">"google.golang.org/genproto/googleapis/rpc/status"</span>
  <span class="s">"google.golang.org/grpc/codes"</span>

  <span class="n">envoy_type</span> <span class="s">"github.com/envoyproxy/go-control-plane/envoy/type/v3"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">denied</span><span class="p">(</span><span class="n">code</span> <span class="kt">int32</span><span class="p">,</span> <span class="n">body</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">{</span>
    <span class="n">Status</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">{</span><span class="n">Code</span><span class="o">:</span> <span class="n">code</span><span class="p">},</span>
    <span class="n">HttpResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse_DeniedResponse</span><span class="p">{</span>
      <span class="n">DeniedResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">DeniedHttpResponse</span><span class="p">{</span>
        <span class="n">Status</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">envoy_type</span><span class="o">.</span><span class="n">HttpStatus</span><span class="p">{</span>
          <span class="n">Code</span><span class="o">:</span> <span class="n">envoy_type</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">Body</span><span class="o">:</span> <span class="n">body</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">allowed</span><span class="p">()</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">{</span>
    <span class="n">Status</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">{</span><span class="n">Code</span><span class="o">:</span> <span class="kt">int32</span><span class="p">(</span><span class="n">codes</span><span class="o">.</span><span class="n">OK</span><span class="p">)},</span>
    <span class="n">HttpResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse_OkResponse</span><span class="p">{</span>
      <span class="n">OkResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">OkHttpResponse</span><span class="p">{</span>
        <span class="n">HeadersToRemove</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"token"</span><span class="p">},</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Notice that we are not using the traditional <code>google.golang.org/grpc/status</code> here. We are using <code>google.golang.org/genproto/googleapis/rpc/status</code>. <strong>As of the time of writing this, I'm not aware of why this is the case. I might come back and update that when I learned why.</strong></p>
<p>Finally, we can finish the implementation of both <code>Check</code> and <code>Greet</code>. We will make <code>Greet</code> return an empty response. And we will make <code>Check</code> return the result of <code>denied</code> in case of error and wrong token, or return the result of <code>allowed</code> if everything goes well.</p>
<div class="code_switcher_container_parent 642d915d-1d5d-4f69-9f95-2efaf6771352"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="s">"net/http"</span>
  <span class="c">//...</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Check</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">headers</span> <span class="o">:=</span> <span class="n">req</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Http</span><span class="o">.</span><span class="n">Headers</span>
  <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containsToken</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s">"token"</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">denied</span><span class="p">(</span>
      <span class="n">http</span><span class="o">.</span><span class="n">StatusBadRequest</span><span class="p">,</span>
      <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"failed retrieving the api key: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span>
    <span class="p">),</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">denied</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">,</span> <span class="s">"unauthorized"</span><span class="p">),</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">allowed</span><span class="p">(),</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Greet</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">GreetRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">GreetResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">GreetResponse</span><span class="p">{},</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<h2 id="demo-time">Demo Time!</h2>
<p>Here we are! It's demo time baby!</p>
<p>To test all of this, we will run our server:</p>
<div class="code_switcher_container_parent 66cbbd5c-3680-498d-8952-01b8f68e1ffc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go run server/<span class="k">*</span>.go
listening at 0.0.0.0:50051
</code></pre></div></div>
</div>
<p>After that, let's use <a href="https://func-e.io/">func-e</a> to run our Envoy instance:</p>
<div class="code_switcher_container_parent ab5f753a-d722-4aeb-a223-18b614b1a3c9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>func-e run <span class="nt">-c</span> envoy/config.yaml
</code></pre></div></div>
</div>
<p>And finally, I will use <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a> to query the Greet endpoint on <code>0.0.0.0:50050</code> (Envoy listener). Let's start with the happy path scenario:</p>
<div class="code_switcher_container_parent 0d397838-32dc-4583-8a1c-8797ace86db6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/greet.proto <span class="se">\</span>
          <span class="nt">-rpc-header</span><span class="o">=</span><span class="s2">"token: authz"</span> <span class="se">\</span>
          0.0.0.0:50050 greet.GreetService/Greet
<span class="o">{</span>

<span class="o">}</span>
</code></pre></div></div>
</div>
<p>We get an empty <code>GreetResponse</code>, as expected.</p>
<p>Now, we can try without token:</p>
<div class="code_switcher_container_parent 00da7fdf-2025-4024-950c-fb4bf2c7a2b4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/greet.proto <span class="se">\</span>
          0.0.0.0:50050 greet.GreetService/Greet
ERROR:
  Code: Internal
  Message: failed retrieving the api key: empty key
</code></pre></div></div>
</div>
<p>We get an Internal error with the message &quot;empty key&quot;.</p>
<p>And finally, we test with a wrong token:</p>
<div class="code_switcher_container_parent fcf39e89-62fd-4ca9-ae91-70e921cebcde"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/greet.proto <span class="se">\</span>
          <span class="nt">-rpc-header</span><span class="o">=</span><span class="s2">"token: authd"</span> <span class="se">\</span>
          0.0.0.0:50050 greet.GreetService/Greet
ERROR:
  Code: Unauthenticated
  Message: unauthorized
</code></pre></div></div>
</div>
<p>Unauthorized! Great everything is working as expected.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this post we saw that we can use Envoy to sit between our services and call an Authorization service to decide whether or not to forward the request to a given route. In our case, we worked on a simple token checking logic but this should look similar for your real-life scenario. I hope this was interesting, thank you for reading!</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="gRPC" /><category term="Envoy" /><summary type="html"><![CDATA[Recently, I've been looking for a good alternative to Traefik as Reverse Proxy for gRPC services. Traefik has great support for gRPC and other common features, but Envoy comes with Protobuf-backed configuration and even greater support for gRPC services. In the article, I want to show how you can make Envoy use your custom authorization logic before redirecting (or not) the request to other services.]]></summary></entry><entry><title type="html">Range Testing in Strings</title><link href="https://clement-jean.github.io/range_testing_in_strings/" rel="alternate" type="text/html" title="Range Testing in Strings" /><published>2023-06-02T00:00:00+08:00</published><updated>2023-06-02T00:00:00+08:00</updated><id>https://clement-jean.github.io/range_testing_in_strings</id><content type="html" xml:base="https://clement-jean.github.io/range_testing_in_strings/"><![CDATA[<p>Recently, I've been working on adding support for <code>SourceCodeInfo</code> into <a href="https://github.com/Clement-Jean/protein">Protein</a>. This required checking a lot of Column/Line ranges in string. An example of this is the following. Given a oneof like this:</p>
<div class="code_switcher_container_parent 7e6950b4-c267-4f2d-aed3-45c422aff993"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">oneof</span> <span class="n">Test</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>we should come up with the following ranges:</p>
<div class="code_switcher_container_parent f259e487-ec7e-471e-9e75-43211efdd9be"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>
  // line,column
  <span class="o">{</span>0, 0, 2, 1<span class="o">}</span> // oneof - from 0,0 to 2, 1
  <span class="o">{</span>1, 2, 15<span class="o">}</span>   // oneof field - from 1,2 to 1,15 <span class="o">(</span>same lines get ommited<span class="o">)</span>
  <span class="o">{</span>1, 2, 7<span class="o">}</span>    // oneof field <span class="nb">type</span> - from 1,2 to 1,7
  <span class="o">{</span>1, 8, 10<span class="o">}</span>   // oneof field name - from 1,8 to 1,10
  <span class="o">{</span>1, 13, 14<span class="o">}</span>  // oneof field tage - from 1,13 to 1,14
<span class="o">]</span>
</code></pre></div></div>
</div>
<p>This might seem like a daunting and it was until I found out how to test ranges correctly for these kind of situations.</p>
<h2 id="sourcecodeinfo">SourceCodeInfo</h2>
<p>Before starting with the whole testing thing. It is important to get a sense of what a Protobuf's <code>SourceCodeInfo</code> is. As its name suggests this is information about the source code. This information is basically lines and columns for tokens (called spans) and some tags sequence starting from <code>FileDescriptorProto</code> (called path). This info is mostly important for tools like what Protein will be: linters, LSPs, ... It gives us a way to find elements both in terms of position (line 1, column 10) in code and in terms of context (a oneof inside a message).</p>
<p>While the second part is pretty interesting, we are not going to cover that. We will focus on testing the spans correctly. However, if you are interested in learning more about paths, I'd be happy to write an article on it. Leave a comment if you are.</p>
<h2 id="naive-testing">Naive Testing</h2>
<p>Now that we know what are <code>SourceCodeInfo</code> we can start with the testing. A naive and rather manual solution to solve this is probably writing every span by hand. This is pretty much what I did in the introduction of this article. This could mean something like this:</p>
<div class="code_switcher_container_parent 53523435-cf35-45ec-a3c6-7a5626fc9d5f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
  <span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
  <span class="n">info</span> <span class="p">[]</span><span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">SourceCodeInfo_Location</span><span class="p">,</span>
  <span class="n">expectedSpans</span> <span class="p">[][]</span><span class="kt">int32</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"expected info"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expectedSpans</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"expected %v, got: %v"</span><span class="p">,</span> <span class="n">expectedSpans</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">expectedSpan</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">expectedSpans</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Span</span><span class="p">,</span> <span class="n">expectedSpan</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"path %d wrong. expected %v, got: %v"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">expectedSpan</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Span</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestOneofSourceCodeInfo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// Arrange</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

  <span class="c">// Act</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">:=</span> <span class="n">augmentParse</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">),</span> <span class="no">nil</span><span class="p">)</span>

  <span class="c">// Assert</span>
  <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">info</span><span class="p">,</span>
    <span class="p">[][]</span><span class="kt">int32</span><span class="p">{</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">45</span><span class="p">},</span>  <span class="c">// oneof - from 0,0 to 0, 45</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">13</span><span class="p">,</span> <span class="m">26</span><span class="p">},</span> <span class="c">// oneof field - from 0,13 to 0,26</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">13</span><span class="p">,</span> <span class="m">18</span><span class="p">},</span> <span class="c">// oneof field type - from 0,13 to 0,18</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">19</span><span class="p">,</span> <span class="m">21</span><span class="p">},</span> <span class="c">// oneof field name - from 0,19 to 0,21</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">24</span><span class="p">,</span> <span class="m">25</span><span class="p">},</span> <span class="c">// oneof field tage - from 0,24 to 0,25</span>
      <span class="c">// etc...</span>
    <span class="p">},</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This looks rather simple and if we stick to testing small pieces of code, it is feasible to get our way through. However, as you might expect, this is tiring and very repetitive work. Imagine doing that for every single concept in Protobuf...</p>
<h2 id="a-better-way">A Better Way</h2>
<p>For full disclosure, this idea for testing ranges in strings is not my idea. This is an idea I discovered after reading Protobuf documentation and unit tests. An example of this is the documentation for <code>SourceCodeInfo</code> in the descriptor.proto file:</p>
<div class="code_switcher_container_parent 3ac1cd19-b83d-40e8-84e8-dac08d341db6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Let's look at just the field definition:</span>
<span class="c">//   optional string foo = 1;</span>
<span class="c">//   ^       ^^     ^^  ^  ^^^</span>
<span class="c">//   a       bc     de  f  ghi</span>
<span class="c">// We have the following locations:</span>
<span class="c">//   span   path               represents</span>
<span class="c">//   [a,i)  [ 4, 0, 2, 0 ]     The whole field definition.</span>
<span class="c">//   [a,b)  [ 4, 0, 2, 0, 4 ]  The label (optional).</span>
<span class="c">//   [c,d)  [ 4, 0, 2, 0, 5 ]  The type (string).</span>
<span class="c">//   [e,f)  [ 4, 0, 2, 0, 1 ]  The name (foo).</span>
<span class="c">//   [g,h)  [ 4, 0, 2, 0, 3 ]  The number (1).</span>
</code></pre></div></div>
</div>
<p>We can just focus on the span and how they mark the beginning and end of them with letters. <code>optional</code> as a span of [a, b) (from a to b non-inclusive). Meaning that we go from column 0 to column 8 (length of the work optional) but you can see that <code>b</code> is marking the space character so we do not include that.</p>
<p>Now, even I didn't get the original idea, I believe that implementing it in Go (original in C++) and adding line support is quite interesting. Let us start by the v1 which didn't support multiline code.</p>
<p>The idea is that we are going to have function calculating indices from a string full of separator characters and letters. For example, if we say that the separator is '-', we could have a string like this:</p>
<div class="code_switcher_container_parent d8820962-cce9-4451-bf28-e328ab1e325f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a------------b----cd-e--fghi-----jk---l--mno-p
</code></pre></div></div>
</div>
<p>that would match a oneof like this one:</p>
<div class="code_switcher_container_parent 1d32d21c-20f0-49db-b23a-7e8edb8bc304"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">oneof</span> <span class="n">Test</span> <span class="p">{</span> <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="kt">string</span> <span class="na">uuid</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>
</div>
<p>To better see it we will have a function that takes both the original Protobuf code and the reference string (that is what I called the separator-full string) as parameters:</p>
<div class="code_switcher_container_parent ded03554-7bf2-4d4a-b356-5dbb4bad9f81"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">referenceString</span><span class="p">(</span>
  <span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">,</span>
  <span class="s">"a------------b----cd-e--fghi-----jk---l--mno-p"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>
</div>
<p>This nicely matches and it is easier to visually see where the span starts and ends when we know the letter. If I told you there should be a span [b, h), you can clearly understand that these references to the id field definition.</p>
<p>Now, how should we represent all of this in terms of data structure? The naive approach is to create a <code>map[rune]int32</code>. The <code>rune</code> will be the letterm and we are return <code>int32</code> instead of <code>int</code> simply because <code>SourceCodeInfo</code> is expecting <code>int32</code>s. Then, when we will want to check the value of <code>a</code>, we can simply do:</p>
<div class="code_switcher_container_parent 1dd49173-b60f-4d8a-8c98-4b5bf2c22352"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">:=</span> <span class="n">refs</span><span class="p">[</span><span class="sc">'a'</span><span class="p">]</span>
</code></pre></div></div>
</div>
<p>This doesn't seem that bad right? Well, what if you need to access letters a to z? You basically have 26 of these variables around. Feasible but not that ergonomic.</p>
<h2 id="an-even-better-way">An Even Better Way</h2>
<p>My second thought on how to improve this comes from my early interest in reflection. I find it amazing that we take a look at the guts of our program and manipulate it programmatically. An example of that is listing all the fields in a struct and/or set values to them. I don't know what you think but for me this is just so powerful (and dangerous!).</p>
<p>Enough about my geekiness on reflection. What if we could simply have an object into which we will set the values of our spans. This would let us write something like following for accessing values:</p>
<div class="code_switcher_container_parent f0b9cbf4-b727-477a-999e-807ff46c9df5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ref</span><span class="o">.</span><span class="n">A</span>
</code></pre></div></div>
</div>
<p>How nice would that be? We would only have one variable (ref) and we could access the fields.</p>
<p>It turns out that we can do it pretty easily. Think about a <code>struct</code> like the following:</p>
<div class="code_switcher_container_parent 413475d0-78a1-43aa-beba-63514599316f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Ref</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="kt">int32</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>I agree that this definition is not that beautiful but it will make our test code easier to read.</p>
<p>With that <code>Ref</code>, we will now use reflection to set <code>A</code> (uppercase because reflection require exported fields) when we see a <code>a</code> in the string. This will look like this:</p>
<div class="code_switcher_container_parent 9efd5569-7bf3-4566-a73c-8785881e6af2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// referenceString returns the original string and the newly created Ref</span>
<span class="c">// the sep argument is the separator we skip (e.g `-`)</span>
<span class="k">func</span> <span class="n">referenceString</span><span class="p">(</span><span class="n">src</span> <span class="kt">string</span><span class="p">,</span> <span class="n">indices</span> <span class="kt">string</span><span class="p">,</span> <span class="n">sep</span> <span class="kt">rune</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">Ref</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// indices should always be longer than src by 1 rune</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">+</span><span class="m">1</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">"wrong indices"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">ref</span> <span class="o">:=</span> <span class="n">Ref</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">indices</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">sep</span> <span class="p">{</span>
      <span class="c">// checks valid characters (lowercase letter)</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLetter</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLower</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v is not a lowercase letter"</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
      <span class="p">}</span>

      <span class="c">// this is the index of the letter in our Ref struct!</span>
      <span class="c">// e.g A is at index 0 and Z is at index 25</span>
      <span class="n">idx</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="kt">byte</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="sc">'a'</span><span class="p">)</span> <span class="c">// ASCII trick to get index of letter in alphabet</span>

      <span class="c">// set the value of i to the field at index idx</span>
      <span class="n">reflect</span><span class="o">.</span><span class="n">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">Elem</span><span class="p">()</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">SetInt</span><span class="p">(</span><span class="kt">int64</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">ref</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>with that we can simply write the following:</p>
<div class="code_switcher_container_parent 254b2397-a1ed-4d7b-b6fe-5653ada1c2d5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
  <span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">,</span>
  <span class="s">"a------------b----cd-e--fghi-----jk---l--mno-p"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>
</div>
<p>and if we print <code>ref</code> we get:</p>
<div class="code_switcher_container_parent ca58fd3d-2104-40c4-978e-225bd9e8d2a0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ref</span> <span class="p">{</span><span class="n">A</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">B</span><span class="o">:</span> <span class="m">13</span><span class="p">,</span> <span class="n">C</span><span class="o">:</span> <span class="m">18</span><span class="p">,</span> <span class="n">D</span><span class="o">:</span> <span class="m">19</span><span class="p">,</span> <span class="n">E</span><span class="o">:</span> <span class="m">21</span><span class="p">,</span> <span class="n">F</span><span class="o">:</span> <span class="m">24</span><span class="p">,</span> <span class="n">G</span><span class="o">:</span> <span class="m">25</span><span class="p">,</span> <span class="n">H</span><span class="o">:</span> <span class="m">26</span><span class="p">,</span> <span class="n">I</span><span class="o">:</span> <span class="m">27</span><span class="p">,</span> <span class="n">J</span><span class="o">:</span> <span class="m">33</span><span class="p">,</span> <span class="n">K</span><span class="o">:</span> <span class="m">34</span><span class="p">,</span> <span class="n">L</span><span class="o">:</span> <span class="m">38</span><span class="p">,</span> <span class="n">M</span><span class="o">:</span> <span class="m">41</span><span class="p">,</span> <span class="n">N</span><span class="o">:</span> <span class="m">42</span><span class="p">,</span> <span class="n">O</span><span class="o">:</span> <span class="m">43</span><span class="p">,</span> <span class="n">P</span><span class="o">:</span> <span class="m">45</span><span class="p">,</span> <span class="n">Q</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">R</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">S</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">T</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">U</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">V</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">W</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">X</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">Y</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">Z</span><span class="o">:</span> <span class="m">0</span><span class="p">}</span>
</code></pre></div></div>
</div>
<p>If we check at the span [b, h), we can see that we have [13, 26). This is quite powerful and way more readable. If we rewrite the <code>TestOneofSourceCodeInfo</code> function with the use of <code>Ref</code>, we have:</p>
<div class="code_switcher_container_parent 24ff36a1-ce07-410c-bba5-83afecbc87a2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestOneofSourceCodeInfo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// Arrange</span>
  <span class="n">pb</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
    <span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">,</span>
    <span class="s">"a------------b----cd-e--fghi-----jk---l--mno-p"</span><span class="p">,</span>
    <span class="sc">'-'</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

  <span class="c">// Act</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">:=</span> <span class="n">augmentParse</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">),</span> <span class="no">nil</span><span class="p">)</span>

  <span class="c">// Assert</span>
  <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">info</span><span class="p">,</span>
    <span class="p">[][]</span><span class="kt">int32</span><span class="p">{</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">P</span><span class="p">},</span>  <span class="c">// oneof - from 0,0 to 0, 45</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">H</span><span class="p">},</span> <span class="c">// oneof field - from 0,13 to 0,26</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">C</span><span class="p">},</span> <span class="c">// oneof field type - from 0,13 to 0,18</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">E</span><span class="p">},</span> <span class="c">// oneof field name - from 0,19 to 0,21</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">G</span><span class="p">},</span> <span class="c">// oneof field tage - from 0,24 to 0,25</span>
      <span class="c">// etc...</span>
    <span class="p">},</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This now look a little bit less magic than before with all these numbers everywhere.</p>
<h2 id="supporting-lines">Supporting lines</h2>
<p>As you can see, we still have these 0s for each line. They actually represent lines. Could we also support multiline code? This would let us write something like:</p>
<div class="code_switcher_container_parent 2ed9b920-2da9-45ad-b7b6-48a253f40cda"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pb</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
  <span class="s">`oneof Test {
int32 id = 1;
string uuid = 2;
}`</span><span class="p">,</span>
  <span class="s">`a------------
b----cd-e--fgh
i-----jk---l--mno
-p`</span><span class="p">,</span>
  <span class="sc">'-'</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>
</div>
<p>Without indentation that looks a little bit weird but this is already letting us testing a little bit more in depth.</p>
<p>The first thing that we are going to do is adding fields in <code>Ref</code> for lines. This looks like:</p>
<div class="code_switcher_container_parent 9a61849d-7f4b-4903-a8e3-d20b6c2c287e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Ref</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="n">LA</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">LC</span><span class="p">,</span> <span class="n">LD</span><span class="p">,</span> <span class="n">LE</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">LG</span><span class="p">,</span> <span class="n">LH</span><span class="p">,</span> <span class="n">LI</span><span class="p">,</span> <span class="n">LJ</span><span class="p">,</span> <span class="n">LK</span><span class="p">,</span> <span class="n">LL</span><span class="p">,</span> <span class="n">LM</span><span class="p">,</span> <span class="n">LN</span><span class="p">,</span> <span class="n">LO</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LQ</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span> <span class="n">LT</span><span class="p">,</span> <span class="n">LU</span><span class="p">,</span> <span class="n">LV</span><span class="p">,</span> <span class="n">LW</span><span class="p">,</span> <span class="n">LX</span><span class="p">,</span> <span class="n">LY</span><span class="p">,</span> <span class="n">LZ</span> <span class="kt">int32</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Cringing a little? It's fine! Keep in mind that this is for the sake of having more expressive tests.</p>
<p>Now, in referenceString we will keep track of columns and lines and, for <code>a</code>, we are going to set <code>A</code> to the column and <code>LA</code> to the line. We now have:</p>
<div class="code_switcher_container_parent 65cdf557-95ad-4c6a-b256-944d459366a2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">referenceString</span><span class="p">(</span><span class="n">src</span> <span class="kt">string</span><span class="p">,</span> <span class="n">indices</span> <span class="kt">string</span><span class="p">,</span> <span class="n">sep</span> <span class="kt">rune</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">Ref</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">ReplaceAll</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">+</span><span class="m">1</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">"wrong indices"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">ref</span> <span class="o">:=</span> <span class="n">Ref</span><span class="p">{}</span>
  <span class="n">line</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="c">// the line</span>
  <span class="n">column</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="c">// the column - do not use i anymore</span>

  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">indices</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">sep</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">!=</span> <span class="sc">'\n'</span> <span class="p">{</span> <span class="c">// also check '\n'</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLetter</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLower</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v is not a lowercase letter"</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
      <span class="p">}</span>

      <span class="n">idx</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="kt">byte</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="sc">'a'</span><span class="p">)</span>

      <span class="c">// set the column</span>
      <span class="n">reflect</span><span class="o">.</span><span class="n">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">Elem</span><span class="p">()</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">SetInt</span><span class="p">(</span><span class="kt">int64</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>

      <span class="c">// set the line</span>
      <span class="n">reflect</span><span class="o">.</span><span class="n">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">Elem</span><span class="p">()</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="m">26</span><span class="p">)</span><span class="o">.</span><span class="n">SetInt</span><span class="p">(</span><span class="kt">int64</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="n">column</span> <span class="o">+=</span> <span class="m">1</span>

    <span class="c">// on newline reset column and increase line</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="p">{</span>
      <span class="n">line</span><span class="o">++</span>
      <span class="n">column</span> <span class="o">=</span> <span class="m">0</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">ref</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>With that we can now write a test for multiline like this:</p>
<div class="code_switcher_container_parent ddb715a9-239f-4b16-861f-8e715c2f1aa4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestOneofMultilineSourceCodeInfo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">pb</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
    <span class="s">`oneof Test {
int32 id = 1;
string uuid = 2;
}`</span><span class="p">,</span>
    <span class="s">`a------------
b----cd-e--fgh
i-----jk---l--mno
-p`</span><span class="p">,</span>
    <span class="sc">'-'</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
  <span class="n">ctx</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">oneofContext</span><span class="p">{}</span>

  <span class="c">// Act</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">:=</span> <span class="n">augmentParse</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span><span class="o">.</span><span class="n">parseOneof</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">),</span> <span class="n">ctx</span><span class="p">)</span>

  <span class="c">// Assert</span>
  <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">info</span><span class="p">,</span>
    <span class="p">[][]</span><span class="kt">int32</span><span class="p">{</span>
      <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LA</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">LP</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">P</span><span class="p">},</span>
      <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LB</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">H</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LB</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">C</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LD</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">E</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LF</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">G</span><span class="p">},</span>
      <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LI</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">O</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LI</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">J</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LK</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">L</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LM</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">N</span><span class="p">},</span>
    <span class="p">},</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Take your time to wrap your mind around it. We just made the all things look a little bit more verbose but less magical and frightening.</p>
<h2 id="advantages">Advantages</h2>
<ul>
<li>New developers looking at these tests will probably be less afraid of writing a new test.</li>
<li>Fewer places where we can make typos. Most typos will be in the reference string.</li>
<li>Changing the spans or separators requires us to only update the reference strings, not all the numbers in int32 arrays.</li>
<li>Reflection is letting us create a map out of a struct and have fewer variables.</li>
</ul>
<h2 id="disadvantages">Disadvantages</h2>
<ul>
<li>More verbose.</li>
<li>Reflection is kind of magical too. However, magic is only happening in <code>referenceString</code>. Not everywhere like before.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>I hope this makes you as interested as I am on how to improve testing code. I already loved creating readable and deterministic tests but now with this other tool in my tool belt, I'm interested in thinking more about readability and developer onboarding.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="Protobuf" /><summary type="html"><![CDATA[Recently, I've been working on adding support for SourceCodeInfo into Protein. This required checking a lot of Column/Line ranges in string. An example of this is the following. Given a oneof like this:]]></summary></entry><entry><title type="html">Custom RPC Options in Protobuf</title><link href="https://clement-jean.github.io/custom_rpc_options/" rel="alternate" type="text/html" title="Custom RPC Options in Protobuf" /><published>2023-04-17T00:00:00+08:00</published><updated>2023-04-17T00:00:00+08:00</updated><id>https://clement-jean.github.io/custom_rpc_options</id><content type="html" xml:base="https://clement-jean.github.io/custom_rpc_options/"><![CDATA[<p>Recently I had to design authentication for a Blazor Application. After finishing implementing, I soon faced the need to know which RPC endpoint needs authentication and which doesn't. And while part of the problem is a solved one, I still needed a mechanism to let me define this. Let's see how.</p>
<blockquote>
<p>All the code (<strong>only running through Bazel right now</strong>) is available <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-04-17-custom_rpc_options">here</a></p>
</blockquote>
<h2 id="custom-options">Custom Options</h2>
<p>Before explaining what my solution to the problem is, I'd like to make sure you understand what are custom options in Protobuf and how to define one. If you are confident about this skill, feel free to skip to the next section.</p>
<p><strong>A custom option is a way to define metadata for a proto file, message, enum, fields, service and rpc</strong>. Generally, we are used to these:</p>
<div class="code_switcher_container_parent eaf7c140-1278-430f-a0f1-5204fc8fbe65"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"github.com/Clement-Jean/test"</span><span class="p">;</span>
</code></pre></div></div>
</div>
<p>being placed at the top of the proto file. But it is important to know that you can make a field or message deprecated like so:</p>
<div class="code_switcher_container_parent 849f1057-9cdf-4b0d-b5df-fe548091aba9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Test</span> <span class="p">{</span>
  <span class="k">option</span> <span class="na">deprecated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kt">int32</span> <span class="na">field</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span> <span class="na">deprecated</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Now, I agree that, in most of the cases, these option are more informational than anything else. They do not necessarily impact the code generation but they are here to document the code. Also, knowing that Protobuf has reflection, we can use them in our code. This means that we could have a tool checking for deprecated messages, fields, ... and give us warnings when we use them in our code base.</p>
<p>How do we define one, though? Well, it turns out that this is pretty simple. We need to use the <code>extend</code> concept and define which kind of option we want to extend. Let's first take a look at what kind of options we have:</p>
<ul class="code-tab-container 219bc03c-c424-4a4f-b9e3-5731884fb086"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '219bc03c-c424-4a4f-b9e3-5731884fb086', 0)">descriptor.proto</a></li></ul><ul class="code-tab-switcher 219bc03c-c424-4a4f-b9e3-5731884fb086"><li class="code_switcher_container_parent active-tab code_switcher_proto afefa612-e59c-4888-9d1f-c95e4e4872c4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">FileOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>

  <span class="c1">// Clients can define custom options in extensions of this message. See above.</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">MessageOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">FieldOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">OneofOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">EnumOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">EnumValueOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">ServiceOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">MethodOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>That's actually every concept that we have in Protobuf! So let's define a simple option now. We will define an option called <code>hello</code> of type string. And for making this related to the problem that I'm trying to solve, let's define that option in <code>MethodOptions</code> which represents the options for RPC endpoints.</p>
<p>So we will extend <code>MethodOptions</code>:</p>
<ul class="code-tab-container 61222f05-e195-4dff-8e1d-36f71f223fe9"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '61222f05-e195-4dff-8e1d-36f71f223fe9', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher 61222f05-e195-4dff-8e1d-36f71f223fe9"><li class="code_switcher_container_parent active-tab code_switcher_proto 10b7a6eb-9fb6-4f42-841b-87997d4b08e9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"google/protobuf/descriptor.proto"</span><span class="p">;</span>

<span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And then inside this <code>extend</code> we can just write the hello field:</p>
<ul class="code-tab-container 7f0cf5e2-c6f3-4bbd-a944-9034d246eca1"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '7f0cf5e2-c6f3-4bbd-a944-9034d246eca1', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher 7f0cf5e2-c6f3-4bbd-a944-9034d246eca1"><li class="code_switcher_container_parent active-tab code_switcher_proto cb13e078-5fa5-48bb-84ba-30ad250769f6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">hello</span> <span class="o">=</span> <span class="err">??</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>But what is the tag that we need to use? Well, if you noticed in the <code>descriptor.proto</code> we have an extension range. These are the numbers we can use for tag. For now, we will use 1000, however, be aware that some of these tags are reserved by some already defined options. <strong>So if you were to use a tool that defines options that have the same tag number, there would be conflicts</strong>.</p>
<p>We now have:</p>
<ul class="code-tab-container e3bebeb1-2738-4181-be17-85aeb16ab8fe"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'e3bebeb1-2738-4181-be17-85aeb16ab8fe', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher e3bebeb1-2738-4181-be17-85aeb16ab8fe"><li class="code_switcher_container_parent active-tab code_switcher_proto 7187ef2d-61c5-4a6c-b51b-659876e287f5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">hello</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="reflection">Reflection</h2>
<p>Let us now use that option and read the value in code.</p>
<p>To use it, this is pretty simple, we just need to import the file in which we wrote the <code>extend</code> and make sure we use the option on an RPC endpoint.</p>
<ul class="code-tab-container 3c1aa551-429b-41c3-93d8-bcd48fab2230"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '3c1aa551-429b-41c3-93d8-bcd48fab2230', 0)">world.proto</a></li></ul><ul class="code-tab-switcher 3c1aa551-429b-41c3-93d8-bcd48fab2230"><li class="code_switcher_container_parent active-tab code_switcher_proto 1656078a-357a-4452-9aa0-0eb316a86c89"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"hello.proto"</span><span class="p">;</span>

<span class="c1">//...</span>

<span class="kd">service</span> <span class="n">HelloWorldService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">HelloWorld</span> <span class="p">(</span><span class="n">HelloWorldRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloWorldResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">option</span> <span class="p">(</span><span class="n">hello</span><span class="p">)</span> <span class="o">=</span> <span class="s">"world"</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We can generate the proto files out of world.proto and hello.proto. And after that we can take a bottom-up approach to read this value through reflection. By bottom up, I mean that we are going to first see how to read the value of a <code>MethodOptions</code>, then we will go to getting a <code>MethodDescriptor</code> out of a <code>ServiceDescriptor</code>, and finally getting a <code>ServiceDescriptor</code> out a <code>FileDescriptor</code>.</p>
<h3 id="getting-an-option-value">Getting an Option Value</h3>
<p>The first thing we are going to deal with is <code>MethodOptions</code>. These represent the options set on an RPC endpoint. In most of the implementations, we can check the existence of an option so this is as simple as &quot;check if there is the option with a given id on this method, if yes return the value, otherwise return null&quot;.</p>
<ul class="code-tab-container 585f5fa8-bf47-4ace-b484-cc9bad283cbe"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '585f5fa8-bf47-4ace-b484-cc9bad283cbe', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '585f5fa8-bf47-4ace-b484-cc9bad283cbe', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '585f5fa8-bf47-4ace-b484-cc9bad283cbe', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '585f5fa8-bf47-4ace-b484-cc9bad283cbe', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '585f5fa8-bf47-4ace-b484-cc9bad283cbe', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 585f5fa8-bf47-4ace-b484-cc9bad283cbe"><li class="code_switcher_container_parent active-tab code_switcher_go 6d1d3e19-3e43-4fa8-8df1-58721ed48737"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="s">"google.golang.org/protobuf/proto"</span>
  <span class="s">"google.golang.org/protobuf/reflect/protoreflect"</span>
  <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">getOptionValue</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span> <span class="c">// T is not covering all types...</span>
  <span class="n">opts</span> <span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">MethodOptions</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="n">value</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">proto</span><span class="o">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">value</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp 64262ee3-1606-4061-ba37-e3de200618d3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;optional&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">OPT_T</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">OPT_T</span><span class="o">&gt;</span> <span class="n">get_option_value</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">MethodOptions</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">,</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">id</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">opts</span><span class="p">.</span><span class="n">HasExtension</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">?</span>
    <span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 8c90031b-7674-4b5f-8d3a-43352e9b2de1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.DescriptorProtos</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.protobuf.GeneratedMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getOptionValue</span><span class="o">(</span>
  <span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span> <span class="n">opts</span><span class="o">,</span>
  <span class="nc">GeneratedMessage</span><span class="o">.</span><span class="na">GeneratedExtension</span><span class="o">&lt;</span><span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">id</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">opts</span><span class="o">.</span><span class="na">hasExtension</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">?</span>
    <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">((</span><span class="no">T</span><span class="o">)</span><span class="n">opts</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">id</span><span class="o">))</span> <span class="o">:</span>
    <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python bce09b90-f993-4924-8d7f-158e46539abb"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_option_value</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">.</span><span class="n">ListFields</span><span class="p">():</span>
    <span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s">""</span> <span class="ow">and</span> <span class="n">desc</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp 5a68d977-c14e-4e44-aab9-79b6c2e22154"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">pb</span> <span class="p">=</span> <span class="k">global</span><span class="p">::</span><span class="n">Google</span><span class="p">.</span><span class="n">Protobuf</span><span class="p">;</span>

<span class="k">static</span> <span class="k">private</span> <span class="n">T</span> <span class="n">GetOptionValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="k">this</span> <span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span> <span class="n">md</span><span class="p">,</span> <span class="c1">// MethodDescriptor and not MethodOptions as promised (sorry!)</span>
  <span class="n">pb</span><span class="p">::</span><span class="n">Extension</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodOptions</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">id</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="n">md</span><span class="p">.</span><span class="nf">GetOptions</span><span class="p">().</span><span class="nf">GetExtension</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</code></pre></div></div>
</li></ul>
<h3 id="getting-a-method">Getting a Method</h3>
<p>The next step is to get a <code>MethodDescriptor</code> out of a <code>ServiceDescriptor</code>. This is done so that we can later call the GetOptionValue function on the options of that method (if any). We will basically loop over all the methods of a service and check for a predicate on each. If the predicate returns true, we &quot;select&quot; that method.</p>
<ul class="code-tab-container 8d5f1305-b6c4-455a-a585-c10689da3976"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8d5f1305-b6c4-455a-a585-c10689da3976', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '8d5f1305-b6c4-455a-a585-c10689da3976', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '8d5f1305-b6c4-455a-a585-c10689da3976', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '8d5f1305-b6c4-455a-a585-c10689da3976', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '8d5f1305-b6c4-455a-a585-c10689da3976', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 8d5f1305-b6c4-455a-a585-c10689da3976"><li class="code_switcher_container_parent active-tab code_switcher_go b71dca8d-2a5e-46ad-808f-905d594e31fb"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">getServiceMethod</span><span class="p">(</span>
  <span class="n">sd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ServiceDescriptor</span><span class="p">,</span>
  <span class="n">fn</span> <span class="k">func</span><span class="p">(</span><span class="n">md</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span><span class="p">)</span> <span class="kt">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">.</span><span class="n">Methods</span><span class="p">()</span><span class="o">.</span><span class="n">Len</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="n">md</span> <span class="o">:=</span> <span class="n">sd</span><span class="o">.</span><span class="n">Methods</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">&amp;</span><span class="n">md</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp 20e1802f-7ba6-4c96-b239-215cc86a5631"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp">
</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*&gt;</span> <span class="n">get_service_method</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">ServiceDescriptor</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">(</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">predicate</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">method_count</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">md</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">predicate</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">md</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 0ae2f9ca-3f75-4a14-aad9-bd56067a2488"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.Descriptors</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span><span class="o">&gt;</span> <span class="nf">getServiceMethod</span><span class="o">(</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">ServiceDescriptor</span> <span class="n">sd</span><span class="o">,</span>
  <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">predicate</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">.</span><span class="na">getMethods</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span> <span class="n">method</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">getMethods</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">predicate</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">method</span><span class="o">))</span>
      <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python 49591487-9978-4f49-be57-9eeb4f3d3d3c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">.</span><span class="n">methods_by_name</span><span class="p">:</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">sd</span><span class="p">.</span><span class="n">methods_by_name</span><span class="p">[</span><span class="n">method_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">md</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp a795385c-fa5c-4968-8e1c-b1e3b622f550"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span><span class="p">&gt;</span> <span class="nf">GetServiceMethod</span><span class="p">(</span>
  <span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">ServiceDescriptor</span><span class="p">&gt;</span> <span class="n">services</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="k">from</span> <span class="n">svc</span> <span class="k">in</span> <span class="n">services</span>
     <span class="k">from</span> <span class="n">method</span> <span class="k">in</span> <span class="n">svc</span><span class="p">.</span><span class="n">Methods</span>
     <span class="k">where</span> <span class="nf">predicate</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
     <span class="k">select</span> <span class="n">method</span><span class="p">;</span>
</code></pre></div></div>
</li></ul>
<h3 id="putting-everything-together">Putting Everything Together</h3>
<p>And finally the idea is to call <code>GetServiceMethod</code> on all the <code>ServiceDescriptor</code>s and with the predicate is true we can call <code>GetOptionValue</code> on the method selected.</p>
<ul class="code-tab-container 79930a6b-d339-4d7f-84ce-b9b8a515b281"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '79930a6b-d339-4d7f-84ce-b9b8a515b281', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '79930a6b-d339-4d7f-84ce-b9b8a515b281', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '79930a6b-d339-4d7f-84ce-b9b8a515b281', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '79930a6b-d339-4d7f-84ce-b9b8a515b281', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '79930a6b-d339-4d7f-84ce-b9b8a515b281', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 79930a6b-d339-4d7f-84ce-b9b8a515b281"><li class="code_switcher_container_parent active-tab code_switcher_go c378919a-df53-4d34-b3dd-182a821e79c7"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">getMethodOptionValue</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span>
  <span class="n">sd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ServiceDescriptor</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">value</span> <span class="o">*</span><span class="n">T</span> <span class="o">=</span> <span class="no">nil</span>

  <span class="n">getServiceMethod</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">md</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">md</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">MethodOptions</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">false</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tmp</span> <span class="o">:=</span> <span class="n">getOptionValue</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span>
      <span class="k">return</span> <span class="no">true</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="no">false</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="n">value</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">getMethodExtension</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span>
  <span class="n">fd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">FileDescriptor</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd</span><span class="o">.</span><span class="n">Services</span><span class="p">()</span><span class="o">.</span><span class="n">Len</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="n">sd</span> <span class="o">:=</span> <span class="n">fd</span><span class="o">.</span><span class="n">Services</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">:=</span> <span class="n">getMethodOptionValue</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">sd</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="n">value</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp e5e094b5-71df-4ea5-9761-7407b90ef3e4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">U</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">get_method_option_value</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">ServiceDescriptor</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="c1">// in C++ we can access the ServiceDescriptor directly</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">id</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">;</span>

  <span class="n">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">](</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">get_option_value</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 4b190046-142e-4803-b186-b3a14578b91c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getMethodExtension</span><span class="o">(</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span>
  <span class="nc">GeneratedMessage</span><span class="o">.</span><span class="na">GeneratedExtension</span><span class="o">&lt;</span><span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">id</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd</span><span class="o">.</span><span class="na">getServices</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Descriptors</span><span class="o">.</span><span class="na">ServiceDescriptor</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getServices</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">world</span> <span class="o">=</span> <span class="n">getMethodOptionValue</span><span class="o">(</span><span class="n">sd</span><span class="o">,</span> <span class="nc">Hello</span><span class="o">.</span><span class="na">hello</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">world</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span>
      <span class="k">return</span> <span class="n">world</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python d93533ac-8c10-4301-8f9a-6ab27c450c35"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_method_option_value</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="n">md</span> <span class="o">=</span> <span class="n">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">md</span><span class="p">:</span> <span class="n">get_option_value</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">GetOptions</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">get_option_value</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">GetOptions</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_method_extension</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">svc_name</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">.</span><span class="n">services_by_name</span><span class="p">:</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">.</span><span class="n">services_by_name</span><span class="p">[</span><span class="n">svc_name</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">get_method_option_value</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp 5e24ec33-b5d5-4b06-b291-327af31d0f17"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">private</span> <span class="n">T</span> <span class="n">GetMethodOptionValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="k">this</span> <span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">FileDescriptor</span> <span class="n">fd</span><span class="p">,</span>
  <span class="n">pb</span><span class="p">::</span><span class="n">Extension</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodOptions</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">id</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="n">fd</span><span class="p">.</span><span class="n">Services</span>
       <span class="p">.</span><span class="nf">GetServiceMethod</span><span class="p">(</span><span class="n">md</span> <span class="p">=&gt;</span> <span class="n">md</span><span class="p">.</span><span class="nf">GetOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
       <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">()</span>
       <span class="p">.</span><span class="nf">GetOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</code></pre></div></div>
</li></ul>
<h3 id="usage">Usage</h3>
<p>Let's see how to use that in our main function.</p>
<ul class="code-tab-container 8df3db8f-fe4b-4e6a-9805-9f6d48e07574"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8df3db8f-fe4b-4e6a-9805-9f6d48e07574', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '8df3db8f-fe4b-4e6a-9805-9f6d48e07574', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '8df3db8f-fe4b-4e6a-9805-9f6d48e07574', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '8df3db8f-fe4b-4e6a-9805-9f6d48e07574', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '8df3db8f-fe4b-4e6a-9805-9f6d48e07574', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 8df3db8f-fe4b-4e6a-9805-9f6d48e07574"><li class="code_switcher_container_parent active-tab code_switcher_go 8f79719f-f805-4b2a-8a00-0f024306ec75"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">// pb.File_proto_world_proto is the generated FileDescriptor</span>
  <span class="c">// and pb.E_Hello the generated custom option</span>
  <span class="n">world</span> <span class="o">:=</span> <span class="n">getMethodExtension</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="n">pb</span><span class="o">.</span><span class="n">File_proto_world_proto</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">E_Hello</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">world</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">*</span><span class="n">world</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp c916aaeb-9917-41ee-b885-a1eaf2a88bdd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// HelloWorldService is the generated service</span>
  <span class="k">auto</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">HelloWorldService</span><span class="o">::</span><span class="n">descriptor</span><span class="p">();</span>
  <span class="c1">// hello is the generated custom option</span>
  <span class="k">auto</span> <span class="n">world</span> <span class="o">=</span> <span class="n">get_method_option_value</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">hello</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">world</span><span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">world</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 259b1559-f636-442f-b4f7-df62fb908b06"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// World is the FileDescriptor for the file world.proto</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="nc">World</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">();</span>
  <span class="c1">// Hello.hello is the generated custom option</span>
  <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">world</span> <span class="o">=</span> <span class="n">getMethodExtension</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="nc">Hello</span><span class="o">.</span><span class="na">hello</span><span class="o">);</span>

  <span class="n">world</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">w</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">w</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python b585666c-013d-4341-bb25-a59828b67654"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">proto.world_pb2</span> <span class="kn">import</span> <span class="n">DESCRIPTOR</span> <span class="c1"># FileDescriptor for world.proto
</span>
<span class="k">print</span><span class="p">(</span><span class="n">get_method_extension</span><span class="p">(</span><span class="n">DESCRIPTOR</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">))</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp 465d0992-b23d-41fe-a26c-e228c025fef1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// HelloExtensions.Hello is the generated custom option</span>
  <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">HelloExtensions</span><span class="p">.</span><span class="n">Hello</span><span class="p">;</span>
  <span class="c1">// WorldReflection.Descriptor is the FileDescriptor for the file world.proto</span>
  <span class="kt">string</span> <span class="n">world</span> <span class="p">=</span> <span class="n">WorldReflection</span><span class="p">.</span><span class="n">Descriptor</span><span class="p">.</span><span class="nf">GetMethodOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">world</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">world</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="back-to-the-problem">Back to the Problem</h2>
<p>Now, as I mentioned I was trying to detect which routes need authentication with the help of such a custom option. It is not that hard to imagine the code we saw in the previous section work for an extension like the following:</p>
<div class="code_switcher_container_parent af0ab1e3-006d-4d6a-8ba3-639abfd56506"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="na">is_authenticated</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Then, we can use it like so:</p>
<div class="code_switcher_container_parent bb28693e-a44d-48de-98ca-74ebfab7e630"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">service</span> <span class="n">CheckoutService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">Checkout</span> <span class="p">(</span><span class="n">CheckoutRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CheckoutResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">option</span> <span class="p">(</span><span class="n">is_authenticated</span><span class="p">)</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>And with that we can get the value from the code we wrote earlier. We just need to be requesting the methods with Option having the id &quot;is_authenticated&quot; and make sure that we are asking for a boolean instead of a string.</p>
<h2 id="conclusion">Conclusion</h2>
<p>While this is a little bit hard to work directly with the Protobuf library, automating simple tasks like checking which routes need authentication save a lot of effort. I hope that you will find this content interesting and that you will share some of the extensions that you wrote.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Protobuf" /><summary type="html"><![CDATA[Recently I had to design authentication for a Blazor Application. After finishing implementing, I soon faced the need to know which RPC endpoint needs authentication and which doesn't. And while part of the problem is a solved one, I still needed a mechanism to let me define this. Let's see how.]]></summary></entry><entry><title type="html">Parse go module files</title><link href="https://clement-jean.github.io/parse_go_module_files/" rel="alternate" type="text/html" title="Parse go module files" /><published>2023-03-30T00:00:00+08:00</published><updated>2023-03-30T00:00:00+08:00</updated><id>https://clement-jean.github.io/parse_go_module_files</id><content type="html" xml:base="https://clement-jean.github.io/parse_go_module_files/"><![CDATA[<p>Did you ever need to know, inside your program, on which go version you are running? That's what we are going to solve today. The most common use case for this is logging. We want to be able to debug by reproducing the environment of where the binary is running as close as possible. This starts by knowing which version of go we are using.</p>
<h1 id="setup">Setup</h1>
<p>To get started doing that, we will need a go module. Let's create that:</p>
<div class="code_switcher_container_parent 8ce5eac4-8f9a-4e8e-b848-76361a128de5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go mod init test.com
</code></pre></div></div>
</div>
<p>We should now have a go.mod file in our folder. If you inspect this file, we can get the go version which will be used for compiling the project. It looks like this:</p>
<ul class="code-tab-container 05bc94f7-d716-4b10-8018-aba7d13d4d7b"><li class="active-tab code_switcher_text"><a onclick="selectTab('code_switcher_text', '05bc94f7-d716-4b10-8018-aba7d13d4d7b', 0)">go.mod</a></li></ul><ul class="code-tab-switcher 05bc94f7-d716-4b10-8018-aba7d13d4d7b"><li class="code_switcher_container_parent active-tab code_switcher_text 2814827c-4bbb-479e-b208-752c1401bc41"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module test.com

go 1.20
</code></pre></div></div>
</li></ul>
<p>That's pretty much it. We will use this file to get the info we want.</p>
<h1 id="go-command">Go Command</h1>
<p>One thing that I learned recently is that we can actually get a JSON representation of or modules, workspaces, ... via the command line. To do that, we can run the following command:</p>
<div class="code_switcher_container_parent 2b88af3c-5e0e-436e-8eca-f19d1a7c9a43"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go mod edit <span class="nt">-json</span>
<span class="o">{</span>
  <span class="s2">"Module"</span>: <span class="o">{</span>
    <span class="s2">"Path"</span>: <span class="s2">"test.com"</span>
  <span class="o">}</span>,
  <span class="s2">"Go"</span>: <span class="s2">"1.20"</span>,
  <span class="s2">"Require"</span>: null,
  <span class="s2">"Exclude"</span>: null,
  <span class="s2">"Replace"</span>: null,
  <span class="s2">"Retract"</span>: null
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>And we have our JSON!</p>
<h1 id="parsing-json">Parsing JSON</h1>
<p>The only thing left to do is execute this command in our main, Unmarshal the JSON result and we should be able to get the version.</p>
<p>First, let's define the structs into which we will Unmarshal to.</p>
<ul class="code-tab-container 3245209b-aa80-4f17-aa8a-23a78d7b858b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '3245209b-aa80-4f17-aa8a-23a78d7b858b', 0)">main.go</a></li></ul><ul class="code-tab-switcher 3245209b-aa80-4f17-aa8a-23a78d7b858b"><li class="code_switcher_container_parent active-tab code_switcher_go d137937c-bb44-4b1e-9515-776cbf900ed8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Module</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Path</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">GoMod</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Module</span> <span class="n">Module</span>
  <span class="n">Go</span>     <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Notice here that I'm not taking Require, Exclude, ... into account. We only want the Go string.</p>
<p>After that, the rest is pretty easy. We can execute a command line and get its stdout result like so:</p>
<div class="code_switcher_container_parent c0431afc-6d30-4a87-af2f-ecb4bbd266ad"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"go"</span><span class="p">,</span> <span class="s">"mod"</span><span class="p">,</span> <span class="s">"edit"</span><span class="p">,</span> <span class="s">"-json"</span><span class="p">)</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
</code></pre></div></div>
</div>
<p>I'm skipping the err handling here by dropping the error with _ but make sure to handle this for production-grade scripts.</p>
<p>And finally, we use <code>json.Unmarshal</code> function which takes the ouput of the command line, and the destination of where we want to populate the data. In our case, this is an instance of GoMod.</p>
<p>In the end, the main function looks like:</p>
<ul class="code-tab-container b28bb88a-c9b5-4995-9c7b-3c77140d655c"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b28bb88a-c9b5-4995-9c7b-3c77140d655c', 0)">main.go</a></li></ul><ul class="code-tab-switcher b28bb88a-c9b5-4995-9c7b-3c77140d655c"><li class="code_switcher_container_parent active-tab code_switcher_go a6fa7a84-d9e3-4ace-b5cb-71e91410b2e3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"encoding/json"</span>
  <span class="s">"fmt"</span>
  <span class="s">"os/exec"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Module</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Path</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">GoMod</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Module</span> <span class="n">Module</span>
  <span class="n">Go</span>     <span class="kt">string</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">mod</span> <span class="n">GoMod</span>
  <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"go"</span><span class="p">,</span> <span class="s">"mod"</span><span class="p">,</span> <span class="s">"edit"</span><span class="p">,</span> <span class="s">"-json"</span><span class="p">)</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="p">);</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">Go</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We can run that, and we get:</p>
<div class="code_switcher_container_parent e1ff0315-7237-4018-a305-6575e888d8b7"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go run main.go
1.20
</code></pre></div></div>
</div>
<p>We now have our Go version at runtime and we can use it for logging, selecting features, ...</p>
<h1 id="the-problem">The Problem</h1>
<p>Obviously, what we saw is far from great. What if we compile our go project to binary and the go.mod is not around anymore. Well, basically it doesn't work.</p>
<p>I'm presenting to you this idea because combined with the right tool to build your project, you can actually embed the version inside your binary. This can be done with ldflags (check <a href="https://blog.alexellis.io/inject-build-time-vars-golang/">Alex Ellis blog post</a> on the subject). But this can also be done with Bazel and <a href="https://bazel.build/docs/user-manual#workspace-status">stamping</a>. If you are interested in knowing how to do that, let me know.</p>
<h1 id="conclusion">Conclusion</h1>
<p>In this short post, we saw how to get the go version on which a go project is compiled at runtime. This can be used in multiple ways, but the use case that has come to me is mostly logging. I hope this is interesting for you.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><summary type="html"><![CDATA[Did you ever need to know, inside your program, on which go version you are running? That's what we are going to solve today. The most common use case for this is logging. We want to be able to debug by reproducing the environment of where the binary is running as close as possible. This starts by knowing which version of go we are using.]]></summary></entry><entry><title type="html">Go Monorepos - Intro</title><link href="https://clement-jean.github.io/go-monorepos-intro/" rel="alternate" type="text/html" title="Go Monorepos - Intro" /><published>2023-03-16T00:00:00+08:00</published><updated>2023-03-16T00:00:00+08:00</updated><id>https://clement-jean.github.io/go-monorepos-intro</id><content type="html" xml:base="https://clement-jean.github.io/go-monorepos-intro/"><![CDATA[<p>Recently I've discovered two interesting was in creating monorepos for go projects. In this article we are going to talk about the advantages and disadvantages of each of these techniques.</p>
<p>This article is an introduction. I will skip over details here because the setup is generally dependent on the technologies you use. <strong>If this article makes you want to know more about the subject, I invite you to tell me with which technology I should set a monorepo for (e.g. gRPC)</strong>.</p>
<h1 id="go-workspaces">Go Workspaces</h1>
<p>The first of these techniques are using Go workspaces. This is nice to be able to do that without any other technology than Go. The goal here is basically to create submodules and link them to the workspace. Let's see an example.</p>
<p>Let's say that we have a server and a client. We will then have the following file architecture:</p>
<div class="code_switcher_container_parent dd47b63c-fc00-439e-aa20-e23f9d35faea"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>.
├── client
└── server
</code></pre></div>
<p>with that we can start initializing our modules. You can either go into each folder and run <code>go mod init &lt;module_name&gt;</code>, or you can automatize the process and run something like:</p>
<ul class="code-tab-container d4d765f7-66ac-471c-b1a4-e6465c49aedd"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'd4d765f7-66ac-471c-b1a4-e6465c49aedd', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'd4d765f7-66ac-471c-b1a4-e6465c49aedd', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher d4d765f7-66ac-471c-b1a4-e6465c49aedd"><li class="code_switcher_container_parent active-tab code_switcher_shell d388d9a8-97e1-41be-8cc8-9398939f008a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-maxdepth</span> 1 <span class="nt">-type</span> d <span class="nt">-not</span> <span class="nt">-path</span> <span class="nb">.</span> <span class="nt">-execdir</span> sh <span class="nt">-c</span> <span class="s2">"pushd {}; go mod init '&lt;module_name&gt;/{}'; popd"</span> <span class="s2">";"</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_shell 6f921f6d-a78e-4167-83ea-27276e538b97"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ChildItem <span class="nb">.</span> <span class="nt">-Name</span> <span class="nt">-Directory</span> | ForEach-Object <span class="o">{</span> Push-Location <span class="nv">$_</span><span class="p">;</span> go mod init <span class="s2">"&lt;module_name&gt;/</span><span class="nv">$_</span><span class="s2">"</span> <span class="p">;</span> Pop-Location <span class="o">}</span>
</code></pre></div></div>
</li></ul>
<p>These commands will enter each directory, run <code>go mod init</code>, and get out of the directories. <strong>Be careful though, if you have other folders that you don't want to use as modules, you will have to create more complex commands</strong>.</p>
<p>Once we have this, we can create our workspace. To do that, we simply run:</p>
<div class="code_switcher_container_parent a8ede4a1-b94f-4bc3-8dc8-c1da49197cd2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go work init client server
</code></pre></div></div>
</div>
<p>And that's basically it. Client and Server and individual projects that can have their own set of dependencies and you can run each of them at the root folder by running:</p>
<div class="code_switcher_container_parent 08e37a63-8fd3-4e02-be16-60d1717a7158"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go run ./server
</code></pre></div></div>
</div>
<p>and</p>
<div class="code_switcher_container_parent 7dc2fddc-1b7e-46ce-b4c1-df75b3c91131"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go run ./client
</code></pre></div></div>
</div>
<h2 id="advantages">Advantages</h2>
<ul>
<li>This is pretty low-tech. We only need Go.</li>
<li>Pretty quick setup for new projects.</li>
<li>Each of the module can get their own dependencies and they can also share some.</li>
</ul>
<h2 id="disadvantages">Disadvantages</h2>
<ul>
<li>All the subprojects need to be written in Go for it to work as intended.</li>
<li>Setup for already existing and complex projects might be hard.</li>
</ul>
<h1 id="bazel">Bazel</h1>
<p>Because setting up a project in Bazel is highly dependent on which technology you want to use, I will not go into to much details here. But the idea with Bazel is that we can have the same kind of monorepo as we saw but we can do this is multi-languages.</p>
<p>If we have a client written in JS and a backend written in Go, we will have a BUILD.bazel file for each subprojects defining how to build each part of the projects. And at the root level we will have a WORKSPACE.bazel file which describes all the build dependencies.</p>
<p>Finally, if you are working with Go modules, <a href="https://github.com/bazelbuild/bazel-gazelle">Gazelle</a> (a BUILD.bazel file generator) can help you write all the build boilerplate for you and let you focus on your code.</p>
<h2 id="advantages-1">Advantages</h2>
<ul>
<li>Once it is set up, it is very efficient to run commands.</li>
<li>Multi-language monorepos.</li>
<li>Setup for already existing and complex projects is easier with Gazelle. Note that this is only for Go.</li>
</ul>
<h2 id="disadvantages-1">Disadvantages</h2>
<ul>
<li>Harder upfront cost for setup.</li>
</ul>
<h1 id="conclusion">Conclusion</h1>
<p>In this article, we got an overview of two ways of building monorepos in Go or in multi-language setups. We saw that when we have a newer project we can use Go Workspaces as this is a low-tech way of starting building a monorepo. However, if we decide to have a multi-language setup we will have to move to Bazel. <strong>There are obviously more choices to be made depending on the kind of project you are making and that's why I want your feedback on what I should build</strong>.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="Bazel" /><summary type="html"><![CDATA[Recently I've discovered two interesting was in creating monorepos for go projects. In this article we are going to talk about the advantages and disadvantages of each of these techniques.]]></summary></entry><entry><title type="html">Protein: Parser (Part 1)</title><link href="https://clement-jean.github.io/protein_parser_part_1/" rel="alternate" type="text/html" title="Protein: Parser (Part 1)" /><published>2023-03-09T00:00:00+08:00</published><updated>2023-03-09T00:00:00+08:00</updated><id>https://clement-jean.github.io/protein_parser_part_1</id><content type="html" xml:base="https://clement-jean.github.io/protein_parser_part_1/"><![CDATA[<p>In this article we are going to finally get to building the Parser. We are going to start parsing syntax, package and import statements, and we are going to see how to represent our serializable AST. Hope you are ready for this, it's gonna be fun!</p>
<h2 id="boilerplate">Boilerplate</h2>
<p>As always, we need to think a little bit before to actually write the features themselves. The first thing that we can do to get us started is to write the Parser interface.</p>
<ul class="code-tab-container d6c7f403-7a53-4465-92ac-16f46089b326"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd6c7f403-7a53-4465-92ac-16f46089b326', 0)">parser/parser.go</a></li></ul><ul class="code-tab-switcher d6c7f403-7a53-4465-92ac-16f46089b326"><li class="code_switcher_container_parent active-tab code_switcher_go 7e32a069-89c9-4a97-b05d-452a1b88d005"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="c">// Parser is protein's parser</span>
<span class="k">type</span> <span class="n">Parser</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// Parse returns ???</span>
  <span class="n">Parse</span><span class="p">()</span> <span class="err">???</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This doesn't seem like a fancy interface but we do have a problem. What is our parser returning when finished? Well, it should return an AST, right? But how do we represent this AST. It turns out, we have two good possibilities:</p>
<ul>
<li>We roll our own serializable AST where each object is a Protobuf Message.</li>
<li>We use the descriptor.proto file which defines Messages for describing elements in a Protobuf file.</li>
</ul>
<p>Both have pros and cons. If we go with the first one we have more control over our serialization. It means that we can optimize some elements' serialized data. However, it also means that we are not compatible with the official way and that's not good.
For the &quot;using the official serialization&quot;, I think you get the idea. We have the pros being the cons of the other implementation, and the cons being the pros of the other implementation.</p>
<p>In the end, for the sake of compatibility, I will be sacrificing some performance. However, these performances are only saving a few bytes and having compatibility with programs serialized by protoc far overweights them.</p>
<h3 id="depending-on-protobuf">Depending on Protobuf</h3>
<p>To use the descriptor, we are going to depend on Protobuf's library. To do that we are going to add in our dependency:</p>
<div class="code_switcher_container_parent 0e269f09-4c25-4131-84c3-cc6c471f445d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go get google.golang.org/protobuf
</code></pre></div></div>
</div>
<p>This will let us access <code>descriptorpb</code> package, which contains the <code>FileDescriptorProto</code> struct. If you look at the definition of that struct, you will see the following comment:</p>
<div class="code_switcher_container_parent 4dad5c70-d4bd-42fc-a91f-e761f7ec0ca5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Describes a complete .proto file.</span>
<span class="k">type</span> <span class="n">FileDescriptorProto</span> <span class="k">struct</span>
</code></pre></div></div>
</div>
<p>That's exactly what we are trying to do.</p>
<h3 id="back-to-interface">Back to interface</h3>
<p>With that dependency on Protobuf, we can now finish our interface:</p>
<ul class="code-tab-container 1b691e28-4972-4e3b-9da2-efdd34a9f985"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '1b691e28-4972-4e3b-9da2-efdd34a9f985', 0)">parser/parser.go</a></li></ul><ul class="code-tab-switcher 1b691e28-4972-4e3b-9da2-efdd34a9f985"><li class="code_switcher_container_parent active-tab code_switcher_go 72e659a4-579c-44ea-8a80-bd78361090a8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="n">pb</span> <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>

<span class="c">// Parser is protein's parser</span>
<span class="k">type</span> <span class="n">Parser</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// Parse returns the representation of a file in Protobuf Descriptor</span>
  <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="implementation">Implementation</h2>
<p>Let's now implement the interface. But by now you know the drill. We are going to create a minimal implementation so that our first test fails. So what we need is an <code>Impl</code> struct and we need to implement <code>Parser</code> by writing the <code>Parse</code> function.</p>
<p>For now, the <code>Parse</code> function will simply return an empty <code>FileDescriptorProto</code>.</p>
<ul class="code-tab-container 304a7ee7-f9cf-44ff-9113-c362e25a82d4"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '304a7ee7-f9cf-44ff-9113-c362e25a82d4', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 304a7ee7-f9cf-44ff-9113-c362e25a82d4"><li class="code_switcher_container_parent active-tab code_switcher_go f6717f5b-3d00-461e-9a00-7fd8264522ba"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="n">pb</span> <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>
<span class="p">)</span>

<span class="c">// Impl is the implementation for the Parser interface.</span>
<span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span>
<span class="p">}</span>

<span class="c">// New creates a new instance of the Parser</span>
<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span><span class="p">)</span> <span class="n">Parser</span> <span class="p">{</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span><span class="n">l</span><span class="o">:</span> <span class="n">l</span><span class="p">}</span>
  <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// Parse populates a FileDescriptorProto</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>
  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h3 id="first-test">First test</h3>
<p>As our first test we are going to create the test for a syntax statement. This test will take advantage of the fact that <code>Lexer</code> is an interface by creating a <code>FakeLexer</code>. This fake lexer will simply iterate over an array of tokens and return them one by one.</p>
<ul class="code-tab-container b2550898-0db5-4595-b92c-76c1ef7140b7"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b2550898-0db5-4595-b92c-76c1ef7140b7', 0)">parser/parser_test.go</a></li></ul><ul class="code-tab-switcher b2550898-0db5-4595-b92c-76c1ef7140b7"><li class="code_switcher_container_parent active-tab code_switcher_go 804230e3-3fb8-46b3-b732-b058706cf9b9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">FakeLexer</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">i</span>      <span class="kt">int</span>
  <span class="n">tokens</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">FakeLexer</span><span class="p">)</span> <span class="n">NextToken</span><span class="p">()</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}}</span>
  <span class="p">}</span>

  <span class="n">token</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
  <span class="n">l</span><span class="o">.</span><span class="n">i</span><span class="o">++</span>
  <span class="k">return</span> <span class="n">token</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This basically means that each time we are running a test in the parser, we are not going to run the lexer code. We are going to simply focus on our current features. So, if we encounter a bug, it means that it is in the parser, not anywhere else.</p>
<p>With that, we can write our first test for <code>syntax = &quot;proto3&quot;;</code>.</p>
<ul class="code-tab-container 7bc722a1-602a-4e2e-8344-09637609a6d6"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '7bc722a1-602a-4e2e-8344-09637609a6d6', 0)">parser/parser_syntax_test.go</a></li></ul><ul class="code-tab-switcher 7bc722a1-602a-4e2e-8344-09637609a6d6"><li class="code_switcher_container_parent active-tab code_switcher_go 6d961f9e-f755-4e14-b159-ab4dd967a681"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParseSyntaxProto3</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"syntax"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenEqual</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"="</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">proto3</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"proto3"</span>

  <span class="k">if</span> <span class="n">syntax</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetSyntax</span><span class="p">();</span> <span class="n">syntax</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"syntax wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">syntax</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Obviously:</p>
<div class="code_switcher_container_parent e5fb6fef-e1c8-46e4-b8e8-2d537a7dc50b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParseSyntaxProto3 <span class="o">(</span>0.00s<span class="o">)</span>
    parser_syntax_test.go:22: syntax wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'proto3'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
FAIL
</code></pre></div></div>
</div>
<h3 id="parsing">Parsing</h3>
<p>We should now improve the <code>Parse</code> function to consume the <code>Lexer</code>'s tokens and do things with that. Here is the pseudo code:</p>
<div class="code_switcher_container_parent f6500b71-2175-4e26-8c28-45530ab11be2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">currToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">EOF</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">currToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">Identifier</span> <span class="p">{</span>
    <span class="n">fn</span> <span class="o">:=</span> <span class="n">parseFuncs</span><span class="p">[</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">]</span> <span class="c">// find the function depending on keyword</span>
    <span class="n">fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">)</span> <span class="c">// populate the descriptor</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>You notice that we need a <code>currToken</code> representing the current token being parsed. We will also need the peek token for parsing syntax and other statements. This is because we are going to make sure each time that the peek token is correct, otherwise we will return an error. So <code>Impl</code> now has a <code>currToken</code> and <code>peekToken</code>:</p>
<ul class="code-tab-container 6c964b67-25d9-4ced-8a38-80b36d37e86e"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '6c964b67-25d9-4ced-8a38-80b36d37e86e', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 6c964b67-25d9-4ced-8a38-80b36d37e86e"><li class="code_switcher_container_parent active-tab code_switcher_go efc29b8c-6de5-4a47-944f-02210d588dad"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span>
  <span class="n">curToken</span>  <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
  <span class="n">peekToken</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Now, we need to populate these tokens before being able to use them. The first time we need to initialize them is in the <code>New</code> function.</p>
<ul class="code-tab-container 25b71981-b2b5-459d-8f38-fef97e922370"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '25b71981-b2b5-459d-8f38-fef97e922370', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 25b71981-b2b5-459d-8f38-fef97e922370"><li class="code_switcher_container_parent active-tab code_switcher_go 95c9d5bf-8b3c-4e32-a39e-d99aa3ca2069"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span><span class="p">)</span> <span class="n">Parser</span> <span class="p">{</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span><span class="n">l</span><span class="o">:</span> <span class="n">l</span><span class="p">}</span>
  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>But <code>nextToken</code> is not the <code>Lexer.NextToken</code>, this is a private function in <code>Parser</code>. This is a function that looks for the next non-space token.</p>
<ul class="code-tab-container 30f91afe-3c90-401d-80fc-380da05ec731"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '30f91afe-3c90-401d-80fc-380da05ec731', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 30f91afe-3c90-401d-80fc-380da05ec731"><li class="code_switcher_container_parent active-tab code_switcher_go e888ac37-3290-47cf-8214-46c29f712b88"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">nextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSpace</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">();</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSpace</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>With that we can start updating our <code>Parse</code> function.</p>
<ul class="code-tab-container 8bb4b74e-c501-4a55-a28a-e4baf2113fd1"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8bb4b74e-c501-4a55-a28a-e4baf2113fd1', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 8bb4b74e-c501-4a55-a28a-e4baf2113fd1"><li class="code_switcher_container_parent active-tab code_switcher_go fdd1add1-e883-45d7-bbd2-448140957298"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
      <span class="c">//Do something with token</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Finally, we are going to register all the parsing functions that we are gonna write in this and next articles. We are going to have a map mapping &quot;syntax&quot; to parseSyntax, ...</p>
<ul class="code-tab-container 5b0bbfec-6ef5-47b8-86dc-42b40a2968d0"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '5b0bbfec-6ef5-47b8-86dc-42b40a2968d0', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 5b0bbfec-6ef5-47b8-86dc-42b40a2968d0"><li class="code_switcher_container_parent active-tab code_switcher_go 89fb0ea8-7b25-43a4-9b29-946143d6b410"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>With this we can finalize the <code>Parse</code> function by looking at the relevant function for the <code>currToken.Literal</code>.</p>
<ul class="code-tab-container e30d2049-6904-4494-bc97-76127814e735"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'e30d2049-6904-4494-bc97-76127814e735', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher e30d2049-6904-4494-bc97-76127814e735"><li class="code_switcher_container_parent active-tab code_switcher_go 504c181c-25ed-4d93-8220-2d32af057618"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
      <span class="n">fn</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">parseFuncs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span> <span class="c">// keyword not found</span>
        <span class="k">break</span>
      <span class="p">}</span>
      <span class="n">fn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h3 id="parsesyntax">parseSyntax()</h3>
<p>Before actually parsing a syntax statement, we need two helper functions: <code>accept</code> and <code>acceptPeek</code>. <code>acceptPeek</code> will just call <code>accept</code> with the <code>peekToken.Type</code>. <code>accept</code> take a <code>TokenType</code> and checks if it exists in the following variadic arguments.</p>
<ul class="code-tab-container 59d1448b-486a-4fe5-8df9-39d6372fcc6f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '59d1448b-486a-4fe5-8df9-39d6372fcc6f', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 59d1448b-486a-4fe5-8df9-39d6372fcc6f"><li class="code_switcher_container_parent active-tab code_switcher_go 0a898dcf-659f-491a-bb81-660066faf913"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">accept</span><span class="p">(</span><span class="n">original</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">,</span> <span class="n">expected</span> <span class="o">...</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">slices</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// TODO: add error</span>
    <span class="k">return</span> <span class="no">false</span>
  <span class="p">}</span>

  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="k">return</span> <span class="no">true</span>
<span class="p">}</span>

<span class="c">// acceptPeek returns true and advance token</span>
<span class="c">// if tt contains the peekToken.Type</span>
<span class="c">// else it returns false</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">acceptPeek</span><span class="p">(</span><span class="n">tt</span> <span class="o">...</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">tt</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And now we ready for our <code>parseSyntax</code> function. We are first going to check that we have an <code>=</code> after syntax. Then we check that we have a String, if it’s the case we are going to take the value inside the quotes. And finally, we are going to check that there is a semicolon at the end of the statement.</p>
<ul class="code-tab-container 8fdafa1a-4cc1-4c01-abd6-4f3a6fc443c8"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8fdafa1a-4cc1-4c01-abd6-4f3a6fc443c8', 0)">parser/syntax.go</a></li></ul><ul class="code-tab-switcher 8fdafa1a-4cc1-4c01-abd6-4f3a6fc443c8"><li class="code_switcher_container_parent active-tab code_switcher_go db1e5948-9c5b-40ce-92aa-73f8ca32e213"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parseSyntax</span><span class="p">()</span> <span class="o">*</span><span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenEqual</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="n">s</span> <span class="o">:=</span> <span class="n">destringify</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>The <code>destringify</code> function looks like the following:</p>
<ul class="code-tab-container 97830676-d19d-4967-bccb-bebe6209227a"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '97830676-d19d-4967-bccb-bebe6209227a', 0)">parser/utils.go</a></li></ul><ul class="code-tab-switcher 97830676-d19d-4967-bccb-bebe6209227a"><li class="code_switcher_container_parent active-tab code_switcher_go bb791916-6b28-49e5-8d36-28d211efcaf5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="s">"strings"</span>

<span class="k">func</span> <span class="n">destringify</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">strings</span><span class="o">.</span><span class="n">TrimFunc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="kt">rune</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\'</span><span class="err">'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'"'</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>As mentioned, it takes the values between the quotes.</p>
<p>With our <code>parseSyntax</code> finished, we can rerun the test and:</p>
<div class="code_switcher_container_parent ac8a5512-f3f4-49d8-ae06-4c3734ee64ee"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  1.361s
</code></pre></div></div>
</div>
<h3 id="parseimport">parseImport()</h3>
<p><code>parseImport</code> is really similar to <code>parseSyntax</code>. However, with imports, we get introduced to optional keywords. An import can be written in 3 ways:</p>
<ul>
<li><code>import &quot;my.proto&quot;;</code></li>
<li><code>import public &quot;my.proto&quot;;</code></li>
<li><code>import weak &quot;my.proto&quot;;</code></li>
</ul>
<p>Let's write the tests:</p>
<ul class="code-tab-container f76d67c4-22be-4933-ae92-17d7ebc7d113"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f76d67c4-22be-4933-ae92-17d7ebc7d113', 0)">parser/parser_import_test.go</a></li></ul><ul class="code-tab-switcher f76d67c4-22be-4933-ae92-17d7ebc7d113"><li class="code_switcher_container_parent active-tab code_switcher_go 91df2643-f76a-4f73-964d-48a720637dae"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParseImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParsePublicImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"public"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{</span><span class="m">0</span><span class="p">}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParseWeakImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"weak"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{</span><span class="m">0</span><span class="p">}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Obviously:</p>
<div class="code_switcher_container_parent 5e0cb519-ec0e-475b-9c6e-23b459e0b5bd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParseImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:25: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
<span class="nt">---</span> FAIL: TestParsePublicImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:52: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
<span class="nt">---</span> FAIL: TestParseWeakImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:79: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
FAIL
</code></pre></div></div>
</div>
<p>Even though the 2nd and 3rd one are rarely used, we still need to support them. To do so, we are going to need to create an enum called <code>DependencyType</code> which will have the variants: None, Public, and Weak. After that, we are going to check if we have an identifier and depending on the <code>Literal</code>, we are going to return the type.</p>
<ul class="code-tab-container fee36fde-2633-4ff9-a2d5-b49aaef18056"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'fee36fde-2633-4ff9-a2d5-b49aaef18056', 0)">parser/import.go</a></li></ul><ul class="code-tab-switcher fee36fde-2633-4ff9-a2d5-b49aaef18056"><li class="code_switcher_container_parent active-tab code_switcher_go e874997a-dbdd-427b-8026-3a0d542bd352"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"fmt"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">DependencyType</span> <span class="kt">int</span>

<span class="k">const</span> <span class="p">(</span>
  <span class="n">None</span> <span class="n">DependencyType</span> <span class="o">=</span> <span class="no">iota</span>
  <span class="n">Public</span>
  <span class="n">Weak</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parseImport</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">DependencyType</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
  <span class="p">}</span>

  <span class="n">depType</span> <span class="o">:=</span> <span class="n">None</span>

  <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">"public"</span><span class="o">:</span>
      <span class="n">depType</span> <span class="o">=</span> <span class="n">Public</span>
    <span class="k">case</span> <span class="s">"weak"</span><span class="o">:</span>
      <span class="n">depType</span> <span class="o">=</span> <span class="n">Weak</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">)</span> <span class="p">{</span>
      <span class="c">// TODO: add error</span>
      <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">s</span> <span class="o">:=</span> <span class="n">destringify</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">depType</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And the last thing we need to do is register that to the <code>parseFuncs</code>.</p>
<ul class="code-tab-container f2b332d2-97ca-45bf-bb28-5a7296173dc8"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f2b332d2-97ca-45bf-bb28-5a7296173dc8', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher f2b332d2-97ca-45bf-bb28-5a7296173dc8"><li class="code_switcher_container_parent active-tab code_switcher_go ce4e66cc-3ef9-4a04-99f1-e0fe7ecf6d8a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"import"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dep</span><span class="p">,</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseImport</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">))</span>
      <span class="n">d</span><span class="o">.</span><span class="n">Dependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
      <span class="k">switch</span> <span class="n">t</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">Public</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">Weak</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We basically append the dependency and if we have a public or weak dependency we add its index into <code>PublicDependency</code> and <code>WeakDependency</code> respectively.</p>
<p>We rerun our test:</p>
<div class="code_switcher_container_parent 8f720470-2b94-45a4-9241-d9be972d07de"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  0.450s
</code></pre></div></div>
</div>
<h3 id="parsepackage">parsePackage()</h3>
<p>Once again this function is pretty similar. The main difference is that we are going to look for identifiers and fully qualified names (identifiers separated by dots).</p>
<p>Let's write some tests.</p>
<ul class="code-tab-container 1f61d8c5-0bdb-44b2-bdcf-0c34dce108f1"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '1f61d8c5-0bdb-44b2-bdcf-0c34dce108f1', 0)">parser/parser_package_test.go</a></li></ul><ul class="code-tab-switcher 1f61d8c5-0bdb-44b2-bdcf-0c34dce108f1"><li class="code_switcher_container_parent active-tab code_switcher_go be9a9f80-04f0-485d-94a8-9eb131584237"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParsePackage</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"package"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"google"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"google"</span>

  <span class="k">if</span> <span class="n">pkg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPackage</span><span class="p">();</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"package wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParsePackageFullIdentifier</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"package"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"google"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenDot</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"."</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"protobuf"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"google.protobuf"</span>

  <span class="k">if</span> <span class="n">pkg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPackage</span><span class="p">();</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"package wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Let's fail our tests:</p>
<div class="code_switcher_container_parent 9a3b1494-331f-47dc-9214-1c5400f6f960"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParsePackage <span class="o">(</span>0.00s<span class="o">)</span>
    parser_package_test.go:21: package wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'google'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
<span class="nt">---</span> FAIL: TestParsePackageFullIdentifier <span class="o">(</span>0.00s<span class="o">)</span>
    parser_package_test.go:39: package wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'google.protobuf'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
FAIL
</code></pre></div></div>
</div>
<p>And now we can implement the <code>parsePackage</code> function. We are going to check that we have at least one identifier, and then if we have a dot we are going to make sure that we have another identifier after. Finally, we will be looking for the semicolon.</p>
<ul class="code-tab-container a6846781-510e-4850-a440-9fdd44143926"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'a6846781-510e-4850-a440-9fdd44143926', 0)">parser/package.go</a></li></ul><ul class="code-tab-switcher a6846781-510e-4850-a440-9fdd44143926"><li class="code_switcher_container_parent active-tab code_switcher_go a2c76bd0-84d8-41e2-8947-cb8c38f39f4a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"strings"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parsePackage</span><span class="p">()</span> <span class="o">*</span><span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">var</span> <span class="n">parts</span> <span class="p">[]</span><span class="kt">string</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenDot</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">nil</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">s</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="s">"."</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>The last thing to do is to register this function in our <code>parseFuncs</code>.</p>
<ul class="code-tab-container 69412113-bce7-4b0b-b098-970cc7bdd087"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '69412113-bce7-4b0b-b098-970cc7bdd087', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 69412113-bce7-4b0b-b098-970cc7bdd087"><li class="code_switcher_container_parent active-tab code_switcher_go 8108905d-ae6e-4c14-b922-c6b6160bb260"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"package"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Package</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parsePackage</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"import"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dep</span><span class="p">,</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseImport</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">))</span>
      <span class="n">d</span><span class="o">.</span><span class="n">Dependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
      <span class="k">switch</span> <span class="n">t</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">Public</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">Weak</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and we rerun our tests.</p>
<div class="code_switcher_container_parent c6242e94-49e2-49fa-bb43-ad460309f378"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  0.847s
</code></pre></div></div>
</div>
<h1 id="conclusion">Conclusion</h1>
<p>In this article, we created our first three parsing functions. We parsed syntax, package and imports. We are now ready to go more complicated statements.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>
<div class="container">
  <div class="row">
    <div class="col text-center">
      <a href="/protein_lexer_part_3" class="btn btn-danger text-center">Previous Article</a>
    </div>
    <!-- <div class="col text-center">
      <a href="/protein_lexer_part_1" class="btn btn-danger text-center">Next Article</a>
    </div> -->
  </div>
</div>]]></content><author><name>Clement</name></author><category term="Protocol Buffers" /><category term="Go" /><summary type="html"><![CDATA[In this article we are going to finally get to building the Parser. We are going to start parsing syntax, package and import statements, and we are going to see how to represent our serializable AST. Hope you are ready for this, it's gonna be fun!]]></summary></entry><entry><title type="html">Protein: Lexer (Part 3)</title><link href="https://clement-jean.github.io/protein_lexer_part_3/" rel="alternate" type="text/html" title="Protein: Lexer (Part 3)" /><published>2023-03-03T00:00:00+08:00</published><updated>2023-03-03T00:00:00+08:00</updated><id>https://clement-jean.github.io/protein_lexer_part_3</id><content type="html" xml:base="https://clement-jean.github.io/protein_lexer_part_3/"><![CDATA[<p>This article is a small one intended to solve a bug related to token position. As of right now, we only tested that our token got the right literal and the right token kind. In this article, we are going to add the position checking in our tests.</p>
<h2 id="position-checking">Position Checking</h2>
<p>Adding position checking in our test is pretty trivial since it's 3 ifs checking <code>Offset</code>, <code>Line</code>, and <code>Column</code>. So let's add that:</p>
<ul class="code-tab-container e8daa424-2d41-4688-92f9-a8e0ef01c5b5"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'e8daa424-2d41-4688-92f9-a8e0ef01c5b5', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher e8daa424-2d41-4688-92f9-a8e0ef01c5b5"><li class="code_switcher_container_parent active-tab code_switcher_go 18e9b6e4-a49f-435d-9b34-6ebbb3f12089"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">l</span> <span class="n">Lexer</span><span class="p">,</span> <span class="n">tests</span> <span class="p">[]</span><span class="n">Check</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="c">//...</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Offset</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Offset</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - offset wrong. expected=%d, got=%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Offset</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Offset</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Line</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Line</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - line wrong. expected=%d, got=%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Line</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Line</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Column</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Column</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - column wrong. expected=%d, got=%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Column</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Column</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And now if we run our tests, we should have a lot of errors coming from the fact that Go will initialize <code>Offset</code>, <code>Line</code>, and <code>Column</code> to 0 (default value). An example of error received is:</p>
<div class="code_switcher_container_parent 1b59121c-5b72-4f20-8706-db1365f07a9c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./..
<span class="nt">---</span> FAIL: TestNextTokenOnSymbols <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:31: tests[0] - line wrong. <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">got</span><span class="o">=</span>1
FAIL
</code></pre></div></div>
</div>
<blockquote>
<p>Before going to the new section, make sure that you update the position objects in your tests. If you are not willing to calculate all of the positions, you can just refer to the <a href="https://github.com/Clement-Jean/protein/blob/lexer/lexer/lexer_test.go">tests in the github repo</a> where I did it for you.</p>
</blockquote>
<h2 id="a-bug-">A bug ?!</h2>
<p>Now that we have all our positions set, we can rerun our tests.</p>
<div class="code_switcher_container_parent 3aa5059c-bde7-4bee-86f6-0a6f392d962a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./..
<span class="nt">---</span> FAIL: TestNextTokenOnSpace <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:35: tests[1] - column wrong. <span class="nv">expected</span><span class="o">=</span>4, <span class="nv">got</span><span class="o">=</span>0
FAIL
</code></pre></div></div>
</div>
<p>And yes we have an error. Let's understand it.</p>
<p>The problem here comes from the way we handle newlines in the <code>emit</code> function. As of right now, this is done like so:</p>
<ul class="code-tab-container 6571b5ed-36e8-4328-8ebe-266655aea22b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '6571b5ed-36e8-4328-8ebe-266655aea22b', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 6571b5ed-36e8-4328-8ebe-266655aea22b"><li class="code_switcher_container_parent active-tab code_switcher_go d45cc172-19b0-4fb4-a7b3-4965d1d56b13"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">emit</span><span class="p">(</span><span class="n">tt</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">if</span> <span class="n">tt</span> <span class="o">==</span> <span class="n">TokenSpace</span> <span class="o">&amp;&amp;</span> <span class="n">strings</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span>
  <span class="p">}</span>
  <span class="c">//..</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This code is checking for a newline inside the literal and if it finds one, it will just set the index of <code>\n</code> in the literal to startLineOffset. The problem here is that we handle all consecutive spaces (the general term) as one token. So when we have <code>\t\n\v\f\r</code>, we are effectively saying that the line starts at the beginning our our space token. This is not correct, right? We should be setting <code>startLineOffset</code> to 2 (just after <code>\n</code>) and then this should affect the <code>Column</code> position because of <code>Column: l.start - l.startLineOffset</code> in the <code>Token</code> instantiation in <code>emit</code>.</p>
<p>So how do we solve that? Well, it turns out to be pretty simple. We are going to look for the last instance of <code>\n</code> in the literal and this will give us the beginning of the line. After that we are going to take the current position (which is after the token right now) and subtract it with the length of the literal minus the beginning of the line. This gives us the offset at which the line begins. So now we should have this:</p>
<ul class="code-tab-container 6af50533-babd-4077-8f49-4c5c3080566e"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '6af50533-babd-4077-8f49-4c5c3080566e', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 6af50533-babd-4077-8f49-4c5c3080566e"><li class="code_switcher_container_parent active-tab code_switcher_go 6c66d9b4-3607-418f-b1a4-bacdb3d5c71d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">emit</span><span class="p">(</span><span class="n">tt</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">if</span> <span class="n">tt</span> <span class="o">==</span> <span class="n">TokenSpace</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">lineStart</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">LastIndex</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="n">lineStart</span> <span class="o">!=</span> <span class="o">-</span><span class="m">1</span> <span class="p">{</span>
      <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span> <span class="o">-</span> <span class="n">lineStart</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c">//..</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Note that we are only finding the last index when the token kind is a space. This is important because if we do that for all the tokens we will have performance hits (especially on large tokens).</p>
<p>And now, if we rerun our test:</p>
<div class="code_switcher_container_parent d3ece552-b31b-4da0-8f8c-a580b2fc373c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.857s
</code></pre></div></div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we made the final test for our lexer and we solved a critical bug for <code>Token</code> positions. We now have a functional lexer and in the next article we are going to start the parser!</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>
<div class="container">
  <div class="row">
    <div class="col text-center">
      <a href="/protein_lexer_part_2" class="btn btn-danger text-center">Previous Article</a>
    </div>
    <div class="col text-center">
      <a href="/protein_parser_part_1" class="btn btn-danger text-center">Next Article</a>
    </div>
  </div>
</div>]]></content><author><name>Clement</name></author><category term="Protocol Buffers" /><category term="Go" /><summary type="html"><![CDATA[This article is a small one intended to solve a bug related to token position. As of right now, we only tested that our token got the right literal and the right token kind. In this article, we are going to add the position checking in our tests.]]></summary></entry><entry><title type="html">Protein: Lexer (Part 2)</title><link href="https://clement-jean.github.io/protein_lexer_part_2/" rel="alternate" type="text/html" title="Protein: Lexer (Part 2)" /><published>2023-02-20T00:00:00+08:00</published><updated>2023-02-20T00:00:00+08:00</updated><id>https://clement-jean.github.io/protein_lexer_part_2</id><content type="html" xml:base="https://clement-jean.github.io/protein_lexer_part_2/"><![CDATA[<p>In this article we are going to delve into the second part of the lexing which is tokenizing more advanced part of the input. More precisely, we are going to lex spaces (whitespaces, new lines, ...), comments, Identifiers, Numbers (Int and Float), and Strings. At the end of this article, we will have a fully functioning lexer that can tokenize the <code>descriptor.proto</code> which is the longest proto file in the protobuf repo. Let's get started.</p>
<blockquote>
<p>Note: While this article is designed in a way that shows the evolution of the Lexer, you might still want to look at <a href="https://github.com/Clement-Jean/protein/commits/lexer">the commits</a> in order to see where any piece of code went.</p>
</blockquote>
<h2 id="spaces">Spaces</h2>
<p>Up until now, we assumed that all the characters that we would encounter were symbols. We are now going to add whitespaces, new lines, ... on top of that. Now, one thing to note here is that in traditional lexer, spaces will be discarded and are not counted as tokens. In our case, since the <a href="https://protobuf.dev/programming-guides/style/">Protobuf Style Guide</a> mentions that we should use an indent of 2 spaces, we are going to need that information. Before doing tokenizing spaces, we are going to need to more helper functions:</p>
<ul>
<li><code>backup</code>: Goes back by one utf8 character.</li>
<li><code>peek</code>: Check the next utf8 character without advancing the reading position.</li>
</ul>
<p><code>peek</code> is very similar to next because we are checking that we are still within the limits of our input and we read the character at <code>lexer.pos</code>. However, because we are just looking ahead and not advancing in the input, we are not going to update the <code>lexer.pos</code>.</p>
<ul class="code-tab-container 4c961be2-32c0-4832-959f-f45eb4d8c7f4"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4c961be2-32c0-4832-959f-f45eb4d8c7f4', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 4c961be2-32c0-4832-959f-f45eb4d8c7f4"><li class="code_switcher_container_parent active-tab code_switcher_go 7650ac27-1d3c-4caa-86ab-7b191b952ab5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">peek</span><span class="p">()</span> <span class="kt">rune</span> <span class="p">{</span>
  <span class="k">if</span> <span class="kt">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">utf8</span><span class="o">.</span><span class="n">DecodeRuneInString</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="o">:</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">r</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and <code>backup</code> is pretty simple. We are going to read the last character before <code>lexer.pos</code> and update the reading position by the size of that utf8 character. Furthermore, since in the <code>next</code> function we added <code>l.line++</code> when we have a new line, we are going to need backing that up too. So we are going to decrease <code>lexer.line</code> when we encounter a newline.</p>
<ul class="code-tab-container a75fa11d-1b6b-43dd-817a-234ee0aa7f8d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'a75fa11d-1b6b-43dd-817a-234ee0aa7f8d', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher a75fa11d-1b6b-43dd-817a-234ee0aa7f8d"><li class="code_switcher_container_parent active-tab code_switcher_go bebc71b6-73be-4f0e-984e-ecd92a6bcd5c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">backup</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">l</span><span class="o">.</span><span class="n">atEOF</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">utf8</span><span class="o">.</span><span class="n">DecodeLastRuneInString</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="o">:</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">])</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">-=</span> <span class="n">w</span>

    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="p">{</span>
      <span class="n">l</span><span class="o">.</span><span class="n">line</span><span class="o">--</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>As always, we want to add a test for our function that is skipping spaces. Now, it is important to understand that we are not only interested of whitespaces. We also want to 'skip' other non-printable characters such as '\t', '\r', '\n', ... For that we are going to use the <code>unicode.IsSpace</code> from the Go standard library. So our test, should contain these different characters.</p>
<ul class="code-tab-container 97a78312-40db-4ec7-afd2-8ee021b54668"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '97a78312-40db-4ec7-afd2-8ee021b54668', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 97a78312-40db-4ec7-afd2-8ee021b54668"><li class="code_switcher_container_parent active-tab code_switcher_go 978a4f4f-1854-473b-b149-17a93828fe86"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">TestNextTokenOnSpace</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"</span><span class="se">\t\n\v\f\r</span><span class="s"> "</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">"</span><span class="se">\t\n\v\f\r</span><span class="s"> "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Obviously, if we run this we will get the following:</p>
<div class="code_switcher_container_parent 81022f40-072e-4ff4-ad67-790b9fe46198"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnSpace <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Space"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Now that we have our test, <code>backup</code> and <code>peek</code>, we can write our <code>lexSpaces</code> function. This is a function that loops until we find a non-space character as peek and return a Token for that space.</p>
<ul class="code-tab-container 5c45d98c-3290-486d-9559-cdf89ab1dc52"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '5c45d98c-3290-486d-9559-cdf89ab1dc52', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 5c45d98c-3290-486d-9559-cdf89ab1dc52"><li class="code_switcher_container_parent active-tab code_switcher_go 3490c920-51a5-4fec-9dd2-f028fbd87568"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">lexSpaces</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">r</span> <span class="kt">rune</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsSpace</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenSpace</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This <code>lexSpaces</code> function will now need to be placed in our <code>lexProto</code> switch in order to be taken into consideration.</p>
<ul class="code-tab-container 114ce95a-f550-4287-9fe6-e11b353d3356"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '114ce95a-f550-4287-9fe6-e11b353d3356', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 114ce95a-f550-4287-9fe6-e11b353d3356"><li class="code_switcher_container_parent active-tab code_switcher_go ac3c5016-1225-44d0-96d3-461d2f3f8999"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">unicode</span><span class="o">.</span><span class="n">IsSpace</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span> <span class="c">// go back by one character</span>
    <span class="k">return</span> <span class="n">lexSpaces</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and that's basically it! We run our test and we get:</p>
<div class="code_switcher_container_parent 5bea24e1-8a70-406d-8f81-f02a37a8db6b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.235s
</code></pre></div></div>
</div>
<h2 id="comments">Comments</h2>
<p>It turns out that we can lex comments with a similar technique as the one used for spaces. The only difference here is that we have two type of comment:</p>
<ul>
<li>Line comment: Starts with <code>//</code> and finishes at the end of the line.</li>
<li>Multiline comment: Starts with <code>/*</code> and finishes with <code>*/</code>.</li>
</ul>
<h3 id="line-comment">Line comment</h3>
<p>We are going to start with the line comment. This is very similar to <code>lexSpaces</code>. The major difference is that we are going to check for '\n' or EOF for finishing the comment. Finally, we are going to return a Token.</p>
<p>But before all that, let's write two tests. One that checks that we are skipping until '\n' and the other that checks that we are skipping until EOF.</p>
<ul class="code-tab-container 5faf73d1-aada-4af6-b8ec-2995e6e47cd6"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '5faf73d1-aada-4af6-b8ec-2995e6e47cd6', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 5faf73d1-aada-4af6-b8ec-2995e6e47cd6"><li class="code_switcher_container_parent active-tab code_switcher_go ab09de35-6275-45c6-9042-d85e45d0a0b8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">TestNextTokenOnLineCommentWithEOF</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"//this is a comment"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenComment</span><span class="p">,</span> <span class="s">"//this is a comment"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnLineCommentWithNewLine</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"//this is a comment</span><span class="se">\n</span><span class="s">_"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenComment</span><span class="p">,</span> <span class="s">"//this is a comment"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">19</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">19</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">TokenUnderscore</span><span class="p">,</span> <span class="s">"_"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">20</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">20</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">21</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">21</span><span class="p">}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We fail to pass, once again:</p>
<div class="code_switcher_container_parent aacd5f65-dd3a-48e9-9200-24d46ae09829"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnLineCommentWithEOF <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Comment"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnLineCommentWithNewLine <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Comment"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Let's now write our function.</p>
<ul class="code-tab-container c4fdc873-c3cf-4969-9d2c-6ca739b363f8"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c4fdc873-c3cf-4969-9d2c-6ca739b363f8', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher c4fdc873-c3cf-4969-9d2c-6ca739b363f8"><li class="code_switcher_container_parent active-tab code_switcher_go c18628eb-bf74-46e9-a16b-9d509fdd2ee4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">lexLineComment</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">r</span> <span class="kt">rune</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenComment</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and run our tests:</p>
<div class="code_switcher_container_parent 9e0fa299-cd32-4b22-a7fb-63a589bd8280"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.351s
</code></pre></div></div>
</div>
<p>We pass the Line Comment tests, let's go to the multiline comment.</p>
<h3 id="multiline-comment">Multiline Comment</h3>
<p>These comments are again pretty similar, however, like any other object that doesn't end with EOF we can have errors. The main error here is an unterminated comment. As an example, writing something like:</p>
<div class="code_switcher_container_parent 03e7c976-9f99-4903-b6d1-94041ad45962"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/*</span><span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">comment</span>
</code></pre></div></div>
</div>
<p>should result in an error from the lexer.</p>
<p>To handle such errors, we are going to create a function that will basically stop the lexing process by emitting an Error Token and return nil as state.</p>
<ul class="code-tab-container ce79c601-4e89-4f2e-8d77-9f9ce8766495"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ce79c601-4e89-4f2e-8d77-9f9ce8766495', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher ce79c601-4e89-4f2e-8d77-9f9ce8766495"><li class="code_switcher_container_parent active-tab code_switcher_go 98286979-7a77-4b86-8fc5-7f1ad08049df"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">errorf</span><span class="p">(</span><span class="n">format</span> <span class="kt">string</span><span class="p">,</span> <span class="n">args</span> <span class="o">...</span><span class="n">any</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">l</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="o">...</span><span class="p">),</span> <span class="n">Position</span><span class="p">{</span>
    <span class="n">Offset</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
    <span class="n">Line</span><span class="o">:</span>   <span class="n">l</span><span class="o">.</span><span class="n">startLine</span><span class="p">,</span>
    <span class="n">Column</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span><span class="p">,</span>
  <span class="p">}}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="m">0</span>
  <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="m">0</span>
  <span class="n">l</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="o">:</span><span class="m">0</span><span class="p">]</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This is similar to what we did in emit, the only difference is that here the literal of a token is the error message and we reset the state of our lexer.</p>
<p>Now that we know the requirements for our lexer concerning comments, we can write some tests. Before that, though, as a matter of convenience, we are going to define constants for our error messages. This is done to avoid typos when writing tests:</p>
<ul class="code-tab-container ea9fa7f3-fe5f-4ebf-9ece-727d5b5a2f3a"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ea9fa7f3-fe5f-4ebf-9ece-727d5b5a2f3a', 0)">lexer/errors.go</a></li></ul><ul class="code-tab-switcher ea9fa7f3-fe5f-4ebf-9ece-727d5b5a2f3a"><li class="code_switcher_container_parent active-tab code_switcher_go 1c41b7b9-25a0-4307-88c3-8a379753ce91"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="k">const</span> <span class="p">(</span>
  <span class="n">errorUnterminatedMultilineComment</span> <span class="o">=</span> <span class="s">"unterminated multiline comment"</span>
<span class="p">)</span>
</code></pre></div></div>
</li></ul>
<p>and once this is done we can now have our tests:</p>
<ul class="code-tab-container 57ef5705-c869-4104-aa98-9db37f32ec4f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '57ef5705-c869-4104-aa98-9db37f32ec4f', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 57ef5705-c869-4104-aa98-9db37f32ec4f"><li class="code_switcher_container_parent active-tab code_switcher_go 76380e43-84e6-4f4e-b642-3f9e10179c45"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnMultilineComment</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"/*this is a comment*/_"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenComment</span><span class="p">,</span> <span class="s">"/*this is a comment*/"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">TokenUnderscore</span><span class="p">,</span> <span class="s">"_"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">21</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">21</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">22</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">22</span><span class="p">}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnUnterminatedMultilineComment</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"/*this is a comment"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">errorUnterminatedMultilineComment</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>we run:</p>
<div class="code_switcher_container_parent b23f70e2-f5e8-42d8-b64d-dbebc549a41a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnMultilineComment <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Comment"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnUnterminatedMultilineComment <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Error"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>and we fail (we are used to it).</p>
<p><code>lexMultilineComment</code> is a little bit longer than the other functions we wrote for lexing. This is mostly due to the fact that we are checking for unterminated comment but also because we need to check that the current character is '/' and that the previous character was '*'. So we keep a reference to the previous character and check that for stopping the reading loop.</p>
<ul class="code-tab-container 93722353-0df6-45b6-9cad-3d28760296bb"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '93722353-0df6-45b6-9cad-3d28760296bb', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 93722353-0df6-45b6-9cad-3d28760296bb"><li class="code_switcher_container_parent active-tab code_switcher_go ee66b8e6-8e1e-4793-96ae-4643a915b808"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexMultilineComment</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">p</span> <span class="kt">rune</span>
  <span class="k">var</span> <span class="n">r</span> <span class="kt">rune</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">r</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">errorf</span><span class="p">(</span><span class="n">errorUnterminatedMultilineComment</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="sc">'*'</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="p">{</span>
      <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenComment</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Once again this is very similar to <code>lexSpaces</code> and <code>lexLineComment</code>, isn't it?</p>
<p>Let's now place that in our <code>lexProto</code> function:</p>
<ul class="code-tab-container 361848f3-b3ef-469e-9ab3-a8e59df0f800"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '361848f3-b3ef-469e-9ab3-a8e59df0f800', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 361848f3-b3ef-469e-9ab3-a8e59df0f800"><li class="code_switcher_container_parent active-tab code_switcher_go e53245d1-9bb2-4960-abad-bb9dee26237c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="sc">'*'</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexMultilineComment</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and our tests?</p>
<div class="code_switcher_container_parent b18e3927-66cc-4533-80d3-778592cdfb80"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.741s
</code></pre></div></div>
</div>
<h2 id="identifiers">Identifiers</h2>
<p>For identifiers, we need a way to keep going while we have a letter (capitalized or not), a number or an underscore. We are going to create a function called <code>acceptWhile</code> that does just that. We want to pass the set of possible characters to it and while the set contains the current value it will advance. Once we are done, we are going to use <code>backup</code> to make sure that the <code>lexer.pos</code> is just after the last character of the identifier.</p>
<p>Before we do that, though, it's testing time. We simply want to test that when we pass some text starting with a letter, <code>lexProto</code> will create an Identifier token.</p>
<ul class="code-tab-container 4b8ebf64-4006-4229-8f25-21c6473b893f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4b8ebf64-4006-4229-8f25-21c6473b893f', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 4b8ebf64-4006-4229-8f25-21c6473b893f"><li class="code_switcher_container_parent active-tab code_switcher_go 4d01e277-1a47-4b64-8645-21cd363d198a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnIdentifier</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"hello_world2023 HelloWorld2023"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="s">"hello_world2023"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="s">"HelloWorld2023"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We obviously fail the test:</p>
<div class="code_switcher_container_parent 7decb087-c887-4c02-a90b-b727bddc34ec"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnIdentifier <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Identifier"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>and now we can start our <code>acceptWhile</code> function:</p>
<ul class="code-tab-container a0611c40-4654-4d0c-8a3b-044a1437a5df"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'a0611c40-4654-4d0c-8a3b-044a1437a5df', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher a0611c40-4654-4d0c-8a3b-044a1437a5df"><li class="code_switcher_container_parent active-tab code_switcher_go 9e6fe34a-420d-4bd7-a4d3-57bf4658b1cf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">acceptWhile</span><span class="p">(</span><span class="n">valid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">strings</span><span class="o">.</span><span class="n">ContainsRune</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>That's it. Nothing more! A few lines of code and we can now simply write our <code>lexIdentifier</code>.</p>
<ul class="code-tab-container 6ebc7621-e7da-49b0-bd5c-0a4f7f30dda4"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '6ebc7621-e7da-49b0-bd5c-0a4f7f30dda4', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 6ebc7621-e7da-49b0-bd5c-0a4f7f30dda4"><li class="code_switcher_container_parent active-tab code_switcher_go 3014bb46-f9c1-4f2a-a2f3-26f58c9fcf7b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexIdentifier</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="s">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenIdentifier</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and add that to the <code>lexProto</code>:</p>
<ul class="code-tab-container d4ca296d-f5d8-497d-84cf-e4bb28d466c4"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd4ca296d-f5d8-497d-84cf-e4bb28d466c4', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher d4ca296d-f5d8-497d-84cf-e4bb28d466c4"><li class="code_switcher_container_parent active-tab code_switcher_go 6e23c807-af4f-4b13-9a96-58348c8cfa7f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">unicode</span><span class="o">.</span><span class="n">IsLetter</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexIdentifier</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We rerun our test:</p>
<div class="code_switcher_container_parent be46e55c-65c8-42d2-a78e-013c86cda780"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.767s
</code></pre></div></div>
</div>
<h2 id="strings">Strings</h2>
<p>Before going the numbers, let's continue with something easy. Lexing strings is similar to what we did with multiline comments. We have a beginning and an end delimited by a certain character. In Protobuf, for strings, we can use single and double quotes. However, we cannot match a double quote with a single one. This means that having something like:</p>
<div class="code_switcher_container_parent b4bf0b39-197b-45e6-af93-faa460db4843"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"test'
</span></code></pre></div></div>
</div>
<p>will result in a unterminated string.</p>
<p>Now that we know the requirements, let's write out tests.</p>
<ul class="code-tab-container 2724d471-9aa0-47e6-b625-3cf005a4f387"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '2724d471-9aa0-47e6-b625-3cf005a4f387', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 2724d471-9aa0-47e6-b625-3cf005a4f387"><li class="code_switcher_container_parent active-tab code_switcher_go 6e3975d4-0e47-4193-bc4a-f02530423723"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnString</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"'test' </span><span class="se">\"</span><span class="s">test</span><span class="se">\"</span><span class="s">"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenStr</span><span class="p">,</span> <span class="s">"'test'"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenStr</span><span class="p">,</span> <span class="s">"</span><span class="se">\"</span><span class="s">test</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnUnterminatedString</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"'test"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">errorUnterminatedQuotedString</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnMismatchedQuotesString</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">test'"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">errorUnterminatedQuotedString</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>you notice the constant named <code>errorUnterminatedQuotedString</code>. It is similar to the error message we added for the multiline comment.</p>
<ul class="code-tab-container 8d76087f-4084-4cd8-946d-1478e279ef2d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8d76087f-4084-4cd8-946d-1478e279ef2d', 0)">lexer/errors.go</a></li></ul><ul class="code-tab-switcher 8d76087f-4084-4cd8-946d-1478e279ef2d"><li class="code_switcher_container_parent active-tab code_switcher_go 24521bfc-cf0b-4e9d-9a1b-506d43b99e9c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="k">const</span> <span class="p">(</span>
  <span class="n">errorUnterminatedMultilineComment</span> <span class="o">=</span> <span class="s">"unterminated multiline comment"</span>
  <span class="n">errorUnterminatedQuotedString</span>     <span class="o">=</span> <span class="s">"unterminated quoted string"</span>
<span class="p">)</span>
</code></pre></div></div>
</li></ul>
<p>We obviously fail the test:</p>
<div class="code_switcher_container_parent 5818cc34-88db-4ae6-9133-ccb94546247b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnString <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"String"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnUnterminatedString <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Error"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnMismatchedQuotesString <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Error"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Ok, now we can write our <code>lexString</code>. We are going to write a function that first take notice of the character it currently is on. This character will be a single or double quote and we are going to need it to determine the end of our string. After that we are going to loop over the input and we are going to check for EOF (unterminated string) and the character at the beginning (end of string). When we encounter the end of the string, we can just break out of the loop and return a String Token.</p>
<ul class="code-tab-container ccbb8fa8-3e05-46bb-a8a7-cadac03d8f92"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ccbb8fa8-3e05-46bb-a8a7-cadac03d8f92', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher ccbb8fa8-3e05-46bb-a8a7-cadac03d8f92"><li class="code_switcher_container_parent active-tab code_switcher_go 598b922e-4d4f-4c05-8b79-03fef006085a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexString</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">open</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span>
  <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">Loop</span><span class="o">:</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span><span class="o">:</span>
      <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">errorf</span><span class="p">(</span><span class="n">errorUnterminatedQuotedString</span><span class="p">)</span>
    <span class="k">case</span> <span class="kt">rune</span><span class="p">(</span><span class="n">open</span><span class="p">)</span><span class="o">:</span>
      <span class="k">break</span> <span class="n">Loop</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenStr</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and after that, you know the trick, we add that to <code>lexProto</code>:</p>
<ul class="code-tab-container c7c9afcf-c949-4715-a84f-75e0ab8e31cf"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c7c9afcf-c949-4715-a84f-75e0ab8e31cf', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher c7c9afcf-c949-4715-a84f-75e0ab8e31cf"><li class="code_switcher_container_parent active-tab code_switcher_go bf478209-1418-44a9-b57c-b3e4672c27ff"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\'</span><span class="err">'</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexString</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and the tests?</p>
<div class="code_switcher_container_parent 00d0d34a-b2e7-4e1c-8bb9-ecf8a453654b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.374s
</code></pre></div></div>
</div>
<h2 id="numbers">Numbers</h2>
<p>The real challenge comes with numbers. If we take a look at the <a href="https://protobuf.dev/reference/protobuf/proto3-spec/">Protobuf language specification</a>, we need to accept Decimal, Octal and Hexadecimal for integers and exponents for floats. On top of that we need to be able to put a sign before the number to be able to have -5 for example.</p>
<p>In our tests we are going to try listing all the possible kinds of numbers (if you spot something missing, let me know):</p>
<ul class="code-tab-container 0e0cf12f-2217-4fdd-b39a-981a01dedf23"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '0e0cf12f-2217-4fdd-b39a-981a01dedf23', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 0e0cf12f-2217-4fdd-b39a-981a01dedf23"><li class="code_switcher_container_parent active-tab code_switcher_go b3e98620-30e4-4fd6-af3e-a21816ffda88"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnIntDecimal</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"5 0 -5 +5"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"0"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"-5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"+5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnIntHex</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"0xff 0XFF"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"0xff"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"0XFF"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnIntOctal</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"056"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"056"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnFloat</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"-0.5 +0.5 -.5 +.5 .5 .5e5 .5e+5 .5e-5 5e5"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"-0.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"+0.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"-.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"+.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5e5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5e+5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5e-5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"5e5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Tests fail:</p>
<div class="code_switcher_container_parent 898db591-fa64-4c1a-a79c-a22a28e33d9b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnIntDecimal <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Integer"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnIntHex <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Integer"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnIntOctal <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Integer"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnFloat <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Float"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Now, before writing our <code>lexNumber</code> we want to have an <code>accept</code> function which does something similar to <code>acceptWhile</code> but only one time instead of in a loop. This will help us to check if our number, as an example, is starting by 0 in which case it might be a hexadecimal number.</p>
<ul class="code-tab-container c687c652-3c9f-4b72-979b-db0d276c7516"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c687c652-3c9f-4b72-979b-db0d276c7516', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher c687c652-3c9f-4b72-979b-db0d276c7516"><li class="code_switcher_container_parent active-tab code_switcher_go c1afd058-d86b-42c8-98aa-546b43e53286"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">accept</span><span class="p">(</span><span class="n">valid</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">strings</span><span class="o">.</span><span class="n">ContainsRune</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">true</span>
  <span class="p">}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
  <span class="k">return</span> <span class="no">false</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Now we can write our <code>lexNumber</code> function. We are going to start by assuming that our set of possible characters are from 0 to 9. Then we check if the number starts with the character 0. If it's the case, it will be an Hexadecimal or an Octal. We update the set of possible characters based on that.</p>
<p>Now that we know the possible set of characters, we can do an <code>acceptWhile</code> to read the digits. After the number we might see a dot for floating-point numbers. There we are going to do another <code>acceptWhile</code> to read all the digits. And finally, after all of this, we can still have an exponent followed by a sign and digits.</p>
<ul class="code-tab-container cb0fbf07-4005-4a6a-9f52-0015a3c7a070"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'cb0fbf07-4005-4a6a-9f52-0015a3c7a070', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher cb0fbf07-4005-4a6a-9f52-0015a3c7a070"><li class="code_switcher_container_parent active-tab code_switcher_go 19956bc5-fa98-49fb-810d-6e7bed5978bf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexNumber</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">t</span> <span class="n">TokenType</span> <span class="o">=</span> <span class="n">TokenInt</span>

  <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"+-"</span><span class="p">)</span>

  <span class="n">digits</span> <span class="o">:=</span> <span class="s">"0123456789"</span> <span class="c">// decimal</span>

  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span> <span class="p">{</span> <span class="c">// starts with 0</span>
    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"xX"</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">digits</span> <span class="o">=</span> <span class="s">"0123456789abcdefABCDEF"</span> <span class="c">// hexadecimal</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">digits</span> <span class="o">=</span> <span class="s">"01234567"</span> <span class="c">// octal</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"."</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">TokenFloat</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="s">"0123456789"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"eE"</span><span class="p">)</span> <span class="p">{</span> <span class="c">// exponent</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">TokenFloat</span>
    <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"+-"</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="s">"0123456789"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We add that to <code>lexProto</code>:</p>
<ul class="code-tab-container 1f59b8ba-d8b1-4cf0-adf5-556a918a4a7a"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '1f59b8ba-d8b1-4cf0-adf5-556a918a4a7a', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 1f59b8ba-d8b1-4cf0-adf5-556a918a4a7a"><li class="code_switcher_container_parent active-tab code_switcher_go 52ff6099-5b65-4af9-8353-f23037dabbaf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">||</span> <span class="p">(</span><span class="sc">'0'</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexNumber</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We run our tests again:</p>
<div class="code_switcher_container_parent d5f3dab0-7a52-4fd2-ac8a-9bf3752643e0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnFloat <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[8] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Float"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"."</span>
FAIL
</code></pre></div></div>
</div>
<p>and we still have an error. This is due to the fact that, in part 1, when we were lexing symbols, we added this case statement:</p>
<ul class="code-tab-container 83977a7d-9a83-4617-a047-278a95f4ddaf"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '83977a7d-9a83-4617-a047-278a95f4ddaf', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 83977a7d-9a83-4617-a047-278a95f4ddaf"><li class="code_switcher_container_parent active-tab code_switcher_go 13ab0525-2955-46e2-88ef-50f408628a07"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span><span class="o">:</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenDot</span><span class="p">)</span>
<span class="c">//...</span>
</code></pre></div></div>
</li></ul>
<p>In Protobuf, numbers can start directly with a dot and thus our lexer will just read Dot and then an Integer. So we need to skip the lexing of a dot if it's followed by a number.</p>
<ul class="code-tab-container f522ab2f-7230-4464-9b82-00add338dd1e"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f522ab2f-7230-4464-9b82-00add338dd1e', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher f522ab2f-7230-4464-9b82-00add338dd1e"><li class="code_switcher_container_parent active-tab code_switcher_go 57b823b2-e1ec-45c1-998c-d613953ff652"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsNumber</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">())</span><span class="o">:</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenDot</span><span class="p">)</span>
<span class="c">//...</span>
</code></pre></div></div>
</li></ul>
<p>And our tests pass:</p>
<div class="code_switcher_container_parent fc6e8fd6-9f4c-4007-8ba7-9418ca4b20d3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.763s
</code></pre></div></div>
</div>
<blockquote>
<p>Note: I am aware that some invalid numbers can pass through this lexing function. For example, the invalid number <code>0XFF.5</code> will return you a float. However, this is not the lexer that should handle the verification of number, the parser will. The lexer's job is to return tokens.</p>
</blockquote>
<h2 id="we-can-lex">We can Lex!</h2>
<p>As promised in the beginning of the article, we are able to lex a file called <code>descriptor.proto</code>. This file can be found <a href="https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/descriptor.proto">here</a>. Just copy its content to a file.</p>
<p>Now, we need to write some main function to run our lexer. It will read the first argument from the command line (no error handling because this is just a test), read the file to a string, initialize a lexer and will repeatedly call the <code>NextToken</code> until EOF.</p>
<ul class="code-tab-container f64ba084-cf9e-4914-8f72-f61c16f39b84"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f64ba084-cf9e-4914-8f72-f61c16f39b84', 0)">main.go</a></li></ul><ul class="code-tab-switcher f64ba084-cf9e-4914-8f72-f61c16f39b84"><li class="code_switcher_container_parent active-tab code_switcher_go 35a36794-2de6-4b9c-a644-3ac406d37d51"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"log"</span>
  <span class="s">"os"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">args</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
  <span class="n">content</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">token</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>we run:</p>
<div class="code_switcher_container_parent f18a8135-f278-4d34-8c12-8fc484855ed2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go run main.go descriptor.proto
</code></pre></div></div>
</div>
<p>and we should have output similar to:</p>
<div class="code_switcher_container_parent 09ea6993-e428-4735-b01d-6c6612c3da56"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
2023/02/21 18:01:58 <span class="o">{}</span> <span class="o">}</span> <span class="o">{</span>38493 920 0<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{</span>Space 
 <span class="o">{</span>38494 920 1<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{}</span> <span class="o">}</span> <span class="o">{</span>38495 921 0<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{</span>Space 
 <span class="o">{</span>38496 921 1<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{</span>EOF  <span class="o">{</span>38497 922 0<span class="o">}}</span>
</code></pre></div></div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we tokenized all the elements that we need to get started with our parser. We are even able to lex proto files in the protobuf library! In the next episode, before going to the parser, we are going to make sure that our token positions are correct because up until now we didn't test that.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>
<div class="container">
  <div class="row">
    <div class="col text-center">
      <a href="/protein_lexer_part_1" class="btn btn-danger text-center">Previous Article</a>
    </div>
    <div class="col text-center">
      <a href="/protein_lexer_part_3" class="btn btn-danger text-center">Next Article</a>
    </div>
  </div>
</div>]]></content><author><name>Clement</name></author><category term="Protocol Buffers" /><category term="Go" /><summary type="html"><![CDATA[In this article we are going to delve into the second part of the lexing which is tokenizing more advanced part of the input. More precisely, we are going to lex spaces (whitespaces, new lines, ...), comments, Identifiers, Numbers (Int and Float), and Strings. At the end of this article, we will have a fully functioning lexer that can tokenize the descriptor.proto which is the longest proto file in the protobuf repo. Let's get started.]]></summary></entry></feed>