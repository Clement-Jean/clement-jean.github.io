<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="4.3.1">Jekyll</generator><link href="https://clement-jean.github.io/feed.xml" rel="self" type="application/atom+xml" /><link href="https://clement-jean.github.io/" rel="alternate" type="text/html" /><updated>2023-08-24T16:09:47+02:00</updated><id>https://clement-jean.github.io/feed.xml</id><title type="html">Clément Jean</title><subtitle>Eternal learner and challenges lover</subtitle><author><name>Clément Jean</name></author><entry><title type="html">Pagination in gRPC</title><link href="https://clement-jean.github.io/pagination_in_grpc/" rel="alternate" type="text/html" title="Pagination in gRPC" /><published>2023-08-24T00:00:00+02:00</published><updated>2023-08-24T00:00:00+02:00</updated><id>https://clement-jean.github.io/pagination_in_grpc</id><content type="html" xml:base="https://clement-jean.github.io/pagination_in_grpc/"><![CDATA[<p>Looking into optimizing one of my APIs, I recently stumbled upon the following resource: <a href="https://cloud.google.com/apis/design/design_patterns">Common design patterns</a>. This contains a lot of insights on how to design proto files in order to make gRPC APIs more idiomatic or more efficient. Within this document, I found the pagination part interesting and decided to write an article on how to implement it.</p>
<h2 id="a-disclaimer">A disclaimer</h2>
<p>In this article I assume that you already know how to create a simple server in gRPC. <strong>I will not show all the boilerplate, you can check it in <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-08-24-pagination_in_grpc">here</a></strong>.</p>
<p>Finally, this article contains data from <a href="https://subscription.packtpub.com/search">Packt</a>. They do not sponsor this article in any way. I'm not getting any money promoting these books (except mine), I simply needed some interesting data for this article.</p>
<h2 id="an-explanation">An explanation</h2>
<p>Before starting the implementation, let's first understand what we are implementing.</p>
<h3 id="what">What</h3>
<p>Pagination is a mechanism which allows the consumer of the API to get a subset of the available resources. This is done in order to limit the payload size returned by the API and thus make the API response faster.</p>
<p>This is generally implemented with the combination of <code>page_size</code> and <code>page_token</code> fields. The former tells how big is the subset we want, and the latter act as an index from which we are going to get the next subset.</p>
<p>Let's see an example of such a pagination. We have the following data:</p>
<div class="code_switcher_container_parent 1150998d-902c-449b-b09c-c3b2b94105b7"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"books"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"gRPC Go for Professionals"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"In recent years, the popularity of microservice architecture has surged, bringing forth a new set of requirements."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Clément Jean"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-07-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">260</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781837638840"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Full-Stack Web Development with Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Go is a modern programming language with capabilities to enable high-performance app development."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Nanik Tolaram"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"Nick Glynn"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-02-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">302</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781803234199"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Domain-Driven Design with Golang"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Domain-driven design (DDD) is one of the most sought-after skills in the industry."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Matthew Boyle"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-12-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">204</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804613450"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Building Modern CLI Applications in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Although graphical user interfaces (GUIs) are intuitive and user-friendly, nothing beats a command-line interface"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Marian Montagnino"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-03-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">406</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804611654"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Functional Programming in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"While Go is a multi-paradigm language that gives you the option to choose whichever paradigm works best"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Dylan Meeus"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-03-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">248</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781801811163"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Event-Driven Architecture in Golang"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Event-driven architecture in Golang is an approach used to develop applications that shares state changes asynchronously, internally, and externally using messages."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Michael Stack"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-11-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">384</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781803238012"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Test-Driven Development in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Experienced developers understand the importance of designing a comprehensive testing strategy to ensure efficient shipping and maintaining services in production."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Adelina Simion"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-04-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">342</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781803247878"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mastering Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Mastering Go is the essential guide to putting Go to work on real production systems."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Mihalis Tsoukalos"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2021-08-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">682</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781801079310"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Network Automation with Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Go’s built-in first-class concurrency mechanisms make it an ideal choice for long-lived low-bandwidth I/O operations, which are typical requirements of network automation and network operations applications."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Nicolas Leiva"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-01-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">442</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781800560925"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Microservices with Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"This book covers the key benefits and common issues of microservices, helping you understand the problems microservice architecture helps to solve, the issues it usually introduces, and the ways to tackle them."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Alexander Shuiskov"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2022-11-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">328</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804617007"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Effective Concurrency in Go"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"The Go language has been gaining momentum due to its treatment of concurrency as a core language feature, making concurrent programming more accessible than ever."</span><span class="p">,</span><span class="w">
      </span><span class="nl">"authors"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"Burak Serdar"</span><span class="w">
      </span><span class="p">],</span><span class="w">
      </span><span class="nl">"published"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2023-04-01T00:00:00Z"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"pages"</span><span class="p">:</span><span class="w"> </span><span class="mi">212</span><span class="p">,</span><span class="w">
      </span><span class="nl">"isbn"</span><span class="p">:</span><span class="w"> </span><span class="s2">"9781804619070"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
</div>
<p>As expected, if we start by requesting subset of size 2, we will get the first two books (<code>gRPC Go for Professionals</code> and <code>Full-Stack Web Development with Go</code>). On top of that result, a page token will be returned to us. If we now use this token and request a subset of size 2 we will get the 2 following books (<code>Domain-Driven Design with Golang</code> and <code>Building Modern CLI Applications in Go</code>).</p>
<p>This is pretty much it. It is simple to grasp and also simple to implement.</p>
<h2 id="the-setup">The setup</h2>
<p>In this article:</p>
<ul>
<li>I will be using Postgres to store our books' data. You can find the initialization script <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-08-24-pagination_in_grpc/db">here</a></li>
<li>I will run Postgres and the gRPC with Docker Compose. You can find the YAML file <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-08-24-pagination_in_grpc/docker-compose.yml">here</a></li>
</ul>
<h2 id="protobuf">Protobuf</h2>
<p>If you check the <a href="https://cloud.google.com/apis/design/design_patterns#list_pagination">List Pagination</a> section, you will see that we have the following protobuf schema:</p>
<div class="code_switcher_container_parent 7d45001c-9898-44ac-970a-d944658ad8c6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">rpc</span> <span class="n">ListBooks</span><span class="p">(</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">ListBooksResponse</span><span class="p">);</span>

<span class="kd">message</span> <span class="nc">ListBooksRequest</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">parent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">int32</span> <span class="na">page_size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">page_token</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">ListBooksResponse</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="n">Book</span> <span class="na">books</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">next_page_token</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This code is mostly correct but we are going to remove the <code>parent</code> field. If you are interested in knowing what this is used for, check the <a href="https://cloud.google.com/apis/design/design_patterns#list_sub-collections">List Sub-Collections</a> section.</p>
<p>So we now have:</p>
<div class="code_switcher_container_parent ab270162-75c4-4325-baf4-592109bf62c3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">ListBooksRequest</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">page_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">page_token</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">ListBooksResponse</span> <span class="p">{</span>
  <span class="k">repeated</span> <span class="n">Book</span> <span class="na">books</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">next_page_token</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">service</span> <span class="n">BookStoreService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">ListBooks</span><span class="p">(</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">ListBooksResponse</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>The last thing that we need to do is defining the <code>Book</code> message:</p>
<div class="code_switcher_container_parent 8c81728e-d6bf-4ea9-8ae7-2978447188fd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"google/protobuf/timestamp.proto"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">Book</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">name</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">description</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
  <span class="k">repeated</span> <span class="kt">string</span> <span class="na">authors</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
  <span class="n">google.protobuf.Timestamp</span> <span class="na">published</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
  <span class="kt">uint32</span> <span class="na">pages</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">isbn</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>There is nothing fancy here. We simply laid out all the information needed to represent our books.</p>
<h2 id="listbooks">ListBooks</h2>
<p>Let's get started with an empty implementation for <code>ListBooks</code>:</p>
<div class="code_switcher_container_parent d9029f52-0f62-4eac-a782-4253438d943c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">server</span><span class="p">)</span> <span class="n">ListBooks</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>The first step in every endpoint implementation is to validate arguments. In our case we will validate the <code>page_size</code>. We mostly need to check that the <code>page_size</code> is not too big because it defeats the purpose of pagination, and if no <code>page_size</code> is provided we are going to set it to a default value.</p>
<div class="code_switcher_container_parent 15128c11-f87b-425d-be59-4cb9a4f5a08e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">const</span> <span class="p">(</span>
  <span class="n">defaultPageSize</span> <span class="o">=</span> <span class="m">10</span>
  <span class="n">maxPageSize</span>     <span class="o">=</span> <span class="m">30</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">validatePageSize</span><span class="p">(</span><span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksRequest</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span> <span class="o">&gt;</span> <span class="n">maxPageSize</span> <span class="p">{</span>
    <span class="n">msg</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span>
      <span class="s">"expected page size between 0 and %d, got %d"</span><span class="p">,</span>
      <span class="n">maxPageSize</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">errors</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span> <span class="c">// no page_size provided</span>
    <span class="n">req</span><span class="o">.</span><span class="n">PageSize</span> <span class="o">=</span> <span class="n">defaultPageSize</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This means that we can now do the following in <code>ListBooks</code>:</p>
<div class="code_switcher_container_parent 8b816d16-5ea9-4cbd-93ed-5c79286f6607"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">validatePageSize</span><span class="p">(</span><span class="n">req</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">codes</span><span class="o">.</span><span class="n">InvalidArgument</span><span class="p">,</span> <span class="n">err</span><span class="o">.</span><span class="n">Error</span><span class="p">())</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Next, we need to validate <code>page_token</code>. In this implementation, I decided to use <a href="https://github.com/ulid/spec">ULIDs</a>. This is because they are short ids and they are lexicographically sortable. The sortability part is interesting because we will sort the books by their IDs which are ULIDs.</p>
<p>Fortunately for us oklog provides an <a href="https://github.com/oklog/ulid">ULID implementation</a> for us to verify if a ULID is valid or not. In <code>ListBooks</code>, we can simply do:</p>
<div class="code_switcher_container_parent 4a69498f-d585-45b9-affa-c3eced771d5d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">_</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">ulid</span><span class="o">.</span><span class="n">Parse</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">);</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
  <span class="n">msg</span> <span class="o">:=</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"expected valid ULID, got error %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span>
  <span class="k">return</span> <span class="no">nil</span><span class="p">,</span> <span class="n">status</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">codes</span><span class="o">.</span><span class="n">InvalidArgument</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span><span class="o">.</span><span class="n">Err</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Notice that the <code>page_token</code> is optional (<code>len(req.PageToken) != 0</code>). When we do not provide one we will start from the beginning of the dataset.</p>
<p>Then, we need to generate the SQL query in order to get the subsets. We need to create the following SQL:</p>
<div class="code_switcher_container_parent 79e6039c-c1eb-4940-83c4-6455139ed016"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">SELECT</span> <span class="o">*</span>
<span class="k">FROM</span> <span class="n">book</span>
<span class="k">WHERE</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="n">page_token</span>
<span class="k">LIMIT</span> <span class="n">page_size</span>
<span class="k">ORDER</span> <span class="n">id</span> <span class="k">ASC</span>
</code></pre></div></div>
</div>
<p>Obviously, because the page_token is optional, the where clause is optional too.</p>
<p>Using <a href="https://gorm.io/">GORM</a>, we can easily create the request by writing the following:</p>
<div class="code_switcher_container_parent 10ba471d-9598-4653-9b72-3839c621d219"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">query</span> <span class="o">:=</span> <span class="n">s</span><span class="o">.</span><span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="s">"book"</span><span class="p">)</span><span class="o">.</span><span class="n">Limit</span><span class="p">(</span><span class="kt">int</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageSize</span><span class="p">))</span><span class="o">.</span><span class="n">Order</span><span class="p">(</span><span class="s">"id ASC"</span><span class="p">)</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
  <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">Where</span><span class="p">(</span><span class="s">"id &gt; ?"</span><span class="p">,</span> <span class="n">req</span><span class="o">.</span><span class="n">PageToken</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Now that we have the query, we can simply execute it and map the result into our Protobuf <code>Book</code> model:</p>
<div class="code_switcher_container_parent 3f75166c-5911-4dd0-8ad5-13c35c686df1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">queryRes</span> <span class="o">=</span> <span class="p">[]</span><span class="n">Book</span><span class="p">{}</span>
<span class="n">query</span><span class="o">.</span><span class="n">Scan</span><span class="p">(</span><span class="o">&amp;</span><span class="n">queryRes</span><span class="p">)</span> <span class="c">// execute query</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryRes</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
  <span class="c">// short circuit if not results</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksResponse</span><span class="p">{},</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="n">books</span> <span class="o">:=</span> <span class="n">utils</span><span class="o">.</span><span class="n">Map</span><span class="p">(</span><span class="n">queryRes</span><span class="p">,</span> <span class="n">mapBookToBookPb</span><span class="p">)</span>
</code></pre></div></div>
</div>
<p>Finally, we can get the ID (ULID) of the last item in subset (<code>queryRes</code>) and this will represent the <code>page_token</code> from where a subsequent request need to start getting new result.</p>
<div class="code_switcher_container_parent 6556c4f4-8a07-4266-9824-4b11ff5d740c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lastItemIdx</span> <span class="o">:=</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryRes</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span>
<span class="n">nextPageToken</span> <span class="o">:=</span> <span class="n">queryRes</span><span class="p">[</span><span class="n">lastItemIdx</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">queryRes</span><span class="p">)</span> <span class="o">&lt;</span> <span class="kt">int</span><span class="p">(</span><span class="n">req</span><span class="o">.</span><span class="n">PageSize</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// no more pages</span>
  <span class="n">nextPageToken</span> <span class="o">=</span> <span class="s">""</span>
<span class="p">}</span>

<span class="k">return</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">ListBooksResponse</span><span class="p">{</span>
  <span class="n">Books</span><span class="o">:</span>         <span class="n">books</span><span class="p">,</span>
  <span class="n">NextPageToken</span><span class="o">:</span> <span class="n">nextPageToken</span><span class="p">,</span>
<span class="p">},</span> <span class="no">nil</span>
</code></pre></div></div>
</div>
<p>And we now have pagination! Let's go ahead and test it.</p>
<h2 id="testing">Testing</h2>
<p>The first thing we can test is the case where the consumer doesn't provide a <code>page_token</code> and <code>page_size</code>. This should return 10 results (see <code>defaultPageSize</code>) from the beginning of the data.</p>
<div class="code_switcher_container_parent 57e10e7e-162d-4ce9-9306-797efe81c687"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Full-Stack Web Development with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Domain-Driven Design with Golang"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Building Modern CLI Applications in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Functional Programming in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Event-Driven Architecture in Golang"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Test-Driven Development in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Mastering Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Network Automation with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Microservices with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Effective Concurrency in Go"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"nextPageToken"</span>: <span class="s2">"01H8EH4VYYCS6M4BFVZ90RP7FS"</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>First, you can notice that we had 11 datum and that because we asked for 10 we didn't get &quot;gRPC Go for Professionals&quot;. And secondly, we can see that we got the <code>nextPageToken</code> field.</p>
<p>Let's now use the <code>nextPageToken</code> as <code>page_token</code>:</p>
<div class="code_switcher_container_parent 96f70fd8-f390-4799-a598-8dba048f53cf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{"page_token": "01H8EH4VYYCS6M4BFVZ90RP7FS"}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"gRPC Go for Professionals"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>And here we get our 11th datum!</p>
<p>Finally, we can try mixing the <code>page_token</code> and <code>page_size</code> fields. Let's say that we are going to have a <code>page_size</code> of 2. We will do the first request without <code>page_token</code> to get the 2 first elements:</p>
<div class="code_switcher_container_parent ebdc9353-2cfd-4462-90f7-218cd6d73ffb"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{"page_size": 2}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Full-Stack Web Development with Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Domain-Driven Design with Golang"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"nextPageToken"</span>: <span class="s2">"01H8EH2RM7HVFJG4HYA4XTV0R5"</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>and then we can use the <code>nextPageToken</code> to get the 3rd and 4th elements:</p>
<div class="code_switcher_container_parent 024b8a38-5bb4-4606-a194-0d0f34f8ec20"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/store.proto <span class="se">\</span>
          <span class="nt">-d</span> <span class="s1">'{"page_size": 2, "page_token": "01H8EH2RM7HVFJG4HYA4XTV0R5"}'</span> <span class="se">\</span>
          0.0.0.0:50051 BookStoreService.ListBooks

<span class="o">{</span>
  <span class="s2">"books"</span>: <span class="o">[</span>
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Building Modern CLI Applications in Go"</span>,
      ...
    <span class="o">}</span>,
    <span class="o">{</span>
      <span class="s2">"name"</span>: <span class="s2">"Functional Programming in Go"</span>,
      ...
    <span class="o">}</span>
  <span class="o">]</span>,
  <span class="s2">"nextPageToken"</span>: <span class="s2">"01H8EH3CKPT5BX263G0NGGKQCQ"</span>
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>Here we go! Everything workks as expected!</p>
<h2 id="conclusion">Conclusion</h2>
<p>We saw that we can implement pagination quite easily in gRPC with the combination of <code>page_token</code> and <code>page_size</code> fields in the request. We also saw that the API endpoint will return a <code>next_page_token</code> that we can later use as an index for the next page we want to get.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="gRPC" /><summary type="html"><![CDATA[Looking into optimizing one of my APIs, I recently stumbled upon the following resource: Common design patterns. This contains a lot of insights on how to design proto files in order to make gRPC APIs more idiomatic or more efficient. Within this document, I found the pagination part interesting and decided to write an article on how to implement it.]]></summary></entry><entry><title type="html">Authorization with gRPC and Envoy</title><link href="https://clement-jean.github.io/grpc_authz_envoy/" rel="alternate" type="text/html" title="Authorization with gRPC and Envoy" /><published>2023-06-07T00:00:00+02:00</published><updated>2023-06-07T00:00:00+02:00</updated><id>https://clement-jean.github.io/grpc_authz_envoy</id><content type="html" xml:base="https://clement-jean.github.io/grpc_authz_envoy/"><![CDATA[<p>Recently, I've been looking for a good alternative to <a href="https://traefik.io/traefik/">Traefik</a> as Reverse Proxy for gRPC services. Traefik has great support for gRPC and other common features, but Envoy comes with Protobuf-backed configuration and even greater support for gRPC services. In the article, I want to show how you can make Envoy use your custom authorization logic before redirecting (or not) the request to other services.</p>
<h2 id="the-code">The code</h2>
<p>The code is available <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-06-07-grpc_authz_envoy">here</a>.</p>
<h2 id="disclaimer">Disclaimer</h2>
<p>This post has been inspired from this <a href="https://ekhabarov.com/post/envoy-as-an-api-gateway-authentication-and-authorization/">article</a>. I thought it would be nice to have a little bit more details and explain how to run the whole thing.</p>
<h2 id="envoy">Envoy</h2>
<p>If you don't know Envoy, it is a <a href="https://en.wikipedia.org/wiki/Reverse_proxy">Reverse Proxy</a>. This is basically a server relaying client requests to other servers (your services). It is generally used to protect the services from direct access and potential abuse. As such, Reverse Proxies can load balance, rate limit, and much more.</p>
<p>Envoy is a project originally designed by Lyft and it is described as &quot;a high performance C++ distributed proxy designed for single services and applications, as well as a communication bus and “universal data plane” designed for large microservice “service mesh” architectures&quot;. That's a lot of buzz words! But for us, the most important is this feature:</p>
<blockquote>
<p>HTTP/2 AND GRPC SUPPORT</p>
<p>Envoy has first class support for HTTP/2 and gRPC for both incoming and outgoing connections. It is a transparent HTTP/1.1 to HTTP/2 proxy.</p>
</blockquote>
<p>One of the interesting features coming out of this support is the fact that Envoy can use custom gRPC services you develop. An example of this is the authorization service that I want to show you here.</p>
<h2 id="protobuf">Protobuf</h2>
<p>Before everything else, let us start by defining the service that we want to protect. Nothing fancy, we are going to use a simple GreetService:</p>
<div class="code_switcher_container_parent bf22dff9-fdbd-4b63-a3e9-6ad799c8d337"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="kn">package</span> <span class="nn">greet</span><span class="p">;</span>

<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"github.com/Clement-Jean/clement-jean.github.io/proto"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">GreetRequest</span> <span class="p">{}</span>
<span class="kd">message</span> <span class="nc">GreetResponse</span> <span class="p">{}</span>

<span class="kd">service</span> <span class="n">GreetService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">Greet</span> <span class="p">(</span><span class="n">GreetRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">GreetResponse</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>After that, Envoy provides us with its own protobuf definition for authorization. We can take a look at <a href="https://github.com/envoyproxy/envoy/blob/main/api/envoy/service/auth/v3/external_auth.proto">external_auth.proto</a> which contains the following:</p>
<div class="code_switcher_container_parent 7ed27dc1-e61b-4a33-ab92-7aee3803ee00"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// A generic interface for performing authorization check on incoming</span>
<span class="c1">// requests to a networked service.</span>
<span class="kd">service</span> <span class="n">Authorization</span> <span class="p">{</span>
  <span class="c1">// Performs authorization check based on the attributes associated with the</span>
  <span class="c1">// incoming request, and returns status `OK` or not `OK`.</span>
  <span class="k">rpc</span> <span class="n">Check</span><span class="p">(</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CheckResponse</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This means that we need to implement the Check unary endpoint and register the Authorization service.</p>
<h2 id="go-control-plane">go-control-plane</h2>
<p>Envoy provides us with a project called go-control-plane. This contains a collection of services such as Authorization that we can implement in our project.</p>
<p>To get it, we simply execute:</p>
<div class="code_switcher_container_parent 7c12626f-1e4a-49b1-8af5-1959961de8e6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go get github.com/envoyproxy/go-control-plane
</code></pre></div></div>
</div>
<p>This gives us access to <code>github.com/envoyproxy/go-control-plane/envoy/service/auth/v3</code> which contains the following structs:</p>
<ul>
<li>CheckRequest</li>
<li>CheckResponse</li>
<li>AutorizationServer (which is an interface containing <code>Check</code>)</li>
</ul>
<p>In our code we can now implement the <code>Check</code> function for our server type. This looks like this:</p>
<div class="code_switcher_container_parent 7ef91e66-db24-480e-97fb-e85a4c232b7d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">auth</span> <span class="s">"github.com/envoyproxy/go-control-plane/envoy/service/auth/v3"</span>

<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Check</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>If you are familiar with gRPC, this should look familiar.</p>
<p>And to register the Authorization service we can simply register like we normally would:</p>
<div class="code_switcher_container_parent 7c37f146-4a14-48de-bbc6-920300cf6634"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="n">auth</span> <span class="s">"github.com/envoyproxy/go-control-plane/envoy/service/auth/v3"</span>
  <span class="n">pb</span> <span class="s">"github.com/Clement-Jean/clement-jean.github.io/proto"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Server</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">pb</span><span class="o">.</span><span class="n">UnimplementedGreetServiceServer</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="n">srv</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Server</span><span class="p">{}</span>
  <span class="n">auth</span><span class="o">.</span><span class="n">RegisterAuthorizationServer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">srv</span><span class="p">)</span>
  <span class="n">pb</span><span class="o">.</span><span class="n">RegisterGreetServiceServer</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">srv</span><span class="p">)</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Notice that we are registering both services on the server here. This is not necessary. You could have a microservice specifically dedicated to authorization and the other one to greeting people.</p>
<h2 id="envoy-configuration">Envoy Configuration</h2>
<p>Now, in order to make Envoy do what we want, we need to create some YAML configuration. This configuration generally contains the ports on which Envoy listens, filters for filtering requests based on some properties, and clusters which are a collection of one or more endpoints.</p>
<p>In our case we are going to create two clusters. One for the authorization service and the other service. This is in fact not necessary since we registered both services on the same server, but I wanted to show you that you can split clusters for different microservices.</p>
<p>The clusters definition looks like the following:</p>
<div class="code_switcher_container_parent 87cf5053-cfad-42a0-a79c-1ffe1b7603a8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">clusters</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">grpc_auth</span>
    <span class="na">http2_protocol_options</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">lb_policy</span><span class="pi">:</span> <span class="s">round_robin</span>
    <span class="na">load_assignment</span><span class="pi">:</span>
      <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">grpc_auth</span>
      <span class="na">endpoints</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">lb_endpoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">endpoint</span><span class="pi">:</span>
            <span class="na">address</span><span class="pi">:</span>
              <span class="na">socket_address</span><span class="pi">:</span>
                <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">port_value</span><span class="pi">:</span> <span class="m">50051</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">grpc_greet</span>
    <span class="na">http2_protocol_options</span><span class="pi">:</span> <span class="pi">{}</span>
    <span class="na">lb_policy</span><span class="pi">:</span> <span class="s">round_robin</span>
    <span class="na">load_assignment</span><span class="pi">:</span>
      <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">grpc_greet</span>
      <span class="na">endpoints</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">lb_endpoints</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">endpoint</span><span class="pi">:</span>
            <span class="na">address</span><span class="pi">:</span>
              <span class="na">socket_address</span><span class="pi">:</span>
                <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">port_value</span><span class="pi">:</span> <span class="m">50051</span>
</code></pre></div></div>
</div>
<p>I hope we can agree on the fact that they are very similar so let's only dissect the authorization one.</p>
<p><code>http2_protocol_options: {}</code> simply means that we are enabling HTTP/2 for this cluster. This is required for gRPC services since gRPC is basically Protobuf over HTTP/2.</p>
<p>Then we have <code>lb_policy: round_robin</code>. This is not required for us since we will have only one instance of each service but in the case you scale things up, you will have to balance the load across the multiple services.</p>
<p>And finally, all the rest is basically defining a cluster with the name <code>grpc_auth</code> which can be reached at the address <code>0.0.0.0:50051</code>.</p>
<p>Now that we have that, we can take a look at the listener. Let's see the first part of the listener which is simply defining on which address and port Envoy will listen.</p>
<div class="code_switcher_container_parent e0decdd5-b95c-4367-baea-55a943c65413"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
  <span class="na">address</span><span class="pi">:</span>
    <span class="na">socket_address</span><span class="pi">:</span>
      <span class="na">address</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
      <span class="na">port_value</span><span class="pi">:</span> <span class="m">50050</span>
</code></pre></div></div>
</div>
<p>Once again Envoy will listen on <code>0.0.0.0:50050</code>. Now, note that even if you had <code>0.0.0.0:50051</code> there will be no conflict with the <code>0.0.0.0:50051</code> address set in the cluster. This is because generally the gRPC server will be containerized separately from Envoy and thus will listen on its own 50051 port.</p>
<p>Finally, things get a little bit more interesting when we talk about the filters. We need to start with a <code>http_connection_manager</code> that defines the route that we want to protect with authorization.</p>
<div class="code_switcher_container_parent acbb2050-c6e9-4366-9625-3c94072b3e7b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
    <span class="c1"># address</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>
          <span class="s">stat_prefix</span><span class="err">:</span> <span class="s">grpc_json</span>
          <span class="s">codec_type</span><span class="err">:</span> <span class="s">AUTO</span>
          <span class="s">route_config</span><span class="err">:</span>
            <span class="na">name</span><span class="pi">:</span> <span class="s">route</span>
            <span class="na">virtual_hosts</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">vh</span>
              <span class="na">domains</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">*"</span><span class="pi">]</span>
              <span class="na">routes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">match</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">prefix</span><span class="pi">:</span> <span class="s2">"</span><span class="s">/greet.GreetService/"</span><span class="pi">,</span> <span class="nv">grpc</span><span class="pi">:</span> <span class="pi">{}</span> <span class="pi">}</span>
                <span class="na">route</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">cluster</span><span class="pi">:</span> <span class="nv">grpc_greet</span><span class="pi">,</span> <span class="nv">timeout</span><span class="pi">:</span> <span class="pi">{</span> <span class="nv">seconds</span><span class="pi">:</span> <span class="nv">60</span> <span class="pi">}</span> <span class="pi">}</span>
</code></pre></div></div>
</div>
<p>The most important part is the virtual_hosts one. We say that we will accept requests from any domain (not recommended in prod), and then we basically that every request made on route matching <code>/greet.GreetService/</code> will be redirected to the <code>grpc_greet</code> cluster</p>
<p>After that, we will configure the external authorization.</p>
<div class="code_switcher_container_parent e2ce0bf4-4946-4be4-a04b-fc7a82a3dbb9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
    <span class="c1"># address</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="c1"># route matching</span>
          <span class="na">http_filters</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.http.ext_authz</span>
            <span class="na">typed_config</span><span class="pi">:</span>
              <span class="s2">"</span><span class="s">@type"</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz</span>
              <span class="s">grpc_service</span><span class="err">:</span>
                <span class="na">envoy_grpc</span><span class="pi">:</span>
                  <span class="na">cluster_name</span><span class="pi">:</span> <span class="s">grpc_auth</span>
                <span class="na">timeout</span><span class="pi">:</span> <span class="s">0.5s</span>
              <span class="na">transport_api_version</span><span class="pi">:</span> <span class="s">V3</span>
              <span class="na">failure_mode_allow</span><span class="pi">:</span> <span class="no">false</span>
              <span class="na">with_request_body</span><span class="pi">:</span>
                <span class="na">max_request_bytes</span><span class="pi">:</span> <span class="m">8192</span>
                <span class="na">allow_partial_message</span><span class="pi">:</span> <span class="no">true</span>
                <span class="na">pack_as_bytes</span><span class="pi">:</span> <span class="no">true</span>
              <span class="na">status_on_error</span><span class="pi">:</span>
                <span class="na">code</span><span class="pi">:</span> <span class="m">503</span>
</code></pre></div></div>
</div>
<p>The most important things in this part of the config are:</p>
<ul>
<li><code>cluster_name: grpc_auth</code>. We are specifying that the Authorization service can be found in the <code>grpc_auth</code> cluster.</li>
<li><code>code: 503</code>. If any error happens such as not finding the <code>Check</code> endpoint, Envoy will return a 503 error code.</li>
<li><code>with_request_body</code> forwards HTTP body to the Authorization service.</li>
</ul>
<p>Finally, we need to tell Envoy to actually route the requests. We simply do that by adding a <code>envoy.filters.http.router</code> at the end of the <code>http_filters</code>.</p>
<div class="code_switcher_container_parent 4e6a0d0c-7ccd-497a-b836-838681078a75"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">listeners</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">listener_grpc</span>
    <span class="c1"># address</span>
    <span class="na">filter_chains</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">filters</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.network.http_connection_manager</span>
        <span class="na">typed_config</span><span class="pi">:</span>
          <span class="c1"># route matching</span>
          <span class="na">http_filters</span><span class="pi">:</span>
          <span class="c1"># ext_authz</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">envoy.filters.http.router</span>
            <span class="na">typed_config</span><span class="pi">:</span>
              <span class="s1">'</span><span class="s">@type'</span><span class="err">:</span> <span class="s">type.googleapis.com/envoy.extensions.filters.http.router.v3.Router</span>
</code></pre></div></div>
</div>
<h2 id="lets-codecheckcode">Let's <code>Check</code></h2>
<p>Now that we have our Envoy config ready, it is time to implement the <code>Check</code> endpoint. We will first create a small demo environment where we will receive a token as header. We will check:</p>
<ul>
<li>If the token is empty/doesn't exist -&gt; Deny</li>
<li>If the token value is different from 'authz' -&gt; Deny</li>
<li>Otherwise -&gt; Allow</li>
</ul>
<p>Token checks would normally involve a database of some sort but here, as this is a small demo, let's create a simple function.</p>
<div class="code_switcher_container_parent a0c18054-082e-4c1c-9059-acebc796eaef"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">containsToken</span><span class="p">(</span><span class="n">key</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">false</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Errorf</span><span class="p">(</span><span class="s">"empty key"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="p">(</span><span class="n">key</span> <span class="o">==</span> <span class="s">"authz"</span><span class="p">),</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Nothing fancy.</p>
<p>Now, in <code>Check</code> we will be receiving headers, not as metadata, but as part of the request. I will let you check <a href="https://github.com/envoyproxy/envoy/blob/main/api/envoy/service/auth/v3/external_auth.proto">external_auth.proto</a> and <a href="https://github.com/envoyproxy/envoy/blob/main/api/envoy/service/auth/v3/attribute_context.proto">attribute_context.proto</a> to understand a little bit more about the data that we will receive as part of <code>CheckRequest</code>.</p>
<p>So we now get the token from the headers and pass it through <code>containsToken</code>.</p>
<div class="code_switcher_container_parent 8493cd5e-fcd3-4d03-9a91-52cf972e2747"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Check</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">headers</span> <span class="o">:=</span> <span class="n">req</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Http</span><span class="o">.</span><span class="n">Headers</span>
  <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containsToken</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s">"token"</span><span class="p">])</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Finally, we still have to do error handling. <code>ok</code> will tell us whether the key is in the 'database' and the <code>err</code> will be errors like <code>empty key</code>. Now, returning an error with <code>go-control-plane</code> and Envoy is a little bit different that what you might expect. This is because instead of returning the error as status like we normally do in gRPC is not compatible with Envoy. Instead, we need to return the status as part of the <code>CheckResponse</code>.</p>
<p>Two helpers functions aiming at creating a <code>Allow</code> and <code>Deny</code> response, that I found <a href="https://ekhabarov.com/post/envoy-as-an-api-gateway-authentication-and-authorization/">here</a>, are pretty self describing:</p>
<div class="code_switcher_container_parent d2929ad3-8558-4c7f-af3b-0489323c5ea4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="c">//...</span>
  <span class="s">"google.golang.org/genproto/googleapis/rpc/status"</span>
  <span class="s">"google.golang.org/grpc/codes"</span>

  <span class="n">envoy_type</span> <span class="s">"github.com/envoyproxy/go-control-plane/envoy/type/v3"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">denied</span><span class="p">(</span><span class="n">code</span> <span class="kt">int32</span><span class="p">,</span> <span class="n">body</span> <span class="kt">string</span><span class="p">)</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">{</span>
    <span class="n">Status</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">{</span><span class="n">Code</span><span class="o">:</span> <span class="n">code</span><span class="p">},</span>
    <span class="n">HttpResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse_DeniedResponse</span><span class="p">{</span>
      <span class="n">DeniedResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">DeniedHttpResponse</span><span class="p">{</span>
        <span class="n">Status</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">envoy_type</span><span class="o">.</span><span class="n">HttpStatus</span><span class="p">{</span>
          <span class="n">Code</span><span class="o">:</span> <span class="n">envoy_type</span><span class="o">.</span><span class="n">StatusCode</span><span class="p">(</span><span class="n">code</span><span class="p">),</span>
        <span class="p">},</span>
        <span class="n">Body</span><span class="o">:</span> <span class="n">body</span><span class="p">,</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">allowed</span><span class="p">()</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">{</span>
    <span class="n">Status</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">status</span><span class="o">.</span><span class="n">Status</span><span class="p">{</span><span class="n">Code</span><span class="o">:</span> <span class="kt">int32</span><span class="p">(</span><span class="n">codes</span><span class="o">.</span><span class="n">OK</span><span class="p">)},</span>
    <span class="n">HttpResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse_OkResponse</span><span class="p">{</span>
      <span class="n">OkResponse</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">auth</span><span class="o">.</span><span class="n">OkHttpResponse</span><span class="p">{</span>
        <span class="n">HeadersToRemove</span><span class="o">:</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"token"</span><span class="p">},</span>
      <span class="p">},</span>
    <span class="p">},</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Notice that we are not using the traditional <code>google.golang.org/grpc/status</code> here. We are using <code>google.golang.org/genproto/googleapis/rpc/status</code>. <strong>As of the time of writing this, I'm not aware of why this is the case. I might come back and update that when I learned why.</strong></p>
<p>Finally, we can finish the implementation of both <code>Check</code> and <code>Greet</code>. We will make <code>Greet</code> return an empty response. And we will make <code>Check</code> return the result of <code>denied</code> in case of error and wrong token, or return the result of <code>allowed</code> if everything goes well.</p>
<div class="code_switcher_container_parent 427a5fab-cd2a-4a5b-a00a-b014a191ce72"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="s">"net/http"</span>
  <span class="c">//...</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Check</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">auth</span><span class="o">.</span><span class="n">CheckResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">headers</span> <span class="o">:=</span> <span class="n">req</span><span class="o">.</span><span class="n">Attributes</span><span class="o">.</span><span class="n">Request</span><span class="o">.</span><span class="n">Http</span><span class="o">.</span><span class="n">Headers</span>
  <span class="n">ok</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">containsToken</span><span class="p">(</span><span class="n">headers</span><span class="p">[</span><span class="s">"token"</span><span class="p">])</span>

  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">denied</span><span class="p">(</span>
      <span class="n">http</span><span class="o">.</span><span class="n">StatusBadRequest</span><span class="p">,</span>
      <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"failed retrieving the api key: %v"</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span>
    <span class="p">),</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">denied</span><span class="p">(</span><span class="n">http</span><span class="o">.</span><span class="n">StatusUnauthorized</span><span class="p">,</span> <span class="s">"unauthorized"</span><span class="p">),</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">allowed</span><span class="p">(),</span> <span class="no">nil</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="o">*</span><span class="n">Server</span><span class="p">)</span> <span class="n">Greet</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">,</span> <span class="n">req</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">GreetRequest</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">GreetResponse</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">pb</span><span class="o">.</span><span class="n">GreetResponse</span><span class="p">{},</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<h2 id="demo-time">Demo Time!</h2>
<p>Here we are! It's demo time baby!</p>
<p>To test all of this, we will run our server:</p>
<div class="code_switcher_container_parent dc8690ef-386c-4de2-bd05-35a5e2545671"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go run server/<span class="k">*</span>.go
listening at 0.0.0.0:50051
</code></pre></div></div>
</div>
<p>After that, let's use <a href="https://func-e.io/">func-e</a> to run our Envoy instance:</p>
<div class="code_switcher_container_parent ce4c41ea-f3eb-4f34-aa79-b834eae833bf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>func-e run <span class="nt">-c</span> envoy/config.yaml
</code></pre></div></div>
</div>
<p>And finally, I will use <a href="https://github.com/fullstorydev/grpcurl">grpcurl</a> to query the Greet endpoint on <code>0.0.0.0:50050</code> (Envoy listener). Let's start with the happy path scenario:</p>
<div class="code_switcher_container_parent 0e83dfc7-fdb0-4536-ad99-66dddb6a6998"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/greet.proto <span class="se">\</span>
          <span class="nt">-rpc-header</span><span class="o">=</span><span class="s2">"token: authz"</span> <span class="se">\</span>
          0.0.0.0:50050 greet.GreetService/Greet
<span class="o">{</span>

<span class="o">}</span>
</code></pre></div></div>
</div>
<p>We get an empty <code>GreetResponse</code>, as expected.</p>
<p>Now, we can try without token:</p>
<div class="code_switcher_container_parent a2777b0a-339c-4a69-b191-f02fabcb0745"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/greet.proto <span class="se">\</span>
          0.0.0.0:50050 greet.GreetService/Greet
ERROR:
  Code: Internal
  Message: failed retrieving the api key: empty key
</code></pre></div></div>
</div>
<p>We get an Internal error with the message &quot;empty key&quot;.</p>
<p>And finally, we test with a wrong token:</p>
<div class="code_switcher_container_parent 3b0df074-8ae8-469b-99cd-225f89ad3359"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>grpcurl <span class="nt">-plaintext</span> <span class="se">\</span>
          <span class="nt">-proto</span> proto/greet.proto <span class="se">\</span>
          <span class="nt">-rpc-header</span><span class="o">=</span><span class="s2">"token: authd"</span> <span class="se">\</span>
          0.0.0.0:50050 greet.GreetService/Greet
ERROR:
  Code: Unauthenticated
  Message: unauthorized
</code></pre></div></div>
</div>
<p>Unauthorized! Great everything is working as expected.</p>
<h2 id="conclusion">Conclusion</h2>
<p>In this post we saw that we can use Envoy to sit between our services and call an Authorization service to decide whether or not to forward the request to a given route. In our case, we worked on a simple token checking logic but this should look similar for your real-life scenario. I hope this was interesting, thank you for reading!</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="gRPC" /><category term="Envoy" /><summary type="html"><![CDATA[Recently, I've been looking for a good alternative to Traefik as Reverse Proxy for gRPC services. Traefik has great support for gRPC and other common features, but Envoy comes with Protobuf-backed configuration and even greater support for gRPC services. In the article, I want to show how you can make Envoy use your custom authorization logic before redirecting (or not) the request to other services.]]></summary></entry><entry><title type="html">Range Testing in Strings</title><link href="https://clement-jean.github.io/range_testing_in_strings/" rel="alternate" type="text/html" title="Range Testing in Strings" /><published>2023-06-02T00:00:00+02:00</published><updated>2023-06-02T00:00:00+02:00</updated><id>https://clement-jean.github.io/range_testing_in_strings</id><content type="html" xml:base="https://clement-jean.github.io/range_testing_in_strings/"><![CDATA[<p>Recently, I've been working on adding support for <code>SourceCodeInfo</code> into <a href="https://github.com/Clement-Jean/protein">Protein</a>. This required checking a lot of Column/Line ranges in string. An example of this is the following. Given a oneof like this:</p>
<div class="code_switcher_container_parent 30ab2785-d387-4112-a4c4-32141afcb98b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">oneof</span> <span class="n">Test</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>we should come up with the following ranges:</p>
<div class="code_switcher_container_parent d93c29b8-0fdb-41a0-81e0-79b83f2ba7b3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>
  // line,column
  <span class="o">{</span>0, 0, 2, 1<span class="o">}</span> // oneof - from 0,0 to 2, 1
  <span class="o">{</span>1, 2, 15<span class="o">}</span>   // oneof field - from 1,2 to 1,15 <span class="o">(</span>same lines get ommited<span class="o">)</span>
  <span class="o">{</span>1, 2, 7<span class="o">}</span>    // oneof field <span class="nb">type</span> - from 1,2 to 1,7
  <span class="o">{</span>1, 8, 10<span class="o">}</span>   // oneof field name - from 1,8 to 1,10
  <span class="o">{</span>1, 13, 14<span class="o">}</span>  // oneof field tage - from 1,13 to 1,14
<span class="o">]</span>
</code></pre></div></div>
</div>
<p>This might seem like a daunting and it was until I found out how to test ranges correctly for these kind of situations.</p>
<h2 id="sourcecodeinfo">SourceCodeInfo</h2>
<p>Before starting with the whole testing thing. It is important to get a sense of what a Protobuf's <code>SourceCodeInfo</code> is. As its name suggests this is information about the source code. This information is basically lines and columns for tokens (called spans) and some tags sequence starting from <code>FileDescriptorProto</code> (called path). This info is mostly important for tools like what Protein will be: linters, LSPs, ... It gives us a way to find elements both in terms of position (line 1, column 10) in code and in terms of context (a oneof inside a message).</p>
<p>While the second part is pretty interesting, we are not going to cover that. We will focus on testing the spans correctly. However, if you are interested in learning more about paths, I'd be happy to write an article on it. Leave a comment if you are.</p>
<h2 id="naive-testing">Naive Testing</h2>
<p>Now that we know what are <code>SourceCodeInfo</code> we can start with the testing. A naive and rather manual solution to solve this is probably writing every span by hand. This is pretty much what I did in the introduction of this article. This could mean something like this:</p>
<div class="code_switcher_container_parent a0d5cbdc-331b-4c02-9323-4b0cdaf39160"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
  <span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
  <span class="n">info</span> <span class="p">[]</span><span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">SourceCodeInfo_Location</span><span class="p">,</span>
  <span class="n">expectedSpans</span> <span class="p">[][]</span><span class="kt">int32</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">==</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="s">"expected info"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">expectedSpans</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"expected %v, got: %v"</span><span class="p">,</span> <span class="n">expectedSpans</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">expectedSpan</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">expectedSpans</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Span</span><span class="p">,</span> <span class="n">expectedSpan</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"path %d wrong. expected %v, got: %v"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">expectedSpan</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">Span</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestOneofSourceCodeInfo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// Arrange</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

  <span class="c">// Act</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">:=</span> <span class="n">augmentParse</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">),</span> <span class="no">nil</span><span class="p">)</span>

  <span class="c">// Assert</span>
  <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">info</span><span class="p">,</span>
    <span class="p">[][]</span><span class="kt">int32</span><span class="p">{</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">45</span><span class="p">},</span>  <span class="c">// oneof - from 0,0 to 0, 45</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">13</span><span class="p">,</span> <span class="m">26</span><span class="p">},</span> <span class="c">// oneof field - from 0,13 to 0,26</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">13</span><span class="p">,</span> <span class="m">18</span><span class="p">},</span> <span class="c">// oneof field type - from 0,13 to 0,18</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">19</span><span class="p">,</span> <span class="m">21</span><span class="p">},</span> <span class="c">// oneof field name - from 0,19 to 0,21</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">24</span><span class="p">,</span> <span class="m">25</span><span class="p">},</span> <span class="c">// oneof field tage - from 0,24 to 0,25</span>
      <span class="c">// etc...</span>
    <span class="p">},</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This looks rather simple and if we stick to testing small pieces of code, it is feasible to get our way through. However, as you might expect, this is tiring and very repetitive work. Imagine doing that for every single concept in Protobuf...</p>
<h2 id="a-better-way">A Better Way</h2>
<p>For full disclosure, this idea for testing ranges in strings is not my idea. This is an idea I discovered after reading Protobuf documentation and unit tests. An example of this is the documentation for <code>SourceCodeInfo</code> in the descriptor.proto file:</p>
<div class="code_switcher_container_parent 140b533d-b3ca-41a5-b87b-40df2863a5fd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Let's look at just the field definition:</span>
<span class="c">//   optional string foo = 1;</span>
<span class="c">//   ^       ^^     ^^  ^  ^^^</span>
<span class="c">//   a       bc     de  f  ghi</span>
<span class="c">// We have the following locations:</span>
<span class="c">//   span   path               represents</span>
<span class="c">//   [a,i)  [ 4, 0, 2, 0 ]     The whole field definition.</span>
<span class="c">//   [a,b)  [ 4, 0, 2, 0, 4 ]  The label (optional).</span>
<span class="c">//   [c,d)  [ 4, 0, 2, 0, 5 ]  The type (string).</span>
<span class="c">//   [e,f)  [ 4, 0, 2, 0, 1 ]  The name (foo).</span>
<span class="c">//   [g,h)  [ 4, 0, 2, 0, 3 ]  The number (1).</span>
</code></pre></div></div>
</div>
<p>We can just focus on the span and how they mark the beginning and end of them with letters. <code>optional</code> as a span of [a, b) (from a to b non-inclusive). Meaning that we go from column 0 to column 8 (length of the work optional) but you can see that <code>b</code> is marking the space character so we do not include that.</p>
<p>Now, even I didn't get the original idea, I believe that implementing it in Go (original in C++) and adding line support is quite interesting. Let us start by the v1 which didn't support multiline code.</p>
<p>The idea is that we are going to have function calculating indices from a string full of separator characters and letters. For example, if we say that the separator is '-', we could have a string like this:</p>
<div class="code_switcher_container_parent 3722f245-6a31-4a8a-a374-e52e12263b6d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>a------------b----cd-e--fghi-----jk---l--mno-p
</code></pre></div></div>
</div>
<p>that would match a oneof like this one:</p>
<div class="code_switcher_container_parent 9ce168d2-1864-4ffd-a0e8-3229a5527588"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">oneof</span> <span class="n">Test</span> <span class="p">{</span> <span class="kt">int32</span> <span class="na">id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="kt">string</span> <span class="na">uuid</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="p">}</span>
</code></pre></div></div>
</div>
<p>To better see it we will have a function that takes both the original Protobuf code and the reference string (that is what I called the separator-full string) as parameters:</p>
<div class="code_switcher_container_parent d84fa6d8-ac5b-4825-b0d1-cfb6a1364d0c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">referenceString</span><span class="p">(</span>
  <span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">,</span>
  <span class="s">"a------------b----cd-e--fghi-----jk---l--mno-p"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>
</div>
<p>This nicely matches and it is easier to visually see where the span starts and ends when we know the letter. If I told you there should be a span [b, h), you can clearly understand that these references to the id field definition.</p>
<p>Now, how should we represent all of this in terms of data structure? The naive approach is to create a <code>map[rune]int32</code>. The <code>rune</code> will be the letterm and we are return <code>int32</code> instead of <code>int</code> simply because <code>SourceCodeInfo</code> is expecting <code>int32</code>s. Then, when we will want to check the value of <code>a</code>, we can simply do:</p>
<div class="code_switcher_container_parent f473b2ed-4548-4e44-943b-1cfef9f5723f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">a</span> <span class="o">:=</span> <span class="n">refs</span><span class="p">[</span><span class="sc">'a'</span><span class="p">]</span>
</code></pre></div></div>
</div>
<p>This doesn't seem that bad right? Well, what if you need to access letters a to z? You basically have 26 of these variables around. Feasible but not that ergonomic.</p>
<h2 id="an-even-better-way">An Even Better Way</h2>
<p>My second thought on how to improve this comes from my early interest in reflection. I find it amazing that we take a look at the guts of our program and manipulate it programmatically. An example of that is listing all the fields in a struct and/or set values to them. I don't know what you think but for me this is just so powerful (and dangerous!).</p>
<p>Enough about my geekiness on reflection. What if we could simply have an object into which we will set the values of our spans. This would let us write something like following for accessing values:</p>
<div class="code_switcher_container_parent e193109a-5be4-45d4-8c55-2f0ae01e6975"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ref</span><span class="o">.</span><span class="n">A</span>
</code></pre></div></div>
</div>
<p>How nice would that be? We would only have one variable (ref) and we could access the fields.</p>
<p>It turns out that we can do it pretty easily. Think about a <code>struct</code> like the following:</p>
<div class="code_switcher_container_parent ccd91773-8bc5-4613-a4ab-b859bd979ce0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Ref</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">A</span><span class="p">,</span> <span class="n">B</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">E</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">M</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">O</span><span class="p">,</span> <span class="n">P</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">R</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">W</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span> <span class="kt">int32</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>I agree that this definition is not that beautiful but it will make our test code easier to read.</p>
<p>With that <code>Ref</code>, we will now use reflection to set <code>A</code> (uppercase because reflection require exported fields) when we see a <code>a</code> in the string. This will look like this:</p>
<div class="code_switcher_container_parent 6c5dbf8c-26de-4ad9-b13b-37524e426bc5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// referenceString returns the original string and the newly created Ref</span>
<span class="c">// the sep argument is the separator we skip (e.g `-`)</span>
<span class="k">func</span> <span class="n">referenceString</span><span class="p">(</span><span class="n">src</span> <span class="kt">string</span><span class="p">,</span> <span class="n">indices</span> <span class="kt">string</span><span class="p">,</span> <span class="n">sep</span> <span class="kt">rune</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">Ref</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// indices should always be longer than src by 1 rune</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">+</span><span class="m">1</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">"wrong indices"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">ref</span> <span class="o">:=</span> <span class="n">Ref</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">indices</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">sep</span> <span class="p">{</span>
      <span class="c">// checks valid characters (lowercase letter)</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLetter</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLower</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v is not a lowercase letter"</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
      <span class="p">}</span>

      <span class="c">// this is the index of the letter in our Ref struct!</span>
      <span class="c">// e.g A is at index 0 and Z is at index 25</span>
      <span class="n">idx</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="kt">byte</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="sc">'a'</span><span class="p">)</span> <span class="c">// ASCII trick to get index of letter in alphabet</span>

      <span class="c">// set the value of i to the field at index idx</span>
      <span class="n">reflect</span><span class="o">.</span><span class="n">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">Elem</span><span class="p">()</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">SetInt</span><span class="p">(</span><span class="kt">int64</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">ref</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>with that we can simply write the following:</p>
<div class="code_switcher_container_parent 31bdf661-c946-4d45-adf5-137cf791c7b7"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
  <span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">,</span>
  <span class="s">"a------------b----cd-e--fghi-----jk---l--mno-p"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>
</div>
<p>and if we print <code>ref</code> we get:</p>
<div class="code_switcher_container_parent 0d7c0b4c-38d9-4d0a-8ee6-acf90f673692"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Ref</span> <span class="p">{</span><span class="n">A</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">B</span><span class="o">:</span> <span class="m">13</span><span class="p">,</span> <span class="n">C</span><span class="o">:</span> <span class="m">18</span><span class="p">,</span> <span class="n">D</span><span class="o">:</span> <span class="m">19</span><span class="p">,</span> <span class="n">E</span><span class="o">:</span> <span class="m">21</span><span class="p">,</span> <span class="n">F</span><span class="o">:</span> <span class="m">24</span><span class="p">,</span> <span class="n">G</span><span class="o">:</span> <span class="m">25</span><span class="p">,</span> <span class="n">H</span><span class="o">:</span> <span class="m">26</span><span class="p">,</span> <span class="n">I</span><span class="o">:</span> <span class="m">27</span><span class="p">,</span> <span class="n">J</span><span class="o">:</span> <span class="m">33</span><span class="p">,</span> <span class="n">K</span><span class="o">:</span> <span class="m">34</span><span class="p">,</span> <span class="n">L</span><span class="o">:</span> <span class="m">38</span><span class="p">,</span> <span class="n">M</span><span class="o">:</span> <span class="m">41</span><span class="p">,</span> <span class="n">N</span><span class="o">:</span> <span class="m">42</span><span class="p">,</span> <span class="n">O</span><span class="o">:</span> <span class="m">43</span><span class="p">,</span> <span class="n">P</span><span class="o">:</span> <span class="m">45</span><span class="p">,</span> <span class="n">Q</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">R</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">S</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">T</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">U</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">V</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">W</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">X</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">Y</span><span class="o">:</span> <span class="m">0</span><span class="p">,</span> <span class="n">Z</span><span class="o">:</span> <span class="m">0</span><span class="p">}</span>
</code></pre></div></div>
</div>
<p>If we check at the span [b, h), we can see that we have [13, 26). This is quite powerful and way more readable. If we rewrite the <code>TestOneofSourceCodeInfo</code> function with the use of <code>Ref</code>, we have:</p>
<div class="code_switcher_container_parent d0aa1619-759a-423d-8628-f9b8f52975ec"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestOneofSourceCodeInfo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="c">// Arrange</span>
  <span class="n">pb</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
    <span class="s">"oneof Test { int32 id = 1; string uuid = 2; }"</span><span class="p">,</span>
    <span class="s">"a------------b----cd-e--fghi-----jk---l--mno-p"</span><span class="p">,</span>
    <span class="sc">'-'</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

  <span class="c">// Act</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">:=</span> <span class="n">augmentParse</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">),</span> <span class="no">nil</span><span class="p">)</span>

  <span class="c">// Assert</span>
  <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">info</span><span class="p">,</span>
    <span class="p">[][]</span><span class="kt">int32</span><span class="p">{</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">P</span><span class="p">},</span>  <span class="c">// oneof - from 0,0 to 0, 45</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">H</span><span class="p">},</span> <span class="c">// oneof field - from 0,13 to 0,26</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">C</span><span class="p">},</span> <span class="c">// oneof field type - from 0,13 to 0,18</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">E</span><span class="p">},</span> <span class="c">// oneof field name - from 0,19 to 0,21</span>
      <span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">G</span><span class="p">},</span> <span class="c">// oneof field tage - from 0,24 to 0,25</span>
      <span class="c">// etc...</span>
    <span class="p">},</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>This now look a little bit less magic than before with all these numbers everywhere.</p>
<h2 id="supporting-lines">Supporting lines</h2>
<p>As you can see, we still have these 0s for each line. They actually represent lines. Could we also support multiline code? This would let us write something like:</p>
<div class="code_switcher_container_parent f3c4d776-c9c0-4056-b974-bb7f9b7fb81d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pb</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
  <span class="s">`oneof Test {
int32 id = 1;
string uuid = 2;
}`</span><span class="p">,</span>
  <span class="s">`a------------
b----cd-e--fgh
i-----jk---l--mno
-p`</span><span class="p">,</span>
  <span class="sc">'-'</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div>
</div>
<p>Without indentation that looks a little bit weird but this is already letting us testing a little bit more in depth.</p>
<p>The first thing that we are going to do is adding fields in <code>Ref</code> for lines. This looks like:</p>
<div class="code_switcher_container_parent 0a7b8318-cdb4-4395-affd-5e7d6358d4db"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Ref</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="n">LA</span><span class="p">,</span> <span class="n">LB</span><span class="p">,</span> <span class="n">LC</span><span class="p">,</span> <span class="n">LD</span><span class="p">,</span> <span class="n">LE</span><span class="p">,</span> <span class="n">LF</span><span class="p">,</span> <span class="n">LG</span><span class="p">,</span> <span class="n">LH</span><span class="p">,</span> <span class="n">LI</span><span class="p">,</span> <span class="n">LJ</span><span class="p">,</span> <span class="n">LK</span><span class="p">,</span> <span class="n">LL</span><span class="p">,</span> <span class="n">LM</span><span class="p">,</span> <span class="n">LN</span><span class="p">,</span> <span class="n">LO</span><span class="p">,</span> <span class="n">LP</span><span class="p">,</span> <span class="n">LQ</span><span class="p">,</span> <span class="n">LR</span><span class="p">,</span> <span class="n">LS</span><span class="p">,</span> <span class="n">LT</span><span class="p">,</span> <span class="n">LU</span><span class="p">,</span> <span class="n">LV</span><span class="p">,</span> <span class="n">LW</span><span class="p">,</span> <span class="n">LX</span><span class="p">,</span> <span class="n">LY</span><span class="p">,</span> <span class="n">LZ</span> <span class="kt">int32</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Cringing a little? It's fine! Keep in mind that this is for the sake of having more expressive tests.</p>
<p>Now, in referenceString we will keep track of columns and lines and, for <code>a</code>, we are going to set <code>A</code> to the column and <code>LA</code> to the line. We now have:</p>
<div class="code_switcher_container_parent 76d97006-e9ca-4adc-8187-5f65dbf71edc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">referenceString</span><span class="p">(</span><span class="n">src</span> <span class="kt">string</span><span class="p">,</span> <span class="n">indices</span> <span class="kt">string</span><span class="p">,</span> <span class="n">sep</span> <span class="kt">rune</span><span class="p">)</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">Ref</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">strings</span><span class="o">.</span><span class="n">ReplaceAll</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">src</span><span class="p">)</span><span class="o">+</span><span class="m">1</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">"wrong indices"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">ref</span> <span class="o">:=</span> <span class="n">Ref</span><span class="p">{}</span>
  <span class="n">line</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="c">// the line</span>
  <span class="n">column</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="m">0</span><span class="p">)</span> <span class="c">// the column - do not use i anymore</span>

  <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">index</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">indices</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">!=</span> <span class="n">sep</span> <span class="o">&amp;&amp;</span> <span class="n">index</span> <span class="o">!=</span> <span class="sc">'\n'</span> <span class="p">{</span> <span class="c">// also check '\n'</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLetter</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsLower</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">panic</span><span class="p">(</span><span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="s">"%v is not a lowercase letter"</span><span class="p">,</span> <span class="n">index</span><span class="p">))</span>
      <span class="p">}</span>

      <span class="n">idx</span> <span class="o">:=</span> <span class="kt">int</span><span class="p">(</span><span class="kt">byte</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">-</span> <span class="sc">'a'</span><span class="p">)</span>

      <span class="c">// set the column</span>
      <span class="n">reflect</span><span class="o">.</span><span class="n">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">Elem</span><span class="p">()</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">SetInt</span><span class="p">(</span><span class="kt">int64</span><span class="p">(</span><span class="n">column</span><span class="p">))</span>

      <span class="c">// set the line</span>
      <span class="n">reflect</span><span class="o">.</span><span class="n">ValueOf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">)</span><span class="o">.</span><span class="n">Elem</span><span class="p">()</span><span class="o">.</span><span class="n">Field</span><span class="p">(</span><span class="n">idx</span> <span class="o">+</span> <span class="m">26</span><span class="p">)</span><span class="o">.</span><span class="n">SetInt</span><span class="p">(</span><span class="kt">int64</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="n">column</span> <span class="o">+=</span> <span class="m">1</span>

    <span class="c">// on newline reset column and increase line</span>
    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="p">{</span>
      <span class="n">line</span><span class="o">++</span>
      <span class="n">column</span> <span class="o">=</span> <span class="m">0</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">src</span><span class="p">,</span> <span class="n">ref</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>With that we can now write a test for multiline like this:</p>
<div class="code_switcher_container_parent e389edf3-85b4-4f65-9f6d-53b04cfc4c6d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestOneofMultilineSourceCodeInfo</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">pb</span><span class="p">,</span> <span class="n">ref</span> <span class="o">:=</span> <span class="n">referenceString</span><span class="p">(</span>
    <span class="s">`oneof Test {
int32 id = 1;
string uuid = 2;
}`</span><span class="p">,</span>
    <span class="s">`a------------
b----cd-e--fgh
i-----jk---l--mno
-p`</span><span class="p">,</span>
    <span class="sc">'-'</span><span class="p">,</span>
  <span class="p">)</span>

  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="n">pb</span><span class="p">)</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
  <span class="n">ctx</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">oneofContext</span><span class="p">{}</span>

  <span class="c">// Act</span>
  <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">:=</span> <span class="n">augmentParse</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span><span class="o">.</span><span class="n">parseOneof</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">),</span> <span class="n">ctx</span><span class="p">)</span>

  <span class="c">// Assert</span>
  <span class="n">runSourceCodeInfoCheck</span><span class="p">(</span>
    <span class="n">t</span><span class="p">,</span>
    <span class="n">info</span><span class="p">,</span>
    <span class="p">[][]</span><span class="kt">int32</span><span class="p">{</span>
      <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LA</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">LP</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">P</span><span class="p">},</span>
      <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LB</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">H</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LB</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">B</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">C</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LD</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">D</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">E</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LF</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">G</span><span class="p">},</span>
      <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LI</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">O</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LI</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">J</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LK</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">L</span><span class="p">},</span> <span class="p">{</span><span class="n">ref</span><span class="o">.</span><span class="n">LM</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">M</span><span class="p">,</span> <span class="n">ref</span><span class="o">.</span><span class="n">N</span><span class="p">},</span>
    <span class="p">},</span>
  <span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Take your time to wrap your mind around it. We just made the all things look a little bit more verbose but less magical and frightening.</p>
<h2 id="advantages">Advantages</h2>
<ul>
<li>New developers looking at these tests will probably be less afraid of writing a new test.</li>
<li>Fewer places where we can make typos. Most typos will be in the reference string.</li>
<li>Changing the spans or separators requires us to only update the reference strings, not all the numbers in int32 arrays.</li>
<li>Reflection is letting us create a map out of a struct and have fewer variables.</li>
</ul>
<h2 id="disadvantages">Disadvantages</h2>
<ul>
<li>More verbose.</li>
<li>Reflection is kind of magical too. However, magic is only happening in <code>referenceString</code>. Not everywhere like before.</li>
</ul>
<h2 id="conclusion">Conclusion</h2>
<p>I hope this makes you as interested as I am on how to improve testing code. I already loved creating readable and deterministic tests but now with this other tool in my tool belt, I'm interested in thinking more about readability and developer onboarding.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="Protobuf" /><summary type="html"><![CDATA[Recently, I've been working on adding support for SourceCodeInfo into Protein. This required checking a lot of Column/Line ranges in string. An example of this is the following. Given a oneof like this:]]></summary></entry><entry><title type="html">Custom RPC Options in Protobuf</title><link href="https://clement-jean.github.io/custom_rpc_options/" rel="alternate" type="text/html" title="Custom RPC Options in Protobuf" /><published>2023-04-17T00:00:00+02:00</published><updated>2023-04-17T00:00:00+02:00</updated><id>https://clement-jean.github.io/custom_rpc_options</id><content type="html" xml:base="https://clement-jean.github.io/custom_rpc_options/"><![CDATA[<p>Recently I had to design authentication for a Blazor Application. After finishing implementing, I soon faced the need to know which RPC endpoint needs authentication and which doesn't. And while part of the problem is a solved one, I still needed a mechanism to let me define this. Let's see how.</p>
<blockquote>
<p>All the code (<strong>only running through Bazel right now</strong>) is available <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-04-17-custom_rpc_options">here</a></p>
</blockquote>
<h2 id="custom-options">Custom Options</h2>
<p>Before explaining what my solution to the problem is, I'd like to make sure you understand what are custom options in Protobuf and how to define one. If you are confident about this skill, feel free to skip to the next section.</p>
<p><strong>A custom option is a way to define metadata for a proto file, message, enum, fields, service and rpc</strong>. Generally, we are used to these:</p>
<div class="code_switcher_container_parent 24e50472-5d97-47f0-8e49-14c9085e1c40"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"github.com/Clement-Jean/test"</span><span class="p">;</span>
</code></pre></div></div>
</div>
<p>being placed at the top of the proto file. But it is important to know that you can make a field or message deprecated like so:</p>
<div class="code_switcher_container_parent 7819b959-c0c0-4977-a5a0-455f7182547d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Test</span> <span class="p">{</span>
  <span class="k">option</span> <span class="na">deprecated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kt">int32</span> <span class="na">field</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span> <span class="na">deprecated</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Now, I agree that, in most of the cases, these option are more informational than anything else. They do not necessarily impact the code generation but they are here to document the code. Also, knowing that Protobuf has reflection, we can use them in our code. This means that we could have a tool checking for deprecated messages, fields, ... and give us warnings when we use them in our code base.</p>
<p>How do we define one, though? Well, it turns out that this is pretty simple. We need to use the <code>extend</code> concept and define which kind of option we want to extend. Let's first take a look at what kind of options we have:</p>
<ul class="code-tab-container 07c84017-2abb-4245-8ca5-05891393d490"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '07c84017-2abb-4245-8ca5-05891393d490', 0)">descriptor.proto</a></li></ul><ul class="code-tab-switcher 07c84017-2abb-4245-8ca5-05891393d490"><li class="code_switcher_container_parent active-tab code_switcher_proto 1d1884db-8e11-4ed2-b545-72413387c34c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">FileOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>

  <span class="c1">// Clients can define custom options in extensions of this message. See above.</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">MessageOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">FieldOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">OneofOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">EnumOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">EnumValueOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">ServiceOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">MethodOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>That's actually every concept that we have in Protobuf! So let's define a simple option now. We will define an option called <code>hello</code> of type string. And for making this related to the problem that I'm trying to solve, let's define that option in <code>MethodOptions</code> which represents the options for RPC endpoints.</p>
<p>So we will extend <code>MethodOptions</code>:</p>
<ul class="code-tab-container d148cf5b-6192-4546-b070-017fb0f03208"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'd148cf5b-6192-4546-b070-017fb0f03208', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher d148cf5b-6192-4546-b070-017fb0f03208"><li class="code_switcher_container_parent active-tab code_switcher_proto 0333badd-4642-4271-861f-c8b18048eea1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"google/protobuf/descriptor.proto"</span><span class="p">;</span>

<span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And then inside this <code>extend</code> we can just write the hello field:</p>
<ul class="code-tab-container 02e3d154-f8b2-4287-9ecc-55a3ff99eaf2"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '02e3d154-f8b2-4287-9ecc-55a3ff99eaf2', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher 02e3d154-f8b2-4287-9ecc-55a3ff99eaf2"><li class="code_switcher_container_parent active-tab code_switcher_proto cafc18e5-4aaf-4b7a-8077-64285c789815"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">hello</span> <span class="o">=</span> <span class="err">??</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>But what is the tag that we need to use? Well, if you noticed in the <code>descriptor.proto</code> we have an extension range. These are the numbers we can use for tag. For now, we will use 1000, however, be aware that some of these tags are reserved by some already defined options. <strong>So if you were to use a tool that defines options that have the same tag number, there would be conflicts</strong>.</p>
<p>We now have:</p>
<ul class="code-tab-container f486719f-c140-4f80-9680-c0405b2289e3"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'f486719f-c140-4f80-9680-c0405b2289e3', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher f486719f-c140-4f80-9680-c0405b2289e3"><li class="code_switcher_container_parent active-tab code_switcher_proto da77ee9f-256c-4e8a-af73-d609b73f690b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">hello</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="reflection">Reflection</h2>
<p>Let us now use that option and read the value in code.</p>
<p>To use it, this is pretty simple, we just need to import the file in which we wrote the <code>extend</code> and make sure we use the option on an RPC endpoint.</p>
<ul class="code-tab-container 7e25f2a7-16c2-47dc-9507-7c1206ea1085"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '7e25f2a7-16c2-47dc-9507-7c1206ea1085', 0)">world.proto</a></li></ul><ul class="code-tab-switcher 7e25f2a7-16c2-47dc-9507-7c1206ea1085"><li class="code_switcher_container_parent active-tab code_switcher_proto 9e66b495-3333-49ff-a498-db7c2f15bd20"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"hello.proto"</span><span class="p">;</span>

<span class="c1">//...</span>

<span class="kd">service</span> <span class="n">HelloWorldService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">HelloWorld</span> <span class="p">(</span><span class="n">HelloWorldRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloWorldResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">option</span> <span class="p">(</span><span class="n">hello</span><span class="p">)</span> <span class="o">=</span> <span class="s">"world"</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We can generate the proto files out of world.proto and hello.proto. And after that we can take a bottom-up approach to read this value through reflection. By bottom up, I mean that we are going to first see how to read the value of a <code>MethodOptions</code>, then we will go to getting a <code>MethodDescriptor</code> out of a <code>ServiceDescriptor</code>, and finally getting a <code>ServiceDescriptor</code> out a <code>FileDescriptor</code>.</p>
<h3 id="getting-an-option-value">Getting an Option Value</h3>
<p>The first thing we are going to deal with is <code>MethodOptions</code>. These represent the options set on an RPC endpoint. In most of the implementations, we can check the existence of an option so this is as simple as &quot;check if there is the option with a given id on this method, if yes return the value, otherwise return null&quot;.</p>
<ul class="code-tab-container c6c0ae96-a05e-4985-852b-b8381983c611"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c6c0ae96-a05e-4985-852b-b8381983c611', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', 'c6c0ae96-a05e-4985-852b-b8381983c611', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', 'c6c0ae96-a05e-4985-852b-b8381983c611', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', 'c6c0ae96-a05e-4985-852b-b8381983c611', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', 'c6c0ae96-a05e-4985-852b-b8381983c611', 4)">main.cs</a></li></ul><ul class="code-tab-switcher c6c0ae96-a05e-4985-852b-b8381983c611"><li class="code_switcher_container_parent active-tab code_switcher_go bbd76049-872b-4b8f-bce4-dbfed1785251"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="s">"google.golang.org/protobuf/proto"</span>
  <span class="s">"google.golang.org/protobuf/reflect/protoreflect"</span>
  <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">getOptionValue</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span> <span class="c">// T is not covering all types...</span>
  <span class="n">opts</span> <span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">MethodOptions</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="n">value</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">proto</span><span class="o">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">value</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp d929077f-b0e0-4564-bde9-47c8421f5aae"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;optional&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">OPT_T</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">OPT_T</span><span class="o">&gt;</span> <span class="n">get_option_value</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">MethodOptions</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">,</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">id</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">opts</span><span class="p">.</span><span class="n">HasExtension</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">?</span>
    <span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 56a19574-6a6b-4b6b-85f8-b3b899df04cc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.DescriptorProtos</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.protobuf.GeneratedMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getOptionValue</span><span class="o">(</span>
  <span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span> <span class="n">opts</span><span class="o">,</span>
  <span class="nc">GeneratedMessage</span><span class="o">.</span><span class="na">GeneratedExtension</span><span class="o">&lt;</span><span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">id</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">opts</span><span class="o">.</span><span class="na">hasExtension</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">?</span>
    <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">((</span><span class="no">T</span><span class="o">)</span><span class="n">opts</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">id</span><span class="o">))</span> <span class="o">:</span>
    <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python 1c41e8e0-a49e-45ae-a650-5cf767b2c47d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_option_value</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">.</span><span class="n">ListFields</span><span class="p">():</span>
    <span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s">""</span> <span class="ow">and</span> <span class="n">desc</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp 04f45636-1acd-4315-b7aa-e7b126712daa"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">pb</span> <span class="p">=</span> <span class="k">global</span><span class="p">::</span><span class="n">Google</span><span class="p">.</span><span class="n">Protobuf</span><span class="p">;</span>

<span class="k">static</span> <span class="k">private</span> <span class="n">T</span> <span class="n">GetOptionValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="k">this</span> <span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span> <span class="n">md</span><span class="p">,</span> <span class="c1">// MethodDescriptor and not MethodOptions as promised (sorry!)</span>
  <span class="n">pb</span><span class="p">::</span><span class="n">Extension</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodOptions</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">id</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="n">md</span><span class="p">.</span><span class="nf">GetOptions</span><span class="p">().</span><span class="nf">GetExtension</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</code></pre></div></div>
</li></ul>
<h3 id="getting-a-method">Getting a Method</h3>
<p>The next step is to get a <code>MethodDescriptor</code> out of a <code>ServiceDescriptor</code>. This is done so that we can later call the GetOptionValue function on the options of that method (if any). We will basically loop over all the methods of a service and check for a predicate on each. If the predicate returns true, we &quot;select&quot; that method.</p>
<ul class="code-tab-container 3737e9ea-0c1c-4f64-afda-ab46ac75739d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '3737e9ea-0c1c-4f64-afda-ab46ac75739d', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '3737e9ea-0c1c-4f64-afda-ab46ac75739d', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '3737e9ea-0c1c-4f64-afda-ab46ac75739d', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '3737e9ea-0c1c-4f64-afda-ab46ac75739d', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '3737e9ea-0c1c-4f64-afda-ab46ac75739d', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 3737e9ea-0c1c-4f64-afda-ab46ac75739d"><li class="code_switcher_container_parent active-tab code_switcher_go 8be23dca-9e8d-41a4-a183-40054dc517e4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">getServiceMethod</span><span class="p">(</span>
  <span class="n">sd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ServiceDescriptor</span><span class="p">,</span>
  <span class="n">fn</span> <span class="k">func</span><span class="p">(</span><span class="n">md</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span><span class="p">)</span> <span class="kt">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">.</span><span class="n">Methods</span><span class="p">()</span><span class="o">.</span><span class="n">Len</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="n">md</span> <span class="o">:=</span> <span class="n">sd</span><span class="o">.</span><span class="n">Methods</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">&amp;</span><span class="n">md</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp 32959f91-4e00-45e7-848d-6ce0a6a3454b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp">
</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*&gt;</span> <span class="n">get_service_method</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">ServiceDescriptor</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">(</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">predicate</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">method_count</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">md</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">predicate</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">md</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 05537d13-f19f-43a0-a991-280a950be4e4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.Descriptors</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span><span class="o">&gt;</span> <span class="nf">getServiceMethod</span><span class="o">(</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">ServiceDescriptor</span> <span class="n">sd</span><span class="o">,</span>
  <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">predicate</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">.</span><span class="na">getMethods</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span> <span class="n">method</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">getMethods</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">predicate</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">method</span><span class="o">))</span>
      <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python 89caa85e-4052-41f2-9bf2-e0f6ca11f479"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">.</span><span class="n">methods_by_name</span><span class="p">:</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">sd</span><span class="p">.</span><span class="n">methods_by_name</span><span class="p">[</span><span class="n">method_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">md</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp be392db9-2c6d-41bb-95ae-8208fb5c0216"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span><span class="p">&gt;</span> <span class="nf">GetServiceMethod</span><span class="p">(</span>
  <span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">ServiceDescriptor</span><span class="p">&gt;</span> <span class="n">services</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="k">from</span> <span class="n">svc</span> <span class="k">in</span> <span class="n">services</span>
     <span class="k">from</span> <span class="n">method</span> <span class="k">in</span> <span class="n">svc</span><span class="p">.</span><span class="n">Methods</span>
     <span class="k">where</span> <span class="nf">predicate</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
     <span class="k">select</span> <span class="n">method</span><span class="p">;</span>
</code></pre></div></div>
</li></ul>
<h3 id="putting-everything-together">Putting Everything Together</h3>
<p>And finally the idea is to call <code>GetServiceMethod</code> on all the <code>ServiceDescriptor</code>s and with the predicate is true we can call <code>GetOptionValue</code> on the method selected.</p>
<ul class="code-tab-container 3f1ed8eb-8e02-414b-a46f-27dcd27b002d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '3f1ed8eb-8e02-414b-a46f-27dcd27b002d', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '3f1ed8eb-8e02-414b-a46f-27dcd27b002d', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '3f1ed8eb-8e02-414b-a46f-27dcd27b002d', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '3f1ed8eb-8e02-414b-a46f-27dcd27b002d', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '3f1ed8eb-8e02-414b-a46f-27dcd27b002d', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 3f1ed8eb-8e02-414b-a46f-27dcd27b002d"><li class="code_switcher_container_parent active-tab code_switcher_go 624b2f34-e329-4ecf-a086-0a5920e30c71"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">getMethodOptionValue</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span>
  <span class="n">sd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ServiceDescriptor</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">value</span> <span class="o">*</span><span class="n">T</span> <span class="o">=</span> <span class="no">nil</span>

  <span class="n">getServiceMethod</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">md</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">md</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">MethodOptions</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">false</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tmp</span> <span class="o">:=</span> <span class="n">getOptionValue</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span>
      <span class="k">return</span> <span class="no">true</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="no">false</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="n">value</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">getMethodExtension</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span>
  <span class="n">fd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">FileDescriptor</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd</span><span class="o">.</span><span class="n">Services</span><span class="p">()</span><span class="o">.</span><span class="n">Len</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="n">sd</span> <span class="o">:=</span> <span class="n">fd</span><span class="o">.</span><span class="n">Services</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">:=</span> <span class="n">getMethodOptionValue</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">sd</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="n">value</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp 795d2f8e-e1f2-49c5-a907-9f09de5cdfb8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">U</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">get_method_option_value</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">ServiceDescriptor</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="c1">// in C++ we can access the ServiceDescriptor directly</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">id</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">;</span>

  <span class="n">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">](</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">get_option_value</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 1f30a24a-a572-46fb-a7d1-ca866b9ce2a3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getMethodExtension</span><span class="o">(</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span>
  <span class="nc">GeneratedMessage</span><span class="o">.</span><span class="na">GeneratedExtension</span><span class="o">&lt;</span><span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">id</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd</span><span class="o">.</span><span class="na">getServices</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Descriptors</span><span class="o">.</span><span class="na">ServiceDescriptor</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getServices</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">world</span> <span class="o">=</span> <span class="n">getMethodOptionValue</span><span class="o">(</span><span class="n">sd</span><span class="o">,</span> <span class="nc">Hello</span><span class="o">.</span><span class="na">hello</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">world</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span>
      <span class="k">return</span> <span class="n">world</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python 8109b56d-ad27-4103-adde-04d197942fb8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_method_option_value</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="n">md</span> <span class="o">=</span> <span class="n">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">md</span><span class="p">:</span> <span class="n">get_option_value</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">GetOptions</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">get_option_value</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">GetOptions</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_method_extension</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">svc_name</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">.</span><span class="n">services_by_name</span><span class="p">:</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">.</span><span class="n">services_by_name</span><span class="p">[</span><span class="n">svc_name</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">get_method_option_value</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp f0defd83-857d-462a-b86c-40a5f5bfbba1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">private</span> <span class="n">T</span> <span class="n">GetMethodOptionValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="k">this</span> <span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">FileDescriptor</span> <span class="n">fd</span><span class="p">,</span>
  <span class="n">pb</span><span class="p">::</span><span class="n">Extension</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodOptions</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">id</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="n">fd</span><span class="p">.</span><span class="n">Services</span>
       <span class="p">.</span><span class="nf">GetServiceMethod</span><span class="p">(</span><span class="n">md</span> <span class="p">=&gt;</span> <span class="n">md</span><span class="p">.</span><span class="nf">GetOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
       <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">()</span>
       <span class="p">.</span><span class="nf">GetOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</code></pre></div></div>
</li></ul>
<h3 id="usage">Usage</h3>
<p>Let's see how to use that in our main function.</p>
<ul class="code-tab-container c068373f-025d-4470-8038-eab0e9ee9d42"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c068373f-025d-4470-8038-eab0e9ee9d42', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', 'c068373f-025d-4470-8038-eab0e9ee9d42', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', 'c068373f-025d-4470-8038-eab0e9ee9d42', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', 'c068373f-025d-4470-8038-eab0e9ee9d42', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', 'c068373f-025d-4470-8038-eab0e9ee9d42', 4)">main.cs</a></li></ul><ul class="code-tab-switcher c068373f-025d-4470-8038-eab0e9ee9d42"><li class="code_switcher_container_parent active-tab code_switcher_go b680f05d-6ac3-4366-92fe-658400e60f29"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">// pb.File_proto_world_proto is the generated FileDescriptor</span>
  <span class="c">// and pb.E_Hello the generated custom option</span>
  <span class="n">world</span> <span class="o">:=</span> <span class="n">getMethodExtension</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="n">pb</span><span class="o">.</span><span class="n">File_proto_world_proto</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">E_Hello</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">world</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">*</span><span class="n">world</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_cpp 688e2268-2c22-45a2-984d-96d3473505fd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// HelloWorldService is the generated service</span>
  <span class="k">auto</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">HelloWorldService</span><span class="o">::</span><span class="n">descriptor</span><span class="p">();</span>
  <span class="c1">// hello is the generated custom option</span>
  <span class="k">auto</span> <span class="n">world</span> <span class="o">=</span> <span class="n">get_method_option_value</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">hello</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">world</span><span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">world</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_java 464ac2ab-6c26-43b8-9b47-ecda4f345077"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// World is the FileDescriptor for the file world.proto</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="nc">World</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">();</span>
  <span class="c1">// Hello.hello is the generated custom option</span>
  <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">world</span> <span class="o">=</span> <span class="n">getMethodExtension</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="nc">Hello</span><span class="o">.</span><span class="na">hello</span><span class="o">);</span>

  <span class="n">world</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">w</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">w</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_python 94cac3f4-e28c-4aab-9c31-eb7f4c65006c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">proto.world_pb2</span> <span class="kn">import</span> <span class="n">DESCRIPTOR</span> <span class="c1"># FileDescriptor for world.proto
</span>
<span class="k">print</span><span class="p">(</span><span class="n">get_method_extension</span><span class="p">(</span><span class="n">DESCRIPTOR</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">))</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_csharp 31f86215-77c1-4576-a134-29c45589f84c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// HelloExtensions.Hello is the generated custom option</span>
  <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">HelloExtensions</span><span class="p">.</span><span class="n">Hello</span><span class="p">;</span>
  <span class="c1">// WorldReflection.Descriptor is the FileDescriptor for the file world.proto</span>
  <span class="kt">string</span> <span class="n">world</span> <span class="p">=</span> <span class="n">WorldReflection</span><span class="p">.</span><span class="n">Descriptor</span><span class="p">.</span><span class="nf">GetMethodOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">world</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">world</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="back-to-the-problem">Back to the Problem</h2>
<p>Now, as I mentioned I was trying to detect which routes need authentication with the help of such a custom option. It is not that hard to imagine the code we saw in the previous section work for an extension like the following:</p>
<div class="code_switcher_container_parent fd0138f5-6912-4c98-af1f-43887dc97f59"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="na">is_authenticated</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>Then, we can use it like so:</p>
<div class="code_switcher_container_parent 6c227546-bbe8-4af7-adbb-91d87a36d8b5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">service</span> <span class="n">CheckoutService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">Checkout</span> <span class="p">(</span><span class="n">CheckoutRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CheckoutResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">option</span> <span class="p">(</span><span class="n">is_authenticated</span><span class="p">)</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>And with that we can get the value from the code we wrote earlier. We just need to be requesting the methods with Option having the id &quot;is_authenticated&quot; and make sure that we are asking for a boolean instead of a string.</p>
<h2 id="conclusion">Conclusion</h2>
<p>While this is a little bit hard to work directly with the Protobuf library, automating simple tasks like checking which routes need authentication save a lot of effort. I hope that you will find this content interesting and that you will share some of the extensions that you wrote.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Protobuf" /><summary type="html"><![CDATA[Recently I had to design authentication for a Blazor Application. After finishing implementing, I soon faced the need to know which RPC endpoint needs authentication and which doesn't. And while part of the problem is a solved one, I still needed a mechanism to let me define this. Let's see how.]]></summary></entry><entry><title type="html">Parse go module files</title><link href="https://clement-jean.github.io/parse_go_module_files/" rel="alternate" type="text/html" title="Parse go module files" /><published>2023-03-30T00:00:00+02:00</published><updated>2023-03-30T00:00:00+02:00</updated><id>https://clement-jean.github.io/parse_go_module_files</id><content type="html" xml:base="https://clement-jean.github.io/parse_go_module_files/"><![CDATA[<p>Did you ever need to know, inside your program, on which go version you are running? That's what we are going to solve today. The most common use case for this is logging. We want to be able to debug by reproducing the environment of where the binary is running as close as possible. This starts by knowing which version of go we are using.</p>
<h1 id="setup">Setup</h1>
<p>To get started doing that, we will need a go module. Let's create that:</p>
<div class="code_switcher_container_parent b5503cd9-80c0-442d-a79e-b36003b69173"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go mod init test.com
</code></pre></div></div>
</div>
<p>We should now have a go.mod file in our folder. If you inspect this file, we can get the go version which will be used for compiling the project. It looks like this:</p>
<ul class="code-tab-container 092f3ef4-ae51-439e-a61f-a8b5dab97e34"><li class="active-tab code_switcher_text"><a onclick="selectTab('code_switcher_text', '092f3ef4-ae51-439e-a61f-a8b5dab97e34', 0)">go.mod</a></li></ul><ul class="code-tab-switcher 092f3ef4-ae51-439e-a61f-a8b5dab97e34"><li class="code_switcher_container_parent active-tab code_switcher_text 43544988-f7f6-4b8d-81e4-8bed5b597050"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>module test.com

go 1.20
</code></pre></div></div>
</li></ul>
<p>That's pretty much it. We will use this file to get the info we want.</p>
<h1 id="go-command">Go Command</h1>
<p>One thing that I learned recently is that we can actually get a JSON representation of or modules, workspaces, ... via the command line. To do that, we can run the following command:</p>
<div class="code_switcher_container_parent 1cadb790-5a22-4f9d-a7a0-8bab82d462d1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go mod edit <span class="nt">-json</span>
<span class="o">{</span>
  <span class="s2">"Module"</span>: <span class="o">{</span>
    <span class="s2">"Path"</span>: <span class="s2">"test.com"</span>
  <span class="o">}</span>,
  <span class="s2">"Go"</span>: <span class="s2">"1.20"</span>,
  <span class="s2">"Require"</span>: null,
  <span class="s2">"Exclude"</span>: null,
  <span class="s2">"Replace"</span>: null,
  <span class="s2">"Retract"</span>: null
<span class="o">}</span>
</code></pre></div></div>
</div>
<p>And we have our JSON!</p>
<h1 id="parsing-json">Parsing JSON</h1>
<p>The only thing left to do is execute this command in our main, Unmarshal the JSON result and we should be able to get the version.</p>
<p>First, let's define the structs into which we will Unmarshal to.</p>
<ul class="code-tab-container edc6ff14-eaf4-4516-8bb3-cdaac5b8bfca"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'edc6ff14-eaf4-4516-8bb3-cdaac5b8bfca', 0)">main.go</a></li></ul><ul class="code-tab-switcher edc6ff14-eaf4-4516-8bb3-cdaac5b8bfca"><li class="code_switcher_container_parent active-tab code_switcher_go c510e6e1-7f3e-401b-bdfe-841ad1de5ee3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Module</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Path</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">GoMod</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Module</span> <span class="n">Module</span>
  <span class="n">Go</span>     <span class="kt">string</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Notice here that I'm not taking Require, Exclude, ... into account. We only want the Go string.</p>
<p>After that, the rest is pretty easy. We can execute a command line and get its stdout result like so:</p>
<div class="code_switcher_container_parent a0dbca5a-b2f4-4c0e-ab82-dcab5529244e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"go"</span><span class="p">,</span> <span class="s">"mod"</span><span class="p">,</span> <span class="s">"edit"</span><span class="p">,</span> <span class="s">"-json"</span><span class="p">)</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>
</code></pre></div></div>
</div>
<p>I'm skipping the err handling here by dropping the error with _ but make sure to handle this for production-grade scripts.</p>
<p>And finally, we use <code>json.Unmarshal</code> function which takes the ouput of the command line, and the destination of where we want to populate the data. In our case, this is an instance of GoMod.</p>
<p>In the end, the main function looks like:</p>
<ul class="code-tab-container 30b54756-7879-49d4-b38f-028d886ee64b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '30b54756-7879-49d4-b38f-028d886ee64b', 0)">main.go</a></li></ul><ul class="code-tab-switcher 30b54756-7879-49d4-b38f-028d886ee64b"><li class="code_switcher_container_parent active-tab code_switcher_go 6e693cba-4d1e-4764-b21e-f20574aa6618"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"encoding/json"</span>
  <span class="s">"fmt"</span>
  <span class="s">"os/exec"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">Module</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Path</span> <span class="kt">string</span>
<span class="p">}</span>

<span class="k">type</span> <span class="n">GoMod</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Module</span> <span class="n">Module</span>
  <span class="n">Go</span>     <span class="kt">string</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">mod</span> <span class="n">GoMod</span>
  <span class="n">out</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">exec</span><span class="o">.</span><span class="n">Command</span><span class="p">(</span><span class="s">"go"</span><span class="p">,</span> <span class="s">"mod"</span><span class="p">,</span> <span class="s">"edit"</span><span class="p">,</span> <span class="s">"-json"</span><span class="p">)</span><span class="o">.</span><span class="n">Output</span><span class="p">()</span>

  <span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">json</span><span class="o">.</span><span class="n">Unmarshal</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mod</span><span class="p">);</span> <span class="n">err</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">mod</span><span class="o">.</span><span class="n">Go</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We can run that, and we get:</p>
<div class="code_switcher_container_parent 051d1f2a-b4b6-415c-ba47-942d79c367cf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go run main.go
1.20
</code></pre></div></div>
</div>
<p>We now have our Go version at runtime and we can use it for logging, selecting features, ...</p>
<h1 id="the-problem">The Problem</h1>
<p>Obviously, what we saw is far from great. What if we compile our go project to binary and the go.mod is not around anymore. Well, basically it doesn't work.</p>
<p>I'm presenting to you this idea because combined with the right tool to build your project, you can actually embed the version inside your binary. This can be done with ldflags (check <a href="https://blog.alexellis.io/inject-build-time-vars-golang/">Alex Ellis blog post</a> on the subject). But this can also be done with Bazel and <a href="https://bazel.build/docs/user-manual#workspace-status">stamping</a>. If you are interested in knowing how to do that, let me know.</p>
<h1 id="conclusion">Conclusion</h1>
<p>In this short post, we saw how to get the go version on which a go project is compiled at runtime. This can be used in multiple ways, but the use case that has come to me is mostly logging. I hope this is interesting for you.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><summary type="html"><![CDATA[Did you ever need to know, inside your program, on which go version you are running? That's what we are going to solve today. The most common use case for this is logging. We want to be able to debug by reproducing the environment of where the binary is running as close as possible. This starts by knowing which version of go we are using.]]></summary></entry><entry><title type="html">Go Monorepos - Intro</title><link href="https://clement-jean.github.io/go-monorepos-intro/" rel="alternate" type="text/html" title="Go Monorepos - Intro" /><published>2023-03-16T00:00:00+01:00</published><updated>2023-03-16T00:00:00+01:00</updated><id>https://clement-jean.github.io/go-monorepos-intro</id><content type="html" xml:base="https://clement-jean.github.io/go-monorepos-intro/"><![CDATA[<p>Recently I've discovered two interesting was in creating monorepos for go projects. In this article we are going to talk about the advantages and disadvantages of each of these techniques.</p>
<p>This article is an introduction. I will skip over details here because the setup is generally dependent on the technologies you use. <strong>If this article makes you want to know more about the subject, I invite you to tell me with which technology I should set a monorepo for (e.g. gRPC)</strong>.</p>
<h1 id="go-workspaces">Go Workspaces</h1>
<p>The first of these techniques are using Go workspaces. This is nice to be able to do that without any other technology than Go. The goal here is basically to create submodules and link them to the workspace. Let's see an example.</p>
<p>Let's say that we have a server and a client. We will then have the following file architecture:</p>
<div class="code_switcher_container_parent d9655f66-eb75-4eab-b37f-1f6458c9c566"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>.
├── client
└── server
</code></pre></div>
<p>with that we can start initializing our modules. You can either go into each folder and run <code>go mod init &lt;module_name&gt;</code>, or you can automatize the process and run something like:</p>
<ul class="code-tab-container 853a9760-8428-4dff-a324-f11bf538b73f"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '853a9760-8428-4dff-a324-f11bf538b73f', 0)">Linux/MacOS</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '853a9760-8428-4dff-a324-f11bf538b73f', 1)">Windows (Powershell)</a></li></ul><ul class="code-tab-switcher 853a9760-8428-4dff-a324-f11bf538b73f"><li class="code_switcher_container_parent active-tab code_switcher_shell ae961590-69f3-41fe-a36e-b0bdbd591220"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find <span class="nb">.</span> <span class="nt">-maxdepth</span> 1 <span class="nt">-type</span> d <span class="nt">-not</span> <span class="nt">-path</span> <span class="nb">.</span> <span class="nt">-execdir</span> sh <span class="nt">-c</span> <span class="s2">"pushd {}; go mod init '&lt;module_name&gt;/{}'; popd"</span> <span class="s2">";"</span>
</code></pre></div></div>
</li><li class="code_switcher_container_parent code_switcher_shell 566401cd-d162-4b78-91aa-3c07f3e53adc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Get-ChildItem <span class="nb">.</span> <span class="nt">-Name</span> <span class="nt">-Directory</span> | ForEach-Object <span class="o">{</span> Push-Location <span class="nv">$_</span><span class="p">;</span> go mod init <span class="s2">"&lt;module_name&gt;/</span><span class="nv">$_</span><span class="s2">"</span> <span class="p">;</span> Pop-Location <span class="o">}</span>
</code></pre></div></div>
</li></ul>
<p>These commands will enter each directory, run <code>go mod init</code>, and get out of the directories. <strong>Be careful though, if you have other folders that you don't want to use as modules, you will have to create more complex commands</strong>.</p>
<p>Once we have this, we can create our workspace. To do that, we simply run:</p>
<div class="code_switcher_container_parent 87357005-d79f-4640-886b-006c6cfcf980"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go work init client server
</code></pre></div></div>
</div>
<p>And that's basically it. Client and Server and individual projects that can have their own set of dependencies and you can run each of them at the root folder by running:</p>
<div class="code_switcher_container_parent deb96a22-0b45-49e9-afaf-356e28193d7b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go run ./server
</code></pre></div></div>
</div>
<p>and</p>
<div class="code_switcher_container_parent 565ea6ec-4d4e-46ac-9054-3972397e8a0c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go run ./client
</code></pre></div></div>
</div>
<h2 id="advantages">Advantages</h2>
<ul>
<li>This is pretty low-tech. We only need Go.</li>
<li>Pretty quick setup for new projects.</li>
<li>Each of the module can get their own dependencies and they can also share some.</li>
</ul>
<h2 id="disadvantages">Disadvantages</h2>
<ul>
<li>All the subprojects need to be written in Go for it to work as intended.</li>
<li>Setup for already existing and complex projects might be hard.</li>
</ul>
<h1 id="bazel">Bazel</h1>
<p>Because setting up a project in Bazel is highly dependent on which technology you want to use, I will not go into to much details here. But the idea with Bazel is that we can have the same kind of monorepo as we saw but we can do this is multi-languages.</p>
<p>If we have a client written in JS and a backend written in Go, we will have a BUILD.bazel file for each subprojects defining how to build each part of the projects. And at the root level we will have a WORKSPACE.bazel file which describes all the build dependencies.</p>
<p>Finally, if you are working with Go modules, <a href="https://github.com/bazelbuild/bazel-gazelle">Gazelle</a> (a BUILD.bazel file generator) can help you write all the build boilerplate for you and let you focus on your code.</p>
<h2 id="advantages-1">Advantages</h2>
<ul>
<li>Once it is set up, it is very efficient to run commands.</li>
<li>Multi-language monorepos.</li>
<li>Setup for already existing and complex projects is easier with Gazelle. Note that this is only for Go.</li>
</ul>
<h2 id="disadvantages-1">Disadvantages</h2>
<ul>
<li>Harder upfront cost for setup.</li>
</ul>
<h1 id="conclusion">Conclusion</h1>
<p>In this article, we got an overview of two ways of building monorepos in Go or in multi-language setups. We saw that when we have a newer project we can use Go Workspaces as this is a low-tech way of starting building a monorepo. However, if we decide to have a multi-language setup we will have to move to Bazel. <strong>There are obviously more choices to be made depending on the kind of project you are making and that's why I want your feedback on what I should build</strong>.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>]]></content><author><name>Clement</name></author><category term="Go" /><category term="Bazel" /><summary type="html"><![CDATA[Recently I've discovered two interesting was in creating monorepos for go projects. In this article we are going to talk about the advantages and disadvantages of each of these techniques.]]></summary></entry><entry><title type="html">Protein: Parser (Part 1)</title><link href="https://clement-jean.github.io/protein_parser_part_1/" rel="alternate" type="text/html" title="Protein: Parser (Part 1)" /><published>2023-03-09T00:00:00+01:00</published><updated>2023-03-09T00:00:00+01:00</updated><id>https://clement-jean.github.io/protein_parser_part_1</id><content type="html" xml:base="https://clement-jean.github.io/protein_parser_part_1/"><![CDATA[<p>In this article we are going to finally get to building the Parser. We are going to start parsing syntax, package and import statements, and we are going to see how to represent our serializable AST. Hope you are ready for this, it's gonna be fun!</p>
<h2 id="boilerplate">Boilerplate</h2>
<p>As always, we need to think a little bit before to actually write the features themselves. The first thing that we can do to get us started is to write the Parser interface.</p>
<ul class="code-tab-container 94321d6a-5f5f-43b1-9e50-47fd539487c9"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '94321d6a-5f5f-43b1-9e50-47fd539487c9', 0)">parser/parser.go</a></li></ul><ul class="code-tab-switcher 94321d6a-5f5f-43b1-9e50-47fd539487c9"><li class="code_switcher_container_parent active-tab code_switcher_go 11e16feb-0419-4611-9af9-6b3f3348ed1e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="c">// Parser is protein's parser</span>
<span class="k">type</span> <span class="n">Parser</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// Parse returns ???</span>
  <span class="n">Parse</span><span class="p">()</span> <span class="err">???</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This doesn't seem like a fancy interface but we do have a problem. What is our parser returning when finished? Well, it should return an AST, right? But how do we represent this AST. It turns out, we have two good possibilities:</p>
<ul>
<li>We roll our own serializable AST where each object is a Protobuf Message.</li>
<li>We use the descriptor.proto file which defines Messages for describing elements in a Protobuf file.</li>
</ul>
<p>Both have pros and cons. If we go with the first one we have more control over our serialization. It means that we can optimize some elements' serialized data. However, it also means that we are not compatible with the official way and that's not good.
For the &quot;using the official serialization&quot;, I think you get the idea. We have the pros being the cons of the other implementation, and the cons being the pros of the other implementation.</p>
<p>In the end, for the sake of compatibility, I will be sacrificing some performance. However, these performances are only saving a few bytes and having compatibility with programs serialized by protoc far overweights them.</p>
<h3 id="depending-on-protobuf">Depending on Protobuf</h3>
<p>To use the descriptor, we are going to depend on Protobuf's library. To do that we are going to add in our dependency:</p>
<div class="code_switcher_container_parent 7c4f0b2e-cc14-4b2c-a4b4-f6c74db77c36"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go get google.golang.org/protobuf
</code></pre></div></div>
</div>
<p>This will let us access <code>descriptorpb</code> package, which contains the <code>FileDescriptorProto</code> struct. If you look at the definition of that struct, you will see the following comment:</p>
<div class="code_switcher_container_parent 4c507299-bbc2-4ba2-978a-5a50b79a5599"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Describes a complete .proto file.</span>
<span class="k">type</span> <span class="n">FileDescriptorProto</span> <span class="k">struct</span>
</code></pre></div></div>
</div>
<p>That's exactly what we are trying to do.</p>
<h3 id="back-to-interface">Back to interface</h3>
<p>With that dependency on Protobuf, we can now finish our interface:</p>
<ul class="code-tab-container db4a1597-3754-463c-a138-56365cd0f64d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'db4a1597-3754-463c-a138-56365cd0f64d', 0)">parser/parser.go</a></li></ul><ul class="code-tab-switcher db4a1597-3754-463c-a138-56365cd0f64d"><li class="code_switcher_container_parent active-tab code_switcher_go 238ceba2-b5d4-4f25-af76-0563c21fb870"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="n">pb</span> <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>

<span class="c">// Parser is protein's parser</span>
<span class="k">type</span> <span class="n">Parser</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// Parse returns the representation of a file in Protobuf Descriptor</span>
  <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="implementation">Implementation</h2>
<p>Let's now implement the interface. But by now you know the drill. We are going to create a minimal implementation so that our first test fails. So what we need is an <code>Impl</code> struct and we need to implement <code>Parser</code> by writing the <code>Parse</code> function.</p>
<p>For now, the <code>Parse</code> function will simply return an empty <code>FileDescriptorProto</code>.</p>
<ul class="code-tab-container 22cc49d1-ef06-4a72-9a98-a7fed9a19935"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '22cc49d1-ef06-4a72-9a98-a7fed9a19935', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 22cc49d1-ef06-4a72-9a98-a7fed9a19935"><li class="code_switcher_container_parent active-tab code_switcher_go a06df92f-acc4-48d7-810b-b6c306e84754"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="n">pb</span> <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>
<span class="p">)</span>

<span class="c">// Impl is the implementation for the Parser interface.</span>
<span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span>
<span class="p">}</span>

<span class="c">// New creates a new instance of the Parser</span>
<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span><span class="p">)</span> <span class="n">Parser</span> <span class="p">{</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span><span class="n">l</span><span class="o">:</span> <span class="n">l</span><span class="p">}</span>
  <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>

<span class="c">// Parse populates a FileDescriptorProto</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>
  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h3 id="first-test">First test</h3>
<p>As our first test we are going to create the test for a syntax statement. This test will take advantage of the fact that <code>Lexer</code> is an interface by creating a <code>FakeLexer</code>. This fake lexer will simply iterate over an array of tokens and return them one by one.</p>
<ul class="code-tab-container fd5e4e7b-1719-42cc-b600-b4c989e10445"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'fd5e4e7b-1719-42cc-b600-b4c989e10445', 0)">parser/parser_test.go</a></li></ul><ul class="code-tab-switcher fd5e4e7b-1719-42cc-b600-b4c989e10445"><li class="code_switcher_container_parent active-tab code_switcher_go 59538e3a-42fc-46eb-a172-1aac70e42264"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">FakeLexer</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">i</span>      <span class="kt">int</span>
  <span class="n">tokens</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">FakeLexer</span><span class="p">)</span> <span class="n">NextToken</span><span class="p">()</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">tokens</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}}</span>
  <span class="p">}</span>

  <span class="n">token</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">tokens</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">i</span><span class="p">]</span>
  <span class="n">l</span><span class="o">.</span><span class="n">i</span><span class="o">++</span>
  <span class="k">return</span> <span class="n">token</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This basically means that each time we are running a test in the parser, we are not going to run the lexer code. We are going to simply focus on our current features. So, if we encounter a bug, it means that it is in the parser, not anywhere else.</p>
<p>With that, we can write our first test for <code>syntax = &quot;proto3&quot;;</code>.</p>
<ul class="code-tab-container f95df9ab-cd99-4d9e-ac55-3c95eba3b0d5"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f95df9ab-cd99-4d9e-ac55-3c95eba3b0d5', 0)">parser/parser_syntax_test.go</a></li></ul><ul class="code-tab-switcher f95df9ab-cd99-4d9e-ac55-3c95eba3b0d5"><li class="code_switcher_container_parent active-tab code_switcher_go 0adb6b60-4f08-438c-9a1a-8f32b5b5067d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParseSyntaxProto3</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"syntax"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenEqual</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"="</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">proto3</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"proto3"</span>

  <span class="k">if</span> <span class="n">syntax</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetSyntax</span><span class="p">();</span> <span class="n">syntax</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"syntax wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">syntax</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Obviously:</p>
<div class="code_switcher_container_parent a2126390-f6a2-4810-9ebb-1a8133c60d66"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParseSyntaxProto3 <span class="o">(</span>0.00s<span class="o">)</span>
    parser_syntax_test.go:22: syntax wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'proto3'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
FAIL
</code></pre></div></div>
</div>
<h3 id="parsing">Parsing</h3>
<p>We should now improve the <code>Parse</code> function to consume the <code>Lexer</code>'s tokens and do things with that. Here is the pseudo code:</p>
<div class="code_switcher_container_parent ae7c5b29-3ac7-4eae-a3ac-2aa8c50cb732"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">for</span> <span class="n">currToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">EOF</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">currToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">Identifier</span> <span class="p">{</span>
    <span class="n">fn</span> <span class="o">:=</span> <span class="n">parseFuncs</span><span class="p">[</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">]</span> <span class="c">// find the function depending on keyword</span>
    <span class="n">fn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">descriptor</span><span class="p">)</span> <span class="c">// populate the descriptor</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</div>
<p>You notice that we need a <code>currToken</code> representing the current token being parsed. We will also need the peek token for parsing syntax and other statements. This is because we are going to make sure each time that the peek token is correct, otherwise we will return an error. So <code>Impl</code> now has a <code>currToken</code> and <code>peekToken</code>:</p>
<ul class="code-tab-container 92124fca-59ee-4bc0-b6bf-cf2fdba31150"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '92124fca-59ee-4bc0-b6bf-cf2fdba31150', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 92124fca-59ee-4bc0-b6bf-cf2fdba31150"><li class="code_switcher_container_parent active-tab code_switcher_go f47f9c5c-96ce-4fb8-b7ea-fff7d4a23c8a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span>
  <span class="n">curToken</span>  <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
  <span class="n">peekToken</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Token</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Now, we need to populate these tokens before being able to use them. The first time we need to initialize them is in the <code>New</code> function.</p>
<ul class="code-tab-container 482eaa7d-5ebc-4046-aed1-0b5b530853eb"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '482eaa7d-5ebc-4046-aed1-0b5b530853eb', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 482eaa7d-5ebc-4046-aed1-0b5b530853eb"><li class="code_switcher_container_parent active-tab code_switcher_go deed9ed5-f9a1-4e66-8802-ef67cdd21f5e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Lexer</span><span class="p">)</span> <span class="n">Parser</span> <span class="p">{</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span><span class="n">l</span><span class="o">:</span> <span class="n">l</span><span class="p">}</span>
  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">p</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>But <code>nextToken</code> is not the <code>Lexer.NextToken</code>, this is a private function in <code>Parser</code>. This is a function that looks for the next non-space token.</p>
<ul class="code-tab-container b75d62e1-33f7-41cb-958b-9e12f5913990"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b75d62e1-33f7-41cb-958b-9e12f5913990', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher b75d62e1-33f7-41cb-958b-9e12f5913990"><li class="code_switcher_container_parent active-tab code_switcher_go 88846686-acb6-46f2-b418-8b0fa5295c07"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">nextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSpace</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">();</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSpace</span><span class="p">;</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>With that we can start updating our <code>Parse</code> function.</p>
<ul class="code-tab-container 6f299b3f-d9d0-4d89-9f90-c8b2384d91d9"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '6f299b3f-d9d0-4d89-9f90-c8b2384d91d9', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 6f299b3f-d9d0-4d89-9f90-c8b2384d91d9"><li class="code_switcher_container_parent active-tab code_switcher_go 88aa1e4b-cfb5-4323-af5b-232a1324108d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
      <span class="c">//Do something with token</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Finally, we are going to register all the parsing functions that we are gonna write in this and next articles. We are going to have a map mapping &quot;syntax&quot; to parseSyntax, ...</p>
<ul class="code-tab-container 8aa286ff-c554-4fb2-861a-d65d9a95d3a0"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8aa286ff-c554-4fb2-861a-d65d9a95d3a0', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher 8aa286ff-c554-4fb2-861a-d65d9a95d3a0"><li class="code_switcher_container_parent active-tab code_switcher_go fbf2e57a-9678-42b6-b4cd-1480a7e047d2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>With this we can finalize the <code>Parse</code> function by looking at the relevant function for the <code>currToken.Literal</code>.</p>
<ul class="code-tab-container d3d3b52c-74cf-4b48-8ac7-8daba3040b5f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd3d3b52c-74cf-4b48-8ac7-8daba3040b5f', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher d3d3b52c-74cf-4b48-8ac7-8daba3040b5f"><li class="code_switcher_container_parent active-tab code_switcher_go 3ba84479-9f57-44e5-8831-0ee5820c6491"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">Parse</span><span class="p">()</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span> <span class="p">{</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">{}</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
      <span class="n">fn</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">parseFuncs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">]</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span> <span class="c">// keyword not found</span>
        <span class="k">break</span>
      <span class="p">}</span>
      <span class="n">fn</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">d</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h3 id="parsesyntax">parseSyntax()</h3>
<p>Before actually parsing a syntax statement, we need two helper functions: <code>accept</code> and <code>acceptPeek</code>. <code>acceptPeek</code> will just call <code>accept</code> with the <code>peekToken.Type</code>. <code>accept</code> take a <code>TokenType</code> and checks if it exists in the following variadic arguments.</p>
<ul class="code-tab-container ec10750b-e72e-4da4-8ebb-3ebb161c9388"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ec10750b-e72e-4da4-8ebb-3ebb161c9388', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher ec10750b-e72e-4da4-8ebb-3ebb161c9388"><li class="code_switcher_container_parent active-tab code_switcher_go f284dd02-2469-41be-a0c0-9a6668bb7943"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">accept</span><span class="p">(</span><span class="n">original</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">,</span> <span class="n">expected</span> <span class="o">...</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">slices</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">original</span><span class="p">)</span> <span class="p">{</span>
    <span class="c">// TODO: add error</span>
    <span class="k">return</span> <span class="no">false</span>
  <span class="p">}</span>

  <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>
  <span class="k">return</span> <span class="no">true</span>
<span class="p">}</span>

<span class="c">// acceptPeek returns true and advance token</span>
<span class="c">// if tt contains the peekToken.Type</span>
<span class="c">// else it returns false</span>
<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">acceptPeek</span><span class="p">(</span><span class="n">tt</span> <span class="o">...</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenType</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">p</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span><span class="p">,</span> <span class="n">tt</span><span class="o">...</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And now we ready for our <code>parseSyntax</code> function. We are first going to check that we have an <code>=</code> after syntax. Then we check that we have a String, if it’s the case we are going to take the value inside the quotes. And finally, we are going to check that there is a semicolon at the end of the statement.</p>
<ul class="code-tab-container 7d142acb-6594-4980-b6a6-851b0474273b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '7d142acb-6594-4980-b6a6-851b0474273b', 0)">parser/syntax.go</a></li></ul><ul class="code-tab-switcher 7d142acb-6594-4980-b6a6-851b0474273b"><li class="code_switcher_container_parent active-tab code_switcher_go c8d13658-4c37-4a72-ba90-e1b77ed37adf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parseSyntax</span><span class="p">()</span> <span class="o">*</span><span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenEqual</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="n">s</span> <span class="o">:=</span> <span class="n">destringify</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>The <code>destringify</code> function looks like the following:</p>
<ul class="code-tab-container 5ff32f4e-dd2b-4843-85d8-f1e19cede1d5"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '5ff32f4e-dd2b-4843-85d8-f1e19cede1d5', 0)">parser/utils.go</a></li></ul><ul class="code-tab-switcher 5ff32f4e-dd2b-4843-85d8-f1e19cede1d5"><li class="code_switcher_container_parent active-tab code_switcher_go 00b971bc-97b2-43f0-baec-89314d9b52fd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="s">"strings"</span>

<span class="k">func</span> <span class="n">destringify</span><span class="p">(</span><span class="n">s</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">strings</span><span class="o">.</span><span class="n">TrimFunc</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">r</span> <span class="kt">rune</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\'</span><span class="err">'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'"'</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>As mentioned, it takes the values between the quotes.</p>
<p>With our <code>parseSyntax</code> finished, we can rerun the test and:</p>
<div class="code_switcher_container_parent 90f57d4a-497b-44d7-bbcb-19d686deb660"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  1.361s
</code></pre></div></div>
</div>
<h3 id="parseimport">parseImport()</h3>
<p><code>parseImport</code> is really similar to <code>parseSyntax</code>. However, with imports, we get introduced to optional keywords. An import can be written in 3 ways:</p>
<ul>
<li><code>import &quot;my.proto&quot;;</code></li>
<li><code>import public &quot;my.proto&quot;;</code></li>
<li><code>import weak &quot;my.proto&quot;;</code></li>
</ul>
<p>Let's write the tests:</p>
<ul class="code-tab-container 8f9da953-4559-40e6-9fae-cbc691e6abe5"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8f9da953-4559-40e6-9fae-cbc691e6abe5', 0)">parser/parser_import_test.go</a></li></ul><ul class="code-tab-switcher 8f9da953-4559-40e6-9fae-cbc691e6abe5"><li class="code_switcher_container_parent active-tab code_switcher_go 594f3869-b163-43b3-a15c-5563fa99cd67"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParseImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParsePublicImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"public"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{</span><span class="m">0</span><span class="p">}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParseWeakImport</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"import"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"weak"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"</span><span class="se">\"</span><span class="s">google/protobuf/empty.proto</span><span class="se">\"</span><span class="s">"</span><span class="p">},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">string</span><span class="p">{</span><span class="s">"google/protobuf/empty.proto"</span><span class="p">}</span>
  <span class="n">public</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{}</span>
  <span class="n">weak</span> <span class="o">:=</span> <span class="p">[]</span><span class="kt">int32</span><span class="p">{</span><span class="m">0</span><span class="p">}</span>

  <span class="k">if</span> <span class="n">imp</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">imp</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">imp</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">p</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPublicDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">public</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"public import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetWeakDependency</span><span class="p">();</span> <span class="n">slices</span><span class="o">.</span><span class="n">Compare</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">weak</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"weak import wrong. expected='%v', got='%v'"</span><span class="p">,</span> <span class="n">weak</span><span class="p">,</span> <span class="n">w</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Obviously:</p>
<div class="code_switcher_container_parent 4d584ccb-4609-4c28-a30c-d3f8a41b09cc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParseImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:25: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
<span class="nt">---</span> FAIL: TestParsePublicImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:52: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
<span class="nt">---</span> FAIL: TestParseWeakImport <span class="o">(</span>0.00s<span class="o">)</span>
    parser_import_test.go:79: import wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'[google/protobuf/empty.proto]'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">'[]'</span>
FAIL
</code></pre></div></div>
</div>
<p>Even though the 2nd and 3rd one are rarely used, we still need to support them. To do so, we are going to need to create an enum called <code>DependencyType</code> which will have the variants: None, Public, and Weak. After that, we are going to check if we have an identifier and depending on the <code>Literal</code>, we are going to return the type.</p>
<ul class="code-tab-container 074ff50c-0f13-44d7-8f50-45e06d35533e"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '074ff50c-0f13-44d7-8f50-45e06d35533e', 0)">parser/import.go</a></li></ul><ul class="code-tab-switcher 074ff50c-0f13-44d7-8f50-45e06d35533e"><li class="code_switcher_container_parent active-tab code_switcher_go 1cbddef9-4996-4723-8714-b660db655dbd"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"fmt"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">type</span> <span class="n">DependencyType</span> <span class="kt">int</span>

<span class="k">const</span> <span class="p">(</span>
  <span class="n">None</span> <span class="n">DependencyType</span> <span class="o">=</span> <span class="no">iota</span>
  <span class="n">Public</span>
  <span class="n">Weak</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parseImport</span><span class="p">()</span> <span class="p">(</span><span class="kt">string</span><span class="p">,</span> <span class="n">DependencyType</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">,</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
  <span class="p">}</span>

  <span class="n">depType</span> <span class="o">:=</span> <span class="n">None</span>

  <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span> <span class="p">{</span>
    <span class="k">case</span> <span class="s">"public"</span><span class="o">:</span>
      <span class="n">depType</span> <span class="o">=</span> <span class="n">Public</span>
    <span class="k">case</span> <span class="s">"weak"</span><span class="o">:</span>
      <span class="n">depType</span> <span class="o">=</span> <span class="n">Weak</span>
    <span class="k">default</span><span class="o">:</span>
      <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenStr</span><span class="p">)</span> <span class="p">{</span>
      <span class="c">// TODO: add error</span>
      <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">s</span> <span class="o">:=</span> <span class="n">destringify</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="s">""</span><span class="p">,</span> <span class="n">None</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">s</span><span class="p">,</span> <span class="n">depType</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And the last thing we need to do is register that to the <code>parseFuncs</code>.</p>
<ul class="code-tab-container fbe5fe39-c7cd-49e7-86bb-5d36363b23cb"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'fbe5fe39-c7cd-49e7-86bb-5d36363b23cb', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher fbe5fe39-c7cd-49e7-86bb-5d36363b23cb"><li class="code_switcher_container_parent active-tab code_switcher_go 0ffcc190-998a-4909-9002-3433c3a8db64"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"import"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dep</span><span class="p">,</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseImport</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">))</span>
      <span class="n">d</span><span class="o">.</span><span class="n">Dependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
      <span class="k">switch</span> <span class="n">t</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">Public</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">Weak</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We basically append the dependency and if we have a public or weak dependency we add its index into <code>PublicDependency</code> and <code>WeakDependency</code> respectively.</p>
<p>We rerun our test:</p>
<div class="code_switcher_container_parent da1b51d7-a429-48a2-a720-fecc700744e0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  0.450s
</code></pre></div></div>
</div>
<h3 id="parsepackage">parsePackage()</h3>
<p>Once again this function is pretty similar. The main difference is that we are going to look for identifiers and fully qualified names (identifiers separated by dots).</p>
<p>Let's write some tests.</p>
<ul class="code-tab-container a7dd5483-c741-448f-b177-0ccc97223d21"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'a7dd5483-c741-448f-b177-0ccc97223d21', 0)">parser/parser_package_test.go</a></li></ul><ul class="code-tab-switcher a7dd5483-c741-448f-b177-0ccc97223d21"><li class="code_switcher_container_parent active-tab code_switcher_go 4335b5ff-83a5-49e3-8e6a-6523d6211b05"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">TestParsePackage</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"package"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"google"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"google"</span>

  <span class="k">if</span> <span class="n">pkg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPackage</span><span class="p">();</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"package wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestParsePackageFullIdentifier</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">tokens</span> <span class="o">:=</span> <span class="p">[]</span><span class="n">lexer</span><span class="o">.</span><span class="n">Token</span><span class="p">{</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"package"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"google"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenDot</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"."</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">"protobuf"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">Type</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="n">Literal</span><span class="o">:</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="o">:</span> <span class="n">lexer</span><span class="o">.</span><span class="n">Position</span><span class="p">{}},</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">FakeLexer</span><span class="p">{</span><span class="n">tokens</span><span class="o">:</span> <span class="n">tokens</span><span class="p">}</span>
  <span class="n">p</span> <span class="o">:=</span> <span class="n">New</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
  <span class="n">d</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">Parse</span><span class="p">()</span>
  <span class="n">expected</span> <span class="o">:=</span> <span class="s">"google.protobuf"</span>

  <span class="k">if</span> <span class="n">pkg</span> <span class="o">:=</span> <span class="n">d</span><span class="o">.</span><span class="n">GetPackage</span><span class="p">();</span> <span class="n">pkg</span> <span class="o">!=</span> <span class="n">expected</span> <span class="p">{</span>
    <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"package wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">expected</span><span class="p">,</span> <span class="n">pkg</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Let's fail our tests:</p>
<div class="code_switcher_container_parent 9c8ed26c-b71f-4583-9a67-0d5e3a9e1f53"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestParsePackage <span class="o">(</span>0.00s<span class="o">)</span>
    parser_package_test.go:21: package wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'google'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
<span class="nt">---</span> FAIL: TestParsePackageFullIdentifier <span class="o">(</span>0.00s<span class="o">)</span>
    parser_package_test.go:39: package wrong. <span class="nv">expected</span><span class="o">=</span><span class="s1">'google.protobuf'</span>, <span class="nv">got</span><span class="o">=</span><span class="s1">''</span>
FAIL
</code></pre></div></div>
</div>
<p>And now we can implement the <code>parsePackage</code> function. We are going to check that we have at least one identifier, and then if we have a dot we are going to make sure that we have another identifier after. Finally, we will be looking for the semicolon.</p>
<ul class="code-tab-container 150aab09-ee5e-4737-879b-352a6cec7948"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '150aab09-ee5e-4737-879b-352a6cec7948', 0)">parser/package.go</a></li></ul><ul class="code-tab-switcher 150aab09-ee5e-4737-879b-352a6cec7948"><li class="code_switcher_container_parent active-tab code_switcher_go 86d53482-529a-4d3b-a153-f379e4c2d1eb"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">parser</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"strings"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">parsePackage</span><span class="p">()</span> <span class="o">*</span><span class="kt">string</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">var</span> <span class="n">parts</span> <span class="p">[]</span><span class="kt">string</span>

  <span class="k">for</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span> <span class="p">{</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">curToken</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">peekToken</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">TokenDot</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">p</span><span class="o">.</span><span class="n">nextToken</span><span class="p">()</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenIdentifier</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">nil</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">s</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">Join</span><span class="p">(</span><span class="n">parts</span><span class="p">,</span> <span class="s">"."</span><span class="p">)</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">p</span><span class="o">.</span><span class="n">acceptPeek</span><span class="p">(</span><span class="n">lexer</span><span class="o">.</span><span class="n">TokenSemicolon</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="o">&amp;</span><span class="n">s</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>The last thing to do is to register this function in our <code>parseFuncs</code>.</p>
<ul class="code-tab-container ddc4cce4-e742-46c2-be22-b873931272e3"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ddc4cce4-e742-46c2-be22-b873931272e3', 0)">parser/impl.go</a></li></ul><ul class="code-tab-switcher ddc4cce4-e742-46c2-be22-b873931272e3"><li class="code_switcher_container_parent active-tab code_switcher_go cab625b2-56cd-41bc-90f6-85f327b3bd11"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">var</span> <span class="n">parseFuncs</span> <span class="o">=</span> <span class="k">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">){</span>
  <span class="s">"syntax"</span><span class="o">:</span>  <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Syntax</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseSyntax</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"package"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span> <span class="n">d</span><span class="o">.</span><span class="n">Package</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parsePackage</span><span class="p">()</span> <span class="p">},</span>
  <span class="s">"import"</span><span class="o">:</span> <span class="k">func</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span><span class="n">Impl</span><span class="p">,</span> <span class="n">d</span> <span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">FileDescriptorProto</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">dep</span><span class="p">,</span> <span class="n">t</span> <span class="o">:=</span> <span class="n">p</span><span class="o">.</span><span class="n">parseImport</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="p">{</span>
      <span class="n">i</span> <span class="o">:=</span> <span class="kt">int32</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">))</span>
      <span class="n">d</span><span class="o">.</span><span class="n">Dependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">Dependency</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
      <span class="k">switch</span> <span class="n">t</span> <span class="p">{</span>
      <span class="k">case</span> <span class="n">Public</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">PublicDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">Weak</span><span class="o">:</span>
        <span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span> <span class="o">=</span> <span class="nb">append</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">WeakDependency</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and we rerun our tests.</p>
<div class="code_switcher_container_parent 6399597a-bd31-4f3d-92ba-830fa5059c24"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/parser  0.847s
</code></pre></div></div>
</div>
<h1 id="conclusion">Conclusion</h1>
<p>In this article, we created our first three parsing functions. We parsed syntax, package and imports. We are now ready to go more complicated statements.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>
<div class="container">
  <div class="row">
    <div class="col text-center">
      <a href="/protein_lexer_part_3" class="btn btn-danger text-center">Previous Article</a>
    </div>
    <!-- <div class="col text-center">
      <a href="/protein_lexer_part_1" class="btn btn-danger text-center">Next Article</a>
    </div> -->
  </div>
</div>]]></content><author><name>Clement</name></author><category term="Protocol Buffers" /><category term="Go" /><summary type="html"><![CDATA[In this article we are going to finally get to building the Parser. We are going to start parsing syntax, package and import statements, and we are going to see how to represent our serializable AST. Hope you are ready for this, it's gonna be fun!]]></summary></entry><entry><title type="html">Protein: Lexer (Part 3)</title><link href="https://clement-jean.github.io/protein_lexer_part_3/" rel="alternate" type="text/html" title="Protein: Lexer (Part 3)" /><published>2023-03-03T00:00:00+01:00</published><updated>2023-03-03T00:00:00+01:00</updated><id>https://clement-jean.github.io/protein_lexer_part_3</id><content type="html" xml:base="https://clement-jean.github.io/protein_lexer_part_3/"><![CDATA[<p>This article is a small one intended to solve a bug related to token position. As of right now, we only tested that our token got the right literal and the right token kind. In this article, we are going to add the position checking in our tests.</p>
<h2 id="position-checking">Position Checking</h2>
<p>Adding position checking in our test is pretty trivial since it's 3 ifs checking <code>Offset</code>, <code>Line</code>, and <code>Column</code>. So let's add that:</p>
<ul class="code-tab-container ea163007-d79c-41bb-a976-7be181ae7d9c"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ea163007-d79c-41bb-a976-7be181ae7d9c', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher ea163007-d79c-41bb-a976-7be181ae7d9c"><li class="code_switcher_container_parent active-tab code_switcher_go 4d9e81e9-ddff-4062-b167-9c23a65664ae"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">l</span> <span class="n">Lexer</span><span class="p">,</span> <span class="n">tests</span> <span class="p">[]</span><span class="n">Check</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="c">//...</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Offset</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Offset</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - offset wrong. expected=%d, got=%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Offset</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Offset</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Line</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Line</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - line wrong. expected=%d, got=%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Line</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Line</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Column</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Column</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - column wrong. expected=%d, got=%d"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedPosition</span><span class="o">.</span><span class="n">Column</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Position</span><span class="o">.</span><span class="n">Column</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And now if we run our tests, we should have a lot of errors coming from the fact that Go will initialize <code>Offset</code>, <code>Line</code>, and <code>Column</code> to 0 (default value). An example of error received is:</p>
<div class="code_switcher_container_parent dfb9ee00-11f0-491e-82d8-37b2f2ee1ebf"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./..
<span class="nt">---</span> FAIL: TestNextTokenOnSymbols <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:31: tests[0] - line wrong. <span class="nv">expected</span><span class="o">=</span>0, <span class="nv">got</span><span class="o">=</span>1
FAIL
</code></pre></div></div>
</div>
<blockquote>
<p>Before going to the new section, make sure that you update the position objects in your tests. If you are not willing to calculate all of the positions, you can just refer to the <a href="https://github.com/Clement-Jean/protein/blob/lexer/lexer/lexer_test.go">tests in the github repo</a> where I did it for you.</p>
</blockquote>
<h2 id="a-bug-">A bug ?!</h2>
<p>Now that we have all our positions set, we can rerun our tests.</p>
<div class="code_switcher_container_parent 05d9c550-c10e-42b8-b59b-d11940f9882e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./..
<span class="nt">---</span> FAIL: TestNextTokenOnSpace <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:35: tests[1] - column wrong. <span class="nv">expected</span><span class="o">=</span>4, <span class="nv">got</span><span class="o">=</span>0
FAIL
</code></pre></div></div>
</div>
<p>And yes we have an error. Let's understand it.</p>
<p>The problem here comes from the way we handle newlines in the <code>emit</code> function. As of right now, this is done like so:</p>
<ul class="code-tab-container dab5b870-3645-43f5-a48c-7833793d5405"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'dab5b870-3645-43f5-a48c-7833793d5405', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher dab5b870-3645-43f5-a48c-7833793d5405"><li class="code_switcher_container_parent active-tab code_switcher_go a53f78f7-6fa3-4288-a585-90d1ef2fdd4b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">emit</span><span class="p">(</span><span class="n">tt</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">if</span> <span class="n">tt</span> <span class="o">==</span> <span class="n">TokenSpace</span> <span class="o">&amp;&amp;</span> <span class="n">strings</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span>
  <span class="p">}</span>
  <span class="c">//..</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This code is checking for a newline inside the literal and if it finds one, it will just set the index of <code>\n</code> in the literal to startLineOffset. The problem here is that we handle all consecutive spaces (the general term) as one token. So when we have <code>\t\n\v\f\r</code>, we are effectively saying that the line starts at the beginning our our space token. This is not correct, right? We should be setting <code>startLineOffset</code> to 2 (just after <code>\n</code>) and then this should affect the <code>Column</code> position because of <code>Column: l.start - l.startLineOffset</code> in the <code>Token</code> instantiation in <code>emit</code>.</p>
<p>So how do we solve that? Well, it turns out to be pretty simple. We are going to look for the last instance of <code>\n</code> in the literal and this will give us the beginning of the line. After that we are going to take the current position (which is after the token right now) and subtract it with the length of the literal minus the beginning of the line. This gives us the offset at which the line begins. So now we should have this:</p>
<ul class="code-tab-container b8055b90-ce52-46da-9dbe-bd619ac7b6d1"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b8055b90-ce52-46da-9dbe-bd619ac7b6d1', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher b8055b90-ce52-46da-9dbe-bd619ac7b6d1"><li class="code_switcher_container_parent active-tab code_switcher_go 051b33ea-fce5-4b4a-9d3a-a52b1d300a2c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">emit</span><span class="p">(</span><span class="n">tt</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">if</span> <span class="n">tt</span> <span class="o">==</span> <span class="n">TokenSpace</span> <span class="p">{</span>
    <span class="k">if</span> <span class="n">lineStart</span> <span class="o">:=</span> <span class="n">strings</span><span class="o">.</span><span class="n">LastIndex</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">);</span> <span class="n">lineStart</span> <span class="o">!=</span> <span class="o">-</span><span class="m">1</span> <span class="p">{</span>
      <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span> <span class="o">-</span> <span class="n">lineStart</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c">//..</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Note that we are only finding the last index when the token kind is a space. This is important because if we do that for all the tokens we will have performance hits (especially on large tokens).</p>
<p>And now, if we rerun our test:</p>
<div class="code_switcher_container_parent eb721e61-d127-4c35-9df4-2b4f868efb68"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.857s
</code></pre></div></div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we made the final test for our lexer and we solved a critical bug for <code>Token</code> positions. We now have a functional lexer and in the next article we are going to start the parser!</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>
<div class="container">
  <div class="row">
    <div class="col text-center">
      <a href="/protein_lexer_part_2" class="btn btn-danger text-center">Previous Article</a>
    </div>
    <div class="col text-center">
      <a href="/protein_parser_part_1" class="btn btn-danger text-center">Next Article</a>
    </div>
  </div>
</div>]]></content><author><name>Clement</name></author><category term="Protocol Buffers" /><category term="Go" /><summary type="html"><![CDATA[This article is a small one intended to solve a bug related to token position. As of right now, we only tested that our token got the right literal and the right token kind. In this article, we are going to add the position checking in our tests.]]></summary></entry><entry><title type="html">Protein: Lexer (Part 2)</title><link href="https://clement-jean.github.io/protein_lexer_part_2/" rel="alternate" type="text/html" title="Protein: Lexer (Part 2)" /><published>2023-02-20T00:00:00+01:00</published><updated>2023-02-20T00:00:00+01:00</updated><id>https://clement-jean.github.io/protein_lexer_part_2</id><content type="html" xml:base="https://clement-jean.github.io/protein_lexer_part_2/"><![CDATA[<p>In this article we are going to delve into the second part of the lexing which is tokenizing more advanced part of the input. More precisely, we are going to lex spaces (whitespaces, new lines, ...), comments, Identifiers, Numbers (Int and Float), and Strings. At the end of this article, we will have a fully functioning lexer that can tokenize the <code>descriptor.proto</code> which is the longest proto file in the protobuf repo. Let's get started.</p>
<blockquote>
<p>Note: While this article is designed in a way that shows the evolution of the Lexer, you might still want to look at <a href="https://github.com/Clement-Jean/protein/commits/lexer">the commits</a> in order to see where any piece of code went.</p>
</blockquote>
<h2 id="spaces">Spaces</h2>
<p>Up until now, we assumed that all the characters that we would encounter were symbols. We are now going to add whitespaces, new lines, ... on top of that. Now, one thing to note here is that in traditional lexer, spaces will be discarded and are not counted as tokens. In our case, since the <a href="https://protobuf.dev/programming-guides/style/">Protobuf Style Guide</a> mentions that we should use an indent of 2 spaces, we are going to need that information. Before doing tokenizing spaces, we are going to need to more helper functions:</p>
<ul>
<li><code>backup</code>: Goes back by one utf8 character.</li>
<li><code>peek</code>: Check the next utf8 character without advancing the reading position.</li>
</ul>
<p><code>peek</code> is very similar to next because we are checking that we are still within the limits of our input and we read the character at <code>lexer.pos</code>. However, because we are just looking ahead and not advancing in the input, we are not going to update the <code>lexer.pos</code>.</p>
<ul class="code-tab-container 7f0f9f10-6b41-49a8-96b3-aa48dd056ce4"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '7f0f9f10-6b41-49a8-96b3-aa48dd056ce4', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 7f0f9f10-6b41-49a8-96b3-aa48dd056ce4"><li class="code_switcher_container_parent active-tab code_switcher_go c34b3dda-d462-45d8-bc4d-893ae2d1ea73"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">peek</span><span class="p">()</span> <span class="kt">rune</span> <span class="p">{</span>
  <span class="k">if</span> <span class="kt">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">r</span><span class="p">,</span> <span class="n">_</span> <span class="o">:=</span> <span class="n">utf8</span><span class="o">.</span><span class="n">DecodeRuneInString</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="o">:</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">r</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and <code>backup</code> is pretty simple. We are going to read the last character before <code>lexer.pos</code> and update the reading position by the size of that utf8 character. Furthermore, since in the <code>next</code> function we added <code>l.line++</code> when we have a new line, we are going to need backing that up too. So we are going to decrease <code>lexer.line</code> when we encounter a newline.</p>
<ul class="code-tab-container 70647057-1162-4059-b897-4e5ea9b376d7"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '70647057-1162-4059-b897-4e5ea9b376d7', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 70647057-1162-4059-b897-4e5ea9b376d7"><li class="code_switcher_container_parent active-tab code_switcher_go 95117320-1c7b-4b2d-a7d0-24a6c06e1591"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">backup</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">l</span><span class="o">.</span><span class="n">atEOF</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">&gt;</span> <span class="m">0</span> <span class="p">{</span>
    <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">utf8</span><span class="o">.</span><span class="n">DecodeLastRuneInString</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="o">:</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">])</span>
    <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">-=</span> <span class="n">w</span>

    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="p">{</span>
      <span class="n">l</span><span class="o">.</span><span class="n">line</span><span class="o">--</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>As always, we want to add a test for our function that is skipping spaces. Now, it is important to understand that we are not only interested of whitespaces. We also want to 'skip' other non-printable characters such as '\t', '\r', '\n', ... For that we are going to use the <code>unicode.IsSpace</code> from the Go standard library. So our test, should contain these different characters.</p>
<ul class="code-tab-container 43f6b8ab-d025-47aa-8723-124ef625d75f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '43f6b8ab-d025-47aa-8723-124ef625d75f', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 43f6b8ab-d025-47aa-8723-124ef625d75f"><li class="code_switcher_container_parent active-tab code_switcher_go 2f7ef245-db22-433a-81a4-affdad9f1b57"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">TestNextTokenOnSpace</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"</span><span class="se">\t\n\v\f\r</span><span class="s"> "</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">"</span><span class="se">\t\n\v\f\r</span><span class="s"> "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Obviously, if we run this we will get the following:</p>
<div class="code_switcher_container_parent 77708e73-bb77-4d54-9362-811532f9bbf1"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnSpace <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Space"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Now that we have our test, <code>backup</code> and <code>peek</code>, we can write our <code>lexSpaces</code> function. This is a function that loops until we find a non-space character as peek and return a Token for that space.</p>
<ul class="code-tab-container 4bf53422-b740-4008-8a8f-4f8935c81e10"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4bf53422-b740-4008-8a8f-4f8935c81e10', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 4bf53422-b740-4008-8a8f-4f8935c81e10"><li class="code_switcher_container_parent active-tab code_switcher_go c5c8ccc8-1633-4805-a403-b39cb4fdfc40"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">lexSpaces</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">r</span> <span class="kt">rune</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsSpace</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenSpace</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This <code>lexSpaces</code> function will now need to be placed in our <code>lexProto</code> switch in order to be taken into consideration.</p>
<ul class="code-tab-container 317586f7-e1b4-44d3-aa14-1faf184e8740"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '317586f7-e1b4-44d3-aa14-1faf184e8740', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 317586f7-e1b4-44d3-aa14-1faf184e8740"><li class="code_switcher_container_parent active-tab code_switcher_go 413529b4-1d71-4af5-bb7b-c594767b47e6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">unicode</span><span class="o">.</span><span class="n">IsSpace</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span> <span class="c">// go back by one character</span>
    <span class="k">return</span> <span class="n">lexSpaces</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and that's basically it! We run our test and we get:</p>
<div class="code_switcher_container_parent 4e32bb94-cfb5-4318-acb2-9343dd09779d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.235s
</code></pre></div></div>
</div>
<h2 id="comments">Comments</h2>
<p>It turns out that we can lex comments with a similar technique as the one used for spaces. The only difference here is that we have two type of comment:</p>
<ul>
<li>Line comment: Starts with <code>//</code> and finishes at the end of the line.</li>
<li>Multiline comment: Starts with <code>/*</code> and finishes with <code>*/</code>.</li>
</ul>
<h3 id="line-comment">Line comment</h3>
<p>We are going to start with the line comment. This is very similar to <code>lexSpaces</code>. The major difference is that we are going to check for '\n' or EOF for finishing the comment. Finally, we are going to return a Token.</p>
<p>But before all that, let's write two tests. One that checks that we are skipping until '\n' and the other that checks that we are skipping until EOF.</p>
<ul class="code-tab-container 4f57e304-36f1-4560-933d-245c98b7e3f1"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4f57e304-36f1-4560-933d-245c98b7e3f1', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 4f57e304-36f1-4560-933d-245c98b7e3f1"><li class="code_switcher_container_parent active-tab code_switcher_go 393ac204-343e-4f03-8cbe-c76eadf78b55"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">TestNextTokenOnLineCommentWithEOF</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"//this is a comment"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenComment</span><span class="p">,</span> <span class="s">"//this is a comment"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnLineCommentWithNewLine</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"//this is a comment</span><span class="se">\n</span><span class="s">_"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenComment</span><span class="p">,</span> <span class="s">"//this is a comment"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">1</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">19</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">19</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">TokenUnderscore</span><span class="p">,</span> <span class="s">"_"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">20</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">20</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">21</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">21</span><span class="p">}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We fail to pass, once again:</p>
<div class="code_switcher_container_parent 6c894a7d-ff9a-449a-9d30-1aec3180a53b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnLineCommentWithEOF <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Comment"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnLineCommentWithNewLine <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Comment"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Let's now write our function.</p>
<ul class="code-tab-container aad74366-d1eb-429d-8dd0-f9df54e17ccb"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'aad74366-d1eb-429d-8dd0-f9df54e17ccb', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher aad74366-d1eb-429d-8dd0-f9df54e17ccb"><li class="code_switcher_container_parent active-tab code_switcher_go 4d73c474-c1fa-4c0b-881e-d392ed55f440"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="n">lexLineComment</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">r</span> <span class="kt">rune</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenComment</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and run our tests:</p>
<div class="code_switcher_container_parent 72ccc6ae-a149-4030-a908-fa93dd6c668e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.351s
</code></pre></div></div>
</div>
<p>We pass the Line Comment tests, let's go to the multiline comment.</p>
<h3 id="multiline-comment">Multiline Comment</h3>
<p>These comments are again pretty similar, however, like any other object that doesn't end with EOF we can have errors. The main error here is an unterminated comment. As an example, writing something like:</p>
<div class="code_switcher_container_parent 7735f573-cb18-416d-9677-f36e9131512a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">/*</span><span class="n">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">comment</span>
</code></pre></div></div>
</div>
<p>should result in an error from the lexer.</p>
<p>To handle such errors, we are going to create a function that will basically stop the lexing process by emitting an Error Token and return nil as state.</p>
<ul class="code-tab-container a2493382-1de8-4262-a61a-a79a66b4f1cb"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'a2493382-1de8-4262-a61a-a79a66b4f1cb', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher a2493382-1de8-4262-a61a-a79a66b4f1cb"><li class="code_switcher_container_parent active-tab code_switcher_go ffbc0f5f-307f-49ed-b09d-db59eade1999"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">errorf</span><span class="p">(</span><span class="n">format</span> <span class="kt">string</span><span class="p">,</span> <span class="n">args</span> <span class="o">...</span><span class="n">any</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">l</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">Token</span><span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Sprintf</span><span class="p">(</span><span class="n">format</span><span class="p">,</span> <span class="n">args</span><span class="o">...</span><span class="p">),</span> <span class="n">Position</span><span class="p">{</span>
    <span class="n">Offset</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
    <span class="n">Line</span><span class="o">:</span>   <span class="n">l</span><span class="o">.</span><span class="n">startLine</span><span class="p">,</span>
    <span class="n">Column</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span><span class="p">,</span>
  <span class="p">}}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="m">0</span>
  <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="m">0</span>
  <span class="n">l</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="o">:</span><span class="m">0</span><span class="p">]</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>This is similar to what we did in emit, the only difference is that here the literal of a token is the error message and we reset the state of our lexer.</p>
<p>Now that we know the requirements for our lexer concerning comments, we can write some tests. Before that, though, as a matter of convenience, we are going to define constants for our error messages. This is done to avoid typos when writing tests:</p>
<ul class="code-tab-container b6917cc7-97dd-4d23-bd7e-140b90f74f46"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b6917cc7-97dd-4d23-bd7e-140b90f74f46', 0)">lexer/errors.go</a></li></ul><ul class="code-tab-switcher b6917cc7-97dd-4d23-bd7e-140b90f74f46"><li class="code_switcher_container_parent active-tab code_switcher_go 988a19b4-3d63-4291-a250-c58dbbd3c13d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="k">const</span> <span class="p">(</span>
  <span class="n">errorUnterminatedMultilineComment</span> <span class="o">=</span> <span class="s">"unterminated multiline comment"</span>
<span class="p">)</span>
</code></pre></div></div>
</li></ul>
<p>and once this is done we can now have our tests:</p>
<ul class="code-tab-container 5f842d7c-29fe-483b-b830-0fe52fb484c6"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '5f842d7c-29fe-483b-b830-0fe52fb484c6', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 5f842d7c-29fe-483b-b830-0fe52fb484c6"><li class="code_switcher_container_parent active-tab code_switcher_go c2518e60-6cc3-47b0-9878-518984e0a796"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnMultilineComment</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"/*this is a comment*/_"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenComment</span><span class="p">,</span> <span class="s">"/*this is a comment*/"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">TokenUnderscore</span><span class="p">,</span> <span class="s">"_"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">21</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">21</span><span class="p">}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">22</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">22</span><span class="p">}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnUnterminatedMultilineComment</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"/*this is a comment"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">errorUnterminatedMultilineComment</span><span class="p">,</span> <span class="n">Position</span><span class="p">{</span><span class="m">0</span><span class="p">,</span> <span class="m">1</span><span class="p">,</span> <span class="m">0</span><span class="p">}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>we run:</p>
<div class="code_switcher_container_parent ec29b7c2-2247-41ab-9543-663e7511d6a9"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnMultilineComment <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Comment"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnUnterminatedMultilineComment <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Error"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>and we fail (we are used to it).</p>
<p><code>lexMultilineComment</code> is a little bit longer than the other functions we wrote for lexing. This is mostly due to the fact that we are checking for unterminated comment but also because we need to check that the current character is '/' and that the previous character was '*'. So we keep a reference to the previous character and check that for stopping the reading loop.</p>
<ul class="code-tab-container 85b0b79f-b5fc-4236-a918-1c269b7799e6"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '85b0b79f-b5fc-4236-a918-1c269b7799e6', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 85b0b79f-b5fc-4236-a918-1c269b7799e6"><li class="code_switcher_container_parent active-tab code_switcher_go 9525fb98-8fc4-4ebe-99c4-630283fa80ad"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexMultilineComment</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">p</span> <span class="kt">rune</span>
  <span class="k">var</span> <span class="n">r</span> <span class="kt">rune</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">r</span>
    <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">errorf</span><span class="p">(</span><span class="n">errorUnterminatedMultilineComment</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">p</span> <span class="o">==</span> <span class="sc">'*'</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="p">{</span>
      <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
      <span class="k">break</span>
    <span class="p">}</span>

    <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenComment</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Once again this is very similar to <code>lexSpaces</code> and <code>lexLineComment</code>, isn't it?</p>
<p>Let's now place that in our <code>lexProto</code> function:</p>
<ul class="code-tab-container ceff0f5f-7486-4ec8-8ba5-00b9a714b513"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ceff0f5f-7486-4ec8-8ba5-00b9a714b513', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher ceff0f5f-7486-4ec8-8ba5-00b9a714b513"><li class="code_switcher_container_parent active-tab code_switcher_go d01a7bb5-1ddf-488b-bd37-8bf7aed5f8e3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'/'</span> <span class="o">&amp;&amp;</span> <span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">()</span> <span class="o">==</span> <span class="sc">'*'</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexMultilineComment</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and our tests?</p>
<div class="code_switcher_container_parent ec6b05c6-e978-4ceb-b174-9408b2d12dd0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.741s
</code></pre></div></div>
</div>
<h2 id="identifiers">Identifiers</h2>
<p>For identifiers, we need a way to keep going while we have a letter (capitalized or not), a number or an underscore. We are going to create a function called <code>acceptWhile</code> that does just that. We want to pass the set of possible characters to it and while the set contains the current value it will advance. Once we are done, we are going to use <code>backup</code> to make sure that the <code>lexer.pos</code> is just after the last character of the identifier.</p>
<p>Before we do that, though, it's testing time. We simply want to test that when we pass some text starting with a letter, <code>lexProto</code> will create an Identifier token.</p>
<ul class="code-tab-container 30aef622-9296-4109-82c8-84899c68e1e5"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '30aef622-9296-4109-82c8-84899c68e1e5', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 30aef622-9296-4109-82c8-84899c68e1e5"><li class="code_switcher_container_parent active-tab code_switcher_go 0d957954-98f1-4e8d-9215-243a442c3c34"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnIdentifier</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"hello_world2023 HelloWorld2023"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="s">"hello_world2023"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenIdentifier</span><span class="p">,</span> <span class="s">"HelloWorld2023"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We obviously fail the test:</p>
<div class="code_switcher_container_parent b2d43f57-e50b-4aca-bf6d-83f05a54b871"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnIdentifier <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Identifier"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>and now we can start our <code>acceptWhile</code> function:</p>
<ul class="code-tab-container f8e0e88e-c40b-44bc-92cb-c6bf43246f95"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f8e0e88e-c40b-44bc-92cb-c6bf43246f95', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher f8e0e88e-c40b-44bc-92cb-c6bf43246f95"><li class="code_switcher_container_parent active-tab code_switcher_go 92d55385-61e2-440e-b3a3-50bcb347f9f8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">acceptWhile</span><span class="p">(</span><span class="n">valid</span> <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">strings</span><span class="o">.</span><span class="n">ContainsRune</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">())</span> <span class="p">{</span>
  <span class="p">}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>That's it. Nothing more! A few lines of code and we can now simply write our <code>lexIdentifier</code>.</p>
<ul class="code-tab-container 323d1a15-e4e1-42a6-97e7-0259254fbcc9"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '323d1a15-e4e1-42a6-97e7-0259254fbcc9', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 323d1a15-e4e1-42a6-97e7-0259254fbcc9"><li class="code_switcher_container_parent active-tab code_switcher_go f42ebf3a-b3b1-4a94-be3b-ad8ccb1ff96f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexIdentifier</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="s">"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_"</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenIdentifier</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and add that to the <code>lexProto</code>:</p>
<ul class="code-tab-container d7271edf-3e88-4744-ac29-258d020ca2e9"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd7271edf-3e88-4744-ac29-258d020ca2e9', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher d7271edf-3e88-4744-ac29-258d020ca2e9"><li class="code_switcher_container_parent active-tab code_switcher_go d4cb8dd8-a7ab-464d-8ba3-b2949e1c4645"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">unicode</span><span class="o">.</span><span class="n">IsLetter</span><span class="p">(</span><span class="n">r</span><span class="p">)</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexIdentifier</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We rerun our test:</p>
<div class="code_switcher_container_parent d13dfb9f-d0ab-482d-9993-bef3a0761e80"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.767s
</code></pre></div></div>
</div>
<h2 id="strings">Strings</h2>
<p>Before going the numbers, let's continue with something easy. Lexing strings is similar to what we did with multiline comments. We have a beginning and an end delimited by a certain character. In Protobuf, for strings, we can use single and double quotes. However, we cannot match a double quote with a single one. This means that having something like:</p>
<div class="code_switcher_container_parent fa4c2a01-75b0-4f01-aaff-8d0d20efe90c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">"test'
</span></code></pre></div></div>
</div>
<p>will result in a unterminated string.</p>
<p>Now that we know the requirements, let's write out tests.</p>
<ul class="code-tab-container 53964efc-fa02-4228-b817-2a9b1b929ba7"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '53964efc-fa02-4228-b817-2a9b1b929ba7', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 53964efc-fa02-4228-b817-2a9b1b929ba7"><li class="code_switcher_container_parent active-tab code_switcher_go 226baf35-e2c8-4e05-91c6-b49710cb4f2f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnString</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"'test' </span><span class="se">\"</span><span class="s">test</span><span class="se">\"</span><span class="s">"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenStr</span><span class="p">,</span> <span class="s">"'test'"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenStr</span><span class="p">,</span> <span class="s">"</span><span class="se">\"</span><span class="s">test</span><span class="se">\"</span><span class="s">"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnUnterminatedString</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"'test"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">errorUnterminatedQuotedString</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnMismatchedQuotesString</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"</span><span class="se">\"</span><span class="s">test'"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenError</span><span class="p">,</span> <span class="n">errorUnterminatedQuotedString</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>you notice the constant named <code>errorUnterminatedQuotedString</code>. It is similar to the error message we added for the multiline comment.</p>
<ul class="code-tab-container 791157be-dff2-4f6d-8db8-f0fd3afb8482"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '791157be-dff2-4f6d-8db8-f0fd3afb8482', 0)">lexer/errors.go</a></li></ul><ul class="code-tab-switcher 791157be-dff2-4f6d-8db8-f0fd3afb8482"><li class="code_switcher_container_parent active-tab code_switcher_go 27359273-dfc8-4cc3-81d3-71cd84a9381e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="k">const</span> <span class="p">(</span>
  <span class="n">errorUnterminatedMultilineComment</span> <span class="o">=</span> <span class="s">"unterminated multiline comment"</span>
  <span class="n">errorUnterminatedQuotedString</span>     <span class="o">=</span> <span class="s">"unterminated quoted string"</span>
<span class="p">)</span>
</code></pre></div></div>
</li></ul>
<p>We obviously fail the test:</p>
<div class="code_switcher_container_parent 718747e0-21e2-44ba-b524-8cb0f101f0b3"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnString <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"String"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnUnterminatedString <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Error"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnMismatchedQuotesString <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Error"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Ok, now we can write our <code>lexString</code>. We are going to write a function that first take notice of the character it currently is on. This character will be a single or double quote and we are going to need it to determine the end of our string. After that we are going to loop over the input and we are going to check for EOF (unterminated string) and the character at the beginning (end of string). When we encounter the end of the string, we can just break out of the loop and return a String Token.</p>
<ul class="code-tab-container 9b587c85-8ff1-41b5-a34a-f26b72228d4d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '9b587c85-8ff1-41b5-a34a-f26b72228d4d', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 9b587c85-8ff1-41b5-a34a-f26b72228d4d"><li class="code_switcher_container_parent active-tab code_switcher_go 025e100a-2abf-45c4-9f20-5ef404b0644d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexString</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">open</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">]</span>
  <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
<span class="n">Loop</span><span class="o">:</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">()</span> <span class="p">{</span>
    <span class="k">case</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span><span class="o">:</span>
      <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">errorf</span><span class="p">(</span><span class="n">errorUnterminatedQuotedString</span><span class="p">)</span>
    <span class="k">case</span> <span class="kt">rune</span><span class="p">(</span><span class="n">open</span><span class="p">)</span><span class="o">:</span>
      <span class="k">break</span> <span class="n">Loop</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenStr</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and after that, you know the trick, we add that to <code>lexProto</code>:</p>
<ul class="code-tab-container 4852e7ea-7c59-49d7-8641-633e509d2e6b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4852e7ea-7c59-49d7-8641-633e509d2e6b', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 4852e7ea-7c59-49d7-8641-633e509d2e6b"><li class="code_switcher_container_parent active-tab code_switcher_go 8532846a-b26b-4865-9d3e-d30b1550a1fc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'"'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\'</span><span class="err">'</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexString</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and the tests?</p>
<div class="code_switcher_container_parent b2e29521-0a86-48cb-88dd-5f75948144e6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.374s
</code></pre></div></div>
</div>
<h2 id="numbers">Numbers</h2>
<p>The real challenge comes with numbers. If we take a look at the <a href="https://protobuf.dev/reference/protobuf/proto3-spec/">Protobuf language specification</a>, we need to accept Decimal, Octal and Hexadecimal for integers and exponents for floats. On top of that we need to be able to put a sign before the number to be able to have -5 for example.</p>
<p>In our tests we are going to try listing all the possible kinds of numbers (if you spot something missing, let me know):</p>
<ul class="code-tab-container 7b5a7b68-b293-45f6-b6c2-22332adca450"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '7b5a7b68-b293-45f6-b6c2-22332adca450', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 7b5a7b68-b293-45f6-b6c2-22332adca450"><li class="code_switcher_container_parent active-tab code_switcher_go 8d471032-1898-428e-89f7-98d2760c58d8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">TestNextTokenOnIntDecimal</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"5 0 -5 +5"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"0"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"-5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"+5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnIntHex</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"0xff 0XFF"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"0xff"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"0XFF"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnIntOctal</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"056"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenInt</span><span class="p">,</span> <span class="s">"056"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">TestNextTokenOnFloat</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(</span><span class="s">"-0.5 +0.5 -.5 +.5 .5 .5e5 .5e+5 .5e-5 5e5"</span><span class="p">),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"-0.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"+0.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"-.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"+.5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5e5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5e+5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">".5e-5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSpace</span><span class="p">,</span> <span class="s">" "</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenFloat</span><span class="p">,</span> <span class="s">"5e5"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Tests fail:</p>
<div class="code_switcher_container_parent b85030e7-c2cd-4d2d-af59-8cd25114bf67"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnIntDecimal <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Integer"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnIntHex <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Integer"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnIntOctal <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Integer"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
<span class="nt">---</span> FAIL: TestNextTokenOnFloat <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Float"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>Now, before writing our <code>lexNumber</code> we want to have an <code>accept</code> function which does something similar to <code>acceptWhile</code> but only one time instead of in a loop. This will help us to check if our number, as an example, is starting by 0 in which case it might be a hexadecimal number.</p>
<ul class="code-tab-container 72da6724-3b52-4c94-aef9-a73f80f90227"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '72da6724-3b52-4c94-aef9-a73f80f90227', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 72da6724-3b52-4c94-aef9-a73f80f90227"><li class="code_switcher_container_parent active-tab code_switcher_go 2e5ebf43-189f-497d-a52b-201d96b39533"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">accept</span><span class="p">(</span><span class="n">valid</span> <span class="kt">string</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
  <span class="k">if</span> <span class="n">strings</span><span class="o">.</span><span class="n">ContainsRune</span><span class="p">(</span><span class="n">valid</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">())</span> <span class="p">{</span>
    <span class="k">return</span> <span class="no">true</span>
  <span class="p">}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
  <span class="k">return</span> <span class="no">false</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Now we can write our <code>lexNumber</code> function. We are going to start by assuming that our set of possible characters are from 0 to 9. Then we check if the number starts with the character 0. If it's the case, it will be an Hexadecimal or an Octal. We update the set of possible characters based on that.</p>
<p>Now that we know the possible set of characters, we can do an <code>acceptWhile</code> to read the digits. After the number we might see a dot for floating-point numbers. There we are going to do another <code>acceptWhile</code> to read all the digits. And finally, after all of this, we can still have an exponent followed by a sign and digits.</p>
<ul class="code-tab-container d6e1216b-df0c-4735-9716-40fbdf5081bc"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd6e1216b-df0c-4735-9716-40fbdf5081bc', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher d6e1216b-df0c-4735-9716-40fbdf5081bc"><li class="code_switcher_container_parent active-tab code_switcher_go cc13201c-3573-4371-b136-d4c2b63702f4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexNumber</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">t</span> <span class="n">TokenType</span> <span class="o">=</span> <span class="n">TokenInt</span>

  <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"+-"</span><span class="p">)</span>

  <span class="n">digits</span> <span class="o">:=</span> <span class="s">"0123456789"</span> <span class="c">// decimal</span>

  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"0"</span><span class="p">)</span> <span class="p">{</span> <span class="c">// starts with 0</span>
    <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"xX"</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">digits</span> <span class="o">=</span> <span class="s">"0123456789abcdefABCDEF"</span> <span class="c">// hexadecimal</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">digits</span> <span class="o">=</span> <span class="s">"01234567"</span> <span class="c">// octal</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="n">digits</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"."</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">TokenFloat</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="s">"0123456789"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"eE"</span><span class="p">)</span> <span class="p">{</span> <span class="c">// exponent</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">TokenFloat</span>
    <span class="n">l</span><span class="o">.</span><span class="n">accept</span><span class="p">(</span><span class="s">"+-"</span><span class="p">)</span>
    <span class="n">l</span><span class="o">.</span><span class="n">acceptWhile</span><span class="p">(</span><span class="s">"0123456789"</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We add that to <code>lexProto</code>:</p>
<ul class="code-tab-container 8b068b90-a04d-4932-ac58-615e2f6fded8"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8b068b90-a04d-4932-ac58-615e2f6fded8', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 8b068b90-a04d-4932-ac58-615e2f6fded8"><li class="code_switcher_container_parent active-tab code_switcher_go 1efb597d-d953-4d1b-ae22-ccc841d9a405"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="c">//...</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'+'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'-'</span> <span class="o">||</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">||</span> <span class="p">(</span><span class="sc">'0'</span> <span class="o">&lt;=</span> <span class="n">r</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="sc">'9'</span><span class="p">)</span><span class="o">:</span>
    <span class="n">l</span><span class="o">.</span><span class="n">backup</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">lexNumber</span>
  <span class="p">}</span>
  <span class="c">//...</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We run our tests again:</p>
<div class="code_switcher_container_parent eb37cc3d-33df-4ced-8107-2faa332c941b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnFloat <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[8] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"Float"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"."</span>
FAIL
</code></pre></div></div>
</div>
<p>and we still have an error. This is due to the fact that, in part 1, when we were lexing symbols, we added this case statement:</p>
<ul class="code-tab-container 35e494f9-b0cf-4106-94c0-ad0de8899804"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '35e494f9-b0cf-4106-94c0-ad0de8899804', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 35e494f9-b0cf-4106-94c0-ad0de8899804"><li class="code_switcher_container_parent active-tab code_switcher_go 7d2f62fe-5370-4743-ad8c-b82874cb02a8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span><span class="o">:</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenDot</span><span class="p">)</span>
<span class="c">//...</span>
</code></pre></div></div>
</li></ul>
<p>In Protobuf, numbers can start directly with a dot and thus our lexer will just read Dot and then an Integer. So we need to skip the lexing of a dot if it's followed by a number.</p>
<ul class="code-tab-container eb8eaac3-ad80-4a8c-ab63-91b2600f1394"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'eb8eaac3-ad80-4a8c-ab63-91b2600f1394', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher eb8eaac3-ad80-4a8c-ab63-91b2600f1394"><li class="code_switcher_container_parent active-tab code_switcher_go 5ed68ab1-c3f3-44f4-8c3f-f06aad705734"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">unicode</span><span class="o">.</span><span class="n">IsNumber</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">peek</span><span class="p">())</span><span class="o">:</span>
  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenDot</span><span class="p">)</span>
<span class="c">//...</span>
</code></pre></div></div>
</li></ul>
<p>And our tests pass:</p>
<div class="code_switcher_container_parent 27d79484-b98a-44b8-9eb4-ee3991714329"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.763s
</code></pre></div></div>
</div>
<blockquote>
<p>Note: I am aware that some invalid numbers can pass through this lexing function. For example, the invalid number <code>0XFF.5</code> will return you a float. However, this is not the lexer that should handle the verification of number, the parser will. The lexer's job is to return tokens.</p>
</blockquote>
<h2 id="we-can-lex">We can Lex!</h2>
<p>As promised in the beginning of the article, we are able to lex a file called <code>descriptor.proto</code>. This file can be found <a href="https://github.com/protocolbuffers/protobuf/blob/main/src/google/protobuf/descriptor.proto">here</a>. Just copy its content to a file.</p>
<p>Now, we need to write some main function to run our lexer. It will read the first argument from the command line (no error handling because this is just a test), read the file to a string, initialize a lexer and will repeatedly call the <code>NextToken</code> until EOF.</p>
<ul class="code-tab-container 71ec142c-4d0b-42ec-9fa9-b1b6186952b1"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '71ec142c-4d0b-42ec-9fa9-b1b6186952b1', 0)">main.go</a></li></ul><ul class="code-tab-switcher 71ec142c-4d0b-42ec-9fa9-b1b6186952b1"><li class="code_switcher_container_parent active-tab code_switcher_go 8b1b464b-88ce-4bac-bb60-2e65a753d177"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"log"</span>
  <span class="s">"os"</span>

  <span class="s">"github.com/Clement-Jean/protein/lexer"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">args</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">Args</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">]</span>
  <span class="n">content</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">os</span><span class="o">.</span><span class="n">ReadFile</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
  <span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
  <span class="p">}</span>
  <span class="n">l</span> <span class="o">:=</span> <span class="n">lexer</span><span class="o">.</span><span class="n">New</span><span class="p">(</span><span class="kt">string</span><span class="p">(</span><span class="n">content</span><span class="p">))</span>

  <span class="k">for</span> <span class="p">{</span>
    <span class="n">token</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span>

    <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">token</span><span class="o">.</span><span class="n">Type</span> <span class="o">==</span> <span class="n">lexer</span><span class="o">.</span><span class="n">EOF</span> <span class="p">{</span>
      <span class="k">break</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>we run:</p>
<div class="code_switcher_container_parent 13a8c696-9f9f-4a3c-8246-eda8885f1137"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go run main.go descriptor.proto
</code></pre></div></div>
</div>
<p>and we should have output similar to:</p>
<div class="code_switcher_container_parent 72e08319-c34e-493d-b8c1-8ea71ffbc17c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>...
2023/02/21 18:01:58 <span class="o">{}</span> <span class="o">}</span> <span class="o">{</span>38493 920 0<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{</span>Space 
 <span class="o">{</span>38494 920 1<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{}</span> <span class="o">}</span> <span class="o">{</span>38495 921 0<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{</span>Space 
 <span class="o">{</span>38496 921 1<span class="o">}}</span>
2023/02/21 18:01:58 <span class="o">{</span>EOF  <span class="o">{</span>38497 922 0<span class="o">}}</span>
</code></pre></div></div>
</div>
<h2 id="conclusion">Conclusion</h2>
<p>In this article, we tokenized all the elements that we need to get started with our parser. We are even able to lex proto files in the protobuf library! In the next episode, before going to the parser, we are going to make sure that our token positions are correct because up until now we didn't test that.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>
<div class="container">
  <div class="row">
    <div class="col text-center">
      <a href="/protein_lexer_part_1" class="btn btn-danger text-center">Previous Article</a>
    </div>
    <div class="col text-center">
      <a href="/protein_lexer_part_3" class="btn btn-danger text-center">Next Article</a>
    </div>
  </div>
</div>]]></content><author><name>Clement</name></author><category term="Protocol Buffers" /><category term="Go" /><summary type="html"><![CDATA[In this article we are going to delve into the second part of the lexing which is tokenizing more advanced part of the input. More precisely, we are going to lex spaces (whitespaces, new lines, ...), comments, Identifiers, Numbers (Int and Float), and Strings. At the end of this article, we will have a fully functioning lexer that can tokenize the descriptor.proto which is the longest proto file in the protobuf repo. Let's get started.]]></summary></entry><entry><title type="html">Protein: Lexer (Part 1)</title><link href="https://clement-jean.github.io/protein_lexer_part_1/" rel="alternate" type="text/html" title="Protein: Lexer (Part 1)" /><published>2023-02-17T00:00:00+01:00</published><updated>2023-02-17T00:00:00+01:00</updated><id>https://clement-jean.github.io/protein_lexer_part_1</id><content type="html" xml:base="https://clement-jean.github.io/protein_lexer_part_1/"><![CDATA[<p>As promised in a <a href="https://www.linkedin.com/posts/clement-jean_protobuf-activity-7024951031868391424-I26b?utm_source=share&amp;utm_medium=member_desktop">LinkedIn Poll</a>, we are going to develop Parser for proto files which will create an AST that is serializable in Protobuf itself. Obviously, this is going to be a series of articles because we need to write quite a lot of parsing code. However, I believe that this is worth doing since we are going to see another use of Protobuf outside of gRPC.</p>
<p>In this article, we are going to present the project and start writing a Lexer. This is not the most amusing part. However, this will be the foundations for our part 2 in which we will start more complex tokenizing of the input.</p>
<h2 id="the-project">The Project</h2>
<p>The project is called <a href="https://github.com/Clement-Jean/protein">protein</a>. In itself, this is intended to be a project showing how to parse proto files to do tools for Protobuf. But the end goal is to provide an easy-to-use and efficient linter.</p>
<p>The project is mostly divided into three components:</p>
<ul>
<li>The Lexer: it tokenizes the input and provides metadata about these tokens.</li>
<li>The Parser: it verifies the validity of our tokens and builds an AST.</li>
<li>The Linter: it analyzes the AST and provide feedback to users.</li>
</ul>
<blockquote>
<p>Note: There might be more components later but these are the major ones.</p>
</blockquote>
<p>One thing worth mentioning is that the AST will be built with objects generated by Protobuf. This means that we will have an AST that we can serialize and maybe even cache for multiple runs of our Linter.</p>
<p>Finally, as mentioned, this project shows how to build tools for Protobuf. Thus I hope the readers will be inspired to create their own tools and/or contribute to this project. I'm going to document all the code and explain all the logic so that you can follow along and even participate in the development.</p>
<h2 id="the-lexer">The Lexer</h2>
<p>The <code>protein</code> Lexer has been inspired by one of the great pieces of code out there: The <a href="https://cs.opensource.google/go/go/+/master:src/text/template/parse/lex.go">template library lex.go</a> in the Go standard library. I was introduced to this code by an <a href="https://www.youtube.com/watch?v=HxaD_trXwRE">amazing talk</a> given by <a href="https://en.wikipedia.org/wiki/Rob_Pike">Rob Pike</a>. So I want to thank all the contributors and Rob for the amazing talk. <strong>Thank you guys!</strong></p>
<p>The essence of the Lexer is a <a href="https://en.wikipedia.org/wiki/Finite-state_machine">Finite-state Machine</a> (FSM). This basically means that we are going to go from state to state by applying functions to do the transition. For example, let's say that we have the following line:</p>
<div class="code_switcher_container_parent 68690b65-bb6f-49cb-aef4-fca7f39027b7"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>
</code></pre></div></div>
</div>
<p>We will go through the following states:</p>
<div class="code_switcher_container_parent 323431da-6c74-4e64-8221-d163b4687756"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>initial state -&gt; Identifier(&quot;syntax&quot;) -&gt; Equal -&gt; Str(&quot;proto3&quot;) -&gt; EOF
</code></pre></div>
<p>And each state will know how to parse their own value (e.g. &quot;proto3&quot; for the Str state).</p>
<p>Finally, the Lexer will be used by calling the <code>NextToken</code> function. This function, as its name suggests, will return the next token in the input. This is basically calling all the parsing functions from each state.</p>
<h2 id="lets-start-simple">Let's Start Simple</h2>
<p>Let's fullfil the first requirement. The user code, in our case the Parser, will interact with the Lexer by repeatedly calling the <code>NextToken</code> function. So let's define an interface because that will be handy later on in this series to test the Parser on a fake Lexer.</p>
<ul class="code-tab-container 3a83a503-04e3-4cfe-9c6e-e37da0fb61bc"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '3a83a503-04e3-4cfe-9c6e-e37da0fb61bc', 0)">lexer/lexer.go</a></li></ul><ul class="code-tab-switcher 3a83a503-04e3-4cfe-9c6e-e37da0fb61bc"><li class="code_switcher_container_parent active-tab code_switcher_go aeccd370-6643-49f1-9e92-0da247ef7f0d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="c">// Lexer is protein's tokenizer</span>
<span class="k">type</span> <span class="n">Lexer</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// NextToken returns the following token in the input source.</span>
  <span class="n">NextToken</span><span class="p">()</span> <span class="n">Token</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>For now, &quot;input source&quot; is still a little vague but we are going to deal with that later in the implementation.</p>
<p>After that, we do not have the definition of a <code>Token</code>. In our application, a token is a collection of few information about some text in the input:</p>
<ul>
<li>A type: a simple way to identify tokens (e.g., Identifier, Str, ...)</li>
<li>A literal: the value of a token as a string</li>
<li>A position: the position of this text in the input</li>
</ul>
<p>Let's define all that. Let's start with position. We want to know the offset relative to the beginning of the file and we want to know the line and column at which the token shows up. These info are for making the error messages clearer to the user (at least we'll try our best!). Instead of having something like:</p>
<p><code>unterminated string</code></p>
<p>we want to have:</p>
<p><code>file.proto 1:10 unterminated string: &quot;this is unterminated</code></p>
<p>Where, in this example 1 is the line and 10 is the column.</p>
<p>So a position is pretty simple.</p>
<ul class="code-tab-container 6f2935fc-66ef-45ad-a45d-ab46d46f6869"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '6f2935fc-66ef-45ad-a45d-ab46d46f6869', 0)">lexer/position.go</a></li></ul><ul class="code-tab-switcher 6f2935fc-66ef-45ad-a45d-ab46d46f6869"><li class="code_switcher_container_parent active-tab code_switcher_go ad07c3b9-736f-4274-ba1f-34a1342faa59"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="c">// Position is a position in the input</span>
<span class="k">type</span> <span class="n">Position</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="c">// Offset is the position relative to the beginning of the file (starts at 0)</span>
  <span class="n">Offset</span> <span class="kt">int</span>

  <span class="c">// Line is the file line (starts at 1)</span>
  <span class="n">Line</span> <span class="kt">int</span>

  <span class="c">// Column is the offset relative to the beginning of the line (starts at 0)</span>
  <span class="n">Column</span> <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>And with that we can now define our Token.</p>
<ul class="code-tab-container ed4c5bf4-9ff9-4072-a2d3-1cc760c3d2da"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ed4c5bf4-9ff9-4072-a2d3-1cc760c3d2da', 0)">lexer/token.go</a></li></ul><ul class="code-tab-switcher ed4c5bf4-9ff9-4072-a2d3-1cc760c3d2da"><li class="code_switcher_container_parent active-tab code_switcher_go 56b1504c-2426-43bf-88bd-8f6bb9bef2c2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="c">// TokenType is an alias type which tells of which kind the token is</span>
<span class="k">type</span> <span class="n">TokenType</span> <span class="kt">int</span>

<span class="c">// Token is a piece of the input</span>
<span class="k">type</span> <span class="n">Token</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Type</span>    <span class="n">TokenType</span>
  <span class="n">Literal</span> <span class="kt">string</span>
  <span class="n">Position</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="token-types">Token Types</h2>
<p>Right now, we simply have the <code>TokenType</code> type alias but do not define any value. We are going to define an enum for all the possible values that the <code>Token.Type</code> property can have.</p>
<ul class="code-tab-container c70ff09f-8de7-44bf-b000-21e4dc5a3940"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c70ff09f-8de7-44bf-b000-21e4dc5a3940', 0)">lexer/token.go</a></li></ul><ul class="code-tab-switcher c70ff09f-8de7-44bf-b000-21e4dc5a3940"><li class="code_switcher_container_parent active-tab code_switcher_go e1fcbfe1-111e-4f0d-8fca-d50bf4f3009b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="c">// These are all the token types</span>
<span class="k">const</span> <span class="p">(</span>
  <span class="n">EOF</span>          <span class="n">TokenType</span> <span class="o">=</span> <span class="no">iota</span> <span class="o">-</span> <span class="m">1</span> <span class="c">// End Of File</span>
  <span class="n">TokenIllegal</span>                      <span class="c">// Illegal token</span>
  <span class="n">TokenError</span>                        <span class="c">// Error</span>
  <span class="n">TokenSpace</span>                        <span class="c">// Space (whitespace, '\n', '\r', '\t')</span>
  <span class="n">TokenComment</span>                      <span class="c">// Comment (single line or multiline)</span>

  <span class="n">TokenIdentifier</span> <span class="c">// Identifier</span>
  <span class="n">TokenInt</span>        <span class="c">// Integer</span>
  <span class="n">TokenFloat</span>      <span class="c">// Float</span>
  <span class="n">TokenStr</span>        <span class="c">// String ('...' or "...")</span>

  <span class="n">TokenUnderscore</span>  <span class="c">// _</span>
  <span class="n">TokenEqual</span>       <span class="c">// =</span>
  <span class="n">TokenColon</span>       <span class="c">// ,</span>
  <span class="n">TokenSemicolon</span>   <span class="c">// ;</span>
  <span class="n">TokenDot</span>         <span class="c">// .</span>
  <span class="n">TokenLeftBrace</span>   <span class="c">// {</span>
  <span class="n">TokenRightBrace</span>  <span class="c">// }</span>
  <span class="n">TokenLeftSquare</span>  <span class="c">// [</span>
  <span class="n">TokenRightSquare</span> <span class="c">// ]</span>
  <span class="n">TokenLeftParen</span>   <span class="c">// (</span>
  <span class="n">TokenRightParen</span>  <span class="c">// )</span>
  <span class="n">TokenLeftAngle</span>   <span class="c">// &lt;</span>
  <span class="n">TokenRightAngle</span>  <span class="c">// &gt;</span>
<span class="p">)</span>
</code></pre></div></div>
</li></ul>
<p>There are few things to notice here. The first one is the use of <code>iota</code>. If you are not familiar with this, this is a keyword that lets us define multiple constant with consecutive values. Here, we use <code>iota - 1</code> because, by default, <code>iota</code> starts counting at zero but here we want to start at -1. The second thing to notice is that some of these tokens have constant values (e.g., <code>TokenEqual</code> == '=') and others don't have one (e.g., Identifier value will be evaluated at runtime).</p>
<p>For debugging and testing, we will need a way to display the <code>TokenType</code> as a string. In Go, we can simply do that by defining a function called <code>String()</code> on the <code>TokenType</code> type. And to define the value we are going to have a constant array defining values based on the type (remember <code>TokenType</code> is just an int).</p>
<ul class="code-tab-container 3e1dc4bd-8e4b-4fee-b613-bb8780ee6678"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '3e1dc4bd-8e4b-4fee-b613-bb8780ee6678', 0)">lexer/token.go</a></li></ul><ul class="code-tab-switcher 3e1dc4bd-8e4b-4fee-b613-bb8780ee6678"><li class="code_switcher_container_parent active-tab code_switcher_go 22caf500-5dcc-4f09-8126-4e18eb2e9f00"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">var</span> <span class="n">tokenTypeStr</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
  <span class="s">"EOF"</span><span class="p">,</span>
  <span class="s">"Illegal"</span><span class="p">,</span>
  <span class="s">"Error"</span><span class="p">,</span>
  <span class="s">"Space"</span><span class="p">,</span>
  <span class="s">"Comment"</span><span class="p">,</span>
  <span class="s">"Identifier"</span><span class="p">,</span>
  <span class="s">"Integer"</span><span class="p">,</span>
  <span class="s">"Float"</span><span class="p">,</span>
  <span class="s">"String"</span><span class="p">,</span>
  <span class="s">"_"</span><span class="p">,</span>
  <span class="s">"="</span><span class="p">,</span>
  <span class="s">","</span><span class="p">,</span>
  <span class="s">";"</span><span class="p">,</span>
  <span class="s">"."</span><span class="p">,</span>
  <span class="s">"{"</span><span class="p">,</span> <span class="s">"}"</span><span class="p">,</span>
  <span class="s">"["</span><span class="p">,</span> <span class="s">"]"</span><span class="p">,</span>
  <span class="s">"("</span><span class="p">,</span> <span class="s">")"</span><span class="p">,</span>
  <span class="s">"&lt;"</span><span class="p">,</span> <span class="s">"&gt;"</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">tokenTypeStr</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="m">1</span><span class="p">]</span> <span class="c">// +1 because we start at iota - 1</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="implementing-a-basic-lexer">Implementing a Basic Lexer</h2>
<p>With all of the previous boilerplate, we can now start our implementation. Don't get too excited though, we are simply going to define an &quot;empty shell&quot; Lexer in order to be able to write a failing test (see <a href="https://stackoverflow.com/questions/276813/what-is-red-green-testing">Red/Green testing</a>).</p>
<p>As we know, we need to implement the <code>NextToken</code> function.</p>
<ul class="code-tab-container e16f7870-0c94-40c5-bdf8-8cdc82629c0b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'e16f7870-0c94-40c5-bdf8-8cdc82629c0b', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher e16f7870-0c94-40c5-bdf8-8cdc82629c0b"><li class="code_switcher_container_parent active-tab code_switcher_go 077c2a67-99df-4f71-8ed1-ee53d387eaff"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">NextToken</span><span class="p">()</span> <span class="n">Token</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Token</span><span class="p">{</span>
    <span class="n">Type</span><span class="o">:</span> <span class="n">TokenIllegal</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Furthermore, we need a simple way to instantiate our Lexer. To do so, we are going to create a function called <code>New</code> with a return type being <code>Lexer</code> and will return an instance of <code>Impl</code>.</p>
<ul class="code-tab-container af57ec9a-ba95-4976-87a8-159eb7b90cbe"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'af57ec9a-ba95-4976-87a8-159eb7b90cbe', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher af57ec9a-ba95-4976-87a8-159eb7b90cbe"><li class="code_switcher_container_parent active-tab code_switcher_go 934ae9ff-1dc2-4edb-8835-c8671b4e7ffe"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="c">// New creates a new instance of the Lexer</span>
<span class="k">func</span> <span class="n">New</span><span class="p">()</span> <span class="n">Lexer</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="writing-a-failing-test">Writing a Failing Test</h2>
<p>Now let's start with a simple test. We are going to test all the symbols (Underscore, Equal, ...). At the end of this article, we aim to make that test pass.</p>
<p>We are going to use a technique called <a href="https://arslan.io/2022/12/04/functional-table-driven-tests-in-go/">table-driven tests</a>. To do so, we are going to define a type that represents an expected Token.</p>
<ul class="code-tab-container c4e7dd8a-e748-42a2-94b4-005e3a4c9a5b"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'c4e7dd8a-e748-42a2-94b4-005e3a4c9a5b', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher c4e7dd8a-e748-42a2-94b4-005e3a4c9a5b"><li class="code_switcher_container_parent active-tab code_switcher_go c61900bf-fa2b-4582-af13-f4c0aaec9b69"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Check</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">expectedType</span>     <span class="n">TokenType</span>
  <span class="n">expectedLiteral</span>  <span class="kt">string</span>
  <span class="n">expectedPosition</span> <span class="n">Position</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>I'm calling it <code>Check</code> because it will be used as for a single check in a list of checks. We are going to iterate over that list of checks and do asserts on the three properties.</p>
<ul class="code-tab-container 0cd8f3b5-1fa8-4ef0-bdec-2fca570947fe"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '0cd8f3b5-1fa8-4ef0-bdec-2fca570947fe', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 0cd8f3b5-1fa8-4ef0-bdec-2fca570947fe"><li class="code_switcher_container_parent active-tab code_switcher_go 23b8f181-3afd-4632-9665-359a900b9b00"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">l</span> <span class="n">Lexer</span><span class="p">,</span> <span class="n">tests</span> <span class="p">[]</span><span class="n">Check</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="n">tok</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedType</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - tokentype wrong. expected=%q, got=%q"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedType</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Literal</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedLiteral</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - literal wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedLiteral</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// asserts on Position for later</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>With that we can now write a compiling and failing test.</p>
<ul class="code-tab-container 291f5322-a20a-4d31-b51d-1254b8b55617"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '291f5322-a20a-4d31-b51d-1254b8b55617', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 291f5322-a20a-4d31-b51d-1254b8b55617"><li class="code_switcher_container_parent active-tab code_switcher_go ba0bb6b5-76e3-41f1-a18a-743d53e021d5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>
<span class="p">)</span>

<span class="c">//...</span>

<span class="k">func</span> <span class="n">TestNextTokenOnSymbols</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenUnderscore</span><span class="p">,</span> <span class="s">"_"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenEqual</span><span class="p">,</span> <span class="s">"="</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenColon</span><span class="p">,</span> <span class="s">","</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenDot</span><span class="p">,</span> <span class="s">"."</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftBrace</span><span class="p">,</span> <span class="s">"{"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightBrace</span><span class="p">,</span> <span class="s">"}"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftSquare</span><span class="p">,</span> <span class="s">"["</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightSquare</span><span class="p">,</span> <span class="s">"]"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftParen</span><span class="p">,</span> <span class="s">"("</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightParen</span><span class="p">,</span> <span class="s">")"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftAngle</span><span class="p">,</span> <span class="s">"&lt;"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightAngle</span><span class="p">,</span> <span class="s">"&gt;"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and if we test:</p>
<div class="code_switcher_container_parent f13f92c4-3489-489f-8f06-ac2c75cdb880"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnSymbols <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"_"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>That was expected.</p>
<h2 id="improving-impl">Improving Impl</h2>
<p>If you didn't notice, our implementation for the Lexer is useless. It's not storing any state and it doesn't even process text. Let's change that.</p>
<p>Let's first look at the states our Lexer will store.</p>
<ul class="code-tab-container 0906806b-c02b-4fe9-857b-8c774288414f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '0906806b-c02b-4fe9-857b-8c774288414f', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 0906806b-c02b-4fe9-857b-8c774288414f"><li class="code_switcher_container_parent active-tab code_switcher_go b1e1d8c4-7551-473b-8fa5-eea855f1e33b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Impl is the implementation for the Lexer interface.</span>
<span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">src</span>             <span class="kt">string</span> <span class="c">// the input text</span>
  <span class="n">start</span>           <span class="kt">int</span>    <span class="c">// the start of a token</span>
  <span class="n">startLine</span>       <span class="kt">int</span>    <span class="c">// the line at which a token start</span>
  <span class="n">startLineOffset</span> <span class="kt">int</span>    <span class="c">// the offset of the starting line relative to beginning of file</span>
  <span class="n">line</span>            <span class="kt">int</span>    <span class="c">// the current file line being process</span>
  <span class="n">pos</span>             <span class="kt">int</span>    <span class="c">// the reading position in the file</span>
  <span class="n">atEOF</span>           <span class="kt">bool</span>   <span class="c">// tells wether the Lexer is finished</span>
  <span class="n">token</span>           <span class="n">Token</span>  <span class="c">// the token to return</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>That seems like a lot but don't worry, this is actually pretty intuitive once we start interacting with these properties.</p>
<p>Now, we can improve our <code>New</code> function a little bit.</p>
<ul class="code-tab-container 4e025757-35cd-425c-8c58-cb2d4e9b5eb9"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4e025757-35cd-425c-8c58-cb2d4e9b5eb9', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 4e025757-35cd-425c-8c58-cb2d4e9b5eb9"><li class="code_switcher_container_parent active-tab code_switcher_go 07952a41-2271-4ad5-b474-e7da509ec1da"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="c">// New creates a new instance of the Lexer</span>
<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">input</span> <span class="kt">string</span><span class="p">)</span> <span class="n">Lexer</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span>
    <span class="n">src</span><span class="o">:</span>       <span class="n">input</span><span class="p">,</span>
    <span class="n">line</span><span class="o">:</span>      <span class="m">1</span><span class="p">,</span> <span class="c">// lines are 1-indexed</span>
    <span class="n">startLine</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>We are finally storing text and some indices to keep track of where we are in it.</p>
<p>We can now start to think about emitting token in the <code>NextToken</code> function but before actually emitting tokens we are going to need thinking about the FSM.</p>
<p>As mentioned, we are going to create states and transitions between these states. These states will be represented as functions and the transitions will be made by returning another state after the processing needed for the current state.</p>
<p>We define a state as follows:</p>
<ul class="code-tab-container b892f9f2-38a4-4b54-8851-d33bcc3d3acc"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b892f9f2-38a4-4b54-8851-d33bcc3d3acc', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher b892f9f2-38a4-4b54-8851-d33bcc3d3acc"><li class="code_switcher_container_parent active-tab code_switcher_go fce96f1b-460c-4ff8-a072-0676a1916bfb"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">type</span> <span class="n">stateFn</span> <span class="k">func</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span>
</code></pre></div></div>
</li></ul>
<p>You can notice that this is a function, taking an <code>Impl</code> as parameter and returning a stateFn. Think about is as a list of states linked together.</p>
<p>With that, we are now able to define the <code>NextToken</code> logic.</p>
<ul class="code-tab-container 4f6f7f36-6cae-45ae-9459-aca22fd267d3"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4f6f7f36-6cae-45ae-9459-aca22fd267d3', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 4f6f7f36-6cae-45ae-9459-aca22fd267d3"><li class="code_switcher_container_parent active-tab code_switcher_go a1bed576-d382-45bf-90aa-649c11ee506f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="c">// NextToken provides the following token in the input</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">NextToken</span><span class="p">()</span> <span class="n">Token</span> <span class="p">{</span>
  <span class="n">state</span> <span class="o">:=</span> <span class="n">lexProto</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">token</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>Where <code>lexerProto</code> is the initial state and where we iterate until <code>state</code> it becomes <code>nil</code>.</p>
<h2 id="lexproto">lexProto</h2>
<p><code>lexProto</code> Is the initial state of our FSM. This is a <code>stateFn</code>. This means that it interacts with <code>Impl</code> and returns another <code>stateFn</code>.</p>
<p>For now, we can make this function really simple. It is a function that checks the next character and checking if this character is a symbol. If it is, we return a <code>Token</code> with the relevant <code>TokenType</code>, otherwise we return an Illegal <code>Token</code>.</p>
<ul class="code-tab-container e4bd6a41-25e1-4b2d-bed7-1370001aeea8"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'e4bd6a41-25e1-4b2d-bed7-1370001aeea8', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher e4bd6a41-25e1-4b2d-bed7-1370001aeea8"><li class="code_switcher_container_parent active-tab code_switcher_go 74e7d4ec-3615-4564-878e-52a0fcc9472c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'_'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenUnderscore</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'='</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenEqual</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">','</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenColon</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">';'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenSemicolon</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenDot</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'{'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftBrace</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'}'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightBrace</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'['</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftSquare</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">']'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightSquare</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'('</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftParen</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">')'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightParen</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'&lt;'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftAngle</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'&gt;'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightAngle</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenIllegal</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="next">next()</h2>
<p><code>next</code> Is also pretty simple. It basically checks if the position is valid. If it isn't it returns <code>EOF</code>, otherwise it takes the next rune (utf8 character), updates the <code>pos</code>, updates the <code>line</code> if needed, and return the rune read.</p>
<ul class="code-tab-container 425f0b15-aced-4cfb-a49f-8d559b6df6ca"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '425f0b15-aced-4cfb-a49f-8d559b6df6ca', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 425f0b15-aced-4cfb-a49f-8d559b6df6ca"><li class="code_switcher_container_parent active-tab code_switcher_go 8da882eb-3908-47a4-b710-9efbda6d7435"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">next</span><span class="p">()</span> <span class="kt">rune</span> <span class="p">{</span>
  <span class="k">if</span> <span class="kt">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">atEOF</span> <span class="o">=</span> <span class="no">true</span>
    <span class="k">return</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">utf8</span><span class="o">.</span><span class="n">DecodeRuneInString</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="o">:</span><span class="p">])</span>
  <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">w</span>

  <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">line</span><span class="o">++</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">r</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<h2 id="emittokentype">emit(TokenType)</h2>
<p><code>emit</code> Is a function that checks our current location in the input text, creates a token, and return nil to stop the loop in <code>NextToken</code>.</p>
<ul class="code-tab-container 457e9a6f-e2a8-4767-b9b3-b8fffbcfb7ac"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '457e9a6f-e2a8-4767-b9b3-b8fffbcfb7ac', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 457e9a6f-e2a8-4767-b9b3-b8fffbcfb7ac"><li class="code_switcher_container_parent active-tab code_switcher_go 68c59d31-a2c9-4777-a93b-7f7f66eb766d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">emit</span><span class="p">(</span><span class="n">tt</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">t</span> <span class="o">:=</span> <span class="n">Token</span><span class="p">{</span>
    <span class="n">Type</span><span class="o">:</span>    <span class="n">tt</span><span class="p">,</span>
    <span class="n">Literal</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">start</span><span class="o">:</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">],</span>
    <span class="n">Position</span><span class="o">:</span> <span class="n">Position</span><span class="p">{</span>
      <span class="n">Offset</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
      <span class="n">Line</span><span class="o">:</span>   <span class="n">l</span><span class="o">.</span><span class="n">startLine</span><span class="p">,</span>
      <span class="n">Column</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span><span class="p">,</span>
    <span class="p">}}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">pos</span>
  <span class="n">l</span><span class="o">.</span><span class="n">startLine</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">line</span>
  <span class="k">if</span> <span class="n">tt</span> <span class="o">==</span> <span class="n">TokenSpace</span> <span class="o">&amp;&amp;</span> <span class="n">strings</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span>
  <span class="p">}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">t</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<blockquote>
<p>Note: this is a lot of small operations. Take the time to go through the comments written in the <code>Impl</code> struct. This is not that hard.</p>
</blockquote>
<h2 id="handling-eof">Handling EOF</h2>
<p>If we run our test now, we will get the following:</p>
<div class="code_switcher_container_parent 8059e9be-2bdb-49a5-9f66-747b5eb6cc4c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnSymbols <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:20: tests[13] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"EOF"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div>
</div>
<p>This is basically saying: &quot;we received an Illegal Token but we expected EOF&quot;.</p>
<p>This is pretty trivial to solve. Remember the <code>atEOF</code> property in the <code>Impl</code>? Well, we just add that in our switch statement.</p>
<ul class="code-tab-container 55679f7f-695d-45f9-ad44-2e5620e90af4"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '55679f7f-695d-45f9-ad44-2e5620e90af4', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 55679f7f-695d-45f9-ad44-2e5620e90af4"><li class="code_switcher_container_parent active-tab code_switcher_go 36a3ff27-6531-499d-a813-647efeca175d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">l</span><span class="o">.</span><span class="n">atEOF</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
  <span class="c">//...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
</li></ul>
<p>and now:</p>
<div class="code_switcher_container_parent ecd7d248-63e8-4fd1-bf27-150598e34d11"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
ok      github.com/Clement-Jean/protein/lexer  0.809s
</code></pre></div></div>
</div>
<p>Boom !</p>
<h2 id="conclusion">Conclusion</h2>
<p>We have a Lexer that is able to go through a text and identify the symbols that we defined as TokenType. Admittedly, this is not exceptional but we are now ready for the next part where we are going to skip whitespaces and comments, and lex Identifiers, Numbers (Int and Float), and Strings.</p>
<p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p>
<div class="container">
  <div class="row">
		<div class="col text-center">
			<a href="/protein_lexer_part_2" class="btn btn-danger text-center">Next Article</a>
		</div>
	</div>
</div>]]></content><author><name>Clement</name></author><category term="Protocol Buffers" /><category term="Go" /><summary type="html"><![CDATA[As promised in a LinkedIn Poll, we are going to develop Parser for proto files which will create an AST that is serializable in Protobuf itself. Obviously, this is going to be a series of articles because we need to write quite a lot of parsing code. However, I believe that this is worth doing since we are going to see another use of Protobuf outside of gRPC.]]></summary></entry></feed>