<!DOCTYPE html> <html> <head> <title>Custom RPC Options in Protobuf – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="Recently I had to design authentication for a Blazor Application. After finishing implementing, I soon faced the need to know which RPC endpoint needs authentication and which doesn't. And while part of the problem is a solved one, I still needed a mechanism to let me define this. Let's see how. " /> <meta property="og:description" content="Recently I had to design authentication for a Blazor Application. After finishing implementing, I soon faced the need to know which RPC endpoint needs authentication and which doesn't. And while part of the problem is a solved one, I still needed a mechanism to let me define this. Let's see how. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="Custom RPC Options in Protobuf" /> <meta property="twitter:title" content="Custom RPC Options in Protobuf" /> <link rel="stylesheet" type="text/css" href="/css/org-style.css" /> <link rel="stylesheet" type="text/css" href="/css/org-code.css"/> <link rel="stylesheet" type="text/css" href="/css/org-normalize.css"/> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/css/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>Custom RPC Options in Protobuf</h1> <div class="entry"> <p>Recently I had to design authentication for a Blazor Application. After finishing implementing, I soon faced the need to know which RPC endpoint needs authentication and which doesn't. And while part of the problem is a solved one, I still needed a mechanism to let me define this. Let's see how.</p> <blockquote> <p>All the code (<strong>only running through Bazel right now</strong>) is available <a href="https://github.com/Clement-Jean/clement-jean.github.io/tree/working/src/2023-04-17-custom_rpc_options">here</a></p> </blockquote> <h2 id="custom-options">Custom Options</h2> <p>Before explaining what my solution to the problem is, I'd like to make sure you understand what are custom options in Protobuf and how to define one. If you are confident about this skill, feel free to skip to the next section.</p> <p><strong>A custom option is a way to define metadata for a proto file, message, enum, fields, service and rpc</strong>. Generally, we are used to these:</p> <div class="code_switcher_container_parent 1002749b-c528-4ae1-9cf8-ed7989ef72e6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"github.com/Clement-Jean/test"</span><span class="p">;</span>
</code></pre></div></div> </div> <p>being placed at the top of the proto file. But it is important to know that you can make a field or message deprecated like so:</p> <div class="code_switcher_container_parent 012f8242-a30c-4ff3-9bd9-93f376041367"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Test</span> <span class="p">{</span>
  <span class="k">option</span> <span class="na">deprecated</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="kt">int32</span> <span class="na">field</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span> <span class="na">deprecated</span> <span class="o">=</span> <span class="kc">true</span> <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>Now, I agree that, in most of the cases, these option are more informational than anything else. They do not necessarily impact the code generation but they are here to document the code. Also, knowing that Protobuf has reflection, we can use them in our code. This means that we could have a tool checking for deprecated messages, fields, ... and give us warnings when we use them in our code base.</p> <p>How do we define one, though? Well, it turns out that this is pretty simple. We need to use the <code>extend</code> concept and define which kind of option we want to extend. Let's first take a look at what kind of options we have:</p> <ul class="code-tab-container 4e6d9128-ddda-41bc-8678-6837f0aa999b"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '4e6d9128-ddda-41bc-8678-6837f0aa999b', 0)">descriptor.proto</a></li></ul><ul class="code-tab-switcher 4e6d9128-ddda-41bc-8678-6837f0aa999b"><li class="code_switcher_container_parent active-tab code_switcher_proto 9ab99140-d0dd-4337-a89e-514dde303b7c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">FileOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>

  <span class="c1">// Clients can define custom options in extensions of this message. See above.</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">MessageOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">FieldOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">OneofOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">EnumOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">EnumValueOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">ServiceOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">message</span> <span class="nc">MethodOptions</span> <span class="p">{</span>
  <span class="c1">//...</span>
  <span class="k">extensions</span> <span class="mi">1000</span> <span class="k">to</span> <span class="k">max</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>That's actually every concept that we have in Protobuf! So let's define a simple option now. We will define an option called <code>hello</code> of type string. And for making this related to the problem that I'm trying to solve, let's define that option in <code>MethodOptions</code> which represents the options for RPC endpoints.</p> <p>So we will extend <code>MethodOptions</code>:</p> <ul class="code-tab-container b5da795a-b2ce-4b2b-b921-4245570156bd"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'b5da795a-b2ce-4b2b-b921-4245570156bd', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher b5da795a-b2ce-4b2b-b921-4245570156bd"><li class="code_switcher_container_parent active-tab code_switcher_proto 324f734f-e0f0-4e4f-bb4e-01f82ca124da"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"google/protobuf/descriptor.proto"</span><span class="p">;</span>

<span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span> <span class="p">}</span>
</code></pre></div></div> </li></ul> <p>And then inside this <code>extend</code> we can just write the hello field:</p> <ul class="code-tab-container c32cf882-524b-466c-99bf-f450f239d332"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'c32cf882-524b-466c-99bf-f450f239d332', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher c32cf882-524b-466c-99bf-f450f239d332"><li class="code_switcher_container_parent active-tab code_switcher_proto 29a2bfbb-b76c-4e26-b79b-a7fdf9a203b5"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">hello</span> <span class="o">=</span> <span class="err">??</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>But what is the tag that we need to use? Well, if you noticed in the <code>descriptor.proto</code> we have an extension range. These are the numbers we can use for tag. For now, we will use 1000, however, be aware that some of these tags are reserved by some already defined options. <strong>So if you were to use a tool that defines options that have the same tag number, there would be conflicts</strong>.</p> <p>We now have:</p> <ul class="code-tab-container 34099478-5fcc-4a69-8acf-6df5e0d01e8b"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '34099478-5fcc-4a69-8acf-6df5e0d01e8b', 0)">hello.proto</a></li></ul><ul class="code-tab-switcher 34099478-5fcc-4a69-8acf-6df5e0d01e8b"><li class="code_switcher_container_parent active-tab code_switcher_proto 7e3564b2-58f8-42cd-a9cc-ffbffd70e66b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">hello</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="reflection">Reflection</h2> <p>Let us now use that option and read the value in code.</p> <p>To use it, this is pretty simple, we just need to import the file in which we wrote the <code>extend</code> and make sure we use the option on an RPC endpoint.</p> <ul class="code-tab-container 67509fa2-4ec5-4e23-948a-2399a6826cf1"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '67509fa2-4ec5-4e23-948a-2399a6826cf1', 0)">world.proto</a></li></ul><ul class="code-tab-switcher 67509fa2-4ec5-4e23-948a-2399a6826cf1"><li class="code_switcher_container_parent active-tab code_switcher_proto e122b89d-8002-4e2b-b624-ecf527d32284"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"hello.proto"</span><span class="p">;</span>

<span class="c1">//...</span>

<span class="kd">service</span> <span class="n">HelloWorldService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">HelloWorld</span> <span class="p">(</span><span class="n">HelloWorldRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">HelloWorldResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">option</span> <span class="p">(</span><span class="n">hello</span><span class="p">)</span> <span class="o">=</span> <span class="s">"world"</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>We can generate the proto files out of world.proto and hello.proto. And after that we can take a bottom-up approach to read this value through reflection. By bottom up, I mean that we are going to first see how to read the value of a <code>MethodOptions</code>, then we will go to getting a <code>MethodDescriptor</code> out of a <code>ServiceDescriptor</code>, and finally getting a <code>ServiceDescriptor</code> out a <code>FileDescriptor</code>.</p> <h3 id="getting-an-option-value">Getting an Option Value</h3> <p>The first thing we are going to deal with is <code>MethodOptions</code>. These represent the options set on an RPC endpoint. In most of the implementations, we can check the existence of an option so this is as simple as &quot;check if there is the option with a given id on this method, if yes return the value, otherwise return null&quot;.</p> <ul class="code-tab-container 9d188342-8d81-4d90-b592-0dd03116bb75"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '9d188342-8d81-4d90-b592-0dd03116bb75', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '9d188342-8d81-4d90-b592-0dd03116bb75', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '9d188342-8d81-4d90-b592-0dd03116bb75', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '9d188342-8d81-4d90-b592-0dd03116bb75', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '9d188342-8d81-4d90-b592-0dd03116bb75', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 9d188342-8d81-4d90-b592-0dd03116bb75"><li class="code_switcher_container_parent active-tab code_switcher_go 6632b5da-aaa0-41f9-97e7-729aaea169ce"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
  <span class="s">"google.golang.org/protobuf/proto"</span>
  <span class="s">"google.golang.org/protobuf/reflect/protoreflect"</span>
  <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">getOptionValue</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span> <span class="c">// T is not covering all types...</span>
  <span class="n">opts</span> <span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">MethodOptions</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="n">value</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">proto</span><span class="o">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">ok</span> <span class="p">{</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">value</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 810ec051-f5fa-428a-9c3f-8e582f2d3a7a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;optional&gt;</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="p">;</span>

<span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">OPT_T</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">OPT_T</span><span class="o">&gt;</span> <span class="n">get_option_value</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">MethodOptions</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">,</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">id</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">opts</span><span class="p">.</span><span class="n">HasExtension</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">?</span>
    <span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="p">(</span><span class="n">opts</span><span class="p">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">id</span><span class="p">))</span> <span class="o">:</span>
    <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java ea3ec2ee-fc87-4ec2-8d67-c74646184026"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.DescriptorProtos</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.google.protobuf.GeneratedMessage</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Optional</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getOptionValue</span><span class="o">(</span>
  <span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span> <span class="n">opts</span><span class="o">,</span>
  <span class="nc">GeneratedMessage</span><span class="o">.</span><span class="na">GeneratedExtension</span><span class="o">&lt;</span><span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">id</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">return</span> <span class="n">opts</span><span class="o">.</span><span class="na">hasExtension</span><span class="o">(</span><span class="n">id</span><span class="o">)</span> <span class="o">?</span>
    <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">((</span><span class="no">T</span><span class="o">)</span><span class="n">opts</span><span class="o">.</span><span class="na">getExtension</span><span class="o">(</span><span class="n">id</span><span class="o">))</span> <span class="o">:</span>
    <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_python e33a4651-4db0-4473-9679-9d988a31c1e8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_option_value</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">opts</span><span class="p">.</span><span class="n">ListFields</span><span class="p">():</span>
    <span class="p">(</span><span class="n">desc</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="o">=</span> <span class="n">field</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s">""</span> <span class="ow">and</span> <span class="n">desc</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="nb">id</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp 0752702e-64db-4b5b-b817-d76be1702360"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">pb</span> <span class="p">=</span> <span class="k">global</span><span class="p">::</span><span class="n">Google</span><span class="p">.</span><span class="n">Protobuf</span><span class="p">;</span>

<span class="k">static</span> <span class="k">private</span> <span class="n">T</span> <span class="n">GetOptionValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="k">this</span> <span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span> <span class="n">md</span><span class="p">,</span> <span class="c1">// MethodDescriptor and not MethodOptions as promised (sorry!)</span>
  <span class="n">pb</span><span class="p">::</span><span class="n">Extension</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodOptions</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">id</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="n">md</span><span class="p">.</span><span class="nf">GetOptions</span><span class="p">().</span><span class="nf">GetExtension</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</code></pre></div></div> </li></ul> <h3 id="getting-a-method">Getting a Method</h3> <p>The next step is to get a <code>MethodDescriptor</code> out of a <code>ServiceDescriptor</code>. This is done so that we can later call the GetOptionValue function on the options of that method (if any). We will basically loop over all the methods of a service and check for a predicate on each. If the predicate returns true, we &quot;select&quot; that method.</p> <ul class="code-tab-container d30abdcc-47a1-4a09-a812-e124e47c391e"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd30abdcc-47a1-4a09-a812-e124e47c391e', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', 'd30abdcc-47a1-4a09-a812-e124e47c391e', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', 'd30abdcc-47a1-4a09-a812-e124e47c391e', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', 'd30abdcc-47a1-4a09-a812-e124e47c391e', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', 'd30abdcc-47a1-4a09-a812-e124e47c391e', 4)">main.cs</a></li></ul><ul class="code-tab-switcher d30abdcc-47a1-4a09-a812-e124e47c391e"><li class="code_switcher_container_parent active-tab code_switcher_go bc63c1b0-f10c-4ac2-80cc-718ce356c227"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">getServiceMethod</span><span class="p">(</span>
  <span class="n">sd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ServiceDescriptor</span><span class="p">,</span>
  <span class="n">fn</span> <span class="k">func</span><span class="p">(</span><span class="n">md</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span><span class="p">)</span> <span class="kt">bool</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">.</span><span class="n">Methods</span><span class="p">()</span><span class="o">.</span><span class="n">Len</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="n">md</span> <span class="o">:=</span> <span class="n">sd</span><span class="o">.</span><span class="n">Methods</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fn</span><span class="p">(</span><span class="n">md</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="o">&amp;</span><span class="n">md</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp d2dd015e-846b-4020-b242-7982ac7d58ac"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;functional&gt;</span><span class="cp">
</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*&gt;</span> <span class="n">get_service_method</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">ServiceDescriptor</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">(</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*</span><span class="p">)</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">predicate</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">method_count</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">md</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">method</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">predicate</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">md</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java 8ad84fc4-0456-4f39-bd31-2e938a226444"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">com.google.protobuf.Descriptors</span><span class="o">;</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span><span class="o">&gt;</span> <span class="nf">getServiceMethod</span><span class="o">(</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">ServiceDescriptor</span> <span class="n">sd</span><span class="o">,</span>
  <span class="nc">Function</span><span class="o">&lt;</span><span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span><span class="o">,</span> <span class="nc">Boolean</span><span class="o">&gt;</span> <span class="n">predicate</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sd</span><span class="o">.</span><span class="na">getMethods</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Descriptors</span><span class="o">.</span><span class="na">MethodDescriptor</span> <span class="n">method</span> <span class="o">=</span> <span class="n">sd</span><span class="o">.</span><span class="na">getMethods</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">predicate</span><span class="o">.</span><span class="na">apply</span><span class="o">(</span><span class="n">method</span><span class="o">))</span>
      <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="n">method</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_python ff6f57cd-936d-4124-bd89-25ca78126bb0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">predicate</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">method_name</span> <span class="ow">in</span> <span class="n">sd</span><span class="p">.</span><span class="n">methods_by_name</span><span class="p">:</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">sd</span><span class="p">.</span><span class="n">methods_by_name</span><span class="p">[</span><span class="n">method_name</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">predicate</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">md</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp a347ea08-dc7c-4f0e-ad36-42fba49fae8b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">private</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span><span class="p">&gt;</span> <span class="nf">GetServiceMethod</span><span class="p">(</span>
  <span class="k">this</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">ServiceDescriptor</span><span class="p">&gt;</span> <span class="n">services</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodDescriptor</span><span class="p">,</span> <span class="kt">bool</span><span class="p">&gt;</span> <span class="n">predicate</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="k">from</span> <span class="n">svc</span> <span class="k">in</span> <span class="n">services</span>
     <span class="k">from</span> <span class="n">method</span> <span class="k">in</span> <span class="n">svc</span><span class="p">.</span><span class="n">Methods</span>
     <span class="k">where</span> <span class="nf">predicate</span><span class="p">(</span><span class="n">method</span><span class="p">)</span>
     <span class="k">select</span> <span class="n">method</span><span class="p">;</span>
</code></pre></div></div> </li></ul> <h3 id="putting-everything-together">Putting Everything Together</h3> <p>And finally the idea is to call <code>GetServiceMethod</code> on all the <code>ServiceDescriptor</code>s and with the predicate is true we can call <code>GetOptionValue</code> on the method selected.</p> <ul class="code-tab-container 8cdd2964-9fad-47f7-ba13-64a3c694bf8f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8cdd2964-9fad-47f7-ba13-64a3c694bf8f', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '8cdd2964-9fad-47f7-ba13-64a3c694bf8f', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '8cdd2964-9fad-47f7-ba13-64a3c694bf8f', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '8cdd2964-9fad-47f7-ba13-64a3c694bf8f', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '8cdd2964-9fad-47f7-ba13-64a3c694bf8f', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 8cdd2964-9fad-47f7-ba13-64a3c694bf8f"><li class="code_switcher_container_parent active-tab code_switcher_go 9aa129a7-4025-4df2-9b81-954ce6fd05af"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">getMethodOptionValue</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span>
  <span class="n">sd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ServiceDescriptor</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">value</span> <span class="o">*</span><span class="n">T</span> <span class="o">=</span> <span class="no">nil</span>

  <span class="n">getServiceMethod</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">func</span><span class="p">(</span><span class="n">md</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">MethodDescriptor</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="n">opts</span><span class="p">,</span> <span class="n">ok</span> <span class="o">:=</span> <span class="n">md</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">MethodOptions</span><span class="p">)</span>

    <span class="k">if</span> <span class="o">!</span><span class="n">ok</span> <span class="p">{</span>
      <span class="k">return</span> <span class="no">false</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tmp</span> <span class="o">:=</span> <span class="n">getOptionValue</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="n">tmp</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span>
      <span class="k">return</span> <span class="no">true</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="no">false</span>
  <span class="p">})</span>

  <span class="k">return</span> <span class="n">value</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">getMethodExtension</span><span class="p">[</span><span class="n">T</span> <span class="kt">string</span> <span class="o">|</span> <span class="kt">int</span> <span class="o">|</span> <span class="kt">bool</span><span class="p">](</span>
  <span class="n">fd</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">FileDescriptor</span><span class="p">,</span>
  <span class="n">id</span> <span class="n">protoreflect</span><span class="o">.</span><span class="n">ExtensionType</span><span class="p">,</span>
<span class="p">)</span> <span class="o">*</span><span class="n">T</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">:=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd</span><span class="o">.</span><span class="n">Services</span><span class="p">()</span><span class="o">.</span><span class="n">Len</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span> <span class="p">{</span>
    <span class="n">sd</span> <span class="o">:=</span> <span class="n">fd</span><span class="o">.</span><span class="n">Services</span><span class="p">()</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">:=</span> <span class="n">getMethodOptionValue</span><span class="p">[</span><span class="n">T</span><span class="p">](</span><span class="n">sd</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="n">value</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 2ae817b4-b41e-4a67-b844-323457f40aaa"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="nc">U</span><span class="p">&gt;</span>
<span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">get_method_option_value</span><span class="p">(</span>
  <span class="k">const</span> <span class="n">ServiceDescriptor</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="c1">// in C++ we can access the ServiceDescriptor directly</span>
  <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">id</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>

  <span class="n">std</span><span class="o">::</span><span class="n">optional</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">value</span><span class="p">;</span>

  <span class="n">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="p">[</span><span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">](</span><span class="k">const</span> <span class="n">MethodDescriptor</span> <span class="o">*</span><span class="n">md</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">auto</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">auto</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">get_option_value</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">(</span><span class="n">opts</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">value</span> <span class="o">!=</span> <span class="n">std</span><span class="o">::</span><span class="n">nullopt</span><span class="p">;</span>
  <span class="p">});</span>

  <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java 1b1ef9c7-53a3-4cc5-b05e-3b0365fcc47c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">private</span> <span class="kd">static</span> <span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="nf">getMethodExtension</span><span class="o">(</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span> <span class="n">fd</span><span class="o">,</span>
  <span class="nc">GeneratedMessage</span><span class="o">.</span><span class="na">GeneratedExtension</span><span class="o">&lt;</span><span class="nc">DescriptorProtos</span><span class="o">.</span><span class="na">MethodOptions</span><span class="o">,</span> <span class="o">?&gt;</span> <span class="n">id</span>
<span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fd</span><span class="o">.</span><span class="na">getServices</span><span class="o">().</span><span class="na">size</span><span class="o">();</span> <span class="o">++</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">Descriptors</span><span class="o">.</span><span class="na">ServiceDescriptor</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">fd</span><span class="o">.</span><span class="na">getServices</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
    <span class="nc">Optional</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="n">world</span> <span class="o">=</span> <span class="n">getMethodOptionValue</span><span class="o">(</span><span class="n">sd</span><span class="o">,</span> <span class="nc">Hello</span><span class="o">.</span><span class="na">hello</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">world</span><span class="o">.</span><span class="na">isPresent</span><span class="o">())</span>
      <span class="k">return</span> <span class="n">world</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="k">return</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">();</span>
<span class="o">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_python 5072d817-55fc-4054-91f4-56dd4b0173a4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">get_method_option_value</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="n">md</span> <span class="o">=</span> <span class="n">get_service_method</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">md</span><span class="p">:</span> <span class="n">get_option_value</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">GetOptions</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">get_option_value</span><span class="p">(</span><span class="n">md</span><span class="p">.</span><span class="n">GetOptions</span><span class="p">(),</span> <span class="nb">id</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_method_extension</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">svc_name</span> <span class="ow">in</span> <span class="n">fd</span><span class="p">.</span><span class="n">services_by_name</span><span class="p">:</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">fd</span><span class="p">.</span><span class="n">services_by_name</span><span class="p">[</span><span class="n">svc_name</span><span class="p">]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">get_method_option_value</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp 588b7102-3814-4cf4-8d8c-4ae8b2a14307"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">private</span> <span class="n">T</span> <span class="n">GetMethodOptionValue</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="k">this</span> <span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">FileDescriptor</span> <span class="n">fd</span><span class="p">,</span>
  <span class="n">pb</span><span class="p">::</span><span class="n">Extension</span><span class="p">&lt;</span><span class="n">pb</span><span class="p">.</span><span class="n">Reflection</span><span class="p">.</span><span class="n">MethodOptions</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">id</span>
<span class="p">)</span> <span class="p">=&gt;</span> <span class="n">fd</span><span class="p">.</span><span class="n">Services</span>
       <span class="p">.</span><span class="nf">GetServiceMethod</span><span class="p">(</span><span class="n">md</span> <span class="p">=&gt;</span> <span class="n">md</span><span class="p">.</span><span class="nf">GetOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
       <span class="p">.</span><span class="nf">FirstOrDefault</span><span class="p">()</span>
       <span class="p">.</span><span class="nf">GetOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
</code></pre></div></div> </li></ul> <h3 id="usage">Usage</h3> <p>Let's see how to use that in our main function.</p> <ul class="code-tab-container 8b316adf-86b1-4811-a008-fe0767732e7f"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8b316adf-86b1-4811-a008-fe0767732e7f', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', '8b316adf-86b1-4811-a008-fe0767732e7f', 1)">main.cc</a></li><li class=" code_switcher_java"><a onclick="selectTab('code_switcher_java', '8b316adf-86b1-4811-a008-fe0767732e7f', 2)">main.java</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '8b316adf-86b1-4811-a008-fe0767732e7f', 3)">main.py</a></li><li class=" code_switcher_csharp"><a onclick="selectTab('code_switcher_csharp', '8b316adf-86b1-4811-a008-fe0767732e7f', 4)">main.cs</a></li></ul><ul class="code-tab-switcher 8b316adf-86b1-4811-a008-fe0767732e7f"><li class="code_switcher_container_parent active-tab code_switcher_go 684b1675-7729-4859-bcaf-e971c0c93512"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"fmt"</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c">// pb.File_proto_world_proto is the generated FileDescriptor</span>
  <span class="c">// and pb.E_Hello the generated custom option</span>
  <span class="n">world</span> <span class="o">:=</span> <span class="n">getMethodExtension</span><span class="p">[</span><span class="kt">string</span><span class="p">](</span><span class="n">pb</span><span class="o">.</span><span class="n">File_proto_world_proto</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">E_Hello</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">world</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="o">*</span><span class="n">world</span><span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 7a192601-85c7-4299-bcf0-08d633c37c3d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// HelloWorldService is the generated service</span>
  <span class="k">auto</span> <span class="n">sd</span> <span class="o">=</span> <span class="n">HelloWorldService</span><span class="o">::</span><span class="n">descriptor</span><span class="p">();</span>
  <span class="c1">// hello is the generated custom option</span>
  <span class="k">auto</span> <span class="n">world</span> <span class="o">=</span> <span class="n">get_method_option_value</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">hello</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">world</span><span class="p">)</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">world</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_java cbe3223c-3bc3-41f1-acfb-a46840202f7c"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
  <span class="c1">// World is the FileDescriptor for the file world.proto</span>
  <span class="nc">Descriptors</span><span class="o">.</span><span class="na">FileDescriptor</span> <span class="n">fd</span> <span class="o">=</span> <span class="nc">World</span><span class="o">.</span><span class="na">getDescriptor</span><span class="o">();</span>
  <span class="c1">// Hello.hello is the generated custom option</span>
  <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">String</span><span class="o">&gt;</span> <span class="n">world</span> <span class="o">=</span> <span class="n">getMethodExtension</span><span class="o">(</span><span class="n">fd</span><span class="o">,</span> <span class="nc">Hello</span><span class="o">.</span><span class="na">hello</span><span class="o">);</span>

  <span class="n">world</span><span class="o">.</span><span class="na">ifPresent</span><span class="o">(</span><span class="n">w</span> <span class="o">-&gt;</span> <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">w</span><span class="o">));</span>
<span class="o">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_python 891fc860-49a2-4979-9e4d-1747a1a34e83"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">proto.world_pb2</span> <span class="kn">import</span> <span class="n">DESCRIPTOR</span> <span class="c1"># FileDescriptor for world.proto
</span>
<span class="k">print</span><span class="p">(</span><span class="n">get_method_extension</span><span class="p">(</span><span class="n">DESCRIPTOR</span><span class="p">,</span> <span class="s">"hello"</span><span class="p">))</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_csharp c8e36400-bda3-4ed1-8e6e-95b9509ae38f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">static</span> <span class="k">public</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="n">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">// HelloExtensions.Hello is the generated custom option</span>
  <span class="kt">var</span> <span class="n">id</span> <span class="p">=</span> <span class="n">HelloExtensions</span><span class="p">.</span><span class="n">Hello</span><span class="p">;</span>
  <span class="c1">// WorldReflection.Descriptor is the FileDescriptor for the file world.proto</span>
  <span class="kt">string</span> <span class="n">world</span> <span class="p">=</span> <span class="n">WorldReflection</span><span class="p">.</span><span class="n">Descriptor</span><span class="p">.</span><span class="nf">GetMethodOptionValue</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">world</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
    <span class="n">System</span><span class="p">.</span><span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">world</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="back-to-the-problem">Back to the Problem</h2> <p>Now, as I mentioned I was trying to detect which routes need authentication with the help of such a custom option. It is not that hard to imagine the code we saw in the previous section work for an extension like the following:</p> <div class="code_switcher_container_parent 49054411-1e4d-45f4-9dae-a6df11c76db2"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.MethodOptions</span> <span class="p">{</span>
  <span class="kt">bool</span> <span class="na">is_authenticated</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>Then, we can use it like so:</p> <div class="code_switcher_container_parent 23945910-5ee0-414a-a18c-2fa55acf5812"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">service</span> <span class="n">CheckoutService</span> <span class="p">{</span>
  <span class="k">rpc</span> <span class="n">Checkout</span> <span class="p">(</span><span class="n">CheckoutRequest</span><span class="p">)</span> <span class="k">returns</span> <span class="p">(</span><span class="n">CheckoutResponse</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">option</span> <span class="p">(</span><span class="n">is_authenticated</span><span class="p">)</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div> </div> <p>And with that we can get the value from the code we wrote earlier. We just need to be requesting the methods with Option having the id &quot;is_authenticated&quot; and make sure that we are asking for a boolean instead of a string.</p> <h2 id="conclusion">Conclusion</h2> <p>While this is a little bit hard to work directly with the Protobuf library, automating simple tasks like checking which routes need authentication save a lot of effort. I hope that you will find this content interesting and that you will share some of the extensions that you wrote.</p> <p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p> </div> <div class="date"> Written on April 17, 2023 </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <script type="text/javascript" src="/js/codetabs.js"></script> </body> </html>