<!DOCTYPE html> <html> <head> <title>Protein: Lexer (Part 1) – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="As promised in a LinkedIn Poll, we are going to develop Parser for proto files which will create an AST that is serializable in Protobuf itself. Obviously, this is going to be a series of articles because we need to write quite a lot of parsing code. However, I believe that this is worth doing since we are going to see another use of Protobuf outside of gRPC. " /> <meta property="og:description" content="As promised in a LinkedIn Poll, we are going to develop Parser for proto files which will create an AST that is serializable in Protobuf itself. Obviously, this is going to be a series of articles because we need to write quite a lot of parsing code. However, I believe that this is worth doing since we are going to see another use of Protobuf outside of gRPC. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="Protein: Lexer (Part 1)" /> <meta property="twitter:title" content="Protein: Lexer (Part 1)" /> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>Protein: Lexer (Part 1)</h1> <div class="entry"> <p>As promised in a <a href="https://www.linkedin.com/posts/clement-jean_protobuf-activity-7024951031868391424-I26b?utm_source=share&amp;utm_medium=member_desktop">LinkedIn Poll</a>, we are going to develop Parser for proto files which will create an AST that is serializable in Protobuf itself. Obviously, this is going to be a series of articles because we need to write quite a lot of parsing code. However, I believe that this is worth doing since we are going to see another use of Protobuf outside of gRPC.</p> <p>In this article, we are going to present the project and start writing a Lexer. This is not the most amusing part. However, this will be the foundations for our part 2 in which we will start more complex tokenizing of the input.</p> <h2 id="the-project">The Project</h2> <p>The project is called <a href="https://github.com/Clement-Jean/protein">protein</a>. In itself, this is intended to be a project showing how to parse proto files to do tools for Protobuf. But the end goal is to provide an easy-to-use and efficient linter.</p> <p>The project is mostly divided into three components:</p> <ul> <li>The Lexer: it tokenizes the input and provides metadata about these tokens.</li> <li>The Parser: it verifies the validity of our tokens and builds an AST.</li> <li>The Linter: it analyzes the AST and provide feedback to users.</li> </ul> <blockquote> <p>Note: There might be more components later but these are the major ones.</p> </blockquote> <p>One thing worth mentioning is that the AST will be built with objects generated by Protobuf. This means that we will have an AST that we can serialize and maybe even cache for multiple runs of our Linter.</p> <p>Finally, as mentioned, this project shows how to build tools for Protobuf. Thus I hope the readers will be inspired to create their own tools and/or contribute to this project. I'm going to document all the code and explain all the logic so that you can follow along and even participate in the development.</p> <h2 id="the-lexer">The Lexer</h2> <p>The <code>protein</code> Lexer has been inspired by one of the great pieces of code out there: The <a href="https://cs.opensource.google/go/go/+/master:src/text/template/parse/lex.go">template library lex.go</a> in the Go standard library. I was introduced to this code by an <a href="https://www.youtube.com/watch?v=HxaD_trXwRE">amazing talk</a> given by <a href="https://en.wikipedia.org/wiki/Rob_Pike">Rob Pike</a>. So I want to thank all the contributors and Rob for the amazing talk. <strong>Thank you guys!</strong></p> <p>The essence of the Lexer is a <a href="https://en.wikipedia.org/wiki/Finite-state_machine">Finite-state Machine</a> (FSM). This basically means that we are going to go from state to state by applying functions to do the transition. For example, let's say that we have the following line:</p> <div class="code_switcher_container_parent 0c356e04-26c7-4f0d-ad8c-fb449cc9b36f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>
</code></pre></div></div> </div> <p>We will go through the following states:</p> <div class="code_switcher_container_parent 47b13464-1b91-4bb1-badd-ba10bcff4056"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div><pre><code>initial state -&gt; Identifier(&quot;syntax&quot;) -&gt; Equal -&gt; Str(&quot;proto3&quot;) -&gt; EOF
</code></pre></div> <p>And each state will know how to parse their own value (e.g. &quot;proto3&quot; for the Str state).</p> <p>Finally, the Lexer will be used by calling the <code>NextToken</code> function. This function, as its name suggests, will return the next token in the input. This is basically calling all the parsing functions from each state.</p> <h2 id="lets-start-simple">Let's Start Simple</h2> <p>Let's fullfil the first requirement. The user code, in our case the Parser, will interact with the Lexer by repeatedly calling the <code>NextToken</code> function. So let's define an interface because that will be handy later on in this series to test the Parser on a fake Lexer.</p> <ul class="code-tab-container 4801b54f-8d6b-4254-9a0c-8d697b251e45"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '4801b54f-8d6b-4254-9a0c-8d697b251e45', 0)">lexer/lexer.go</a></li></ul><ul class="code-tab-switcher 4801b54f-8d6b-4254-9a0c-8d697b251e45"><li class="code_switcher_container_parent active-tab code_switcher_go e1139fb9-c0e4-4231-b50f-bd9495e5b200"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="c">// Lexer is protein's tokenizer</span>
<span class="k">type</span> <span class="n">Lexer</span> <span class="k">interface</span> <span class="p">{</span>
  <span class="c">// NextToken returns the following token in the input source.</span>
  <span class="n">NextToken</span><span class="p">()</span> <span class="n">Token</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>For now, &quot;input source&quot; is still a little vague but we are going to deal with that later in the implementation.</p> <p>After that, we do not have the definition of a <code>Token</code>. In our application, a token is a collection of few information about some text in the input:</p> <ul> <li>A type: a simple way to identify tokens (e.g., Identifier, Str, ...)</li> <li>A literal: the value of a token as a string</li> <li>A position: the position of this text in the input</li> </ul> <p>Let's define all that. Let's start with position. We want to know the offset relative to the beginning of the file and we want to know the line and column at which the token shows up. These info are for making the error messages clearer to the user (at least we'll try our best!). Instead of having something like:</p> <p><code>unterminated string</code></p> <p>we want to have:</p> <p><code>file.proto 1:10 unterminated string: &quot;this is unterminated</code></p> <p>Where, in this example 1 is the line and 10 is the column.</p> <p>So a position is pretty simple.</p> <ul class="code-tab-container 75c0d8ef-d939-4cb6-994c-b194e6bbc756"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '75c0d8ef-d939-4cb6-994c-b194e6bbc756', 0)">lexer/position.go</a></li></ul><ul class="code-tab-switcher 75c0d8ef-d939-4cb6-994c-b194e6bbc756"><li class="code_switcher_container_parent active-tab code_switcher_go 95bffb28-af38-4a16-bf48-06885513501b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="c">// Position is a position in the input</span>
<span class="k">type</span> <span class="n">Position</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="c">// Offset is the position relative to the beginning of the file (starts at 0)</span>
  <span class="n">Offset</span> <span class="kt">int</span>

  <span class="c">// Line is the file line (starts at 1)</span>
  <span class="n">Line</span> <span class="kt">int</span>

  <span class="c">// Column is the offset relative to the beginning of the line (starts at 0)</span>
  <span class="n">Column</span> <span class="kt">int</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>And with that we can now define our Token.</p> <ul class="code-tab-container 471c6ca7-b7de-467e-b085-0b03ba4d394d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '471c6ca7-b7de-467e-b085-0b03ba4d394d', 0)">lexer/token.go</a></li></ul><ul class="code-tab-switcher 471c6ca7-b7de-467e-b085-0b03ba4d394d"><li class="code_switcher_container_parent active-tab code_switcher_go a9a47c6a-b41c-4ba8-95eb-efce1b7fe772"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="c">// TokenType is an alias type which tells of which kind the token is</span>
<span class="k">type</span> <span class="n">TokenType</span> <span class="kt">int</span>

<span class="c">// Token is a piece of the input</span>
<span class="k">type</span> <span class="n">Token</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">Type</span>    <span class="n">TokenType</span>
  <span class="n">Literal</span> <span class="kt">string</span>
  <span class="n">Position</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="token-types">Token Types</h2> <p>Right now, we simply have the <code>TokenType</code> type alias but do not define any value. We are going to define an enum for all the possible values that the <code>Token.Type</code> property can have.</p> <ul class="code-tab-container 8a40598f-35b4-4868-adc9-19ceba95ac6d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '8a40598f-35b4-4868-adc9-19ceba95ac6d', 0)">lexer/token.go</a></li></ul><ul class="code-tab-switcher 8a40598f-35b4-4868-adc9-19ceba95ac6d"><li class="code_switcher_container_parent active-tab code_switcher_go 86560b08-8ceb-468b-907a-38ffab81c714"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="c">// These are all the token types</span>
<span class="k">const</span> <span class="p">(</span>
  <span class="n">EOF</span>          <span class="n">TokenType</span> <span class="o">=</span> <span class="no">iota</span> <span class="o">-</span> <span class="m">1</span> <span class="c">// End Of File</span>
  <span class="n">TokenIllegal</span>                      <span class="c">// Illegal token</span>
  <span class="n">TokenError</span>                        <span class="c">// Error</span>
  <span class="n">TokenSpace</span>                        <span class="c">// Space (whitespace, '\n', '\r', '\t')</span>
  <span class="n">TokenComment</span>                      <span class="c">// Comment (single line or multiline)</span>

  <span class="n">TokenIdentifier</span> <span class="c">// Identifier</span>
  <span class="n">TokenInt</span>        <span class="c">// Integer</span>
  <span class="n">TokenFloat</span>      <span class="c">// Float</span>
  <span class="n">TokenStr</span>        <span class="c">// String ('...' or "...")</span>

  <span class="n">TokenUnderscore</span>  <span class="c">// _</span>
  <span class="n">TokenEqual</span>       <span class="c">// =</span>
  <span class="n">TokenColon</span>       <span class="c">// ,</span>
  <span class="n">TokenSemicolon</span>   <span class="c">// ;</span>
  <span class="n">TokenDot</span>         <span class="c">// .</span>
  <span class="n">TokenLeftBrace</span>   <span class="c">// {</span>
  <span class="n">TokenRightBrace</span>  <span class="c">// }</span>
  <span class="n">TokenLeftSquare</span>  <span class="c">// [</span>
  <span class="n">TokenRightSquare</span> <span class="c">// ]</span>
  <span class="n">TokenLeftParen</span>   <span class="c">// (</span>
  <span class="n">TokenRightParen</span>  <span class="c">// )</span>
  <span class="n">TokenLeftAngle</span>   <span class="c">// &lt;</span>
  <span class="n">TokenRightAngle</span>  <span class="c">// &gt;</span>
<span class="p">)</span>
</code></pre></div></div> </li></ul> <p>There are few things to notice here. The first one is the use of <code>iota</code>. If you are not familiar with this, this is a keyword that lets us define multiple constant with consecutive values. Here, we use <code>iota - 1</code> because, by default, <code>iota</code> starts counting at zero but here we want to start at -1. The second thing to notice is that some of these tokens have constant values (e.g., <code>TokenEqual</code> == '=') and others don't have one (e.g., Identifier value will be evaluated at runtime).</p> <p>For debugging and testing, we will need a way to display the <code>TokenType</code> as a string. In Go, we can simply do that by defining a function called <code>String()</code> on the <code>TokenType</code> type. And to define the value we are going to have a constant array defining values based on the type (remember <code>TokenType</code> is just an int).</p> <ul class="code-tab-container de5fff39-abd8-4c42-bc5d-d4bfaf2583c3"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'de5fff39-abd8-4c42-bc5d-d4bfaf2583c3', 0)">lexer/token.go</a></li></ul><ul class="code-tab-switcher de5fff39-abd8-4c42-bc5d-d4bfaf2583c3"><li class="code_switcher_container_parent active-tab code_switcher_go e9c16ed4-dd27-42a0-a8cd-9f7db5434fe0"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>
<span class="k">var</span> <span class="n">tokenTypeStr</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span><span class="kt">string</span><span class="p">{</span>
  <span class="s">"EOF"</span><span class="p">,</span>
  <span class="s">"Illegal"</span><span class="p">,</span>
  <span class="s">"Error"</span><span class="p">,</span>
  <span class="s">"Space"</span><span class="p">,</span>
  <span class="s">"Comment"</span><span class="p">,</span>
  <span class="s">"Identifier"</span><span class="p">,</span>
  <span class="s">"Integer"</span><span class="p">,</span>
  <span class="s">"Float"</span><span class="p">,</span>
  <span class="s">"String"</span><span class="p">,</span>
  <span class="s">"_"</span><span class="p">,</span>
  <span class="s">"="</span><span class="p">,</span>
  <span class="s">","</span><span class="p">,</span>
  <span class="s">";"</span><span class="p">,</span>
  <span class="s">"."</span><span class="p">,</span>
  <span class="s">"{"</span><span class="p">,</span> <span class="s">"}"</span><span class="p">,</span>
  <span class="s">"["</span><span class="p">,</span> <span class="s">"]"</span><span class="p">,</span>
  <span class="s">"("</span><span class="p">,</span> <span class="s">")"</span><span class="p">,</span>
  <span class="s">"&lt;"</span><span class="p">,</span> <span class="s">"&gt;"</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">t</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">String</span><span class="p">()</span> <span class="kt">string</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">tokenTypeStr</span><span class="p">[</span><span class="n">t</span><span class="o">+</span><span class="m">1</span><span class="p">]</span> <span class="c">// +1 because we start at iota - 1</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="implementing-a-basic-lexer">Implementing a Basic Lexer</h2> <p>With all of the previous boilerplate, we can now start our implementation. Don't get too excited though, we are simply going to define an &quot;empty shell&quot; Lexer in order to be able to write a failing test (see <a href="https://stackoverflow.com/questions/276813/what-is-red-green-testing">Red/Green testing</a>).</p> <p>As we know, we need to implement the <code>NextToken</code> function.</p> <ul class="code-tab-container 5496daee-c86f-4925-a2a6-fe0ab30162cc"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '5496daee-c86f-4925-a2a6-fe0ab30162cc', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 5496daee-c86f-4925-a2a6-fe0ab30162cc"><li class="code_switcher_container_parent active-tab code_switcher_go e0ca7063-95ca-4670-a9d1-0edb22008a85"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">lexer</span>

<span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span><span class="p">{}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">NextToken</span><span class="p">()</span> <span class="n">Token</span> <span class="p">{</span>
  <span class="k">return</span> <span class="n">Token</span><span class="p">{</span>
    <span class="n">Type</span><span class="o">:</span> <span class="n">TokenIllegal</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Furthermore, we need a simple way to instantiate our Lexer. To do so, we are going to create a function called <code>New</code> with a return type being <code>Lexer</code> and will return an instance of <code>Impl</code>.</p> <ul class="code-tab-container 968068e8-9c09-4ff1-a258-c4e1d3c0f949"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '968068e8-9c09-4ff1-a258-c4e1d3c0f949', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 968068e8-9c09-4ff1-a258-c4e1d3c0f949"><li class="code_switcher_container_parent active-tab code_switcher_go 88c58d77-bebc-43a9-a67a-75dd006db9c8"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="c">// New creates a new instance of the Lexer</span>
<span class="k">func</span> <span class="n">New</span><span class="p">()</span> <span class="n">Lexer</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="writing-a-failing-test">Writing a Failing Test</h2> <p>Now let's start with a simple test. We are going to test all the symbols (Underscore, Equal, ...). At the end of this article, we aim to make that test pass.</p> <p>We are going to use a technique called <a href="https://arslan.io/2022/12/04/functional-table-driven-tests-in-go/">table-driven tests</a>. To do so, we are going to define a type that represents an expected Token.</p> <ul class="code-tab-container ded5989e-9dbd-4eaf-a32f-6f998e3ccdda"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'ded5989e-9dbd-4eaf-a32f-6f998e3ccdda', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher ded5989e-9dbd-4eaf-a32f-6f998e3ccdda"><li class="code_switcher_container_parent active-tab code_switcher_go 5d0a71da-b14e-43a0-9409-46d72748490a"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Check</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">expectedType</span>     <span class="n">TokenType</span>
  <span class="n">expectedLiteral</span>  <span class="kt">string</span>
  <span class="n">expectedPosition</span> <span class="n">Position</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>I'm calling it <code>Check</code> because it will be used as for a single check in a list of checks. We are going to iterate over that list of checks and do asserts on the three properties.</p> <ul class="code-tab-container 13a4d884-bf3e-4094-9d39-3a0d515279cc"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '13a4d884-bf3e-4094-9d39-3a0d515279cc', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher 13a4d884-bf3e-4094-9d39-3a0d515279cc"><li class="code_switcher_container_parent active-tab code_switcher_go 3626d1ed-f243-4b79-a815-0587cecc8fa4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">l</span> <span class="n">Lexer</span><span class="p">,</span> <span class="n">tests</span> <span class="p">[]</span><span class="n">Check</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">tests</span> <span class="p">{</span>
    <span class="n">tok</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">NextToken</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Type</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedType</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - tokentype wrong. expected=%q, got=%q"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedType</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Type</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">tok</span><span class="o">.</span><span class="n">Literal</span> <span class="o">!=</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedLiteral</span> <span class="p">{</span>
      <span class="n">t</span><span class="o">.</span><span class="n">Fatalf</span><span class="p">(</span><span class="s">"tests[%d] - literal wrong. expected='%s', got='%s'"</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tt</span><span class="o">.</span><span class="n">expectedLiteral</span><span class="p">,</span> <span class="n">tok</span><span class="o">.</span><span class="n">Literal</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c">// asserts on Position for later</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>With that we can now write a compiling and failing test.</p> <ul class="code-tab-container b57fcb54-1da0-409c-8876-fc787c62e5dd"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b57fcb54-1da0-409c-8876-fc787c62e5dd', 0)">lexer/lexer_test.go</a></li></ul><ul class="code-tab-switcher b57fcb54-1da0-409c-8876-fc787c62e5dd"><li class="code_switcher_container_parent active-tab code_switcher_go bf9f5299-28ff-4ffa-97ac-3a8d1a81eb3e"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"testing"</span>
<span class="p">)</span>

<span class="c">//...</span>

<span class="k">func</span> <span class="n">TestNextTokenOnSymbols</span><span class="p">(</span><span class="n">t</span> <span class="o">*</span><span class="n">testing</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">runChecks</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">New</span><span class="p">(),</span> <span class="p">[]</span><span class="n">Check</span><span class="p">{</span>
    <span class="p">{</span><span class="n">TokenUnderscore</span><span class="p">,</span> <span class="s">"_"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenEqual</span><span class="p">,</span> <span class="s">"="</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenColon</span><span class="p">,</span> <span class="s">","</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenSemicolon</span><span class="p">,</span> <span class="s">";"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenDot</span><span class="p">,</span> <span class="s">"."</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftBrace</span><span class="p">,</span> <span class="s">"{"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightBrace</span><span class="p">,</span> <span class="s">"}"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftSquare</span><span class="p">,</span> <span class="s">"["</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightSquare</span><span class="p">,</span> <span class="s">"]"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftParen</span><span class="p">,</span> <span class="s">"("</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightParen</span><span class="p">,</span> <span class="s">")"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenLeftAngle</span><span class="p">,</span> <span class="s">"&lt;"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">TokenRightAngle</span><span class="p">,</span> <span class="s">"&gt;"</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
    <span class="p">{</span><span class="n">EOF</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">Position</span><span class="p">{}},</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>and if we test:</p> <div class="code_switcher_container_parent 64655d46-92cf-4a5b-be12-b44f24f95f15"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnSymbols <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:19: tests[0] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"_"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div> </div> <p>That was expected.</p> <h2 id="improving-impl">Improving Impl</h2> <p>If you didn't notice, our implementation for the Lexer is useless. It's not storing any state and it doesn't even process text. Let's change that.</p> <p>Let's first look at the states our Lexer will store.</p> <ul class="code-tab-container f30e7079-397b-4d7d-8028-310f7290d0b0"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f30e7079-397b-4d7d-8028-310f7290d0b0', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher f30e7079-397b-4d7d-8028-310f7290d0b0"><li class="code_switcher_container_parent active-tab code_switcher_go c8d72a43-5c5d-4fde-b2c9-d40c6c971137"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">// Impl is the implementation for the Lexer interface.</span>
<span class="k">type</span> <span class="n">Impl</span> <span class="k">struct</span> <span class="p">{</span>
  <span class="n">src</span>             <span class="kt">string</span> <span class="c">// the input text</span>
  <span class="n">start</span>           <span class="kt">int</span>    <span class="c">// the start of a token</span>
  <span class="n">startLine</span>       <span class="kt">int</span>    <span class="c">// the line at which a token start</span>
  <span class="n">startLineOffset</span> <span class="kt">int</span>    <span class="c">// the offset of the starting line relative to beginning of file</span>
  <span class="n">line</span>            <span class="kt">int</span>    <span class="c">// the current file line being process</span>
  <span class="n">pos</span>             <span class="kt">int</span>    <span class="c">// the reading position in the file</span>
  <span class="n">atEOF</span>           <span class="kt">bool</span>   <span class="c">// tells wether the Lexer is finished</span>
  <span class="n">token</span>           <span class="n">Token</span>  <span class="c">// the token to return</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>That seems like a lot but don't worry, this is actually pretty intuitive once we start interacting with these properties.</p> <p>Now, we can improve our <code>New</code> function a little bit.</p> <ul class="code-tab-container b3f98255-f629-4e8c-b36f-d514de0691f6"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b3f98255-f629-4e8c-b36f-d514de0691f6', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher b3f98255-f629-4e8c-b36f-d514de0691f6"><li class="code_switcher_container_parent active-tab code_switcher_go a88d928d-7c29-4903-aa60-75f97d9a18e6"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="c">// New creates a new instance of the Lexer</span>
<span class="k">func</span> <span class="n">New</span><span class="p">(</span><span class="n">input</span> <span class="kt">string</span><span class="p">)</span> <span class="n">Lexer</span> <span class="p">{</span>
  <span class="k">return</span> <span class="o">&amp;</span><span class="n">Impl</span><span class="p">{</span>
    <span class="n">src</span><span class="o">:</span>       <span class="n">input</span><span class="p">,</span>
    <span class="n">line</span><span class="o">:</span>      <span class="m">1</span><span class="p">,</span> <span class="c">// lines are 1-indexed</span>
    <span class="n">startLine</span><span class="o">:</span> <span class="m">1</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>We are finally storing text and some indices to keep track of where we are in it.</p> <p>We can now start to think about emitting token in the <code>NextToken</code> function but before actually emitting tokens we are going to need thinking about the FSM.</p> <p>As mentioned, we are going to create states and transitions between these states. These states will be represented as functions and the transitions will be made by returning another state after the processing needed for the current state.</p> <p>We define a state as follows:</p> <ul class="code-tab-container 0afbf672-ceb0-48bc-b370-c11629e3305d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '0afbf672-ceb0-48bc-b370-c11629e3305d', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 0afbf672-ceb0-48bc-b370-c11629e3305d"><li class="code_switcher_container_parent active-tab code_switcher_go 2b72fe77-4fa8-49ff-8a14-0961fbecab0d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">type</span> <span class="n">stateFn</span> <span class="k">func</span><span class="p">(</span><span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span>
</code></pre></div></div> </li></ul> <p>You can notice that this is a function, taking an <code>Impl</code> as parameter and returning a stateFn. Think about is as a list of states linked together.</p> <p>With that, we are now able to define the <code>NextToken</code> logic.</p> <ul class="code-tab-container b4fbb5ac-bd5d-449f-a663-cdc16fe2ee1d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'b4fbb5ac-bd5d-449f-a663-cdc16fe2ee1d', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher b4fbb5ac-bd5d-449f-a663-cdc16fe2ee1d"><li class="code_switcher_container_parent active-tab code_switcher_go 05c789ed-611d-4008-bad8-f0b349c25f56"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="c">// NextToken provides the following token in the input</span>
<span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">NextToken</span><span class="p">()</span> <span class="n">Token</span> <span class="p">{</span>
  <span class="n">state</span> <span class="o">:=</span> <span class="n">lexProto</span>
  <span class="k">for</span> <span class="p">{</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span>
      <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">token</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Where <code>lexerProto</code> is the initial state and where we iterate until <code>state</code> it becomes <code>nil</code>.</p> <h2 id="lexproto">lexProto</h2> <p><code>lexProto</code> Is the initial state of our FSM. This is a <code>stateFn</code>. This means that it interacts with <code>Impl</code> and returns another <code>stateFn</code>.</p> <p>For now, we can make this function really simple. It is a function that checks the next character and checking if this character is a symbol. If it is, we return a <code>Token</code> with the relevant <code>TokenType</code>, otherwise we return an Illegal <code>Token</code>.</p> <ul class="code-tab-container d094a939-0d14-4f35-ae42-2b5f492f23a2"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'd094a939-0d14-4f35-ae42-2b5f492f23a2', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher d094a939-0d14-4f35-ae42-2b5f492f23a2"><li class="code_switcher_container_parent active-tab code_switcher_go 532afe63-28e0-4e18-9b23-1d395aad21a4"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'_'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenUnderscore</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'='</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenEqual</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">','</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenColon</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">';'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenSemicolon</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'.'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenDot</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'{'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftBrace</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'}'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightBrace</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'['</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftSquare</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">']'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightSquare</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'('</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftParen</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">')'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightParen</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'&lt;'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenLeftAngle</span><span class="p">)</span>
  <span class="k">case</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'&gt;'</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenRightAngle</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">TokenIllegal</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="next">next()</h2> <p><code>next</code> Is also pretty simple. It basically checks if the position is valid. If it isn't it returns <code>EOF</code>, otherwise it takes the next rune (utf8 character), updates the <code>pos</code>, updates the <code>line</code> if needed, and return the rune read.</p> <ul class="code-tab-container 843d061d-a0a2-41a2-bc3b-19c273c17c08"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '843d061d-a0a2-41a2-bc3b-19c273c17c08', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 843d061d-a0a2-41a2-bc3b-19c273c17c08"><li class="code_switcher_container_parent active-tab code_switcher_go a5e18ee9-3763-4b99-b1d4-ddb2cdf47288"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">next</span><span class="p">()</span> <span class="kt">rune</span> <span class="p">{</span>
  <span class="k">if</span> <span class="kt">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">atEOF</span> <span class="o">=</span> <span class="no">true</span>
    <span class="k">return</span> <span class="kt">rune</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
  <span class="p">}</span>

  <span class="n">r</span><span class="p">,</span> <span class="n">w</span> <span class="o">:=</span> <span class="n">utf8</span><span class="o">.</span><span class="n">DecodeRuneInString</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="o">:</span><span class="p">])</span>
  <span class="n">l</span><span class="o">.</span><span class="n">pos</span> <span class="o">+=</span> <span class="n">w</span>

  <span class="k">if</span> <span class="n">r</span> <span class="o">==</span> <span class="sc">'\n'</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">line</span><span class="o">++</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">r</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <h2 id="emittokentype">emit(TokenType)</h2> <p><code>emit</code> Is a function that checks our current location in the input text, creates a token, and return nil to stop the loop in <code>NextToken</code>.</p> <ul class="code-tab-container f067f5aa-d9c0-4b44-bcb3-79084e71aa71"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'f067f5aa-d9c0-4b44-bcb3-79084e71aa71', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher f067f5aa-d9c0-4b44-bcb3-79084e71aa71"><li class="code_switcher_container_parent active-tab code_switcher_go 5f810406-0ba1-4714-ba31-3232439c1307"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">func</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">emit</span><span class="p">(</span><span class="n">tt</span> <span class="n">TokenType</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="n">t</span> <span class="o">:=</span> <span class="n">Token</span><span class="p">{</span>
    <span class="n">Type</span><span class="o">:</span>    <span class="n">tt</span><span class="p">,</span>
    <span class="n">Literal</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">src</span><span class="p">[</span><span class="n">l</span><span class="o">.</span><span class="n">start</span><span class="o">:</span><span class="n">l</span><span class="o">.</span><span class="n">pos</span><span class="p">],</span>
    <span class="n">Position</span><span class="o">:</span> <span class="n">Position</span><span class="p">{</span>
      <span class="n">Offset</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
      <span class="n">Line</span><span class="o">:</span>   <span class="n">l</span><span class="o">.</span><span class="n">startLine</span><span class="p">,</span>
      <span class="n">Column</span><span class="o">:</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span><span class="p">,</span>
    <span class="p">}}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">pos</span>
  <span class="n">l</span><span class="o">.</span><span class="n">startLine</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">line</span>
  <span class="k">if</span> <span class="n">tt</span> <span class="o">==</span> <span class="n">TokenSpace</span> <span class="o">&amp;&amp;</span> <span class="n">strings</span><span class="o">.</span><span class="n">Contains</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Literal</span><span class="p">,</span> <span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">l</span><span class="o">.</span><span class="n">startLineOffset</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">start</span>
  <span class="p">}</span>
  <span class="n">l</span><span class="o">.</span><span class="n">token</span> <span class="o">=</span> <span class="n">t</span>
  <span class="k">return</span> <span class="no">nil</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <blockquote> <p>Note: this is a lot of small operations. Take the time to go through the comments written in the <code>Impl</code> struct. This is not that hard.</p> </blockquote> <h2 id="handling-eof">Handling EOF</h2> <p>If we run our test now, we will get the following:</p> <div class="code_switcher_container_parent 668ed346-929a-4497-b33e-746ed9f11a2b"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...
<span class="nt">---</span> FAIL: TestNextTokenOnSymbols <span class="o">(</span>0.00s<span class="o">)</span>
    lexer_test.go:20: tests[13] - tokentype wrong. <span class="nv">expected</span><span class="o">=</span><span class="s2">"EOF"</span>, <span class="nv">got</span><span class="o">=</span><span class="s2">"Illegal"</span>
FAIL
</code></pre></div></div> </div> <p>This is basically saying: &quot;we received an Illegal Token but we expected EOF&quot;.</p> <p>This is pretty trivial to solve. Remember the <code>atEOF</code> property in the <code>Impl</code>? Well, we just add that in our switch statement.</p> <ul class="code-tab-container 19ddf854-fc34-4f81-a01f-aefb26b7f843"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', '19ddf854-fc34-4f81-a01f-aefb26b7f843', 0)">lexer/impl.go</a></li></ul><ul class="code-tab-switcher 19ddf854-fc34-4f81-a01f-aefb26b7f843"><li class="code_switcher_container_parent active-tab code_switcher_go 69407d24-50a8-4337-82f2-e14ef350ae0d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">//...</span>

<span class="k">func</span> <span class="n">lexProto</span><span class="p">(</span><span class="n">l</span> <span class="o">*</span><span class="n">Impl</span><span class="p">)</span> <span class="n">stateFn</span> <span class="p">{</span>
  <span class="k">switch</span> <span class="n">r</span> <span class="o">:=</span> <span class="n">l</span><span class="o">.</span><span class="n">next</span><span class="p">();</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">l</span><span class="o">.</span><span class="n">atEOF</span><span class="o">:</span>
    <span class="k">return</span> <span class="n">l</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="n">EOF</span><span class="p">)</span>
  <span class="c">//...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>and now:</p> <div class="code_switcher_container_parent c725a99f-c9e4-4521-ac7a-23498c4080da"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>go <span class="nb">test</span> ./...

ok      test.com/lexer  0.809s
</code></pre></div></div> </div> <p>Boom !</p> <h2 id="conclusion">Conclusion</h2> <p>We have a Lexer that is able to go through a text and identify the symbols that we defined as TokenType. Admittedly, this is not exceptional but we are now ready for the next part where we are going to skip whitespaces and comments, and lex Identifiers, Numbers (Int and Float), and Strings.</p> <p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p> </div> <div class="date"> Written on February 17, 2023 </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript"> var disqus_shortname = 'clement-jean-github-io-1'; (function() { var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true; dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq); })(); </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript> </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <!-- Google Analytics --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-111260962-1', 'auto'); ga('send', 'pageview', { 'page': '/protein_lexer_part_1/', 'title': 'Protein: Lexer (Part 1)' }); </script> <!-- End Google Analytics --> </body> </html>