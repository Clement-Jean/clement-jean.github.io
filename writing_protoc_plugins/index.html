<!DOCTYPE html> <html> <head> <title>Writing Protoc Plugins – Clément Jean – Eternal learner and challenges lover</title> <meta charset="utf-8" /> <meta content='text/html; charset=utf-8' http-equiv='Content-Type'> <meta http-equiv='X-UA-Compatible' content='IE=edge'> <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'> <meta name="description" content="Recently, I answered a StackOverflow question related to writing protoc plugins and Protobuf custom options. I thought this would be interesting to share how to write one because I believe this is quite an involved process and it fits the context of an article. " /> <meta property="og:description" content="Recently, I answered a StackOverflow question related to writing protoc plugins and Protobuf custom options. I thought this would be interesting to share how to write one because I believe this is quite an involved process and it fits the context of an article. " /> <meta name="author" content="Clément Jean" /> <meta property="og:title" content="Writing Protoc Plugins" /> <meta property="twitter:title" content="Writing Protoc Plugins" /> <link rel="stylesheet" type="text/css" href="/css/org-style.css" /> <link rel="stylesheet" type="text/css" href="/css/org-code.css"/> <link rel="stylesheet" type="text/css" href="/css/org-normalize.css"/> <link href="https://techhub.social/@clementjean" rel="me"> <link rel="stylesheet" type="text/css" href="/css/style.css" /> <link rel="alternate" type="application/rss+xml" title="Clément Jean - Eternal learner and challenges lover" href="/feed.xml" /> <link rel="icon" type="image/png" href="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png"> <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Mono"/><link rel="stylesheet" href="/assets/codeblock.css"/><script src="/assets/codeblock.js"></script></head> <body> <div class="wrapper-masthead"> <div class="container"> <header class="masthead clearfix"> <a href="/" aria-label="Home" class="site-avatar"><img src="/images/%E4%B8%80%E4%BB%8B%E5%A5%BD%E5%AD%A6.png" alt="Clement Jean" width="80" height="70"/></a> <div class="site-info"> <h1 class="site-name"><a class="black-red-link" href="/">Clément Jean</a></h1> <p class="site-description">Eternal learner and challenges lover</p> </div> <nav> <a class="black-red-link" href="/">Home</a> <a class="black-red-link" href="/categories">Categories</a> <a class="black-red-link" href="/hire_me">Hire Me</a> <a class="black-red-link" href="/about">About</a> </nav> </header> </div> </div> <div id="main" role="main" class="container"> <article class="post"> <h1>Writing Protoc Plugins</h1> <div class="entry"> <p>Recently, I answered a <a href="https://stackoverflow.com/questions/75343655/modeling-schema-metadata-without-serializing-into-the-protobuf-message/75362085#75362085">StackOverflow question</a> related to writing protoc plugins and Protobuf custom options. I thought this would be interesting to share how to write one because I believe this is quite an involved process and it fits the context of an article.</p> <h2 id="c-or-go">C++ or Go</h2> <p>When checking the protobuf documentation, I could only find a plugin API for C++ and Go. Furthermore, Go seems to be the only language where people have written blog posts about how to write such a custom plugin. In this article, I'm trying to cover as many languages as possible so for now I'll write in both languages and if you find that another language support writing custom plugin, leave a comment and I'll be happy to update.</p> <h2 id="bazel">Bazel</h2> <p>In order to build a multi-language project, I'm going to use Bazel. This might be frightening for some people but I'll try to explain as much as I can. Furthermore, if you are interested in learning Bazel, you can let me know in the comments.</p> <h2 id="the-context">The Context</h2> <p>While the StackOverflow states the problem, I want to explain it again so that I have control of whether the content exists. Here is a copy of the question:</p> <blockquote> <p>Does protobuf support embedding non functional metadata into the protobuf schema without affecting the message serialization/de-serialization? I am attempting to embed business information (ownership, contact info) into a large shared protobuf schema but do NOT want to impact functionality at all.</p> <p>A structured comment or custom_option that does not get serialized would work. I would also like to parse the information from the .proto file for auditing purposes.</p> <p>TIA</p> <div class="code_switcher_container_parent 3bd07dee-086d-4a7c-8679-03b24dbc1ecc"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">message</span> <span class="nc">Bar</span> <span class="p">{</span>
 <span class="k">optional</span> <span class="kt">int32</span> <span class="na">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[(</span><span class="n">silent_options</span><span class="p">)</span><span class="o">.</span><span class="na">owner</span> <span class="o">=</span> <span class="s">"team1"</span><span class="p">,</span> <span class="p">(</span><span class="n">silent_options</span><span class="p">)</span><span class="o">.</span><span class="na">email</span> <span class="o">=</span> <span class="s">"team1@company.com"</span><span class="p">];</span>
 <span class="k">optional</span> <span class="kt">int32</span> <span class="na">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> </div></blockquote> <p>In other words, we want to create a custom FieldOption which lets us assign an owner and an email to a field. On top of that, we want that to be analyzed for auditing purpose. This basically means that we can do that at &quot;compile&quot; time. So we are going to build a custom plugin which will let us write something like:</p> <div class="code_switcher_container_parent b6b90bf9-483b-48f9-b963-4d0af4dc8815"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protoc <span class="nt">--audit_out</span><span class="o">=</span><span class="nb">.</span> test.proto
</code></pre></div></div> </div> <p>Now, in this article, to keep everything simple, we are not going to generate any code or report stored in a file. We are going to print info on the terminal. However, generating files is pretty trivial to add in general. We simply write the information that we print in the terminal to a file (protoc library has some sort of printer to write to files).</p> <h3 id="workspace--build-root">WORKSPACE + BUILD (root)</h3> <p>Let us first create our Bazel Workspace for our project. We do that by creating a WORKSPACE.bazel file at the root and inside we are going to add the dependencies needed to build our project.</p> <ul class="code-tab-container 4c1c228d-5ebc-441b-85cd-a4941ac2e6ab"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', '4c1c228d-5ebc-441b-85cd-a4941ac2e6ab', 0)">WORKSPACE.bazel (Go)</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '4c1c228d-5ebc-441b-85cd-a4941ac2e6ab', 1)">WORKSPACE.bazel (C++)</a></li></ul><ul class="code-tab-switcher 4c1c228d-5ebc-441b-85cd-a4941ac2e6ab"><li class="code_switcher_container_parent active-tab code_switcher_python 990bac05-3a07-4e13-b721-88c5f0db3f6f"><div class="code_switcher_code_action_container"><div id="code_copied_snackbar">Copied!</div><button class="code_switcher_copy_button" title="Copy" onclick="copyText('990bac05-3a07-4e13-b721-88c5f0db3f6f')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span><span class="p">,</span> <span class="s">"http_archive"</span><span class="p">)</span>

<span class="n">RULES_GO_VERSION</span> <span class="o">=</span> <span class="s">"0.37.0"</span>
<span class="n">GO_VERSION</span> <span class="o">=</span> <span class="s">"1.19.5"</span>
<span class="n">GAZELLE_VERSION</span> <span class="o">=</span> <span class="s">"0.29.0"</span>
<span class="n">PROTOBUF_VERSION</span> <span class="o">=</span> <span class="s">"3.21.12"</span>

<span class="c1"># To create go libraries and binaries
</span><span class="n">http_archive</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"io_bazel_rules_go"</span><span class="p">,</span>
  <span class="n">sha256</span> <span class="o">=</span> <span class="s">"56d8c5a5c91e1af73eca71a6fab2ced959b67c86d12ba37feedb0a2dfea441a6"</span><span class="p">,</span>
  <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"https://mirror.bazel.build/github.com/bazelbuild/rules_go/releases/download/v%s/rules_go-v%s.zip"</span> <span class="o">%</span> <span class="p">(</span><span class="n">RULES_GO_VERSION</span><span class="p">,</span> <span class="n">RULES_GO_VERSION</span><span class="p">),</span>
    <span class="s">"https://github.com/bazelbuild/rules_go/releases/download/v%s/rules_go-v%s.zip"</span> <span class="o">%</span> <span class="p">(</span><span class="n">RULES_GO_VERSION</span><span class="p">,</span> <span class="n">RULES_GO_VERSION</span><span class="p">),</span>
  <span class="p">],</span>
<span class="p">)</span>

<span class="c1"># To generate BUILD.bazel files and lists of dependencies (more on that later)
</span><span class="n">http_archive</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"bazel_gazelle"</span><span class="p">,</span>
  <span class="n">sha256</span> <span class="o">=</span> <span class="s">"ecba0f04f96b4960a5b250c8e8eeec42281035970aa8852dda73098274d14a1d"</span><span class="p">,</span>
  <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"https://mirror.bazel.build/github.com/bazelbuild/bazel-gazelle/releases/download/v%s/bazel-gazelle-v%s.tar.gz"</span> <span class="o">%</span> <span class="p">(</span><span class="n">GAZELLE_VERSION</span><span class="p">,</span> <span class="n">GAZELLE_VERSION</span><span class="p">),</span>
    <span class="s">"https://github.com/bazelbuild/bazel-gazelle/releases/download/v%s/bazel-gazelle-v%s.tar.gz"</span> <span class="o">%</span> <span class="p">(</span><span class="n">GAZELLE_VERSION</span><span class="p">,</span> <span class="n">GAZELLE_VERSION</span><span class="p">),</span>
  <span class="p">],</span>
<span class="p">)</span>

<span class="c1"># To get protobuf and protoc libraries
</span><span class="n">http_archive</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"com_google_protobuf"</span><span class="p">,</span>
  <span class="n">sha256</span> <span class="o">=</span> <span class="s">"930c2c3b5ecc6c9c12615cf5ad93f1cd6e12d0aba862b572e076259970ac3a53"</span><span class="p">,</span>
  <span class="n">strip_prefix</span> <span class="o">=</span> <span class="s">"protobuf-%s"</span> <span class="o">%</span> <span class="n">PROTOBUF_VERSION</span><span class="p">,</span>
  <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"https://mirror.bazel.build/github.com/protocolbuffers/protobuf/archive/v%s.tar.gz"</span> <span class="o">%</span> <span class="n">PROTOBUF_VERSION</span><span class="p">,</span>
    <span class="s">"https://github.com/protocolbuffers/protobuf/archive/v%s.tar.gz"</span> <span class="o">%</span> <span class="n">PROTOBUF_VERSION</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">)</span>

<span class="n">load</span><span class="p">(</span><span class="s">"@io_bazel_rules_go//go:deps.bzl"</span><span class="p">,</span> <span class="s">"go_register_toolchains"</span><span class="p">,</span> <span class="s">"go_rules_dependencies"</span><span class="p">)</span>

<span class="n">go_rules_dependencies</span><span class="p">()</span>

<span class="n">go_register_toolchains</span><span class="p">(</span><span class="n">version</span> <span class="o">=</span> <span class="n">GO_VERSION</span><span class="p">)</span>

<span class="n">load</span><span class="p">(</span><span class="s">"@bazel_gazelle//:deps.bzl"</span><span class="p">,</span> <span class="s">"gazelle_dependencies"</span><span class="p">)</span>

<span class="n">gazelle_dependencies</span><span class="p">(</span><span class="n">go_repository_default_config</span> <span class="o">=</span> <span class="s">"//:WORKSPACE.bazel"</span><span class="p">)</span>

<span class="n">load</span><span class="p">(</span><span class="s">"@com_google_protobuf//:protobuf_deps.bzl"</span><span class="p">,</span> <span class="s">"protobuf_deps"</span><span class="p">)</span>

<span class="n">protobuf_deps</span><span class="p">()</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_python 483709ea-5469-4c49-b8bc-fe99e987504d"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('483709ea-5469-4c49-b8bc-fe99e987504d')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@bazel_tools//tools/build_defs/repo:http.bzl"</span><span class="p">,</span> <span class="s">"http_archive"</span><span class="p">)</span>

<span class="n">PROTOBUF_VERSION</span> <span class="o">=</span> <span class="s">"3.21.12"</span>

<span class="c1"># To get protobuf and protoc libraries
</span><span class="n">http_archive</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"com_google_protobuf"</span><span class="p">,</span>
  <span class="n">sha256</span> <span class="o">=</span> <span class="s">"930c2c3b5ecc6c9c12615cf5ad93f1cd6e12d0aba862b572e076259970ac3a53"</span><span class="p">,</span>
  <span class="n">strip_prefix</span> <span class="o">=</span> <span class="s">"protobuf-%s"</span> <span class="o">%</span> <span class="n">PROTOBUF_VERSION</span><span class="p">,</span>
  <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"https://mirror.bazel.build/github.com/protocolbuffers/protobuf/archive/v%s.tar.gz"</span> <span class="o">%</span> <span class="n">PROTOBUF_VERSION</span><span class="p">,</span>
    <span class="s">"https://github.com/protocolbuffers/protobuf/archive/v%s.tar.gz"</span> <span class="o">%</span> <span class="n">PROTOBUF_VERSION</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">)</span>

<span class="n">load</span><span class="p">(</span><span class="s">"@com_google_protobuf//:protobuf_deps.bzl"</span><span class="p">,</span> <span class="s">"protobuf_deps"</span><span class="p">)</span>

<span class="n">protobuf_deps</span><span class="p">()</span>
</code></pre></div></div> </li></ul> <p>This gets all the dependencies needed to work with protobuf. Mainly we are going to use protobuf library which contains some generated code to deal with descriptors (a meta object that describe an object written in protobuf) and the protoc library which lets us define plugins.</p> <h4 id="go">Go</h4> <p>For go, we have some extra steps. The first thing we can do is creating our go module. To do that we can write the following command:</p> <div class="code_switcher_container_parent 817612f7-1dc7-4306-af03-aca3a4b6518c"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('817612f7-1dc7-4306-af03-aca3a4b6518c')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go mod init test.com
</code></pre></div></div> </div> <p>Where you can replace <code>test.com</code> with the name of your module. <strong>If you changed the module name, be aware that you'll need to update all the following <code>test.com</code></strong>.</p> <p>Now, because we also want our application to run with a simple <code>go run main.go</code> kind of command, we are going to add a dependency to the module, which is protobuf. To do that enter the following command:</p> <div class="code_switcher_container_parent 940dcbdf-6945-4727-9f96-ac06983cb85a"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('940dcbdf-6945-4727-9f96-ac06983cb85a')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>go get <span class="nt">-u</span> google.golang.org/protobuf
</code></pre></div></div> </div> <p>Note that we added a protobuf dependency in the WORKSPACE.bazel and in our go.mod. These are not the same. One if for the building phase (linking with libraries) and the other is to be used in the Go program (as code).</p> <p>Finally, we also need to set up Gazelle. We need to create a BUILD.bazel file at the root level.</p> <ul class="code-tab-container 4e5fec6a-9aa1-4f9d-9d35-606492fba460"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', '4e5fec6a-9aa1-4f9d-9d35-606492fba460', 0)">BUILD.bazel</a></li></ul><ul class="code-tab-switcher 4e5fec6a-9aa1-4f9d-9d35-606492fba460"><li class="code_switcher_container_parent active-tab code_switcher_python 952471a8-533d-4694-afaf-6f10d05320ff"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('952471a8-533d-4694-afaf-6f10d05320ff')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@bazel_gazelle//:def.bzl"</span><span class="p">,</span> <span class="s">"gazelle"</span><span class="p">)</span>

<span class="c1"># gazelle:prefix test.com
</span><span class="n">gazelle</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">"gazelle"</span><span class="p">)</span>

<span class="n">gazelle</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"gazelle-update-repos"</span><span class="p">,</span>
  <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"-from_file=go.mod"</span><span class="p">,</span>
    <span class="s">"-to_macro=deps.bzl%go_dependencies"</span><span class="p">,</span>
    <span class="s">"-prune"</span><span class="p">,</span>
  <span class="p">],</span>
  <span class="n">command</span> <span class="o">=</span> <span class="s">"update-repos"</span><span class="p">,</span>
<span class="p">)</span>
</code></pre></div></div> </li></ul> <p>This creates two commands (<code>gazelle</code> and <code>gazelle-update-repos</code>) that we can run to generate our BUILD.bazel and other dependency files automatically.</p> <p>We can now run <code>bazel run //:gazelle-update-repos</code> in the terminal and we will see that it creates a file called <code>deps.bzl</code> and that the WORKSPACE.bazel was modified with these lines:</p> <ul class="code-tab-container d60c8601-12fb-4171-ba78-0d0856a5beda"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', 'd60c8601-12fb-4171-ba78-0d0856a5beda', 0)">WORKSPACE.bazel</a></li></ul><ul class="code-tab-switcher d60c8601-12fb-4171-ba78-0d0856a5beda"><li class="code_switcher_container_parent active-tab code_switcher_python a5defc64-c20c-4f05-a045-c47dcdb6c493"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"//:deps.bzl"</span><span class="p">,</span> <span class="s">"go_dependencies"</span><span class="p">)</span>

<span class="c1"># gazelle:repository_macro deps.bzl%go_dependencies
</span><span class="n">go_dependencies</span><span class="p">()</span>
</code></pre></div></div> </li></ul> <p>If you open the <code>deps.bzl</code>, you will see a list of all the dependencies fetched to be able to build your go application.</p> <h3 id="protobuf">Protobuf</h3> <p>We are now at the stage where we can define our custom option. It is worth noting that in our case we need an option on fields but we can create options for a lot of different context. We could for example create an option at the top-level context (<code>go_package</code>, <code>optimize_for</code>, ...), at a message level, etc. You can find all the options in the file called descriptor.proto in the GitHub repo under <code>src/google/protobuf</code>.</p> <p>To create a custom option, we need to extend the relevant message. In our case we need to extend <code>google.protobuf.FieldOptions</code>. To do that we can simply use the <code>extend</code> concept, which lets us define more fields inside an already existing message.</p> <ul class="code-tab-container 7cd8c45f-7751-420b-8f68-fe47c28db5d2"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '7cd8c45f-7751-420b-8f68-fe47c28db5d2', 0)">proto/silent_option.proto (Go)</a></li><li class=" code_switcher_proto"><a onclick="selectTab('code_switcher_proto', '7cd8c45f-7751-420b-8f68-fe47c28db5d2', 1)">proto/silent_option.proto (C++)</a></li></ul><ul class="code-tab-switcher 7cd8c45f-7751-420b-8f68-fe47c28db5d2"><li class="code_switcher_container_parent active-tab code_switcher_proto 45903718-c3fe-4f39-80ab-32feffa1efba"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('45903718-c3fe-4f39-80ab-32feffa1efba')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"google/protobuf/descriptor.proto"</span><span class="p">;</span>

<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"test.com/proto"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">SilentOption</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">owner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">email</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.FieldOptions</span> <span class="p">{</span>
  <span class="n">SilentOption</span> <span class="na">silent_option</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// see note below for why 1000</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_proto 6c27e741-859b-460c-8d83-0e06901b86db"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('6c27e741-859b-460c-8d83-0e06901b86db')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"google/protobuf/descriptor.proto"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">SilentOption</span> <span class="p">{</span>
  <span class="kt">string</span> <span class="na">owner</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="kt">string</span> <span class="na">email</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">extend</span> <span class="nc">google</span><span class="o">.</span><span class="n">protobuf.FieldOptions</span> <span class="p">{</span>
  <span class="n">SilentOption</span> <span class="na">silent_option</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span> <span class="c1">// see note below for why 1000</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <blockquote> <p>NOTE: if you check the FieldOptions message in the descriptor.proto file, you will see the following line: <code>extensions 1000 to max;</code>. This means that when we are extending this message, our fields will need to contain tags that are between 1000 and max (maximum tag). Furthermore, some of the option tags are &quot;already taken&quot;. This means that other custom options are using them and if you were to use your option with another one having the same tag, you would have a conflict. Check the list of the <a href="https://github.com/protocolbuffers/protobuf/blob/main/docs/options.md">Protobuf Global Extension Registry</a> before selecting the tag for your custom option and maybe register it.</p> </blockquote> <p>Now that we have our proto file, we can think about compiling it. To do that we are going to create a BUILD.bazel file in the proto directory. This will define a library for our proto file and another for the related programming language.</p> <ul class="code-tab-container c1fb8627-c939-4bd3-acfd-21abe03455ed"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'c1fb8627-c939-4bd3-acfd-21abe03455ed', 0)">BUILD.bazel (Go)</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', 'c1fb8627-c939-4bd3-acfd-21abe03455ed', 1)">BUILD.bazel (C++)</a></li></ul><ul class="code-tab-switcher c1fb8627-c939-4bd3-acfd-21abe03455ed"><li class="code_switcher_container_parent active-tab code_switcher_shell 08a5f05d-560d-41b9-8fc0-0de5e6ce6fac"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('08a5f05d-560d-41b9-8fc0-0de5e6ce6fac')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel run //:gazelle
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_python d81c9e68-6165-4063-8b37-0d15e68aa7e5"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('d81c9e68-6165-4063-8b37-0d15e68aa7e5')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@rules_proto//proto:defs.bzl"</span><span class="p">,</span> <span class="s">"proto_library"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">"@rules_cc//cc:defs.bzl"</span><span class="p">,</span> <span class="s">"cc_proto_library"</span><span class="p">)</span>

<span class="n">proto_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"silent_option_proto"</span><span class="p">,</span>
  <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"silent_option.proto"</span><span class="p">],</span>
  <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">"@com_google_protobuf//:descriptor_proto"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">cc_proto_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"silent_option_cc_proto"</span><span class="p">,</span>
  <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">":silent_option_proto"</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div> </li></ul> <h4 id="go-1">Go</h4> <p>You might have noticed that we simply ran a command to generate our BUILD.bazel in the proto directory. This is what gazelle is doing. It checks your file and determine how to create BUILD files. However, I think there are problems with this solution. The main one is the naming of our libraries. By now, you should have something like this:</p> <ul class="code-tab-container dfe3c385-d848-4929-8299-0d269eb3972d"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', 'dfe3c385-d848-4929-8299-0d269eb3972d', 0)">proto/BUILD.bazel</a></li></ul><ul class="code-tab-switcher dfe3c385-d848-4929-8299-0d269eb3972d"><li class="code_switcher_container_parent active-tab code_switcher_python 48e2dd1c-f33e-4b53-aa6c-fbcc5204082d"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@rules_proto//proto:defs.bzl"</span><span class="p">,</span> <span class="s">"proto_library"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">"@io_bazel_rules_go//go:def.bzl"</span><span class="p">,</span> <span class="s">"go_library"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">"@io_bazel_rules_go//proto:def.bzl"</span><span class="p">,</span> <span class="s">"go_proto_library"</span><span class="p">)</span>

<span class="n">proto_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"proto_proto"</span><span class="p">,</span>
  <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"silent_option.proto"</span><span class="p">],</span>
  <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span><span class="s">"@com_google_protobuf//:descriptor_proto"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">go_proto_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"proto_go_proto"</span><span class="p">,</span>
  <span class="n">importpath</span> <span class="o">=</span> <span class="s">"test.com/proto"</span><span class="p">,</span>
  <span class="n">proto</span> <span class="o">=</span> <span class="s">":proto_proto"</span><span class="p">,</span>
  <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
<span class="p">)</span>

<span class="n">go_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"proto"</span><span class="p">,</span>
  <span class="n">embed</span> <span class="o">=</span> <span class="p">[</span><span class="s">":proto_go_proto"</span><span class="p">],</span>
  <span class="n">importpath</span> <span class="o">=</span> <span class="s">"test.com/proto"</span><span class="p">,</span>
  <span class="n">visibility</span> <span class="o">=</span> <span class="p">[</span><span class="s">"//visibility:public"</span><span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div> </li></ul> <p>and these are using generic names based on the folder there are stored in (proto). Let's rename all that.</p> <ul class="code-tab-container 51c87db9-16b7-4105-b647-cd80fa088b90"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', '51c87db9-16b7-4105-b647-cd80fa088b90', 0)">proto/BUILD.bazel</a></li></ul><ul class="code-tab-switcher 51c87db9-16b7-4105-b647-cd80fa088b90"><li class="code_switcher_container_parent active-tab code_switcher_python 7d47dc77-9884-432d-9f18-d33551dd3c1e"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('7d47dc77-9884-432d-9f18-d33551dd3c1e')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@rules_proto//proto:defs.bzl"</span><span class="p">,</span> <span class="s">"proto_library"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">"@io_bazel_rules_go//go:def.bzl"</span><span class="p">,</span> <span class="s">"go_library"</span><span class="p">)</span>
<span class="n">load</span><span class="p">(</span><span class="s">"@io_bazel_rules_go//proto:def.bzl"</span><span class="p">,</span> <span class="s">"go_proto_library"</span><span class="p">)</span>

<span class="n">proto_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"silent_option_proto"</span><span class="p">,</span>
  <span class="c1">#...
</span><span class="p">)</span>

<span class="n">go_proto_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"silent_option_go_proto"</span><span class="p">,</span>
  <span class="n">proto</span> <span class="o">=</span> <span class="s">":silent_option_proto"</span><span class="p">,</span>
  <span class="c1">#...
</span><span class="p">)</span>

<span class="n">go_library</span><span class="p">(</span>
  <span class="n">embed</span> <span class="o">=</span> <span class="p">[</span><span class="s">":silent_option_go_proto"</span><span class="p">],</span>
  <span class="c1">#...
</span><span class="p">)</span>
</code></pre></div></div> </li></ul> <h3 id="plugin">Plugin</h3> <p>Finally, we arrive at the moment where we need to write the plugin. The goal of this plugin is reading a protobuf file and if it sees a field with silent_option, it will print the file name, the field and its related info, and the option content.</p> <blockquote> <p>Note: Since this is a very different process for different implementations of Protobuf, I will rely on code comment to explain what the code is doing.</p> </blockquote> <ul class="code-tab-container def00f8d-d338-4c65-872e-37d5e8912c8d"><li class="active-tab code_switcher_go"><a onclick="selectTab('code_switcher_go', 'def00f8d-d338-4c65-872e-37d5e8912c8d', 0)">main.go</a></li><li class=" code_switcher_cpp"><a onclick="selectTab('code_switcher_cpp', 'def00f8d-d338-4c65-872e-37d5e8912c8d', 1)">main.cc</a></li></ul><ul class="code-tab-switcher def00f8d-d338-4c65-872e-37d5e8912c8d"><li class="code_switcher_container_parent active-tab code_switcher_go ffa315d5-3fbf-44b1-b981-eb812f9083f0"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('ffa315d5-3fbf-44b1-b981-eb812f9083f0')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
  <span class="s">"flag"</span>
  <span class="s">"log"</span>

  <span class="s">"google.golang.org/protobuf/compiler/protogen"</span>
  <span class="s">"google.golang.org/protobuf/proto"</span>
  <span class="s">"google.golang.org/protobuf/types/descriptorpb"</span>

  <span class="n">pb</span> <span class="s">"test.com/proto"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">var</span> <span class="n">flags</span> <span class="n">flag</span><span class="o">.</span><span class="n">FlagSet</span>
  <span class="c">// defines the options that we can pass to our plugin</span>
  <span class="n">team</span> <span class="o">:=</span> <span class="n">flags</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="s">"team"</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="s">"Filtering team"</span><span class="p">)</span>

  <span class="n">protogen</span><span class="o">.</span><span class="n">Options</span><span class="p">{</span>
    <span class="n">ParamFunc</span><span class="o">:</span> <span class="n">flags</span><span class="o">.</span><span class="n">Set</span><span class="p">,</span> <span class="c">// the protobuf library will set the option into the flags variable</span>
  <span class="p">}</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="k">func</span><span class="p">(</span><span class="n">gen</span> <span class="o">*</span><span class="n">protogen</span><span class="o">.</span><span class="n">Plugin</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">file</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">gen</span><span class="o">.</span><span class="n">Files</span> <span class="p">{</span> <span class="c">// iterates over all the proto files given as source</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">file</span><span class="o">.</span><span class="n">Generate</span> <span class="p">{</span>
        <span class="k">continue</span>
      <span class="p">}</span>

      <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">message</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">file</span><span class="o">.</span><span class="n">Messages</span> <span class="p">{</span> <span class="c">// iterates over the messages in the current file</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">field</span> <span class="o">:=</span> <span class="k">range</span> <span class="n">message</span><span class="o">.</span><span class="n">Fields</span> <span class="p">{</span> <span class="c">// iterates over the fields in the current message</span>
          <span class="n">option</span> <span class="o">:=</span> <span class="n">field</span><span class="o">.</span><span class="n">Desc</span><span class="o">.</span><span class="n">Options</span><span class="p">()</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">descriptorpb</span><span class="o">.</span><span class="n">FieldOptions</span><span class="p">)</span> <span class="c">// try to get an option</span>

          <span class="k">if</span> <span class="n">option</span> <span class="o">==</span> <span class="no">nil</span> <span class="p">{</span> <span class="c">// if no option we skip</span>
            <span class="k">continue</span>
          <span class="p">}</span>

          <span class="n">extension</span> <span class="o">:=</span> <span class="n">proto</span><span class="o">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">option</span><span class="p">,</span> <span class="n">pb</span><span class="o">.</span><span class="n">E_SilentOption</span><span class="p">)</span><span class="o">.</span><span class="p">(</span><span class="o">*</span><span class="n">pb</span><span class="o">.</span><span class="n">SilentOption</span><span class="p">)</span> <span class="c">// try to cast this option in SilentOption</span>

          <span class="k">if</span> <span class="n">extension</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="nb">len</span><span class="p">(</span><span class="n">extension</span><span class="o">.</span><span class="n">Owner</span><span class="p">)</span> <span class="o">!=</span> <span class="m">0</span> <span class="o">&amp;&amp;</span> <span class="n">team</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">extension</span><span class="o">.</span><span class="n">Owner</span> <span class="o">==</span> <span class="o">*</span><span class="n">team</span> <span class="p">{</span>
            <span class="c">// in here we have a SilentOption which as the owner equal to the team option pass in command line.</span>
            <span class="n">log</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">Desc</span><span class="o">.</span><span class="n">Name</span><span class="p">(),</span> <span class="n">field</span><span class="p">,</span> <span class="n">extension</span><span class="p">)</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="no">nil</span>
  <span class="p">})</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_cpp 2300d7d3-c1db-4b01-a637-b58516eba942"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('2300d7d3-c1db-4b01-a637-b58516eba942')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-cpp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;google/protobuf/compiler/plugin.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;google/protobuf/compiler/code_generator.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;google/protobuf/descriptor.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;google/protobuf/io/printer.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;google/protobuf/compiler/command_line_interface.h&gt;</span><span class="cp">
#include</span> <span class="cpf">"proto/silent_option.pb.h"</span><span class="cp">
</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">io</span><span class="p">;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">google</span><span class="o">::</span><span class="n">protobuf</span><span class="o">::</span><span class="n">compiler</span><span class="p">;</span>

<span class="c1">// implementation of Generator interface</span>
<span class="k">class</span> <span class="nc">AuditGenerator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">CodeGenerator</span> <span class="p">{</span>
 <span class="nl">public:</span>
  <span class="c1">// iterates over the files and call the Generate function</span>
  <span class="c1">// we are skipping error handling</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">GenerateAll</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">FileDescriptor</span><span class="o">*&gt;</span> <span class="o">&amp;</span><span class="n">files</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">parameter</span><span class="p">,</span>
    <span class="n">GeneratorContext</span> <span class="o">*</span><span class="n">generator_context</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="n">error</span>
  <span class="p">)</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;&amp;</span><span class="n">file</span> <span class="o">:</span> <span class="n">files</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="o">-&gt;</span><span class="n">Generate</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">generator_context</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="c1">// analyzes a file</span>
  <span class="k">virtual</span> <span class="kt">bool</span> <span class="n">Generate</span><span class="p">(</span>
    <span class="k">const</span> <span class="n">FileDescriptor</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
    <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">parameter</span><span class="p">,</span>
    <span class="n">GeneratorContext</span> <span class="o">*</span><span class="n">generator_context</span><span class="p">,</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">*</span><span class="n">error</span>
  <span class="p">)</span> <span class="k">const</span> <span class="k">override</span> <span class="p">{</span>
    <span class="c1">// iterates over the messages in the current file</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">message_type_count</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">auto</span> <span class="n">message</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">message_type</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

      <span class="c1">// iterates over the fields in the current message</span>
      <span class="k">for</span> <span class="p">(</span><span class="kt">size_t</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">();</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">auto</span> <span class="n">field</span> <span class="o">=</span> <span class="n">message</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">(</span><span class="n">j</span><span class="p">);</span>
        <span class="k">auto</span> <span class="n">options</span> <span class="o">=</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">options</span><span class="p">.</span><span class="n">HasExtension</span><span class="p">(</span><span class="n">silent_option</span><span class="p">))</span> <span class="p">{</span><span class="k">continue</span><span class="p">;}</span> <span class="c1">// if no SilentOption we skip</span>

        <span class="k">auto</span> <span class="n">extension</span> <span class="o">=</span> <span class="n">options</span><span class="p">.</span><span class="n">GetExtension</span><span class="p">(</span><span class="n">silent_option</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">extension</span><span class="p">.</span><span class="n">IsInitialized</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">parameter</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">extension</span><span class="p">.</span><span class="n">owner</span><span class="p">()</span> <span class="o">==</span> <span class="n">parameter</span><span class="p">)</span> <span class="p">{</span>
          <span class="c1">// in here we have a SilentOption which as the owner equal to the team option pass in command line.</span>
          <span class="n">std</span><span class="o">::</span><span class="n">cerr</span> <span class="o">&lt;&lt;</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="s">": "</span> <span class="o">&lt;&lt;</span> <span class="n">field</span><span class="o">-&gt;</span><span class="n">DebugString</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
  <span class="n">AuditGenerator</span> <span class="n">generator</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">PluginMain</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">generator</span><span class="p">);</span> <span class="c1">// registers the generator</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>To compile this code, we need to create a BUILD.bazel file which will generate a binary for our application.</p> <ul class="code-tab-container 252f03b8-4c3f-4193-a0f6-d9500355361c"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', '252f03b8-4c3f-4193-a0f6-d9500355361c', 0)">BUILD.bazel (Go)</a></li><li class=" code_switcher_python"><a onclick="selectTab('code_switcher_python', '252f03b8-4c3f-4193-a0f6-d9500355361c', 1)">BUILD.bazel (C++)</a></li></ul><ul class="code-tab-switcher 252f03b8-4c3f-4193-a0f6-d9500355361c"><li class="code_switcher_container_parent active-tab code_switcher_shell b96bf218-35e5-48ea-80f6-a3916b1d4384"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('b96bf218-35e5-48ea-80f6-a3916b1d4384')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel run //:gazelle
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_python a3c19fe5-7eb3-43a7-92d8-287e05c234e6"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('a3c19fe5-7eb3-43a7-92d8-287e05c234e6')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">load</span><span class="p">(</span><span class="s">"@rules_cc//cc:defs.bzl"</span><span class="p">,</span> <span class="s">"cc_binary"</span><span class="p">)</span>

<span class="n">cc_binary</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"protoc-gen-audit"</span><span class="p">,</span>
  <span class="n">srcs</span> <span class="o">=</span> <span class="p">[</span><span class="s">"main.cc"</span><span class="p">],</span>
  <span class="n">deps</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">"//proto:silent_option_cc_proto"</span><span class="p">,</span>
    <span class="s">"@com_google_protobuf//:protobuf"</span><span class="p">,</span>
    <span class="s">"@com_google_protobuf//:protoc_lib"</span><span class="p">,</span>
  <span class="p">],</span>
<span class="p">)</span>
</code></pre></div></div> </li></ul> <h4 id="go-2">Go</h4> <p>Same naming problem as the Protobuf section. Let us rename that.</p> <ul class="code-tab-container 49dd8a5b-e583-4f30-918d-631cc4edd0bd"><li class="active-tab code_switcher_python"><a onclick="selectTab('code_switcher_python', '49dd8a5b-e583-4f30-918d-631cc4edd0bd', 0)">BUILD.bazel</a></li></ul><ul class="code-tab-switcher 49dd8a5b-e583-4f30-918d-631cc4edd0bd"><li class="code_switcher_container_parent active-tab code_switcher_python cad055e7-e76c-40d9-90de-2dc6613a403f"><div class="code_switcher_code_action_container"><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># gazelle related code ...
</span>
<span class="n">go_library</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"protoc-gen-audit_lib"</span><span class="p">,</span>
  <span class="c1">#...
</span><span class="p">)</span>

<span class="n">go_binary</span><span class="p">(</span>
  <span class="n">name</span> <span class="o">=</span> <span class="s">"protoc-gen-audit"</span><span class="p">,</span>
  <span class="n">embed</span> <span class="o">=</span> <span class="p">[</span><span class="s">":protoc-gen-audit_lib"</span><span class="p">],</span>
  <span class="c1">#...
</span><span class="p">)</span>
</code></pre></div></div> </li></ul> <h3 id="running">Running</h3> <p>We can now build our binaries by running:</p> <div class="code_switcher_container_parent 636597b4-22ca-4a79-b682-e705bf0684bd"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('636597b4-22ca-4a79-b682-e705bf0684bd')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bazel build //:protoc-gen-audit
</code></pre></div></div> </div> <p>We also need to have a proto file to test our plugin.</p> <ul class="code-tab-container cfe63874-7f63-4b53-940a-35d9443cc3f9"><li class="active-tab code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'cfe63874-7f63-4b53-940a-35d9443cc3f9', 0)">test.proto (Go)</a></li><li class=" code_switcher_proto"><a onclick="selectTab('code_switcher_proto', 'cfe63874-7f63-4b53-940a-35d9443cc3f9', 1)">test.proto (C++)</a></li></ul><ul class="code-tab-switcher cfe63874-7f63-4b53-940a-35d9443cc3f9"><li class="code_switcher_container_parent active-tab code_switcher_proto 6fe5feed-3533-4c8c-b05b-0c6f98a832b8"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('6fe5feed-3533-4c8c-b05b-0c6f98a832b8')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"proto/silent_option.proto"</span><span class="p">;</span>

<span class="k">option</span> <span class="na">go_package</span> <span class="o">=</span> <span class="s">"another_test.com"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">Bar</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">silent_option</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">owner</span><span class="o">:</span> <span class="s">"team1"</span><span class="p">,</span>
      <span class="n">email</span><span class="o">:</span> <span class="s">"team1@company.com"</span>
    <span class="p">}</span>
  <span class="p">];</span>
  <span class="kt">int32</span> <span class="na">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">silent_option</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">owner</span><span class="o">:</span> <span class="s">"team2"</span><span class="p">,</span>
      <span class="n">email</span><span class="o">:</span> <span class="s">"team2@company.com"</span>
    <span class="p">}</span>
  <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_proto 752e84d9-6a01-427e-8c4f-214fc91816ef"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('752e84d9-6a01-427e-8c4f-214fc91816ef')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-proto highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">syntax</span> <span class="o">=</span> <span class="s">"proto3"</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"proto/silent_option.proto"</span><span class="p">;</span>

<span class="kd">message</span> <span class="nc">Bar</span> <span class="p">{</span>
  <span class="kt">int32</span> <span class="na">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">silent_option</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">owner</span><span class="o">:</span> <span class="s">"team1"</span><span class="p">,</span>
      <span class="n">email</span><span class="o">:</span> <span class="s">"team1@company.com"</span>
    <span class="p">}</span>
  <span class="p">];</span>
  <span class="kt">int32</span> <span class="na">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">silent_option</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">owner</span><span class="o">:</span> <span class="s">"team2"</span><span class="p">,</span>
      <span class="n">email</span><span class="o">:</span> <span class="s">"team2@company.com"</span>
    <span class="p">}</span>
  <span class="p">];</span>
<span class="p">}</span>
</code></pre></div></div> </li></ul> <p>Now that we have our binaries in the <code>bazel-bin</code> directory, we can use them with protoc as plugins. To do so we use the <code>--plugin</code> option which takes the path of our binary and the option related to our plugin. For example, our plugin is called <code>protoc-gen-audit</code>, so now we can use the <code>--audit_out</code> option.</p> <blockquote> <p>Note: we also added a team flag in Go. This lets us use <code>--audit_opt=team=THE_TEAM_NAME</code>.</p> </blockquote> <ul class="code-tab-container ffb762ba-9625-4a7b-8d22-ffc1bbb03e31"><li class="active-tab code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'ffb762ba-9625-4a7b-8d22-ffc1bbb03e31', 0)">Go</a></li><li class=" code_switcher_shell"><a onclick="selectTab('code_switcher_shell', 'ffb762ba-9625-4a7b-8d22-ffc1bbb03e31', 1)">C++</a></li></ul><ul class="code-tab-switcher ffb762ba-9625-4a7b-8d22-ffc1bbb03e31"><li class="code_switcher_container_parent active-tab code_switcher_shell eeda4fb4-9d2d-4a50-bf94-a679152923c3"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('eeda4fb4-9d2d-4a50-bf94-a679152923c3')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protoc <span class="nt">--plugin</span><span class="o">=</span>protoc-gen-audit<span class="o">=</span><span class="si">$(</span>PWD<span class="si">)</span>/bazel-bin/protoc-gen-audit_/protoc-gen-audit <span class="nt">--audit_out</span><span class="o">=</span><span class="nb">.</span> <span class="nt">--audit_opt</span><span class="o">=</span><span class="nv">team</span><span class="o">=</span>team1 test.proto
</code></pre></div></div> </li><li class="code_switcher_container_parent code_switcher_shell e8f1fe8e-ce79-4ea2-bd1d-bb289b71bb3f"><div class="code_switcher_code_action_container"><button class="code_switcher_copy_button" title="Copy" onclick="copyText('e8f1fe8e-ce79-4ea2-bd1d-bb289b71bb3f')"></button><button class="code_switcher_theme_button" onclick="updateTheme(true)"></button></div> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>protoc <span class="nt">--plugin</span><span class="o">=</span>protoc-gen-audit<span class="o">=</span><span class="si">$(</span>PWD<span class="si">)</span>/bazel-bin/protoc-gen-audit <span class="nt">--audit_out</span><span class="o">=</span>team1:. test.proto
</code></pre></div></div> </li></ul> <p>You can now play with your plugin and test with other team names.</p> <h3 id="conclusion">Conclusion</h3> <p>Obviously, we can improve the solution in this post but the most important is that we saw that we can create custom options and protoc plugins. This can be interesting for compile time analysis or generating code. Finally, we saw that in this auditing use case, but we could use this in more advanced use cases (e.g.: <a href="https://github.com/grpc-ecosystem/grpc-gateway">grpc-gateway</a>).</p> <p><strong>If you like this kind of content let me know in the comment section and feel free to ask for help on similar projects, recommend the next post subject or simply send me your feedback.</strong></p> </div> <div class="date"> Written on February 10, 2023 </div> </article> </div> <div class="wrapper-footer"> <div class="container"> <footer class="footer"> <a href="mailto:clement.jean@epitech.eu" aria-label="Email"><i class="svg-icon email"></i></a> <a href="https://github.com/Clement-Jean" aria-label="Github"><i class="svg-icon github"></i></a> <a href="https://www.linkedin.com/in/clement-jean" aria-label="LinkedIn"><i class="svg-icon linkedin"></i></a> <a href="/feed.xml" aria-label="RSS"><i class="svg-icon rss"></i></a> <a href="https://www.twitter.com/ClmentJean1" aria-label="Twitter"><i class="svg-icon twitter"></i></a> <a href="http://stackoverflow.com/users/11269045/clément-jean" aria-label="StackOverflow"><i class="svg-icon stackoverflow"></i></a> <a href="https://techhub.social/@clementjean" aria-label="Mastodon"><i class="svg-icon mastodon"></i></a> </footer> </div> </div> <script type="text/javascript" src="/js/codetabs.js"></script> </body> </html>